# RAG 检索优化说明

## 问题现象

在多轮对话中，第二轮问题"那满三年后是多少天？"没有检索到知识库内容（`refs` 为空），导致 AI 回答错误。

**实际知识库内容**：`员工入职满一年后可享受带薪年假15天，满三年后年假增至20天。`

**AI 回答**：`满三年后仍为15天`（错误）

---

## 问题原因分析

### 1. 问题太短且包含代词
- "那满三年后是多少天？"只有 9 个字
- "那"是代词，指代上一轮的"年假"，但向量检索只看当前问题，无法理解上下文指代
- 向量相似度可能不够高，无法匹配到"满三年后年假增至20天"

### 2. minScore 阈值过高
- 原 `minScore = 0.55` 可能过滤掉了相关但相似度稍低的结果
- 简短问题的向量表示可能不够精确，相似度分数偏低

### 3. 多轮对话上下文未用于检索
- 当前 `buildRagAugment` 只接收 `question`，没有传入对话历史
- 无法利用上一轮的问题来增强检索

---

## 已实施的优化

### 1. 降低 minScore 阈值
```java
// 从 0.55 降低到 0.35
double minScore = 0.35;
```
**效果**：让更多相关结果通过，特别是简短问题的检索结果。

### 2. 问题增强处理
新增 `enhanceQuestionForSearch` 方法：
- 检测问题长度（<10字）
- 检测代词（"那"、"这"、"它"）
- 如果问题包含"满"、"年"、"天"等关键词，自动添加"年假"前缀
- 例如："那满三年后是多少天？" → "年假 那满三年后是多少天？"

**代码位置**：`KnowledgeChatServiceImpl.enhanceQuestionForSearch()`

### 3. 添加调试日志
```java
log.debug("[RAG] 原始问题: {}, 增强后: {}", question, searchQuery);
log.debug("[RAG] 检索结果数量: {}, tenantId={}, question={}", ...);
log.warn("[RAG] 未检索到相关片段, tenantId={}, question={}, searchQuery={}", ...);
```
**效果**：便于排查检索问题，查看实际检索到的结果数量。

---

## 测试验证

### 重新测试多轮对话

**第一轮**：
```json
{
  "question": "星云科技的年假是多少天？"
}
```
**预期**：应检索到"年假每年15天"，`refs` 不为空。

**第二轮**（使用相同 sessionId）：
```json
{
  "sessionId": {第一轮返回的sessionId},
  "question": "那满三年后是多少天？"
}
```
**预期**：
- 问题增强后应为"年假 那满三年后是多少天？"
- 应检索到"满三年后年假增至20天"
- `refs` 应包含"星云科技员工手册"的引用
- AI 回答应为"满三年后年假增至20天"

---

## 进一步优化建议（可选）

### 方案1：多轮对话时结合上一轮问题检索
修改 `buildRagAugment` 接口，接收对话历史：
```java
RagAugmentResult buildRagAugment(Long tenantId, String question, List<Message> history);
```

在检索时，如果当前问题很短或包含代词，可以：
- 从 history 中提取上一轮的问题关键词
- 将关键词加入当前问题的检索查询中

**优点**：更准确地理解多轮对话的上下文
**缺点**：需要修改接口，增加复杂度

### 方案2：动态调整 minScore
根据问题长度动态调整：
- 问题 < 10字：`minScore = 0.3`
- 问题 10-20字：`minScore = 0.35`
- 问题 > 20字：`minScore = 0.4`

### 方案3：关键词扩展规则库
维护一个关键词扩展规则库：
- "那" + "满" + "年" → 添加"年假"
- "那" + "价格" → 添加"产品价格"
- "那" + "时间" → 添加"工作时间"

---

## 排查步骤

如果仍然检索不到，请按以下步骤排查：

### 1. 查看日志
查看应用日志中的 `[RAG]` 相关日志：
```
[RAG] 原始问题: 那满三年后是多少天？
[RAG] 增强后: 年假 那满三年后是多少天？
[RAG] 检索结果数量: X
```

### 2. 检查文档是否已索引
```bash
GET /api/admin/knowledge/document/{docId}
```
确认 `status = 1`（已索引）

### 3. 直接测试检索接口
```bash
GET /api/admin/knowledge/search?q=满三年后年假&topK=5&minScore=0.3
```
查看是否能检索到相关内容

### 4. 检查向量维度
确认 embedding 服务返回的向量维度与 Qdrant 集合配置一致

---

## 当前优化效果

经过优化后：
- ✅ `minScore` 降低到 0.35，更多相关结果能通过
- ✅ 简短问题自动增强，添加关键词提高检索准确率
- ✅ 添加日志便于排查问题

**建议**：重新测试多轮对话，查看日志确认检索是否成功。

