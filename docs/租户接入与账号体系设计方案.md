## 租户接入与账号体系设计方案

> 面向：YuLu 多租户智能客服中台  
> 目标：明确 **B 端租户如何开通 & 登录**，以及 **C 端外部用户如何接入对话与工单**，并给出对应的表结构与接口设计方案。

---

### 一、总体目标与设计原则

#### 1.1 目标

1. **支持多租户 SaaS 模式**
   - 平台运营方可以为不同企业/机构开通租户。
   - 同一套代码、多租户共享基础设施，数据互相隔离。
2. **B 端账号体系清晰**
   - 区分租户管理员（ADMIN）与客服坐席（AGENT）。
   - 支持“平台开通租户 + 邀请管理员”以及“自助试用注册”两种模式。
3. **C 端外部用户易接入**
   - 支持租户业务系统的用户直接接入聊天，无需在客服中台重复注册。
   - 支持 Demo 环境使用中台自身的 C 端用户表。
4. **兼容现有实现**
   - 保留当前的登录/注册逻辑，用于本地开发、演示和测试。
   - 在此基础上扩展更标准的 SaaS 接入方式。

#### 1.2 设计原则

- **租户优先**：所有 B/C 端请求都必须能识别出 `tenantId`。
- **角色明确**：B 端角色至少包括 `ADMIN`、`AGENT`（可扩展 SUPER_ADMIN）。
- **外部用户优先**：C 端在真实业务场景中，以“外部用户 ID”为主。
- **安全可控**：鉴权基于 JWT，token 中携带 `tenantId/userId/role` 等信息。

---

### 二、租户与账号模型概览

#### 2.1 核心实体

1. **Tenant（租户）**
   - 表：`tenant`
   - 代表一个企业/机构/品牌。
2. **User（平台内用户）**
   - 表：`user`
   - 代表 B/C 端在中台维护的用户账号（管理员/客服/演示环境 C 端用户）。
3. **ExternalUser（外部用户映射，可选表）**
   - 表：`external_user`（建议新增）
   - 用于将业务系统中的用户 ID 映射到客服中台的 userId 或直接使用外部 ID。

#### 2.2 角色定义（现有）

`user.role` 字段：

- `ADMIN`：租户管理员
- `AGENT`：客服坐席
- `USER`：C 端演示/内部用户（当前项目已有）

> 真实生产环境中，C 端通常来自租户业务系统，此时你不一定需要在 `user` 表为所有 C 端都建账号，可以通过 ExternalUser 或 `externalUserId` 字段来支持。

---

### 三、B 端：租户开通与登录方案

#### 3.1 租户表设计（现状 + 建议字段）

表：`tenant`

- `id`：主键
- `tenant_code`：租户编码（后台内部使用）
- `tenant_identifier`：租户标识（对外使用，如 `EDU_001`）
- `name`：租户名称
- `industry`：行业（ECOMMERCE / EDU / SAAS / FINANCE / GENERIC …）
- `status`：状态（1=正常，0=禁用）
- `edition`：套餐/版本（TRIAL / STANDARD / ENTERPRISE …）
- `created_at` / `updated_at`

> 现有项目中已具备部分字段（tenantCode/tenantIdentifier 等），可在此基础上扩展。

#### 3.2 B 端租户开通方式

##### 3.2.1 平台运营后台开通（推荐主流程）

1. 运营在“平台运营后台”填写：
   - 企业名称、行业
   - 预设管理员用户名/邮箱
2. 系统执行：
   - 在 `tenant` 表创建记录，生成：
     - `tenantCode`（内部编码）
     - `tenantIdentifier`（用于前端 Widget/API）
   - 在 `user` 表创建 **ADMIN 用户**：
     - `role=ADMIN`
     - `tenant_id` 为新租户 ID
   - 生成激活链接或初始密码（可选）
3. 管理员首次登录后：
   - 必须修改密码
   - 可创建更多 ADMIN/AGENT 账号

接口示例（仅供参考，不直接写入项目）：

```java
@PostMapping("/platform/tenant/create")
@RequireRole("SUPER_ADMIN")
public ApiResponse<TenantCreateResponse> createTenant(@RequestBody TenantCreateRequest req) { ... }
```

##### 3.2.2 自助注册（适合作为试用入口）

- 前端提供“注册试用”页面（你现在已有 B 端注册页）。
- 用户填写租户名、租户编码、管理员用户名/密码。
- 后端创建 `tenant` + `ADMIN` 用户，同时标记 `edition=TRIAL`。
- 可限制试用租户的会话数量、RAG 调用次数等。

> 现有逻辑即类似“自助开通租户”，未来可以在此基础上增加 `edition` 等控制字段。

#### 3.3 B 端登录与 JWT 鉴权

##### 3.3.1 登录请求

B 端登录接口（现有）：

```java
POST /api/admin/auth/login
Body: {
  "tenantCode": "EDU_001",
  "username": "admin",
  "password": "******"
}
```

后端主要逻辑：

1. 通过 `tenantCode` 找到租户记录，检查 `status=正常`。
2. 在 `user` 表中查找：
   - `tenant_id` = 租户 ID
   - `username` = 请求中的用户名
   - `role` in (ADMIN, AGENT)
3. 校验密码，生成 JWT：
   - `tenantId`、`userId`、`role`、`username`
4. 返回 `LoginResponse`：
   - `token`
   - `tenantId`
   - `userId`
   - `role`

##### 3.3.2 鉴权与租户上下文

- 现有的 `JwtAuthFilter` 从 `Authorization: Bearer xxx` 中解析 token。
- 将解析出的 `tenantId/userId/role` 写入：
  - `TenantContextHolder`
  - `UserContextHolder`
- 业务 Controller 通过 `SecurityUtil.currentTenantId()`、`currentUserId()` 等取出上下文。

> 这套机制已经很标准，后续接入 C 端外部用户只需在 token 或上下文中支持额外字段即可。

---

### 四、C 端：外部用户接入方案

真实场景中，C 端用户（买家/学生/终端客户）通常已经存在于 **租户的业务系统**（商城、教务等），不希望在你的客服中台再注册一套账号。为此设计如下两种模式：

#### 4.1 Demo/内测模式（使用中台自有 C 端用户）

适用场景：
- 本地开发/demo 环境/POC 测试。

做法：
- 使用现有的 `CustomerAuthController` 和 `user.role=USER`。
- C 端在你的中台注册/登录，然后在前端直接访问 `/customer/chat`。

> 这是你当前已经实现的逻辑，无需调整，适合作为“演示环境”和“开发调试”使用。

#### 4.2 生产模式：外部用户模式（推荐）

目标：
- 租户系统的用户（如商城用户）在自己系统登录后，进入客服对话时，**无需在中台再注册/登录**。

设计核心：
- **引入 `externalUserId`（或 `channelUserId`）的概念**：
  - 由租户业务系统保证其唯一性与有效性。
  - 中台将其作为 C 端用户的主标识之一。

##### 4.2.1 方案 A：无持久化映射，直接使用 externalUserId

做法：

1. C 端对接方式（Widget / API）在初始化/调用时传入：

```json
{
  "tenantIdentifier": "EDU_001",
  "externalUserId": "u_123456",   // 业务系统的用户ID
  "nickname": "张三",              // 可选
  "avatarUrl": "https://xxx"      // 可选
}
```

2. 你的 C 端控制器如 `CustomerChatController` 接口改造：

- 对于外部调用（非中台直接登录的 USER），允许不走 `CustomerAuthController` 的登录，而是：
  - 从请求体或 Header 读取 `tenantIdentifier` 和 `externalUserId`。
  - 根据 `tenantIdentifier` 查出 `tenantId`，手动设置 `TenantContextHolder`。
  - 在内部上下文中 **临时构建一个 LoginUser**：
    - `userId` 可以为 `null` 或一个虚拟 ID（如 0）
    - 在所有和 C 端用户相关的表（如 `chat_session`、`ticket`）中新增字段 `external_user_id` 保存真正的外部ID。

推荐在以下表中加 `external_user_id` 字段：

- `chat_session`：会话是谁的
- `chat_message`：消息来自哪个外部用户
- `ticket`：工单关联的外部用户

优点：
- 无需提前同步用户表。
- 你只需要信任租户系统传入的 `externalUserId`。

缺点：
- 查询/统计 C 端用户视角时，需要依赖 `external_user_id` 字段。

##### 4.2.2 方案 B：增加 ExternalUser 映射表

表：`external_user`

- `id`：主键
- `tenant_id`
- `external_user_id`：租户业务系统的用户ID
- `user_id`：可选，对应中台 `user` 表的 ID（如果有）
- `nickname`
- `avatar_url`
- `created_at` / `updated_at`

调用流程：

1. 第一次外部调用时：
   - 如果能在 `external_user` 表中查到该 `(tenant_id, external_user_id)`，则直接使用。
   - 否则创建一条记录，仅记录 `external_user_id` 和基础信息。
2. 你可以（可选）为某些外部用户创建中台 `user` 账号并绑定到 `external_user.user_id`。

优点：
- 便于做跨会话、跨工单的“用户级”统计。
- 可以渐进式地给部分 C 端用户开中台账号。

缺点：
- 实现比方案 A 稍复杂。

> 初期建议采用 **方案 A**（无持久化映射），等确有强用户画像/CRM 需求时再演进到方案 B。

---

### 五、接口设计示例

#### 5.1 C 端通过 Widget / API 接入聊天

##### 5.1.1 初始化（伪代码）

前端（租户网站）嵌入：

```js
YuluChat.init({
  baseUrl: 'https://yulu.example.com',
  tenantIdentifier: 'EDU_001',
  externalUserId: currentUser.id,
  nickname: currentUser.nickname
});
```

##### 5.1.2 发送消息接口（改造示例）

```http
POST /api/customer/chat/ask
Content-Type: application/json

{
  "sessionId": 123,           // 可选
  "question": "我想查一下订单 20260116 的物流",
  "externalUserId": "u_123456",
  "tenantIdentifier": "EDU_001"
}
```

后端处理关键点：

1. 根据 `tenantIdentifier` 查询 `tenantId`，设置 `TenantContextHolder`。
2. 将 `externalUserId` 写入 `UserContextHolder` 或一个专门的 C 端上下文对象。
3. 在创建会话/消息/工单时，将 `external_user_id` 字段写入对应表。

> 与现有基于 TOKEN 的 C 端登录并不冲突，两种模式可以共存：  
> - Demo 环境：走 `CustomerAuthController` 登录  
> - 生产环境（外部用户）：走 `tenantIdentifier + externalUserId` 直连模式

#### 5.2 B 端获取会话/工单时的关联字段

在以下 DTO/实体中补充 `externalUserId`（或 `external_user_id`）字段：

- `ChatSession`
- `ChatMessage`
- `Ticket`

接口返回示例（部分）：

```json
{
  "id": 5,
  "tenantId": 1001,
  "userId": null,
  "externalUserId": "u_123456",
  "title": "情绪告警-会话#3",
  "status": "PENDING"
}
```

这样，管理员/客服在 B 端工作台就可以根据 `externalUserId` 或租户系统传来的 `nickname` 查询与其相关的所有会话与工单。

---

### 六、与现有实现的衔接建议

1. **保留现有 B/C 端注册/登录**  
   - 作为开发、测试、演示环境的入口，不要删除。  
   - 可以在数据库中标记这些租户为 `edition=TRIAL`。

2. **新增“外部用户模式”相关字段**  
   - 在 `chat_session/chat_message/ticket` 等表中增加 `external_user_id` 字段。  
   - 在 C 端接口 DTO 中增加 `externalUserId`、`tenantIdentifier` 可选字段。

3. **分环境使用**  
   - 本地/测试环境：仍使用你当前的 C 端登录注册页面。  
   - 真正对接电商/教育客户时：使用 `externalUserId` 接入模式。

4. **编写对外文档**  
   - 在 docs 中新增《租户接入指南》面向租户开发者：  
     - 如何获取 `tenantIdentifier`  
     - Widget / API 的使用示例  
     - externalUserId 的使用规范

---

### 七、总结

- B 端：通过 **平台开通租户 + 管理员账号** 或 **自助注册试用** 建立租户与管理员体系，登录后所有接口均通过 JWT 携带 `tenantId/userId/role` 建立上下文。  
- C 端：生产环境应以 **外部用户 ID（externalUserId）** 为主，不强依赖中台自己的 C 端注册；中台只需要在关键业务表中保存 `external_user_id` 即可。  
- 现有实现可以无缝演进，只需在数据模型和 C 端接口上补上 externalUser 相关字段，就可以支持“真实业务接入”与“演示环境”双模式共存。  



















