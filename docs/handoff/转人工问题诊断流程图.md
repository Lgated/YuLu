# 转人工问题诊断流程图

## 问题现象

```
用户端发送消息
    ↓
❌ 错误：当前会话未接入客服
    ↓
WebSocketMessageService.handleCustomerMessage()
    ↓
检查 chat_session.agent_id
    ↓
发现 agent_id = NULL ❌
```

---

## 正常流程 vs 错误流程

### ✅ 正常流程（修复后）

```
1. 用户发起转人工请求
   ↓
2. HandoffService.createHandoffRequest()
   - 创建 handoff_request 记录
   - status = PENDING
   ↓
3. HandoffService.asyncAssignAgent()
   - AgentAssigner 分配客服
   - 找到可用客服 agentId=3
   ↓
4. 更新数据库（关键！）
   ├─ handoff_request.agent_id = 3 ✅
   └─ chat_session.agent_id = 3 ✅  ← 修复点
   ↓
5. 用户发送消息
   ↓
6. WebSocketMessageService 检查
   - chat_session.agent_id = 3 ✅
   - 消息成功转发给客服
```

### ❌ 错误流程（修复前）

```
1. 用户发起转人工请求
   ↓
2. HandoffService.createHandoffRequest()
   - 创建 handoff_request 记录
   ↓
3. HandoffService.asyncAssignAgent()
   - AgentAssigner 分配客服
   ↓
4. 更新数据库（不完整！）
   ├─ handoff_request.agent_id = 3 ✅
   └─ chat_session.agent_id = NULL ❌  ← 问题所在
   ↓
5. 用户发送消息
   ↓
6. WebSocketMessageService 检查
   - chat_session.agent_id = NULL ❌
   - 抛出异常：当前会话未接入客服
```

---

## Redis 数据结构问题

### ✅ 正确的 Redis 结构

```
agent:status:1:3 (HASH)
├── status: "ONLINE"
├── current_sessions: 0      ← 可以正确读取
├── max_sessions: 5
├── heartbeat_time: 1707472800000
└── last_active_time: "2026-02-09T16:30:00"

AgentAssigner.assignAgent()
    ↓
读取 current_sessions = 0
    ↓
判断：0 < 5 ✅
    ↓
分配成功
```

### ❌ 错误的 Redis 结构

```
agent:status:1:3 (STRING)
└── "1707472800000"          ← 只有时间戳

AgentAssigner.assignAgent()
    ↓
尝试读取 current_sessions
    ↓
返回 NULL ❌
    ↓
无法判断负载
    ↓
分配失败或异常
```

---

## 完整修复流程图

```
┌─────────────────────────────────────────────────────────┐
│ 步骤 1: 重启后端服务                                      │
│ - 停止当前服务                                            │
│ - 重新启动 (mvn spring-boot:run)                         │
│ - 新代码生效 ✅                                           │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 步骤 2: 清理 Redis 数据                                   │
│ - 删除 agent:status:1:3 (STRING)                         │
│ - 删除 agent:sessions:1:3                                │
│ - 删除 agent:online:1                                    │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 步骤 3: 客服重新上线                                      │
│ - 刷新页面                                                │
│ - 点击"上线"按钮                                          │
│ - 触发 AgentStatusServiceImpl.setOnline()                │
│ - 创建正确的 HASH 结构 ✅                                 │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 步骤 4: 验证 Redis 结构                                   │
│ - 调用 /api/admin/debug/check-agent-redis/3             │
│ - 确认 statusKeyType = "HASH" ✅                         │
│ - 确认包含 current_sessions 字段 ✅                       │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ 步骤 5: 测试转人工流程                                    │
│ - 用户发起转人工请求                                      │
│ - 观察日志："已更新会话的客服ID" ✅                        │
│ - 验证数据库：chat_session.agent_id != NULL ✅            │
│ - 用户发送消息成功 ✅                                     │
└─────────────────────────────────────────────────────────┘
```

---

## 数据流向图

### 转人工请求的数据流

```
用户端
  │
  │ 1. POST /api/customer/handoff/transfer
  │    { sessionId: 36 }
  ↓
CustomerHandoffController
  │
  │ 2. 调用 HandoffService.createHandoffRequest()
  ↓
HandoffService
  │
  │ 3. 插入数据库
  │    handoff_request:
  │    ├─ id = 35
  │    ├─ session_id = 36
  │    ├─ agent_id = NULL
  │    └─ status = PENDING
  │
  │ 4. 异步分配客服
  ↓
AgentAssigner
  │
  │ 5. 查询 Redis
  │    agent:status:1:3 (HASH)
  │    ├─ status = "ONLINE"
  │    ├─ current_sessions = 0
  │    └─ max_sessions = 5
  │
  │ 6. 判断：0 < 5 ✅
  │    返回 agentId = 3
  ↓
HandoffService.asyncAssignAgent()
  │
  │ 7. 更新数据库（修复后）
  │    handoff_request:
  │    ├─ agent_id = 3 ✅
  │    └─ status = ASSIGNED
  │
  │    chat_session:
  │    └─ agent_id = 3 ✅  ← 关键修复
  │
  │ 8. 发送 WebSocket 通知
  ↓
客服端
  │
  │ 9. 收到转人工通知
  │    显示新会话
  ↓
用户发送消息
  │
  │ 10. WebSocket 消息
  ↓
WebSocketMessageService
  │
  │ 11. 查询数据库
  │     chat_session.agent_id = 3 ✅
  │
  │ 12. 转发消息给客服
  ↓
客服端收到消息 ✅
```

---

## 客服负载管理流程

```
客服上线
  │
  │ PUT /api/admin/user/online-status?status=ONLINE
  ↓
AgentStatusServiceImpl.setOnline()
  │
  │ 创建 Redis HASH
  │ agent:status:1:3
  │ ├─ status = "ONLINE"
  │ ├─ current_sessions = 0
  │ ├─ max_sessions = 5
  │ └─ heartbeat_time = now
  ↓
接受转人工请求
  │
  │ AgentAssigner 分配会话
  ↓
AgentStatusServiceImpl.incrementSessionCount()
  │
  │ current_sessions: 0 → 1
  ↓
客服结束会话
  │
  │ POST /api/agent/handoff/end
  ↓
AgentStatusServiceImpl.decrementSessionCount()
  │
  │ current_sessions: 1 → 0
  ↓
客服可以接受新会话
```

---

## 问题排查决策树

```
用户报错："当前会话未接入客服"
    ↓
检查：后端服务是否重启？
    ├─ 否 → 重启服务 → 重新测试
    └─ 是 ↓
检查：Redis 数据类型是否正确？
    ├─ 否 (STRING) → 删除 key → 客服重新上线
    └─ 是 (HASH) ↓
检查：客服是否在线？
    ├─ 否 → 客服上线 → 重新测试
    └─ 是 ↓
检查：chat_session.agent_id 是否为 NULL？
    ├─ 是 → 查看后端日志 → 检查代码是否部署
    └─ 否 ↓
检查：WebSocket 连接是否正常？
    ├─ 否 → 刷新页面 → 重新连接
    └─ 是 ↓
其他问题 → 查看详细日志 → 联系技术支持
```

---

## Redis Key 关系图

```
租户 1 (tenantId=1)
│
├─ 客服 3 (agentId=3)
│  │
│  ├─ agent:status:1:3 (HASH)
│  │  ├─ status: "ONLINE"
│  │  ├─ current_sessions: 0
│  │  ├─ max_sessions: 5
│  │  ├─ heartbeat_time: 1707472800000
│  │  └─ last_active_time: "2026-02-09T16:30:00"
│  │
│  └─ agent:sessions:1:3 (STRING)
│     └─ "0"  (当前会话数)
│
├─ agent:online:1 (ZSET)
│  └─ 3 → 1707472800000  (客服ID → 上线时间戳)
│
└─ handoff:queue:1 (LIST)
   ├─ handoffRequestId: 35
   ├─ handoffRequestId: 36
   └─ ...
```

---

## 时序图：完整转人工流程

```
用户端          后端服务          Redis          数据库          客服端
  │               │                │              │               │
  │ 转人工请求     │                │              │               │
  ├──────────────>│                │              │               │
  │               │ 创建请求        │              │               │
  │               ├───────────────────────────────>│               │
  │               │                │              │ handoff_request│
  │               │                │              │ status=PENDING │
  │               │                │              │               │
  │               │ 查询在线客服    │              │               │
  │               ├───────────────>│              │               │
  │               │ HGETALL        │              │               │
  │               │<───────────────┤              │               │
  │               │ {status:ONLINE,│              │               │
  │               │  current:0}    │              │               │
  │               │                │              │               │
  │               │ 分配客服        │              │               │
  │               │ agentId=3      │              │               │
  │               │                │              │               │
  │               │ 更新数据库      │              │               │
  │               ├───────────────────────────────>│               │
  │               │                │              │ handoff_request│
  │               │                │              │ agent_id=3 ✅  │
  │               │                │              │ chat_session   │
  │               │                │              │ agent_id=3 ✅  │
  │               │                │              │               │
  │               │ 增加负载        │              │               │
  │               ├───────────────>│              │               │
  │               │ HINCRBY        │              │               │
  │               │ current:0→1    │              │               │
  │               │                │              │               │
  │               │ WebSocket 通知 │              │               │
  │               ├───────────────────────────────────────────────>│
  │               │                │              │               │ 新会话通知
  │               │                │              │               │
  │ 发送消息       │                │              │               │
  ├──────────────>│                │              │               │
  │               │ 查询 agent_id  │              │               │
  │               ├───────────────────────────────>│               │
  │               │<───────────────────────────────┤               │
  │               │ agent_id=3 ✅  │              │               │
  │               │                │              │               │
  │               │ 转发消息        │              │               │
  │               ├───────────────────────────────────────────────>│
  │               │                │              │               │ 收到消息 ✅
```

---

## 关键代码位置

### 1. 问题代码（修复前）

**文件**：`HandoffService.java`  
**方法**：`asyncAssignAgent()`  
**行号**：约 240-280

```java
// ❌ 只更新了 handoff_request，没有更新 chat_session
request.setAgentId(agentId);
handoffRequestMapper.updateById(request);
```

### 2. 修复代码（修复后）

```java
// ✅ 同时更新 handoff_request 和 chat_session
request.setAgentId(agentId);
handoffRequestMapper.updateById(request);

// 【关键修复】
ChatSession session = chatSessionMapper.selectById(request.getSessionId());
if (session != null) {
    session.setAgentId(agentId);
    chatSessionMapper.updateById(session);
    log.info("[HandoffService] 已更新会话的客服ID：sessionId={}, agentId={}", 
        session.getId(), agentId);
}
```

### 3. Redis 初始化代码

**文件**：`AgentStatusServiceImpl.java`  
**方法**：`setOnline()`

```java
// ✅ 创建正确的 HASH 结构
Map<String, Object> status = new HashMap<>();
status.put("status", "ONLINE");
status.put("current_sessions", 0);
status.put("max_sessions", maxSessions);
status.put("heartbeat_time", now);
status.put("last_active_time", nowDateTime.toString());

redisTemplate.opsForHash().putAll(statusKey, status);
```

### 4. 消息验证代码

**文件**：`WebSocketMessageService.java`  
**方法**：`handleCustomerMessage()`

```java
// 检查会话是否已接入客服
if (session.getAgentId() == null) {
    throw new BizException(ErrorCodes.HANDOFF_NOT_ASSIGNED, "当前会话未接入客服");
}
```

---

## 总结

### 核心问题
1. **代码层面**：`chat_session.agent_id` 未同步更新
2. **Redis 层面**：数据结构错误（STRING 而非 HASH）

### 解决方案
1. **重启服务**：使修复代码生效
2. **清理 Redis**：删除损坏的 key
3. **客服上线**：重建正确的 HASH 结构
4. **验证测试**：确保完整流程正常

### 验证要点
- 后端日志有 "已更新会话的客服ID"
- Redis 数据类型是 HASH
- 数据库 `chat_session.agent_id` 不为 NULL
- 用户可以正常发送消息
