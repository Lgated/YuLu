# 转人工功能问题排查清单

## 🎯 快速诊断流程

### 症状：用户发送消息报错 "当前会话未接入客服"

```
错误位置：WebSocketMessageService.handleCustomerMessage()
错误原因：chat_session.agent_id 为 NULL
```

---

## ✅ 排查步骤

### 第 1 步：确认后端服务已重启

**为什么重要**：代码修复需要重启才能生效

```bash
# 检查后端启动时间
# 应该在代码修改之后

# 查看日志中的启动时间
grep "Started YuLuApplication" logs/application.log
```

**预期结果**：启动时间在代码修改之后

---

### 第 2 步：检查 Redis 数据结构

**为什么重要**：错误的数据类型会导致客服负载计算失败

#### 方法 A：使用 Debug API

```bash
curl -X GET "http://localhost:8080/api/admin/debug/check-agent-redis/3" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期结果**：
```json
{
  "code": 200,
  "data": {
    "statusKeyExists": true,
    "statusKeyType": "HASH",  // ✅ 必须是 HASH
    "statusData": {
      "status": "ONLINE",
      "current_sessions": 0,
      "max_sessions": 5,
      "heartbeat_time": 1707472800000,
      "last_active_time": "2026-02-09T16:30:00"
    }
  }
}
```

**❌ 错误示例**：
```json
{
  "statusKeyType": "STRING",  // ❌ 错误！应该是 HASH
  "statusData": "1707472800000",
  "warning": "数据类型错误！应该是 HASH，实际是 STRING"
}
```

#### 方法 B：直接查询 Redis

```bash
redis-cli

# 检查数据类型
TYPE agent:status:1:3
# 应该返回：hash

# 查看内容
HGETALL agent:status:1:3
# 应该返回多个字段
```

**如果数据类型错误**：
```bash
# 删除损坏的 key
curl -X POST "http://localhost:8080/api/admin/debug/force-reset-agent/3" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 或者直接在 Redis 中删除
redis-cli DEL agent:status:1:3
```

---

### 第 3 步：检查客服在线状态

```bash
curl -X GET "http://localhost:8080/api/admin/debug/agent-status/3" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期结果**：
```json
{
  "code": 200,
  "data": {
    "status": "ONLINE",
    "current_sessions": 0,
    "max_sessions": 5,
    "canAcceptSession": true
  }
}
```

**如果客服不在线**：
- 客服需要刷新页面
- 客服需要点击"上线"按钮
- 或调用上线接口：
  ```bash
  curl -X PUT "http://localhost:8080/api/admin/user/online-status?status=ONLINE" \
    -H "Authorization: Bearer AGENT_TOKEN"
  ```

---

### 第 4 步：检查数据库一致性

运行 `docs/数据库验证查询.sql` 中的查询：

```sql
-- 查看最近的转人工请求
SELECT 
    hr.id AS handoff_id,
    hr.session_id,
    hr.agent_id AS handoff_agent_id,
    cs.agent_id AS session_agent_id,
    CASE 
        WHEN hr.agent_id IS NULL THEN '❌ 未分配客服'
        WHEN cs.agent_id IS NULL THEN '❌ 会话未更新 agent_id'
        WHEN hr.agent_id != cs.agent_id THEN '❌ agent_id 不一致'
        ELSE '✅ 正常'
    END AS check_result
FROM handoff_request hr
LEFT JOIN chat_session cs ON hr.session_id = cs.id
WHERE hr.tenant_id = 1
ORDER BY hr.created_at DESC
LIMIT 5;
```

**预期结果**：
- `handoff_agent_id` 和 `session_agent_id` 应该相同
- `check_result` 应该是 "✅ 正常"

**如果不一致**：
```sql
-- 手动修复（临时方案）
UPDATE chat_session cs
INNER JOIN handoff_request hr ON cs.handoff_request_id = hr.id
SET cs.agent_id = hr.agent_id
WHERE cs.tenant_id = 1
  AND hr.status = 'ASSIGNED'
  AND cs.agent_id IS NULL;
```

---

### 第 5 步：测试完整流程

#### 5.1 清空队列（避免旧数据干扰）

```bash
curl -X DELETE "http://localhost:8080/api/admin/debug/clear-queue" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 5.2 用户发起转人工请求

在用户端点击"转人工"按钮

#### 5.3 观察后端日志

```bash
# 应该看到以下日志
[HandoffService] 创建转人工请求成功
[AgentAssigner] 开始分配客服
[AgentAssigner] 找到可用客服: agentId=3
[HandoffService] 客服分配完成：handoffRequestId=XX, agentId=3, sessionId=XX
[HandoffService] 已更新会话的客服ID：sessionId=XX, agentId=3  # ✅ 关键日志
```

**如果没有看到 "已更新会话的客服ID"**：
- 后端服务未重启
- 代码未正确部署

#### 5.4 验证数据库

```sql
SELECT id, agent_id, handoff_request_id 
FROM chat_session 
WHERE id = XX;
```

**预期结果**：`agent_id` 不为 NULL

#### 5.5 用户发送消息

在用户端发送一条消息

**预期结果**：
- 消息成功发送
- 客服端收到消息
- 不再出现 "当前会话未接入客服" 错误

---

## 🔧 常见问题修复

### 问题 1：Redis 数据类型是 STRING 而不是 HASH

**原因**：可能有旧代码或其他地方错误地写入了 Redis

**解决方案**：
```bash
# 1. 强制删除
curl -X POST "http://localhost:8080/api/admin/debug/force-reset-agent/3" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. 客服重新上线
# 前端：刷新页面 -> 点击"上线"按钮

# 3. 验证
curl -X GET "http://localhost:8080/api/admin/debug/check-agent-redis/3" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

### 问题 2：客服分配成功但 chat_session.agent_id 仍然是 NULL

**原因**：后端服务未重启，旧代码仍在运行

**解决方案**：
```bash
# 1. 停止后端服务
# 2. 重新启动
mvn spring-boot:run

# 3. 验证代码版本
# 查看日志中是否有 "已更新会话的客服ID" 日志
```

---

### 问题 3：转人工请求一直在队列中，没有分配

**可能原因**：
1. 没有在线客服
2. 所有客服负载已满
3. Redis 数据结构错误

**排查步骤**：
```bash
# 1. 查看队列信息
curl -X GET "http://localhost:8080/api/admin/debug/queue-info" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. 查看客服状态
curl -X GET "http://localhost:8080/api/admin/debug/agent-status/3" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. 查看后端日志
grep "AgentAssigner" logs/application.log
```

---

### 问题 4：客服端无法结束会话（缺少 handoffRequestId）

**原因**：客服刷新页面后，会话对象没有包含 `handoffRequestId`

**解决方案**：已修复，前端会自动调用 API 获取 `handoffRequestId`

**验证**：
- 打开浏览器开发者工具
- 查看 Console 是否有 "Fetched handoffRequestId" 日志
- 查看 Network 是否调用了 `/api/agent/handoff/by-session/{sessionId}`

---

## 📋 完整修复清单

执行以下步骤，确保每一步都成功：

- [ ] **步骤 1**：后端服务已重启（启动时间在代码修改之后）
- [ ] **步骤 2**：Redis 数据结构正确（`agent:status:1:3` 是 HASH 类型）
- [ ] **步骤 3**：客服已上线（status = "ONLINE"）
- [ ] **步骤 4**：清空转人工队列
- [ ] **步骤 5**：用户发起新的转人工请求
- [ ] **步骤 6**：后端日志显示 "已更新会话的客服ID"
- [ ] **步骤 7**：数据库 `chat_session.agent_id` 不为 NULL
- [ ] **步骤 8**：用户可以正常发送消息
- [ ] **步骤 9**：客服可以正常接收消息
- [ ] **步骤 10**：客服可以正常结束会话

---

## 🚨 紧急修复脚本

如果需要快速修复，按顺序执行：

### Windows 用户

```cmd
REM 1. 修改 token
notepad docs\快速修复命令-Windows.bat

REM 2. 运行脚本
docs\快速修复命令-Windows.bat
```

### Linux/Mac 用户

```bash
# 1. 修改 token
nano docs/快速修复命令-复制粘贴执行.sh

# 2. 添加执行权限
chmod +x docs/快速修复命令-复制粘贴执行.sh

# 3. 运行脚本
./docs/快速修复命令-复制粘贴执行.sh
```

---

## 📞 仍然无法解决？

请提供以下信息：

1. **后端日志**（最近 100 行）
   ```bash
   tail -n 100 logs/application.log
   ```

2. **Redis 数据**
   ```bash
   curl -X GET "http://localhost:8080/api/admin/debug/check-agent-redis/3" \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

3. **数据库查询结果**
   ```sql
   -- 运行 docs/数据库验证查询.sql 中的查询 1 和 2
   ```

4. **前端控制台错误**（如果有）

5. **后端启动时间**
   ```bash
   grep "Started YuLuApplication" logs/application.log
   ```
