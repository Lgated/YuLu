# 转人工功能测试步骤

## 前置条件

1. 后端服务已启动
2. 数据库已初始化
3. Redis 已启动
4. 至少有一个客服账号（role=AGENT）在线

## 测试场景1：正常转人工流程

### 步骤1：用户端发起转人工请求

1. 使用用户账号登录（role=USER）
2. 进入聊天页面，创建一个新会话
3. 点击"转人工"按钮
4. 填写转人工原因（可选）
5. 提交请求

**预期结果**：
- 前端显示"排队中"提示
- 显示排队位置和预计等待时间
- 后端日志显示：
  ```
  [HandoffService] 创建工单：ticketId=xxx, sessionId=xxx
  [HandoffQueue] 加入队列：tenantId=1, handoffRequestId=xxx, position=1
  ```

### 步骤2：系统自动分配客服

等待1-2秒，系统自动分配客服。

**预期结果**：
- 后端日志显示：
  ```
  [AgentAssigner] 分配客服成功：handoffRequestId=xxx, agentId=xxx, score=xxx
  [HandoffService] 已更新会话的客服ID：sessionId=xxx, agentId=xxx
  [HandoffService] 转人工请求通知已发送：agentId=xxx, handoffRequestId=xxx
  [HandoffService] 客服分配完成：handoffRequestId=xxx, agentId=xxx, sessionId=xxx
  ```

### 步骤3：客服端收到通知

1. 使用客服账号登录（role=AGENT）
2. 进入客服工作台页面
3. 应该在"待处理请求"列表中看到新的转人工请求

**预期结果**：
- 客服端显示新的转人工请求
- 显示客户信息、转人工原因、优先级等
- 有"接受"和"拒绝"按钮

### 步骤4：客服接受请求

1. 客服点击"接受"按钮
2. 系统将请求从待处理列表移除
3. 在"进行中会话"列表中显示该会话

**预期结果**：
- 客服端显示会话窗口
- 可以看到历史消息（如果有）
- 后端日志显示：
  ```
  [HandoffService] 客服已接受通知已发送：userId=xxx, sessionId=xxx, agentId=xxx, handoffRequestId=xxx
  ```

### 步骤5：用户端收到接入通知

用户端应该收到"客服已接入"的通知。

**预期结果**：
- 用户端显示"客服已接入"提示
- 排队提示消失
- 可以正常发送消息

### 步骤6：双方正常通信

1. 用户发送消息："你好，我需要帮助"
2. 客服应该能收到消息
3. 客服回复："您好，请问有什么可以帮您？"
4. 用户应该能收到回复

**预期结果**：
- 双方都能正常收发消息
- 消息实时显示
- 后端日志显示：
  ```
  [WebSocket] 客户消息已转发给客服：sessionId=xxx, agentId=xxx
  [WebSocket] 客服消息已转发给客户：sessionId=xxx, userId=xxx
  ```

### 步骤7：结束对话

客服点击"结束对话"按钮。

**预期结果**：
- 会话状态更新为已完成
- 用户端收到"对话已结束"通知
- 会话切换回 AI 模式
- 后端日志显示：
  ```
  [HandoffService] 转人工对话已完成: handoffRequestId=xxx, agentId=xxx
  ```

## 测试场景2：无客服在线（兜底机制）

### 步骤1：确保没有客服在线

1. 所有客服账号都登出
2. 或者将客服状态设置为离线

### 步骤2：用户发起转人工请求

1. 用户点击"转人工"按钮
2. 提交请求

**预期结果**：
- 系统自动创建工单
- 用户收到提示："抱歉，当前没有客服在线。我们已经为您创建了工单 #xxx，客服上线后会尽快处理您的问题。"
- 后端日志显示：
  ```
  [HandoffService] 租户 1 无在线客服，执行自动转工单兜底策略
  ```

## 测试场景3：客服拒绝请求

### 步骤1：客服收到转人工请求

按照场景1的步骤1-3执行。

### 步骤2：客服拒绝请求

1. 客服点击"拒绝"按钮
2. 填写拒绝原因（可选）
3. 提交

**预期结果**：
- 请求重新进入队列
- 系统尝试分配给其他客服
- 后端日志显示：
  ```
  [HandoffService] 客服已拒绝转人工请求，已重新入队: handoffRequestId=xxx, agentId=xxx
  ```

## 测试场景4：用户取消转人工

### 步骤1：用户发起转人工请求

按照场景1的步骤1执行。

### 步骤2：用户在排队时取消

1. 用户点击"取消转人工"按钮
2. 确认取消

**预期结果**：
- 请求从队列中移除
- 用户端显示"已取消转人工"
- 如果已分配客服，客服端收到取消通知
- 后端日志显示：
  ```
  [HandoffService] 转人工请求已取消：handoffRequestId=xxx, userId=xxx
  ```

## 数据库验证

### 验证1：chat_session 表

```sql
SELECT id, tenant_id, user_id, agent_id, chat_mode, handoff_request_id, create_time, update_time
FROM chat_session
WHERE id = <sessionId>;
```

**预期结果**（客服接受后）：
- `agent_id`: 应该有值（不为 null）
- `chat_mode`: AGENT
- `handoff_request_id`: 应该有值

### 验证2：handoff_request 表

```sql
SELECT id, tenant_id, session_id, user_id, agent_id, status, priority, queue_position, 
       assigned_at, accepted_at, completed_at, create_time
FROM handoff_request
WHERE id = <handoffRequestId>;
```

**预期结果**（客服接受后）：
- `agent_id`: 应该有值
- `status`: ACCEPTED
- `assigned_at`: 应该有值
- `accepted_at`: 应该有值

### 验证3：handoff_event 表

```sql
SELECT id, tenant_id, handoff_request_id, event_type, operator_id, operator_type, event_data, create_time
FROM handoff_event
WHERE handoff_request_id = <handoffRequestId>
ORDER BY create_time;
```

**预期结果**：
应该看到以下事件序列：
1. CREATED (operator_type=USER)
2. ASSIGNED (operator_type=SYSTEM)
3. ACCEPTED (operator_type=AGENT)
4. COMPLETED (operator_type=AGENT)

## 常见问题排查

### 问题1：客服端没有收到通知

**排查步骤**：
1. 检查客服 WebSocket 连接是否建立：
   - 查看浏览器控制台，应该有 `[WebSocket] Connection established.` 日志
2. 检查后端日志，确认是否发送了通知：
   - 应该有 `[HandoffService] 转人工请求通知已发送` 日志
3. 检查客服是否在线：
   - 查询 Redis：`GET agent:status:1:3`（tenantId=1, agentId=3）

### 问题2：用户发送消息失败

**排查步骤**：
1. 检查 `chat_session` 表的 `agent_id` 字段是否为 null
2. 检查后端日志，是否有 `当前会话未接入客服` 错误
3. 检查 `handoff_request` 表的 `status` 字段，应该是 ACCEPTED

### 问题3：WebSocket 连接失败

**排查步骤**：
1. 检查 token 是否有效
2. 检查 WebSocket URL 是否正确
3. 检查后端日志，是否有握手失败的错误

### 问题4：分配客服失败

**排查步骤**：
1. 检查是否有客服在线：
   - 查询 Redis：`KEYS agent:status:1:*`
2. 检查客服配置：
   - 查询 `agent_config` 表
3. 检查客服负载：
   - 查询 Redis：`GET agent:status:1:3`，检查 `current_sessions` 和 `max_sessions`

## 性能测试

### 测试1：并发转人工请求

1. 模拟10个用户同时发起转人工请求
2. 观察系统是否能正确处理排队
3. 观察客服分配是否均衡

**预期结果**：
- 所有请求都能正确进入队列
- 客服负载均衡分配
- 没有请求丢失

### 测试2：高频消息发送

1. 用户和客服快速发送消息（每秒1条）
2. 持续1分钟
3. 观察消息是否都能正确送达

**预期结果**：
- 所有消息都能正确送达
- 没有消息丢失
- 没有 WebSocket 错误

## 总结

完成以上测试后，转人工功能应该能够正常工作。如果遇到问题，请参考"常见问题排查"部分进行诊断。
