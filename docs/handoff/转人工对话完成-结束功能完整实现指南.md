# 转人工对话完成（结束功能）- 完整实现指南

## 一、功能概述

转人工对话完成是指客服与用户的对话已经解决或不需要继续，此时客服点击"完成"按钮，系统会：

1. **后端**：更新转人工请求状态为 `COMPLETED`，更新工单状态为 `DONE`，释放客服会话位置
2. **前端（客服）**：关闭当前对话窗口，返回待处理列表
3. **前端（客户）**：接收 `HANDOFF_COMPLETED` 消息，显示对话已结束，清理客服对话状态

---

## 二、后端已有接口分析

### `HandoffService.complete()`

**位置**：`src/main/java/com/ityfz/yulu/handoff/websocket/service/HandoffService.java`

**功能**：完成转人工对话

```java
@Transactional
public void complete(Long tenantId, Long agentId, Long handoffRequestId) {
    // 1. 验证请求（权限校验）
    // 2. 更新请求状态 → COMPLETED
    // 3. 更新会话模式（可改回 AI）
    // 4. 更新工单状态 → DONE
    // 5. 减少客服会话数
    // 6. 记录事件
    // 7. WebSocket 通知客户 HANDOFF_COMPLETED
}
```

**关键逻辑**：
- 状态转移：`ACCEPTED` 或 `IN_PROGRESS` → `COMPLETED`
- 触发通知：客户收到 `HANDOFF_COMPLETED` 消息，包含 sessionId
- 数据清理：工单变为 DONE，客服会话数递减

---

## 三、前端实现路径

### 3.1 前端 API 层（新增）

**文件**：`frontend/src/api/handoff.ts`

```typescript
/**
 * 完成转人工对话
 */
export const completeHandoff = async (handoffRequestId: number): Promise<any> => {
  return request.post(`/api/handoff/complete`, {
    handoffRequestId
  });
};
```

### 3.2 客服端会话窗口（完成按钮）

**文件**：`frontend/src/components/AgentChatWindow.tsx`

**需要添加的按钮**（在消息输入框下方）：

```tsx
<Button 
  type="primary" 
  danger 
  onClick={handleCompleteHandoff}
  style={{ marginTop: 8 }}
>
  完成对话
</Button>
```

**处理函数**：

```typescript
const handleCompleteHandoff = async () => {
  if (!sessionId) {
    message.error('会话ID丢失');
    return;
  }

  // 确认对话框
  Modal.confirm({
    title: '确认完成对话？',
    content: '完成后将无法继续与该客户通话，请确认已解决问题。',
    okText: '完成',
    cancelText: '取消',
    onOk: async () => {
      try {
        await handoffApi.completeHandoff(handoffRequestId);
        message.success('对话已完成');
        
        // 清理本地状态
        setActiveSessions(prev => {
          const newSessions = new Map(prev);
          newSessions.delete(sessionId);
          return newSessions;
        });
        
        // 回到待处理列表
        setCurrentSessionId(null);
      } catch (e: any) {
        message.error(e?.response?.data?.message || '完成失败');
      }
    }
  });
};
```

### 3.3 客户端（接收完成消息）

**文件**：`frontend/src/pages/ChatPage.tsx`

在 WebSocket 监听器中已有 `HANDOFF_COMPLETED` 处理：

```typescript
client.on('HANDOFF_COMPLETED', (payload) => {
  if (currentSessionId === payload.sessionId) {
    setHandoffStatus(null); // 清理状态
    // payload may include endedBy: 'USER' | 'AGENT'
    if (payload.endedBy === 'USER') {
      insertSystemMessage('您已结束本次人工会话，已切换回 AI 助手。');
    } else {
      insertSystemMessage('客服已结束本次人工会话，已切换回 AI 助手。');
    }
  }
});
```

**工作流程**：
1. 客服点击"完成"
2. 后端发送 `HANDOFF_COMPLETED` 到客户
3. 客户 UI 清理 `handoffStatus` 状态
4. 客户看到系统消息"本次人工服务已结束"
5. 客户可重新转人工或继续使用 AI 助手

---

## 四、完整流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        客服点击"完成对话"                              │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
         ┌───────────────────────────────────┐
         │  前端调用 handoffApi.completeHandoff  │
         │  (handoffRequestId)               │
         └────────────────┬──────────────────┘
                          │
                          ▼
         ┌──────────────────────────────┐
         │ POST /api/handoff/complete   │
         │ {handoffRequestId: xxx}      │
         └────────────────┬─────────────┘
                          │
         ┌────────────────▼─────────────┐
         │  HandoffService.complete()   │
         │  ① 权限校验                   │
         │  ② 状态转移 → COMPLETED      │
         │  ③ 更新会话/工单             │
         │  ④ 释放客服会话数            │
         │  ⑤ 发送 HANDOFF_COMPLETED   │
         └────────────────┬─────────────┘
                          │
         ┌────────────────▼──────────────────────────┐
         │  向客户发送 HANDOFF_COMPLETED 消息         │
         │  (type, sessionId, message)              │
         │  via CustomerWebSocketHandler            │
         └────────────────┬──────────────────────────┘
                          │
    ┌─────────────────────┼─────────────────────┐
    │                     │                     │
    ▼                     ▼                     ▼
客服 UI               客户端 UI              后端数据库
├─关闭会话          ├─清理状态            ├─handoff_request
├─移除从列表        ├─显示系统消息           status=COMPLETED
└─回到待处理        └─可转人工或继续AI     ├─chat_session
                                          chatMode=AI(可选)
                                       └─ticket
                                          status=DONE
```

---

## 五、实现步骤（详细）

### Step 1：后端控制层（新增端点）

**文件**：`src/main/java/.../handoff/controller/HandoffController.java`

```java
@PostMapping("/complete")
@ResponseBody
public ApiResponse<Void> completeHandoff(@RequestBody CompleteHandoffRequest request) {
    Long tenantId = TenantContextHolder.getTenantId();
    Long agentId = getUserIdFromToken(); // 从 JWT 获取
    
    handoffService.complete(tenantId, agentId, request.getHandoffRequestId());
    return ApiResponse.success("对话已完成");
}
```

**DTO**：

```java
@Data
public class CompleteHandoffRequest {
    private Long handoffRequestId;
}
```

### Step 2：前端 API 整合

**文件**：`frontend/src/api/handoff.ts`

```typescript
import { request } from './request';

export const handoffApi = {
  // ... 现有方法
  
  /**
   * 完成转人工对话
   */
  completeHandoff: async (handoffRequestId: number) => {
    return request.post('/api/handoff/complete', {
      handoffRequestId
    });
  }
};
```

### Step 3：客服端会话窗口更新

**文件**：`frontend/src/components/AgentChatWindow.tsx`

需要在组件中：
1. 接收 `handoffRequestId` prop
2. 添加"完成对话"按钮
3. 实现 `handleCompleteHandoff` 处理函数

```tsx
interface AgentChatWindowProps {
  session: AgentSession;
  onSendMessage: (content: string) => void;
  handoffRequestId?: number;  // 新增
  onComplete?: () => void;    // 新增
}

export default function AgentChatWindow({ 
  session, 
  onSendMessage,
  handoffRequestId,
  onComplete
}: AgentChatWindowProps) {
  
  const handleCompleteHandoff = async () => {
    if (!handoffRequestId) {
      message.error('转人工信息丢失');
      return;
    }

    Modal.confirm({
      title: '确认完成对话？',
      content: '完成后将无法继续与该客户通话。',
      okText: '完成',
      cancelText: '取消',
      onOk: async () => {
        try {
          await handoffApi.completeHandoff(handoffRequestId);
          message.success('对话已完成');
          onComplete?.();
        } catch (e: any) {
          message.error(e?.response?.data?.message || '完成失败');
        }
      }
    });
  };

  return (
    <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
      {/* 消息列表 */}
      <div style={{ flex: 1, overflowY: 'auto' }}>
        {/* ... */}
      </div>

      {/* 输入框 */}
      <div style={{ padding: 16, borderTop: '1px solid #f0f0f0' }}>
        <TextArea 
          placeholder="输入消息..."
          onPressEnter={(e) => {
            if (!e.shiftKey) {
              e.preventDefault();
              onSendMessage(inputValue);
            }
          }}
        />
        <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>
          <Button type="primary" onClick={() => onSendMessage(inputValue)}>
            发送
          </Button>
          <Button danger onClick={handleCompleteHandoff}>
            完成对话
          </Button>
        </div>
      </div>
    </div>
  );
}
```

### Step 4：客服工作台集成

**文件**：`frontend/src/pages/agent/AgentWorkspacePage.tsx`

```tsx
<AgentChatWindow
  session={currentChat}
  onSendMessage={(content) => handleSendMessage(currentChat.sessionId, content)}
  handoffRequestId={handoffRequestId}  // 从 URL params 获取或 state 传递
  onComplete={() => {
    // 对话完成后的处理
    setActiveSessions(prev => {
      const newSessions = new Map(prev);
      newSessions.delete(currentChat.sessionId);
      return newSessions;
    });
    setCurrentSessionId(null);
  }}
/>
```

### Step 5：客户端已有处理（确认）

客户端 `ChatPage.tsx` 中已有：

```typescript
client.on('HANDOFF_COMPLETED', (payload) => {
    if (currentSessionId === payload.sessionId) {
        setHandoffStatus(null);
        insertSystemMessage('本次人工服务已结束。');
    }
});
```

✅ 无需修改，自动生效

---

## 六、数据流总结

| 阶段 | 操作 | 状态变化 | 通知方式 |
|------|------|--------|--------|
| **客服完成** | 点击"完成对话"按钮 | - | HTTP POST |
| **后端验证** | 权限校验、状态检查 | - | 异常 → HTTP 400 |
| **数据更新** | 更新 handoff_request、chat_session、ticket | `ACCEPTED`→`COMPLETED` | - |
| **客服通知** | 返回成功响应 | - | HTTP 200 |
| **客户通知** | 发送 `HANDOFF_COMPLETED` | - | WebSocket |
| **客户 UI 更新** | 清理 handoffStatus，显示系统消息 | - | React state 更新 |

---

## 七、错误处理

**可能的错误场景**：

```typescript
// 1. 转人工请求不存在或权限不足
{
  code: 401,
  message: "转人工请求不存在或无权限"
}

// 2. 状态不正确（已完成或已取消）
{
  code: 400,
  message: "当前状态无法完成"
}

// 3. 客服负载异常
{
  code: 500,
  message: "减少客服会话数失败"
}
```

**前端处理建议**：

```typescript
try {
  await handoffApi.completeHandoff(handoffRequestId);
  // 成功处理
} catch (e: any) {
  const errorMsg = e?.response?.data?.message || '操作失败，请重试';
  if (e?.response?.status === 401) {
    message.error('您无权完成此对话');
  } else if (e?.response?.status === 400) {
    message.error('对话状态不允许完成');
  } else {
    message.error(errorMsg);
  }
}
```

---

## 八、测试清单

- [ ] 客服点击"完成对话"，接收确认对话框
- [ ] 点击"完成"后，API 返回 200，显示成功提示
- [ ] 客服 UI 清理该会话，回到待处理列表
- [ ] 客户端接收 `HANDOFF_COMPLETED` 消息
- [ ] 客户 UI 显示"本次人工服务已结束"系统消息
- [ ] 后端数据库：
  - [ ] `handoff_request.status` = `COMPLETED`
  - [ ] `ticket.status` = `DONE`
  - [ ] `agent_status.current_sessions` 递减 1
- [ ] 权限验证：非当前客服的用户无法完成该对话
- [ ] 状态验证：已完成的对话无法再次完成

---

## 九、相关代码文件清单

| 文件 | 说明 | 状态 |
|------|------|------|
| `HandoffService.java` | 后端完成逻辑（已实现） | ✅ |
| `HandoffController.java` | 后端 API 端点 | ⏳ 需新增 |
| `frontend/src/api/handoff.ts` | 前端 API | ⏳ 需新增方法 |
| `AgentChatWindow.tsx` | 客服聊天窗口 | ⏳ 需添加完成按钮 |
| `AgentWorkspacePage.tsx` | 客服工作台 | ⏳ 需集成回调 |
| `ChatPage.tsx` | 客户聊天页面 | ✅ 已有监听 |

---

## 十、快速参考

### 后端端点

```http
POST /api/handoff/complete
Content-Type: application/json

{
  "handoffRequestId": 123
}

Response 200:
{
  "code": "200",
  "message": "对话已完成",
  "data": null
}
```

### WebSocket 消息（客户收到）

```json
{
  "type": "HANDOFF_COMPLETED",
  "payload": {
    "sessionId": 20,
    "message": "本次人工服务已结束，感谢您的咨询。"
  },
  "timestamp": "2026-02-05T16:34:00"
}
```

---

## 总结

完成转人工对话是一个完整的多步流程：

1. ✅ **后端已实现**：`HandoffService.complete()` 包含所有业务逻辑
2. ⏳ **前端需实现**：
   - 新增 API 方法 `handoffApi.completeHandoff()`
   - 在 `AgentChatWindow` 中添加"完成对话"按钮及处理逻辑
   - 在客服工作台集成完成回调
3. ✅ **客户端已就位**：`ChatPage.tsx` 已有 `HANDOFF_COMPLETED` 消息监听器

按照本文档的实现步骤，整个功能可在 **1-2 小时** 内完成。
