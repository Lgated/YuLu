# 转人工功能问题 - 最终解决方案

## 📌 问题总结

### 核心问题
用户转人工后发送消息报错：**"当前会话未接入客服"**

### 根本原因
1. **数据库层面**：`chat_session.agent_id` 字段为 NULL（即使客服已分配）
2. **Redis 层面**：`agent:status:1:3` 数据结构错误（是 STRING 类型，应该是 HASH 类型）

### 影响范围
- 用户无法与客服正常对话
- 客服无法接收用户消息
- 转人工功能完全失效

---

## 🔍 技术分析

### Redis Key 说明

```
agent:status:1:3
             ↓ ↓
             │ └─ agentId (客服用户ID)
             └─── tenantId (租户ID)
```

### 正确的 Redis 数据结构

```
agent:status:1:3 (HASH)
├── status: "ONLINE"              # 客服状态
├── current_sessions: 0           # 当前会话数
├── max_sessions: 5               # 最大并发数
├── heartbeat_time: 1707472800000 # 心跳时间戳
└── last_active_time: "2026-02-09T16:30:00"
```

### 错误的数据结构（当前状态）

```
agent:status:1:3 (STRING)
└── "1707472800000"  # ❌ 只存储了时间戳，无法读取 current_sessions
```

### 代码修复点

**文件**：`HandoffService.java` 的 `asyncAssignAgent()` 方法

**修复前**：
```java
// 只更新 handoff_request 表
request.setAgentId(agentId);
handoffRequestMapper.updateById(request);
```

**修复后**：
```java
// 同时更新 handoff_request 和 chat_session 表
request.setAgentId(agentId);
handoffRequestMapper.updateById(request);

// 【关键修复】同步更新会话的 agentId
ChatSession session = chatSessionMapper.selectById(request.getSessionId());
if (session != null) {
    session.setAgentId(agentId);
    chatSessionMapper.updateById(session);
    log.info("[HandoffService] 已更新会话的客服ID：sessionId={}, agentId={}", 
        session.getId(), agentId);
}
```

---

## ✅ 完整修复步骤

### 步骤 1：重启后端服务（必须！）

```bash
# 停止当前服务
# Ctrl+C 或 kill 进程

# 重新启动
mvn spring-boot:run
```

**为什么必须重启**：代码已经修复，但只有重启后新代码才会生效。

---

### 步骤 2：清理 Redis 数据

#### 方案 A：使用 Debug API（推荐）

**获取 Token**：
1. 登录管理员账号
2. 打开浏览器开发者工具（F12）
3. 查看 localStorage 或 sessionStorage 中的 token

**执行清理**：

```bash
# 替换 YOUR_TOKEN 为实际的 token
TOKEN="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUz..."

# 1. 检查当前 Redis 状态
curl -X GET "http://localhost:8080/api/admin/debug/check-agent-redis/3" \
  -H "Authorization: Bearer ${TOKEN}"

# 2. 强制重置客服状态（删除所有相关 key）
curl -X POST "http://localhost:8080/api/admin/debug/force-reset-agent/3" \
  -H "Authorization: Bearer ${TOKEN}"

# 3. 清空转人工队列
curl -X DELETE "http://localhost:8080/api/admin/debug/clear-queue" \
  -H "Authorization: Bearer ${TOKEN}"
```

#### 方案 B：直接操作 Redis

```bash
# 连接 Redis
redis-cli

# 删除损坏的 key
DEL agent:status:1:3
DEL agent:sessions:1:3
DEL agent:online:1

# 验证删除成功
EXISTS agent:status:1:3
# 应该返回 (integer) 0

exit
```

---

### 步骤 3：客服重新上线

**前端操作**：
1. 客服刷新浏览器页面（F5）
2. 重新登录（如果需要）
3. 点击"上线"按钮

**或者调用 API**：
```bash
# 使用客服的 token
curl -X PUT "http://localhost:8080/api/admin/user/online-status?status=ONLINE" \
  -H "Authorization: Bearer AGENT_TOKEN"
```

**验证上线成功**：
```bash
curl -X GET "http://localhost:8080/api/admin/debug/check-agent-redis/3" \
  -H "Authorization: Bearer ${TOKEN}"

# 期望输出：
# {
#   "statusKeyType": "HASH",  ✅
#   "statusData": {
#     "status": "ONLINE",
#     "current_sessions": 0,
#     ...
#   }
# }
```

---

### 步骤 4：测试转人工流程

1. **用户端**：发起转人工请求
2. **观察后端日志**：

```
[HandoffService] 创建转人工请求成功
[AgentAssigner] 找到可用客服: agentId=3
[HandoffService] 客服分配完成：handoffRequestId=XX, agentId=3, sessionId=XX
[HandoffService] 已更新会话的客服ID：sessionId=XX, agentId=3  ✅ 关键日志
```

3. **验证数据库**：

```sql
SELECT id, agent_id, handoff_request_id 
FROM chat_session 
WHERE id = XX;

-- agent_id 应该不为 NULL
```

4. **用户端发送消息**：
   - 不应该再出现 "当前会话未接入客服" 错误
   - 客服端应该能收到消息

---

## 🛠️ 快速修复工具

### Windows 用户

1. 打开 `docs/快速修复命令-Windows.bat`
2. 修改第 11 行的 `SET TOKEN=YOUR_TOKEN`
3. 双击运行脚本

### Linux/Mac 用户

1. 打开 `docs/快速修复命令-复制粘贴执行.sh`
2. 修改第 13 行的 `TOKEN="YOUR_TOKEN"`
3. 运行：
   ```bash
   chmod +x docs/快速修复命令-复制粘贴执行.sh
   ./docs/快速修复命令-复制粘贴执行.sh
   ```

---

## 📊 验证清单

执行完修复后，逐项检查：

- [ ] 后端服务已重启（查看启动日志）
- [ ] Redis `agent:status:1:3` 数据类型是 HASH
- [ ] 客服状态显示 "ONLINE"
- [ ] 转人工队列已清空
- [ ] 用户发起新的转人工请求
- [ ] 后端日志显示 "已更新会话的客服ID"
- [ ] 数据库 `chat_session.agent_id` 不为 NULL
- [ ] 用户可以正常发送消息
- [ ] 客服可以正常接收消息
- [ ] 客服可以正常结束会话

---

## 🔧 Debug API 列表

所有 Debug API 都在 `DebugController.java` 中：

| API | 方法 | 说明 |
|-----|------|------|
| `/api/admin/debug/check-agent-redis/{agentId}` | GET | 检查 Redis 数据结构 |
| `/api/admin/debug/force-reset-agent/{agentId}` | POST | 强制重置客服状态 |
| `/api/admin/debug/agent-status/{agentId}` | GET | 查看客服状态 |
| `/api/admin/debug/reset-agent-load/{agentId}` | POST | 重置客服负载 |
| `/api/admin/debug/clear-queue` | DELETE | 清空转人工队列 |
| `/api/admin/debug/queue-info` | GET | 查看队列信息 |

---

## 📝 相关文档

1. **完整修复步骤**：`docs/完整修复步骤-立即执行.md`
2. **问题排查清单**：`docs/问题排查清单.md`
3. **数据库验证查询**：`docs/数据库验证查询.sql`
4. **快速修复脚本**：
   - Windows: `docs/快速修复命令-Windows.bat`
   - Linux/Mac: `docs/快速修复命令-复制粘贴执行.sh`

---

## ❓ 常见问题

### Q1: 为什么 Redis 会变成 STRING 类型？

**A**: 可能的原因：
1. 旧代码中有错误的写入逻辑
2. 手动测试时误操作
3. 其他服务或脚本错误地写入了这个 key

**解决方案**：删除后让系统重建（通过客服上线）

---

### Q2: 重启后问题仍然存在怎么办？

**A**: 按顺序检查：
1. 确认代码已更新（查看 `HandoffService.java` 第 265-272 行）
2. 确认 Redis 数据结构正确（使用 check-agent-redis API）
3. 确认客服已上线（使用 agent-status API）
4. 查看后端日志是否有 "已更新会话的客服ID"

---

### Q3: 旧的会话怎么办？

**A**: 旧会话的 `agent_id` 仍然是 NULL，有两种处理方式：

**方式 1**：手动修复数据库
```sql
UPDATE chat_session cs
INNER JOIN handoff_request hr ON cs.handoff_request_id = hr.id
SET cs.agent_id = hr.agent_id
WHERE cs.tenant_id = 1
  AND hr.status = 'ASSIGNED'
  AND cs.agent_id IS NULL;
```

**方式 2**：让用户重新发起转人工请求

---

### Q4: 如何释放客服负载？

**A**: 客服负载存储在 Redis 的 `current_sessions` 字段中：

**方法 1**：客服正常结束会话（会自动减少负载）

**方法 2**：使用 Debug API 重置
```bash
curl -X POST "http://localhost:8080/api/admin/debug/reset-agent-load/3" \
  -H "Authorization: Bearer ${TOKEN}"
```

**方法 3**：客服下线再上线（会重置为 0）

---

## 🎯 核心要点

1. **必须重启后端服务**：代码修复才能生效
2. **必须清理 Redis**：删除损坏的 STRING 类型 key
3. **必须客服重新上线**：触发正确的 HASH 结构创建
4. **验证数据库**：确保 `chat_session.agent_id` 不为 NULL

---

## 📞 技术支持

如果按照以上步骤仍然无法解决，请提供：

1. 后端日志（最近 100 行）
2. Redis 数据结构检查结果
3. 数据库查询结果
4. 前端控制台错误（如果有）

可以运行以下命令收集信息：

```bash
# 1. 后端日志
tail -n 100 logs/application.log > debug-log.txt

# 2. Redis 检查
curl -X GET "http://localhost:8080/api/admin/debug/check-agent-redis/3" \
  -H "Authorization: Bearer ${TOKEN}" > debug-redis.json

# 3. 数据库查询
# 运行 docs/数据库验证查询.sql 中的查询 1 和 2
```

将这些文件提供给技术支持团队。
