# è½¬äººå·¥åŠŸèƒ½è¯¦ç»†å®ç°ä»£ç  - ç¬¬äºŒéƒ¨åˆ† (APIæ¥å£ä¸æµ‹è¯•)

> **åŒ…å«å†…å®¹**ï¼šController å±‚çš„å®Œæ•´ä»£ç ã€è¯¦ç»†çš„ API æ¥å£æµ‹è¯•æŒ‡å—ï¼ˆåŒ…å« `curl` ç¤ºä¾‹ï¼‰ã€‚

---

## ğŸ“‹ ç›®å½•

1. [Controller å±‚ä»£ç ](#controller-å±‚ä»£ç )
   - [CustomerHandoffController](#customerhandoffcontroller)
   - [AgentHandoffController](#agenthandoffcontroller)
2. [API æ¥å£æµ‹è¯•æŒ‡å—](#api-æ¥å£æµ‹è¯•æŒ‡å—)
   - [æµ‹è¯•å‡†å¤‡ï¼šè·å– Token](#æµ‹è¯•å‡†å¤‡è·å–-token)
   - [æ ¸å¿ƒæµ‹è¯•æµç¨‹](#æ ¸å¿ƒæµ‹è¯•æµç¨‹)
   - [è¯¦ç»†æ¥å£æµ‹è¯•ï¼ˆcurl ç¤ºä¾‹ï¼‰](#è¯¦ç»†æ¥å£æµ‹è¯•curl-ç¤ºä¾‹)

---

## 1. Controller å±‚ä»£ç 

### æ­¥éª¤1ï¼šåˆ›å»º Controller æ–‡ä»¶

åœ¨ `src/main/java/com/ityfz/yulu/handoff/controller/` ç›®å½•ä¸‹åˆ›å»ºä»¥ä¸‹ä¸¤ä¸ª Controller æ–‡ä»¶ã€‚

#### CustomerHandoffController

> **ä½œç”¨**ï¼šæä¾›ç»™**å®¢æˆ·**ä½¿ç”¨çš„è½¬äººå·¥ç›¸å…³æ¥å£ã€‚

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/ityfz/yulu/handoff/controller/CustomerHandoffController.java`

```java
package com.ityfz.yulu.handoff.controller;

import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.security.SecurityUtil;
import com.ityfz.yulu.handoff.dto.HandoffStatusResponse;
import com.ityfz.yulu.handoff.dto.HandoffTransferRequest;
import com.ityfz.yulu.handoff.dto.HandoffTransferResponse;
import com.ityfz.yulu.handoff.service.HandoffService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;

@RestController
@RequestMapping("/api/customer/handoff")
@RequiredArgsConstructor
@Validated
@RequireRole("USER") // ä»…å®¢æˆ·å¯è®¿é—®
@Tag(name = "Cç«¯-è½¬äººå·¥ï¼ˆHandoffï¼‰", description = "å®¢æˆ·ç”³è¯·è½¬äººå·¥ã€æŸ¥è¯¢çŠ¶æ€ã€å–æ¶ˆ")
public class CustomerHandoffController {

    private final HandoffService handoffService;

    @PostMapping("/transfer")
    @Operation(summary = "ç”³è¯·è½¬äººå·¥", description = "å®¢æˆ·ä¸ºæŒ‡å®šä¼šè¯ç”³è¯·è½¬äººå·¥æœåŠ¡")
    public ApiResponse<HandoffTransferResponse> transferToAgent(@Valid @RequestBody HandoffTransferRequest request) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long userId = SecurityUtil.currentUserId();
        HandoffTransferResponse response = handoffService.transferToAgent(tenantId, userId, request.getSessionId(), request.getReason());
        return ApiResponse.success("è½¬äººå·¥ç”³è¯·å·²æäº¤", response);
    }

    @GetMapping("/status/{handoffRequestId}")
    @Operation(summary = "æŸ¥è¯¢è½¬äººå·¥çŠ¶æ€", description = "å®¢æˆ·è½®è¯¢æŸ¥è¯¢è½¬äººå·¥è¯·æ±‚çš„å½“å‰çŠ¶æ€")
    public ApiResponse<HandoffStatusResponse> getHandoffStatus(@PathVariable Long handoffRequestId) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long userId = SecurityUtil.currentUserId();
        HandoffStatusResponse response = handoffService.getHandoffStatus(tenantId, userId, handoffRequestId);
        return ApiResponse.success("æŸ¥è¯¢æˆåŠŸ", response);
    }

    @PostMapping("/cancel/{handoffRequestId}")
    @Operation(summary = "å–æ¶ˆè½¬äººå·¥", description = "å®¢æˆ·åœ¨å®¢æœæ¥å…¥å‰å–æ¶ˆè½¬äººå·¥è¯·æ±‚")
    public ApiResponse<Void> cancelHandoff(@PathVariable Long handoffRequestId) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long userId = SecurityUtil.currentUserId();
        handoffService.cancel(tenantId, userId, handoffRequestId);
        return ApiResponse.success("å·²å–æ¶ˆè½¬äººå·¥ç”³è¯·");
    }
}
```

#### AgentHandoffController

> **ä½œç”¨**ï¼šæä¾›ç»™**å®¢æœ**ä½¿ç”¨çš„è½¬äººå·¥ç›¸å…³æ¥å£ã€‚

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/ityfz/yulu/handoff/controller/AgentHandoffController.java`

```java
package com.ityfz.yulu.handoff.controller;

import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.security.SecurityUtil;
import com.ityfz.yulu.handoff.dto.HandoffAcceptRequest;
import com.ityfz.yulu.handoff.dto.HandoffAcceptResponse;
import com.ityfz.yulu.handoff.dto.HandoffRejectRequest;
import com.ityfz.yulu.handoff.dto.HandoffRequestItemDTO;
import com.ityfz.yulu.handoff.service.HandoffService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.util.List;

@RestController
@RequestMapping("/api/agent/handoff")
@RequiredArgsConstructor
@Validated
@RequireRole({"AGENT", "ADMIN"}) // å®¢æœæˆ–ç®¡ç†å‘˜å¯è®¿é—®
@Tag(name = "Bç«¯-è½¬äººå·¥ï¼ˆHandoffï¼‰", description = "å®¢æœè·å–å¾…å¤„ç†è¯·æ±‚ã€æ¥å—ã€æ‹’ç»ã€å®Œæˆ")
public class AgentHandoffController {

    private final HandoffService handoffService;

    @GetMapping("/pending")
    @Operation(summary = "è·å–å¾…å¤„ç†çš„è½¬äººå·¥è¯·æ±‚", description = "è·å–å·²åˆ†é…ç»™å½“å‰å®¢æœä½†å°šæœªæ¥å—çš„è¯·æ±‚åˆ—è¡¨")
    public ApiResponse<List<HandoffRequestItemDTO>> getPendingHandoffRequests() {
        Long tenantId = SecurityUtil.currentTenantId();
        Long agentId = SecurityUtil.currentUserId();
        List<HandoffRequestItemDTO> response = handoffService.getPendingHandoffRequests(tenantId, agentId);
        return ApiResponse.success("æŸ¥è¯¢æˆåŠŸ", response);
    }

    @PostMapping("/accept")
    @Operation(summary = "æ¥å—è½¬äººå·¥è¯·æ±‚", description = "å®¢æœæ¥å—ä¸€ä¸ªè½¬äººå·¥è¯·æ±‚ï¼Œå¹¶å‡†å¤‡å¼€å§‹å¯¹è¯")
    public ApiResponse<HandoffAcceptResponse> acceptHandoff(@Valid @RequestBody HandoffAcceptRequest request) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long agentId = SecurityUtil.currentUserId();
        HandoffAcceptResponse response = handoffService.acceptHandoff(tenantId, agentId, request.getHandoffRequestId());
        return ApiResponse.success("å·²æ¥å—è½¬äººå·¥è¯·æ±‚", response);
    }

    @PostMapping("/reject")
    @Operation(summary = "æ‹’ç»è½¬äººå·¥è¯·æ±‚", description = "å®¢æœæ‹’ç»ä¸€ä¸ªè½¬äººå·¥è¯·æ±‚ï¼Œè¯·æ±‚å°†è¢«é‡æ–°åˆ†é…æˆ–è¶…æ—¶")
    public ApiResponse<Void> rejectHandoff(@Valid @RequestBody HandoffRejectRequest request) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long agentId = SecurityUtil.currentUserId();
        handoffService.decline(tenantId, agentId, request.getHandoffRequestId(), request.getReason());
        return ApiResponse.success("å·²æ‹’ç»è½¬äººå·¥è¯·æ±‚");
    }

    @PostMapping("/complete/{handoffRequestId}")
    @Operation(summary = "å®Œæˆè½¬äººå·¥å¯¹è¯", description = "å®¢æœæ ‡è®°ä¸€ä¸ªè½¬äººå·¥ä¼šè¯å·²å®Œæˆ")
    public ApiResponse<Void> completeHandoff(@PathVariable Long handoffRequestId) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long agentId = SecurityUtil.currentUserId();
        handoffService.complete(tenantId, agentId, handoffRequestId);
        return ApiResponse.success("å¯¹è¯å·²å®Œæˆ");
    }
}
```

---

## 2. API æ¥å£æµ‹è¯•æŒ‡å—

### æµ‹è¯•å‡†å¤‡ï¼šè·å– Token

åœ¨æµ‹è¯•è½¬äººå·¥æ¥å£å‰ï¼Œä½ éœ€è¦ä¸º**å®¢æˆ·**å’Œ**å®¢æœ**åˆ†åˆ«è·å–ä¸€ä¸ª JWT Tokenã€‚

#### 2.1 è·å–å®¢æˆ· Token

- **æ¥å£**: `POST /api/customer/auth/login`
- **å‚æ•°**: `{"tenantIdentifier": "ä½ çš„ç§Ÿæˆ·æ ‡è¯†", "username": "å®¢æˆ·ç”¨æˆ·å", "password": "å®¢æˆ·å¯†ç "}`

#### 2.2 è·å–å®¢æœ Token

- **æ¥å£**: `POST /api/admin/auth/login`
- **å‚æ•°**: `{"tenantCode": "ä½ çš„ç§Ÿæˆ·ç¼–ç ", "username": "å®¢æœç”¨æˆ·å", "password": "å®¢æœå¯†ç "}`

> **æç¤º**: è¯·å°†ä¸‹æ–¹ `curl` å‘½ä»¤ä¸­çš„ `YOUR_CUSTOMER_TOKEN` å’Œ `YOUR_AGENT_TOKEN` æ›¿æ¢ä¸ºå®é™…è·å–åˆ°çš„ Tokenã€‚

### æ ¸å¿ƒæµ‹è¯•æµç¨‹

1.  **å®¢æˆ·ç”³è¯·è½¬äººå·¥**ï¼šå®¢æˆ·ç™»å½•åï¼Œè°ƒç”¨ `POST /api/customer/handoff/transfer`ã€‚
2.  **ç³»ç»Ÿåˆ†é…**ï¼šåå°çš„ `HandoffDispatcherJob` ä¼šè‡ªåŠ¨è¿è¡Œï¼Œå°†è¯·æ±‚åˆ†é…ç»™ä¸€ä¸ªåœ¨çº¿çš„ã€è´Ÿè½½æœ€ä½çš„å®¢æœã€‚
3.  **å®¢æœæŸ¥çœ‹è¯·æ±‚**ï¼šå®¢æœç™»å½•åï¼Œè°ƒç”¨ `GET /api/agent/handoff/pending` æŸ¥çœ‹åˆ†é…ç»™è‡ªå·±çš„è¯·æ±‚ã€‚
4.  **å®¢æœæ¥å—è¯·æ±‚**ï¼šå®¢æœè°ƒç”¨ `POST /api/agent/handoff/accept` æ¥å—è¯·æ±‚ã€‚
5.  **å®¢æˆ·æŸ¥è¯¢çŠ¶æ€**ï¼šå®¢æˆ·å¯ä»¥è½®è¯¢ `GET /api/customer/handoff/status/{id}` æŸ¥çœ‹çŠ¶æ€å˜åŒ–ï¼ˆä» `PENDING` -> `ASSIGNED` -> `ACCEPTED`ï¼‰ã€‚
6.  **å¼€å§‹å¯¹è¯**ï¼šåŒæ–¹é€šè¿‡ WebSocket è¿›è¡Œå®æ—¶é€šä¿¡ï¼ˆè¿™éƒ¨åˆ†å°†åœ¨ç¬¬ä¸‰éƒ¨åˆ†å®ç°ï¼‰ã€‚

### è¯¦ç»†æ¥å£æµ‹è¯•ï¼ˆ`curl` ç¤ºä¾‹ï¼‰

#### åœºæ™¯1ï¼šå®¢æˆ·ç”³è¯·è½¬äººå·¥

- **å‰ç½®æ¡ä»¶**: å®¢æˆ·å·²ç™»å½•ï¼Œå¹¶æœ‰ä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„ä¼šè¯ï¼ˆå‡è®¾ `sessionId` ä¸º `1`ï¼‰ã€‚
- **å‘½ä»¤**:

```bash
curl -X POST 'http://localhost:8080/api/customer/handoff/transfer' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer YOUR_CUSTOMER_TOKEN' \
-d '{
  "sessionId": 1,
  "reason": "AIæ— æ³•è§£å†³æˆ‘çš„é—®é¢˜ï¼Œæˆ‘éœ€è¦äººå·¥å¸®åŠ©ã€‚"
}'
```

- **é¢„æœŸæˆåŠŸå“åº”**:

```json
{
    "success": true,
    "code": "200",
    "message": "è½¬äººå·¥ç”³è¯·å·²æäº¤",
    "data": {
        "handoffRequestId": 1, // æ–°åˆ›å»ºçš„è½¬äººå·¥è¯·æ±‚ID
        "ticketId": 1,       // è‡ªåŠ¨å…³è”çš„å·¥å•ID
        "queuePosition": 1,    // å½“å‰æ’é˜Ÿä½ç½®
        "estimatedWaitTime": 30  // é¢„è®¡ç­‰å¾…æ—¶é—´
    }
}
```

#### åœºæ™¯2ï¼šå®¢æˆ·æŸ¥è¯¢è½¬äººå·¥çŠ¶æ€

- **å‰ç½®æ¡ä»¶**: å·²æˆåŠŸç”³è¯·è½¬äººå·¥ï¼Œè·å¾— `handoffRequestId` ä¸º `1`ã€‚
- **å‘½ä»¤**:

```bash
curl -X GET 'http://localhost:8080/api/customer/handoff/status/1' \
-H 'Authorization: Bearer YOUR_CUSTOMER_TOKEN'
```

- **é¢„æœŸæˆåŠŸå“åº” (å®¢æœæ¥å—å‰)**:

```json
{
    "success": true,
    "code": "200",
    "message": "æŸ¥è¯¢æˆåŠŸ",
    "data": {
        "handoffRequestId": 1,
        "status": "ASSIGNED", // çŠ¶æ€å¯èƒ½ä¸º PENDING æˆ– ASSIGNED
        "queuePosition": null, // å·²åˆ†é…åå¯èƒ½ä¸ºnull
        "estimatedWaitTime": 0,
        "assignedAgentId": 2,  // å·²åˆ†é…çš„å®¢æœID
        "assignedAgentName": "å®¢æœ#2"
    }
}
```

#### åœºæ™¯3ï¼šå®¢æœè·å–å¾…å¤„ç†è¯·æ±‚

- **å‰ç½®æ¡ä»¶**: å®¢æœå·²ç™»å½•ï¼Œä¸”ç³»ç»Ÿå·²å°†è¯·æ±‚åˆ†é…ç»™è¯¥å®¢æœã€‚
- **å‘½ä»¤**:

```bash
curl -X GET 'http://localhost:8080/api/agent/handoff/pending' \
-H 'Authorization: Bearer YOUR_AGENT_TOKEN'
```

- **é¢„æœŸæˆåŠŸå“åº”**:

```json
{
    "success": true,
    "code": "200",
    "message": "æŸ¥è¯¢æˆåŠŸ",
    "data": [
        {
            "handoffRequestId": 1,
            "sessionId": 1,
            "userId": 101,
            "userName": "å®¢æˆ·#101",
            "ticketId": 1,
            "ticketTitle": "è½¬äººå·¥-ä¼šè¯#1",
            "priority": "MEDIUM",
            "reason": "AIæ— æ³•è§£å†³æˆ‘çš„é—®é¢˜ï¼Œæˆ‘éœ€è¦äººå·¥å¸®åŠ©ã€‚",
            "queuePosition": null,
            "createdAt": "2026-02-03T10:00:00"
        }
    ]
}
```

#### åœºæ™¯4ï¼šå®¢æœæ¥å—è½¬äººå·¥è¯·æ±‚

- **å‰ç½®æ¡ä»¶**: å®¢æœå·²è·å–åˆ°å¾…å¤„ç†çš„ `handoffRequestId` ä¸º `1`ã€‚
- **å‘½ä»¤**:

```bash
curl -X POST 'http://localhost:8080/api/agent/handoff/accept' \
-H 'Content-Type: application/json' \
-H 'Authorization: Bearer YOUR_AGENT_TOKEN' \
-d '{
  "handoffRequestId": 1
}'
```

- **é¢„æœŸæˆåŠŸå“åº”**:

```json
{
    "success": true,
    "code": "200",
    "message": "å·²æ¥å—è½¬äººå·¥è¯·æ±‚",
    "data": {
        "handoffRequestId": 1,
        "sessionId": 1,
        "userId": 101,
        "ticketId": 1
    }
}
```

> **éªŒè¯**: æ­¤æ—¶å®¢æˆ·å†æ¬¡è°ƒç”¨â€œæŸ¥è¯¢çŠ¶æ€â€æ¥å£ï¼Œ`status` åº”å˜ä¸º `ACCEPTED`ã€‚

#### åœºæ™¯5ï¼šå®¢æœå®Œæˆå¯¹è¯

- **å‰ç½®æ¡ä»¶**: å¯¹è¯å·²è¿›è¡Œï¼Œå®¢æœå‡†å¤‡ç»“æŸä¼šè¯ã€‚
- **å‘½ä»¤**:

```bash
curl -X POST 'http://localhost:8080/api/agent/handoff/complete/1' \
-H 'Authorization: Bearer YOUR_AGENT_TOKEN'
```

- **é¢„æœŸæˆåŠŸå“åº”**:

```json
{
    "success": true,
    "code": "200",
    "message": "å¯¹è¯å·²å®Œæˆ",
    "data": null
}
```

---

## ğŸ“Œ ä¸‹ä¸€æ­¥

å®Œæˆä»¥ä¸Š Controller çš„ç¼–ç å’Œæ¥å£æµ‹è¯•åï¼Œè½¬äººå·¥åŠŸèƒ½çš„åç«¯æ ¸å¿ƒé“¾è·¯å°±å·²æ‰“é€šã€‚ä¸‹ä¸€æ­¥æ˜¯å®ç°å‰ç«¯çš„ WebSocket å¯¹æ¥å’Œ UI å±•ç¤ºï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬ä¸‰éƒ¨åˆ†è¯¦ç»†ä»‹ç»ã€‚



