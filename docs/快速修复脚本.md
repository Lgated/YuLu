# 转人工负载问题 - 快速修复脚本

## 问题：客服负载已满，无法接入新的转人工请求

## 立即执行（5分钟内解决）

### 方法1：使用 Redis 客户端工具（推荐）

1. **下载并安装 Another Redis Desktop Manager**
   - 下载地址：https://github.com/qishibo/AnotherRedisDesktopManager/releases
   - 选择 Windows 版本下载

2. **连接到 Redis**
   - Host: localhost
   - Port: 6379
   - Name: 本地Redis

3. **执行清理命令**
   ```redis
   # 删除客服状态（客服下次心跳会自动重建）
   DEL agent:status:1:3
   
   # 可选：清空排队队列
   DEL handoff:queue:1
   ```

4. **刷新客服端页面**
   - 客服重新登录
   - 负载会重置为 0

### 方法2：使用 Windows PowerShell（如果有 redis-cli）

如果你安装了 Redis 并配置了环境变量：

```powershell
# 连接到 Redis
redis-cli

# 删除客服状态
DEL agent:status:1:3

# 查看是否删除成功
EXISTS agent:status:1:3
# 应该返回 0

# 退出
exit
```

### 方法3：临时 Java 代码修复（最快）

在你的项目中创建一个临时的 REST 接口：

#### 3.1 创建 DebugController.java

```java
package com.ityfz.yulu.admin.controller;

import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.security.SecurityUtil;
import com.ityfz.yulu.user.service.AgentStatusService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/admin/debug")
@RequireRole("ADMIN")
@Tag(name = "调试接口", description = "仅用于开发调试")
@RequiredArgsConstructor
public class DebugController {
    
    private final AgentStatusService agentStatusService;
    private final RedisTemplate<String, Object> redisTemplate;
    
    @PostMapping("/reset-agent-load/{agentId}")
    @Operation(summary = "重置客服负载", description = "将指定客服的当前会话数重置为0")
    public ApiResponse<String> resetAgentLoad(@PathVariable Long agentId) {
        Long tenantId = SecurityUtil.currentTenantId();
        
        // 构建 Redis key
        String key = "agent:status:" + tenantId + ":" + agentId;
        
        // 删除 Redis 中的状态
        Boolean deleted = redisTemplate.delete(key);
        
        if (Boolean.TRUE.equals(deleted)) {
            return ApiResponse.success("客服负载已重置，客服下次心跳时会自动重建状态");
        } else {
            return ApiResponse.success("客服状态不存在或已删除");
        }
    }
    
    @GetMapping("/agent-status/{agentId}")
    @Operation(summary = "查看客服状态", description = "查看指定客服的当前状态")
    public ApiResponse<Object> getAgentStatus(@PathVariable Long agentId) {
        Long tenantId = SecurityUtil.currentTenantId();
        
        // 构建 Redis key
        String key = "agent:status:" + tenantId + ":" + agentId;
        
        // 获取状态
        Object status = redisTemplate.opsForValue().get(key);
        
        if (status != null) {
            return ApiResponse.success("查询成功", status);
        } else {
            return ApiResponse.success("客服状态不存在");
        }
    }
    
    @DeleteMapping("/clear-queue")
    @Operation(summary = "清空排队队列", description = "清空指定租户的转人工排队队列")
    public ApiResponse<String> clearQueue() {
        Long tenantId = SecurityUtil.currentTenantId();
        
        // 构建 Redis key
        String key = "handoff:queue:" + tenantId;
        
        // 删除队列
        Boolean deleted = redisTemplate.delete(key);
        
        if (Boolean.TRUE.equals(deleted)) {
            return ApiResponse.success("排队队列已清空");
        } else {
            return ApiResponse.success("排队队列不存在或已清空");
        }
    }
}
```

#### 3.2 重启后端服务

#### 3.3 使用 Postman 或浏览器调用接口

**重置客服负载：**
```
POST http://localhost:8080/api/admin/debug/reset-agent-load/3
Headers:
  Authorization: Bearer <你的管理员token>
```

**查看客服状态：**
```
GET http://localhost:8080/api/admin/debug/agent-status/3
Headers:
  Authorization: Bearer <你的管理员token>
```

**清空排队队列：**
```
DELETE http://localhost:8080/api/admin/debug/clear-queue
Headers:
  Authorization: Bearer <你的管理员token>
```

## 验证修复是否成功

### 1. 检查客服状态

使用上面的接口查看客服状态：
```
GET http://localhost:8080/api/admin/debug/agent-status/3
```

应该返回：
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "status": "ONLINE",
    "current_sessions": 0,
    "max_sessions": 5,
    "last_heartbeat": "2026-02-09T14:00:00"
  }
}
```

或者返回"客服状态不存在"（说明已删除，客服下次心跳会重建）。

### 2. 测试转人工流程

1. **用户端**：发起转人工请求
2. **后端日志**：应该看到分配成功的日志
   ```
   [AgentAssigner] 分配客服成功：handoffRequestId=xxx, agentId=3, score=xxx
   [HandoffService] 已更新会话的客服ID：sessionId=xxx, agentId=3
   [HandoffService] 转人工请求通知已发送：agentId=3, handoffRequestId=xxx
   ```

3. **客服端**：应该收到转人工请求通知

4. **客服接受**：点击"接受"按钮

5. **正常通信**：双方能正常收发消息

## 如果还是不行

### 检查1：客服是否真的在线？

```
GET http://localhost:8080/api/admin/debug/agent-status/3
```

如果返回"客服状态不存在"，说明客服不在线。

**解决方法**：
1. 客服端刷新页面
2. 客服重新登录
3. 检查客服端 WebSocket 连接是否建立

### 检查2：是否有其他客服？

如果有多个客服，可能分配给了其他客服。

**解决方法**：
1. 查看后端日志，确认分配给了哪个客服
2. 使用对应的客服账号登录

### 检查3：数据库中是否有未完成的转人工请求？

```sql
SELECT * FROM handoff_request 
WHERE tenant_id = 1 
  AND status NOT IN ('COMPLETED', 'CLOSED', 'CANCELLED')
ORDER BY create_time DESC;
```

如果有很多旧的请求，可以手动清理：

```sql
-- 将旧的请求标记为已取消
UPDATE handoff_request 
SET status = 'CANCELLED', 
    closed_at = NOW()
WHERE tenant_id = 1 
  AND status = 'PENDING'
  AND create_time < DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

## 预防措施

### 1. 定期清理旧数据

每天定时清理超过24小时的未完成请求：

```sql
UPDATE handoff_request 
SET status = 'EXPIRED', 
    closed_at = NOW()
WHERE status IN ('PENDING', 'ASSIGNED')
  AND create_time < DATE_SUB(NOW(), INTERVAL 24 HOUR);
```

### 2. 监控客服负载

定期检查客服负载是否正常：

```redis
# 查看所有客服状态
KEYS agent:status:*

# 逐个查看
GET agent:status:1:3
```

### 3. 添加告警

当客服负载达到上限时，发送告警通知管理员。

## 总结

最快的解决方法：

1. **创建 DebugController**（5分钟）
2. **重启后端服务**（1分钟）
3. **调用重置接口**（1分钟）
4. **刷新客服端页面**（1分钟）
5. **测试转人工功能**（2分钟）

总共约 10 分钟即可解决问题。

如果遇到任何问题，请查看后端日志，或者联系技术支持。
