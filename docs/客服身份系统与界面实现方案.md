# å®¢æœèº«ä»½ç³»ç»Ÿä¸ç•Œé¢å®ç°æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¶é—´**: 2026-01-21  
> **ç›®æ ‡**: å®Œå–„ç”¨æˆ·èº«ä»½ç³»ç»Ÿï¼ˆç®¡ç†å‘˜/å®¢æœ/ç”¨æˆ·ï¼‰ï¼Œå®ç°å®¢æœä¸“ç”¨ç•Œé¢å’ŒåŠŸèƒ½

---

## ğŸ“‹ ä¸€ã€éœ€æ±‚åˆ†æ

### 1.1 å½“å‰çŠ¶æ€
- âœ… å·²æœ‰è§’è‰²æšä¸¾ï¼š`ADMIN`ã€`AGENT`ã€`USER`
- âœ… ç”¨æˆ·è¡¨æœ‰ `role` å­—æ®µ
- âœ… å·¥å•è¡¨æœ‰ `assignee` å­—æ®µï¼ˆåˆ†é…ç»™è°ï¼‰
- âœ… ç®¡ç†å‘˜ç•Œé¢å·²å®ç°
- âŒ å®¢æœç•Œé¢æœªå®ç°
- âŒ ç™»å½•/æ³¨å†Œæ—¶æ²¡æœ‰è§’è‰²é€‰æ‹©
- âŒ å·¥å•æŸ¥è¯¢æ²¡æœ‰æŒ‰ `assignee` è¿‡æ»¤
- âŒ ç®¡ç†å‘˜æ´¾å•åŠŸèƒ½éœ€è¦å®Œå–„

### 1.2 ç›®æ ‡åŠŸèƒ½
1. **ç™»å½•/æ³¨å†Œæ—¶é€‰æ‹©èº«ä»½**ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰
2. **å®¢æœä¸“ç”¨ç•Œé¢**ï¼ˆä¸åŒäºç®¡ç†å‘˜ï¼‰
3. **å®¢æœå·¥å•ç³»ç»Ÿ**ï¼ˆåªèƒ½çœ‹åˆ°åˆ†é…ç»™è‡ªå·±çš„å·¥å•ï¼‰
4. **ç®¡ç†å‘˜æ´¾å•åŠŸèƒ½**ï¼ˆå®Œå–„æ´¾å•æ¥å£å’Œå‰ç«¯ï¼‰
5. **å®¢æœåœ¨çº¿çŠ¶æ€ç®¡ç†**ï¼ˆä¸ºåç»­è½¬äººå·¥åŠŸèƒ½åšå‡†å¤‡ï¼‰
6. **å®¢æœå…¶ä»–åŠŸèƒ½Tab**ï¼ˆé€šçŸ¥ä¸­å¿ƒã€æˆ‘çš„å·¥ä½œå°ç­‰ï¼‰

---

## ğŸ¯ äºŒã€åŠŸèƒ½è®¾è®¡

### 2.1 å®¢æœç•Œé¢åŠŸèƒ½æ¨¡å—

| åŠŸèƒ½æ¨¡å— | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|--------|
| **æˆ‘çš„å·¥å•** | åªèƒ½çœ‹åˆ°åˆ†é…ç»™è‡ªå·±çš„å·¥å• | P0 |
| **å¾…æ¥å…¥ä¼šè¯** | è½¬äººå·¥åçš„å¾…æ¥å…¥ä¼šè¯åˆ—è¡¨ | P0 |
| **é€šçŸ¥ä¸­å¿ƒ** | æ¥æ”¶æ´¾å•é€šçŸ¥ç­‰ | P0 |
| **æˆ‘çš„å·¥ä½œå°** | å½“å‰å¤„ç†çš„ä¼šè¯å’Œå·¥å• | P1 |
| **çŸ¥è¯†åº“æŸ¥è¯¢** | å¿«é€ŸæŸ¥è¯¢çŸ¥è¯†åº“ï¼ˆåªè¯»ï¼‰ | P1 |
| **ä¸ªäººè®¾ç½®** | åœ¨çº¿çŠ¶æ€ã€ä¸ªäººä¿¡æ¯ | P1 |

### 2.2 ç®¡ç†å‘˜ç•Œé¢å¢å¼º

| åŠŸèƒ½ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|------|------|--------|
| **å·¥å•æ´¾å•** | åœ¨å·¥å•åˆ—è¡¨ä¸­å®ç°æ´¾å•åŠŸèƒ½ | P0 |
| **å®¢æœç®¡ç†** | æŸ¥çœ‹å®¢æœåˆ—è¡¨ï¼Œç”¨äºæ´¾å• | P0 |
| **å·¥å•ç»Ÿè®¡** | æŒ‰å®¢æœç»Ÿè®¡å·¥å•å¤„ç†æƒ…å†µ | P1 |

---

## ğŸ—ï¸ ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 å®¢æœé…ç½®ä¸çŠ¶æ€å­˜å‚¨ï¼ˆæ›¿ä»£â€œæ‰©å±• user è¡¨â€æ–¹æ¡ˆï¼‰

ä½ å½“å‰çš„å®ç°æ€è·¯æ˜¯æ­£ç¡®çš„ï¼š**ä¸è¦æŠŠé«˜é¢‘å˜åŒ–çš„åœ¨çº¿çŠ¶æ€/ä¼šè¯æ•°å¡è¿› `user` è¡¨**ã€‚ä¼ä¸šçº§æ›´å¸¸è§çš„åšæ³•æ˜¯æŠŠæ•°æ®æ‹†æˆä¸¤ç±»ï¼š

- **å®¢æœâ€œé…ç½®â€ç±»ä¿¡æ¯ï¼ˆä½é¢‘æ›´æ–°ï¼‰**ï¼šè½åº“ï¼ˆå•ç‹¬è¡¨ï¼Œä¾‹å¦‚ `agent_config`ï¼‰
- **å®¢æœâ€œè¿è¡Œæ—¶çŠ¶æ€â€ï¼ˆé«˜é¢‘æ›´æ–°ï¼‰**ï¼šæ”¾ç¼“å­˜/çŠ¶æ€è¡¨ï¼ˆä¾‹å¦‚ `agent_status` è¡¨ï¼Œæˆ– Redis ä¸ºä¸»ï¼Œå¿…è¦æ—¶å¼‚æ­¥è½åº“ï¼‰

#### 3.1.1 å®¢æœé…ç½®è¡¨ï¼ˆæ¨èï¼š`agent_config`ï¼‰

```sql
CREATE TABLE IF NOT EXISTS `agent_config` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `tenant_id` BIGINT NOT NULL,
  `user_id` BIGINT NOT NULL COMMENT 'å®¢æœç”¨æˆ·IDï¼ˆrole=AGENTï¼‰',
  `max_concurrent_sessions` INT NOT NULL DEFAULT 5 COMMENT 'æœ€å¤§å¹¶å‘ä¼šè¯æ•°ï¼ˆä½é¢‘é…ç½®ï¼‰',
  `skill_tags` VARCHAR(500) DEFAULT NULL COMMENT 'æŠ€èƒ½æ ‡ç­¾ï¼Œé€—å·åˆ†éš”ï¼ˆå¯é€‰ï¼‰',
  `auto_accept` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦è‡ªåŠ¨æ¥å…¥ï¼ˆå¯é€‰ï¼‰',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å®¢æœé…ç½®è¡¨';
```

#### 3.1.2 å®¢æœçŠ¶æ€ï¼ˆä½ ç°åœ¨çš„â€œå®¢æœçŠ¶æ€è¡¨/ç¼“å­˜â€æ–¹æ¡ˆï¼‰

è¿è¡Œæ—¶å­—æ®µç¤ºä¾‹ï¼ˆé«˜é¢‘ï¼‰ï¼š`online_status`ã€`heartbeat_time`ã€`current_sessions`ã€`last_active_time`ã€‚

ä¸¤ç§è½åœ°æ–¹å¼äºŒé€‰ä¸€ï¼ˆæŒ‰ä½ å½“å‰é¡¹ç›®æ¼”è¿›é˜¶æ®µé€‰ï¼‰ï¼š

- **æ–¹æ¡ˆAï¼ˆæ¨èï¼‰**ï¼šRedis ä¸ºä¸»ï¼ˆKey é‡Œå¸¦ `tenantId:userId`ï¼‰ï¼ŒTTL + å¿ƒè·³åˆ·æ–°ï¼›å¿…è¦æ—¶é€šè¿‡å®šæ—¶ä»»åŠ¡æŠŠåœ¨çº¿ç»Ÿè®¡/å†å²å¿«ç…§è½åº“
- **æ–¹æ¡ˆB**ï¼šè½åº“ä¸€å¼  `agent_status` è¡¨ï¼ˆé…åˆ Redis åšå†™å…¥å‰Šå³°/ç¼“å­˜ï¼‰ï¼Œç”¨äºå®¡è®¡ä¸å†å²åˆ†æ

å¦‚æœä½ å½“å‰å·²ç»åšäº†**å®¢æœçŠ¶æ€è¡¨**ï¼Œå»ºè®®å­—æ®µè®¾è®¡å¦‚ä¸‹ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```sql
CREATE TABLE IF NOT EXISTS `agent_status` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `tenant_id` BIGINT NOT NULL,
  `user_id` BIGINT NOT NULL COMMENT 'å®¢æœç”¨æˆ·IDï¼ˆrole=AGENTï¼‰',
  `online_status` VARCHAR(20) NOT NULL DEFAULT 'OFFLINE' COMMENT 'ONLINE/OFFLINE/AWAY',
  `current_sessions` INT NOT NULL DEFAULT 0 COMMENT 'å½“å‰å¤„ç†ä¼šè¯æ•°ï¼ˆé«˜é¢‘ï¼Œå»ºè®®ç¼“å­˜ä¸ºä¸»ï¼‰',
  `last_heartbeat_at` DATETIME DEFAULT NULL COMMENT 'æœ€åå¿ƒè·³æ—¶é—´',
  `last_active_at` DATETIME DEFAULT NULL COMMENT 'æœ€åæ´»è·ƒæ—¶é—´',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_tenant_user` (`tenant_id`, `user_id`),
  KEY `idx_tenant_status` (`tenant_id`, `online_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å®¢æœè¿è¡Œæ—¶çŠ¶æ€è¡¨ï¼ˆå¯é€‰ï¼Œå»ºè®®é…åˆRedisï¼‰';
```

### 3.2 è½¬äººå·¥è®°å½•è¡¨ï¼ˆä¸ºåç»­è½¬äººå·¥åŠŸèƒ½å‡†å¤‡ï¼‰

```sql
CREATE TABLE IF NOT EXISTS `transfer_record` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `tenant_id` BIGINT NOT NULL,
  `session_id` BIGINT NOT NULL,
  `user_id` BIGINT NOT NULL COMMENT 'å®¢æˆ·ID',
  `agent_id` BIGINT COMMENT 'æ¥å…¥çš„å®¢æœID',
  `transfer_reason` VARCHAR(200) COMMENT 'è½¬äººå·¥åŸå› ',
  `status` VARCHAR(20) DEFAULT 'PENDING' COMMENT 'PENDING-å¾…æ¥å…¥ï¼ŒACCEPTED-å·²æ¥å…¥ï¼ŒCLOSED-å·²å…³é—­',
  `create_time` DATETIME,
  `accept_time` DATETIME,
  KEY `idx_session` (`session_id`),
  KEY `idx_agent_status` (`agent_id`, `status`),
  KEY `idx_tenant_status` (`tenant_id`, `status`)
);
```

---

## ğŸ’» å››ã€åç«¯å®ç°æ–¹æ¡ˆ

### 4.1 ç™»å½•/æ³¨å†Œæ¥å£ä¿®æ”¹

#### 4.1.1 ç®¡ç†å‘˜ç™»å½•æ¥å£ä¿®æ”¹

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/controller/AdminAuthController.java`

**ä¿®æ”¹ç‚¹**: ç™»å½•æ¥å£éœ€è¦æ”¯æŒè§’è‰²é€‰æ‹©

**å½“å‰é€»è¾‘**ï¼ˆéœ€è¦ç¡®è®¤ï¼‰:
- ç®¡ç†å‘˜ç™»å½•æ—¶ï¼Œåç«¯æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ï¼Œè¿”å›ç”¨æˆ·çš„ `role`
- å¦‚æœç”¨æˆ·æ˜¯ `ADMIN`ï¼Œè¿”å› `ADMIN` è§’è‰²
- å¦‚æœç”¨æˆ·æ˜¯ `AGENT`ï¼Œè¿”å› `AGENT` è§’è‰²

**å»ºè®®**:
- ä¿æŒåç«¯é€»è¾‘ä¸å˜ï¼Œç™»å½•æ—¶æ ¹æ®ç”¨æˆ·è¡¨ä¸­çš„ `role` å­—æ®µè¿”å›
- å‰ç«¯ç™»å½•æ—¶ï¼Œç”¨æˆ·é€‰æ‹©"ç®¡ç†å‘˜"æˆ–"å®¢æœ"ï¼Œä½†å®é™…è§’è‰²ç”±åç«¯æ•°æ®åº“å†³å®š
- æˆ–è€…ï¼šå‰ç«¯é€‰æ‹©è§’è‰²åï¼Œåç«¯éªŒè¯è¯¥ç”¨æˆ·æ˜¯å¦å…·æœ‰è¯¥è§’è‰²

**å®ç°æ–¹æ¡ˆAï¼ˆæ¨èï¼‰**: å‰ç«¯é€‰æ‹©è§’è‰²ï¼Œåç«¯éªŒè¯
```java
@PostMapping("/login")
public ApiResponse<LoginResponse> login(@RequestBody LoginRequest request) {
    // request ä¸­åŒ…å« role å­—æ®µï¼ˆADMIN æˆ– AGENTï¼‰
    String requestedRole = request.getRole();
    
    // éªŒè¯ç”¨æˆ·
    User user = userService.findByTenantCodeAndUsername(
        request.getTenantCode(), request.getUsername());
    
    // éªŒè¯å¯†ç 
    if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
        throw new BizException(ErrorCodes.UNAUTHORIZED, "å¯†ç é”™è¯¯");
    }
    
    // éªŒè¯è§’è‰²åŒ¹é…
    if (!requestedRole.equals(user.getRole())) {
        throw new BizException(ErrorCodes.FORBIDDEN, 
            "è¯¥è´¦å·ä¸æ˜¯" + (requestedRole.equals("ADMIN") ? "ç®¡ç†å‘˜" : "å®¢æœ"));
    }
    
    // ç”Ÿæˆtoken
    String token = jwtUtil.generateToken(user.getId(), user.getTenantId(), user.getRole());
    
    LoginResponse response = new LoginResponse();
    response.setToken(token);
    response.setRole(user.getRole());
    response.setUsername(user.getUsername());
    
    return ApiResponse.success("ç™»å½•æˆåŠŸ", response);
}
```

**å®ç°æ–¹æ¡ˆBï¼ˆç®€åŒ–ï¼‰**: åç«¯æ ¹æ®ç”¨æˆ·è¡¨è¿”å›è§’è‰²ï¼Œå‰ç«¯é€‰æ‹©ä»…ç”¨äºUIæç¤º
- å‰ç«¯é€‰æ‹©è§’è‰²ä»…ç”¨äºæ˜¾ç¤ºä¸åŒçš„è¡¨å•æç¤º
- å®é™…ç™»å½•æ—¶ï¼Œåç«¯è¿”å›ç”¨æˆ·çš„å®é™…è§’è‰²
- å¦‚æœè§’è‰²ä¸åŒ¹é…ï¼Œå‰ç«¯æç¤ºé”™è¯¯

**æ¨èä½¿ç”¨æ–¹æ¡ˆB**ï¼Œå› ä¸ºï¼š
1. æ›´ç®€å•ï¼Œä¸éœ€è¦ä¿®æ”¹åç«¯éªŒè¯é€»è¾‘
2. è§’è‰²ç”±æ•°æ®åº“å†³å®šï¼Œæ›´å®‰å…¨
3. å‰ç«¯é€‰æ‹©ä»…ç”¨äºUIåŒºåˆ†

#### 4.1.2 ç®¡ç†å‘˜æ³¨å†Œæ¥å£è¯´æ˜

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/controller/AdminAuthController.java`

**å½“å‰é€»è¾‘**:
- æ³¨å†Œç§Ÿæˆ·æ—¶ï¼Œ**å›ºå®šåˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·**ï¼Œè§’è‰²å›ºå®šä¸º `ADMIN`
- æ³¨å†Œæ¥å£ï¼š`POST /api/admin/auth/registerTenant`
- æ³¨å†ŒæˆåŠŸåï¼Œåˆ›å»ºç§Ÿæˆ·å’Œç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦å·

**é‡è¦è¯´æ˜**:
- âš ï¸ **æ³¨å†Œé¡µé¢ä¸å†åŒºåˆ†å®¢æœå’Œç®¡ç†å‘˜**
- âœ… **å®¢æœå’Œç®¡ç†å‘˜çš„åˆ›å»ºéƒ½åœ¨ç®¡ç†å‘˜ç•Œé¢çš„"è´¦æˆ·ç®¡ç†"é¡µé¢å®Œæˆ**
- âœ… ç®¡ç†å‘˜ç™»å½•åï¼Œå¯ä»¥åœ¨"è´¦æˆ·ç®¡ç†" â†’ "Bç«¯ç”¨æˆ·ç®¡ç†"ä¸­åˆ›å»ºæ–°çš„ç®¡ç†å‘˜æˆ–å®¢æœè´¦å·

**æ³¨å†Œæ¥å£å®ç°**ï¼ˆå·²å®ç°ï¼‰:
```java
@PostMapping("/registerTenant")
public ApiResponse<TenantRegisterResponse> registerTenant(
        @Valid @RequestBody TenantRegisterRequest request) {
    // åˆ›å»ºç§Ÿæˆ·
    Tenant tenant = new Tenant();
    tenant.setTenantCode(request.getTenantCode());
    tenant.setName(request.getTenantName());
    tenant.setTenantIdentifier(request.getTenantIdentifier());
    this.save(tenant);
    
    // åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·ï¼ˆå›ºå®šä¸º ADMIN è§’è‰²ï¼‰
    User admin = new User();
    admin.setTenantId(tenant.getId());
    admin.setUsername(request.getAdminUsername());
    admin.setPassword(passwordEncoder.encode(request.getAdminPassword()));
    admin.setRole(Roles.ADMIN); // å›ºå®šä¸º ADMIN
    admin.setStatus(1);
    userService.save(admin);
    
    // è¿”å›ç»“æœ
    TenantRegisterResponse response = new TenantRegisterResponse();
    response.setTenantId(tenant.getId());
    response.setTenantCode(tenant.getTenantCode());
    
    return ApiResponse.success("ç§Ÿæˆ·æ³¨å†ŒæˆåŠŸ", response);
}
```

**è´¦æˆ·ç®¡ç†åŠŸèƒ½**ï¼ˆå·²å®ç°ï¼‰:
- ç®¡ç†å‘˜å¯ä»¥åœ¨"è´¦æˆ·ç®¡ç†"é¡µé¢åˆ›å»ºæ–°çš„ç®¡ç†å‘˜æˆ–å®¢æœè´¦å·
- æ¥å£ï¼š`POST /api/admin/user-management`ï¼ˆé€šè¿‡ `UserManagementService.createUser`ï¼‰
- åˆ›å»ºæ—¶å¯ä»¥æŒ‡å®šè§’è‰²ï¼š`ADMIN` æˆ– `AGENT`
- è¯¦è§ï¼š`docs/è´¦å·ç®¡ç†åŠŸèƒ½å®ç°æ–¹æ¡ˆ.md`

---

### 4.2 å·¥å•æœåŠ¡æ‰©å±•

#### 4.2.1 å·¥å•æŸ¥è¯¢æ–¹æ³•æ‰©å±•

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/ticket/service/TicketService.java`

**æ–°å¢æ–¹æ³•**:
```java
/**
 * æŒ‰ç§Ÿæˆ·ã€çŠ¶æ€å’Œåˆ†é…äººåˆ†é¡µæŸ¥è¯¢å·¥å•åˆ—è¡¨ï¼ˆå®¢æœä½¿ç”¨ï¼‰
 * 
 * @param tenantId ç§Ÿæˆ·ID
 * @param assigneeId åˆ†é…äººIDï¼ˆå®¢æœIDï¼‰ï¼Œå¦‚æœä¸ºnullåˆ™æŸ¥è¯¢æœªåˆ†é…çš„å·¥å•
 * @param status çŠ¶æ€ï¼ˆå¯ä¸ºnullï¼Œè¡¨ç¤ºæŸ¥è¯¢æ‰€æœ‰çŠ¶æ€ï¼‰
 * @param page é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
 * @param size æ¯é¡µå¤§å°
 * @return åˆ†é¡µç»“æœ
 */
IPage<Ticket> listTicketsByAssignee(Long tenantId, Long assigneeId, String status, int page, int size);

/**
 * ç®¡ç†å‘˜æŸ¥è¯¢æ‰€æœ‰å·¥å•ï¼ˆåŒ…æ‹¬æœªåˆ†é…å’Œå·²åˆ†é…çš„ï¼‰
 * 
 * @param tenantId ç§Ÿæˆ·ID
 * @param status çŠ¶æ€ï¼ˆå¯ä¸ºnullï¼‰
 * @param assigneeId åˆ†é…äººIDï¼ˆå¯ä¸ºnullï¼Œè¡¨ç¤ºæŸ¥è¯¢æ‰€æœ‰ï¼‰
 * @param page é¡µç 
 * @param size æ¯é¡µå¤§å°
 * @return åˆ†é¡µç»“æœ
 */
IPage<Ticket> listAllTickets(Long tenantId, String status, Long assigneeId, int page, int size);
```

**å®ç°** (`TicketServiceImpl.java`):
```java
@Override
public IPage<Ticket> listTicketsByAssignee(Long tenantId, Long assigneeId, String status, int page, int size) {
    if (tenantId == null) {
        throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç§Ÿæˆ·IDä¸èƒ½ä¸ºç©º");
    }
    if (assigneeId == null) {
        throw new BizException(ErrorCodes.VALIDATION_ERROR, "åˆ†é…äººIDä¸èƒ½ä¸ºç©º");
    }
    
    Page<Ticket> pageParam = new Page<>(page, size);
    LambdaQueryWrapper<Ticket> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(Ticket::getTenantId, tenantId)
           .eq(Ticket::getAssignee, assigneeId); // åªæŸ¥è¯¢åˆ†é…ç»™è‡ªå·±çš„
    
    if (status != null && !status.trim().isEmpty()) {
        wrapper.eq(Ticket::getStatus, status);
    }
    
    wrapper.orderByDesc(Ticket::getCreateTime);
    
    return ticketMapper.selectPage(pageParam, wrapper);
}

@Override
public IPage<Ticket> listAllTickets(Long tenantId, String status, Long assigneeId, int page, int size) {
    if (tenantId == null) {
        throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç§Ÿæˆ·IDä¸èƒ½ä¸ºç©º");
    }
    
    Page<Ticket> pageParam = new Page<>(page, size);
    LambdaQueryWrapper<Ticket> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(Ticket::getTenantId, tenantId);
    
    if (status != null && !status.trim().isEmpty()) {
        wrapper.eq(Ticket::getStatus, status);
    }
    
    if (assigneeId != null) {
        wrapper.eq(Ticket::getAssignee, assigneeId);
    }
    
    wrapper.orderByDesc(Ticket::getCreateTime);
    
    return ticketMapper.selectPage(pageParam, wrapper);
}
```

#### 4.2.2 å·¥å•Controllerä¿®æ”¹

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/controller/AdminTicketController.java`

**ä¿®æ”¹ `/list` æ¥å£**:
```java
@GetMapping("/list")
public ApiResponse<IPage<Ticket>> list(
        @RequestParam(required = false) String status,
        @RequestParam(required = false) Long assigneeId, // æ–°å¢ï¼šæŒ‰åˆ†é…äººç­›é€‰
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "10") int size
) {
    Long tenantId = SecurityUtil.currentTenantId();
    Long userId = SecurityUtil.currentUserId();
    String role = SecurityUtil.currentRole();
    
    if (tenantId == null || userId == null) {
        throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
    }
    
    if (page < 1) page = 1;
    if (size < 1 || size > 100) size = 10;
    
    IPage<Ticket> result;
    
    if (Roles.isAgent(role)) {
        // å®¢æœï¼šåªèƒ½çœ‹åˆ°åˆ†é…ç»™è‡ªå·±çš„å·¥å•
        result = ticketService.listTicketsByAssignee(tenantId, userId, status, page, size);
    } else if (Roles.isAdmin(role)) {
        // ç®¡ç†å‘˜ï¼šå¯ä»¥çœ‹åˆ°æ‰€æœ‰å·¥å•ï¼Œå¯ä»¥æŒ‰assigneeIdç­›é€‰
        result = ticketService.listAllTickets(tenantId, status, assigneeId, page, size);
    } else {
        throw new BizException(ErrorCodes.FORBIDDEN, "æ— æƒé™è®¿é—®");
    }
    
    return ApiResponse.success("æŸ¥è¯¢æˆåŠŸ", result);
}
```

**æ–°å¢æ¥å£ï¼šè·å–å®¢æœåˆ—è¡¨ï¼ˆç”¨äºæ´¾å•ï¼‰**:
```java
/**
 * è·å–ç§Ÿæˆ·ä¸‹çš„å®¢æœåˆ—è¡¨ï¼ˆç®¡ç†å‘˜æ´¾å•æ—¶ä½¿ç”¨ï¼‰
 * GET /api/admin/ticket/agents
 */
@GetMapping("/agents")
@RequireRole("ADMIN") // ä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹å®¢æœåˆ—è¡¨
public ApiResponse<List<User>> listAgents() {
    Long tenantId = SecurityUtil.currentTenantId();
    if (tenantId == null) {
        throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯");
    }
    
    // æŸ¥è¯¢è¯¥ç§Ÿæˆ·ä¸‹æ‰€æœ‰å®¢æœï¼ˆAGENTè§’è‰²ï¼‰
    List<User> agents = userService.listByTenantIdAndRole(tenantId, Roles.AGENT);
    
    return ApiResponse.success("æŸ¥è¯¢æˆåŠŸ", agents);
}
```

**UserServiceæ–°å¢æ–¹æ³•**:
```java
// UserService.java
/**
 * æ ¹æ®ç§Ÿæˆ·IDå’Œè§’è‰²æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
 */
List<User> listByTenantIdAndRole(Long tenantId, String role);
```

**å®ç°** (`UserServiceImpl.java`):
```java
@Override
public List<User> listByTenantIdAndRole(Long tenantId, String role) {
    LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(User::getTenantId, tenantId)
           .eq(User::getRole, role)
           .eq(User::getStatus, 1) // åªæŸ¥è¯¢æ­£å¸¸çŠ¶æ€çš„ç”¨æˆ·
           .orderByDesc(User::getCreateTime);
    
    return userMapper.selectList(wrapper);
}
```

---

### 4.3 å®¢æœåœ¨çº¿çŠ¶æ€ç®¡ç†

#### 4.3.1 åœ¨çº¿çŠ¶æ€ Serviceï¼ˆæ›´æ–°ï¼šä¸å†å†™ `user` è¡¨ï¼‰

ä½ ç°åœ¨å·²ç»æŠŠâ€œå®¢æœçŠ¶æ€â€ä» `user` è¡¨æŠ½ç¦»ï¼Œæ‰€ä»¥è¿™é‡Œå»ºè®®å¼•å…¥ç‹¬ç«‹æœåŠ¡å±‚ï¼ˆåå­—æŒ‰ä½ å®é™…å‘½åè°ƒæ•´ï¼‰ï¼š

- **`AgentConfigService`**ï¼šè¯»å†™ `agent_config`ï¼ˆä¾‹å¦‚æœ€å¤§å¹¶å‘æ•°ï¼‰
- **`AgentStatusService`**ï¼šè¯»å†™å®¢æœçŠ¶æ€ï¼ˆ`agent_status` è¡¨æˆ– Redisï¼‰

æ¥å£å»ºè®®ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```java
public interface AgentStatusService {
    void setOnline(Long tenantId, Long userId);
    void setOffline(Long tenantId, Long userId);
    void setAway(Long tenantId, Long userId);
    void heartbeat(Long tenantId, Long userId);

    /** å½“å‰ä¼šè¯æ•°ï¼ˆç”¨äºæ’é˜Ÿ/åˆ†é…ï¼‰ */
    int getCurrentSessions(Long tenantId, Long userId);
    void incrSessions(Long tenantId, Long userId);
    void decrSessions(Long tenantId, Long userId);
}
```

#### 4.3.2 åœ¨çº¿çŠ¶æ€Controller

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/controller/AdminUserController.java` (æ–°å»º)

```java
package com.ityfz.yulu.admin.controller;

import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.enums.ErrorCodes;
import com.ityfz.yulu.common.exception.BizException;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.security.SecurityUtil;
import com.ityfz.yulu.user.service.AgentStatusService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/admin/user")
@RequiredArgsConstructor
public class AdminUserController {
    
    private final AgentStatusService agentStatusService;
    
    /**
     * æ›´æ–°åœ¨çº¿çŠ¶æ€ï¼ˆå®¢æœä½¿ç”¨ï¼‰
     * PUT /api/admin/user/online-status
     */
    @PutMapping("/online-status")
    @RequireRole({"ADMIN", "AGENT"})
    public ApiResponse<Void> updateOnlineStatus(@RequestParam String status) {
        Long userId = SecurityUtil.currentUserId();
        Long tenantId = SecurityUtil.currentTenantId();
        if (userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }
        
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯");
        }
        // status: ONLINE/OFFLINE/AWAY
        if ("ONLINE".equalsIgnoreCase(status)) {
            agentStatusService.setOnline(tenantId, userId);
        } else if ("OFFLINE".equalsIgnoreCase(status)) {
            agentStatusService.setOffline(tenantId, userId);
        } else if ("AWAY".equalsIgnoreCase(status)) {
            agentStatusService.setAway(tenantId, userId);
        } else {
            throw new BizException(ErrorCodes.VALIDATION_ERROR, "çŠ¶æ€å€¼æ— æ•ˆ");
        }
        return ApiResponse.success("çŠ¶æ€æ›´æ–°æˆåŠŸ");
    }
    
    // è¯´æ˜ï¼šåœ¨çº¿å®¢æœåˆ—è¡¨å»ºè®®åŸºäº Redis ZSet / agent_status æŸ¥è¯¢å®ç°
}
```

---

## ğŸ¨ äº”ã€å‰ç«¯å®ç°æ–¹æ¡ˆ

### 5.1 ç™»å½•é¡µé¢ä¿®æ”¹

**æ–‡ä»¶**: `frontend/src/pages/Login.tsx`

**ä¿®æ”¹ç‚¹**:
1. åœ¨Bç«¯ç™»å½•è¡¨å•ä¸­æ·»åŠ "èº«ä»½é€‰æ‹©"ä¸‹æ‹‰æ¡†
2. é€‰é¡¹ï¼šç®¡ç†å‘˜ / å®¢æœ
3. ç™»å½•æ—¶ä¼ é€’ `role` å­—æ®µï¼ˆå¯é€‰ï¼Œç”¨äºUIæç¤ºï¼‰

**ä»£ç ç¤ºä¾‹**:
```typescript
// åœ¨ isAdmin ä¸º true çš„è¡¨å•ä¸­æ·»åŠ 
<Form.Item
  label="èº«ä»½"
  name="role"
  rules={[{ required: true, message: 'è¯·é€‰æ‹©èº«ä»½' }]}
  initialValue="ADMIN"
>
  <Select placeholder="è¯·é€‰æ‹©èº«ä»½">
    <Select.Option value="ADMIN">ç®¡ç†å‘˜</Select.Option>
    <Select.Option value="AGENT">å®¢æœ</Select.Option>
  </Select>
</Form.Item>
```

**ç™»å½•é€»è¾‘ä¿®æ”¹**:
```typescript
if (isAdmin) {
  // Bç«¯ç™»å½•ï¼šè°ƒç”¨ç®¡ç†å‘˜ç™»å½•æ¥å£
  res = await authApi.adminLogin({
    tenantCode: values.tenantCode,
    username: values.username,
    password: values.password,
    role: values.role // æ–°å¢ï¼šä¼ é€’è§’è‰²ï¼ˆå¯é€‰ï¼Œç”¨äºåç«¯éªŒè¯ï¼‰
  });
  
  // ç™»å½•æˆåŠŸåæ ¹æ®è§’è‰²è·³è½¬
  if (res.success || res.code === '200') {
    if (res.data?.token) {
      setToken(res.data.token);
    }
    if (res.data?.role) setRole(res.data?.role);
    if (res.data?.username) setUsername(res.data.username);
    message.success(res.message || 'ç™»å½•æˆåŠŸ');
    
    // æ ¹æ®è§’è‰²è·³è½¬ä¸åŒé¡µé¢
    const role = res.data?.role;
    if (role === 'ADMIN') {
      navigate('/admin/dashboard');
    } else if (role === 'AGENT') {
      navigate('/agent/tickets'); // å®¢æœé¦–é¡µ
    } else {
      navigate('/admin/dashboard');
    }
  }
}
```

### 5.2 æ³¨å†Œé¡µé¢è¯´æ˜

**æ–‡ä»¶**: `frontend/src/pages/Register.tsx`

**å½“å‰é€»è¾‘**ï¼ˆå·²å®ç°ï¼‰:
- Bç«¯æ³¨å†Œæ—¶ï¼Œ**åªæ³¨å†Œç§Ÿæˆ·å’Œç®¡ç†å‘˜è´¦å·**ï¼Œä¸åŒºåˆ†å®¢æœå’Œç®¡ç†å‘˜
- æ³¨å†ŒæˆåŠŸåï¼Œåˆ›å»ºç§Ÿæˆ·å’Œç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦å·ï¼ˆè§’è‰²å›ºå®šä¸º `ADMIN`ï¼‰
- æ³¨å†Œé¡µé¢**ä¸åŒ…å«è§’è‰²é€‰æ‹©å­—æ®µ**

**æ³¨å†Œé€»è¾‘**ï¼ˆå½“å‰å®ç°ï¼‰:
```typescript
if (isAdmin) {
  // Bç«¯æ³¨å†Œï¼šè°ƒç”¨ç§Ÿæˆ·æ³¨å†Œæ¥å£
  res = await authApi.adminRegisterTenant({
    tenantCode: values.tenantCode,
    tenantName: values.tenantName,
    adminUsername: values.adminUsername,
    adminPassword: values.adminPassword,
    tenantIdentifier: values.tenantIdentifier || values.tenantCode
    // æ³¨æ„ï¼šä¸ä¼ é€’ role å­—æ®µï¼Œåç«¯å›ºå®šåˆ›å»º ADMIN è§’è‰²
  });
  // æ³¨å†ŒæˆåŠŸåè·³è½¬åˆ°ç™»å½•é¡µé¢
  if (res.success || res.code === '200') {
    message.success(res.message || 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
    navigate('/login');
  }
}
```

**é‡è¦è¯´æ˜**:
- âš ï¸ **æ³¨å†Œé¡µé¢ä¸å†åŒºåˆ†å®¢æœå’Œç®¡ç†å‘˜**
- âœ… **å®¢æœå’Œç®¡ç†å‘˜çš„åˆ›å»ºéƒ½åœ¨ç®¡ç†å‘˜ç•Œé¢çš„"è´¦æˆ·ç®¡ç†"é¡µé¢å®Œæˆ**
- âœ… ç®¡ç†å‘˜ç™»å½•åï¼Œå¯ä»¥åœ¨"è´¦æˆ·ç®¡ç†" â†’ "Bç«¯ç”¨æˆ·ç®¡ç†ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰"ä¸­ï¼š
  - åˆ›å»ºæ–°çš„ç®¡ç†å‘˜è´¦å·ï¼ˆ`ADMIN` è§’è‰²ï¼‰
  - åˆ›å»ºæ–°çš„å®¢æœè´¦å·ï¼ˆ`AGENT` è§’è‰²ï¼‰
- âœ… åˆ›å»ºè´¦å·æ—¶å¯ä»¥é€‰æ‹©è§’è‰²ï¼Œè¯¦è§ï¼š`docs/è´¦å·ç®¡ç†åŠŸèƒ½å®ç°æ–¹æ¡ˆ.md`

### 5.3 å®¢æœå¸ƒå±€ç»„ä»¶

**æ–‡ä»¶**: `frontend/src/components/layout/AgentLayout.tsx` (æ–°å»º)

```typescript
import { 
  ProfileOutlined, 
  BellOutlined, 
  MessageOutlined,
  BookOutlined,
  UserOutlined,
  DesktopOutlined
} from '@ant-design/icons';
import type { ReactNode } from 'react';
import { PortalLayout } from './PortalLayout';

export function AgentLayout({ children }: { children: ReactNode }) {
  return (
    <PortalLayout
      logoText="YuLu å®¢æœå·¥ä½œå°"
      headerTitle="YuLuå®¢æœç«¯"
      menuItems={[
        {
          key: '/agent/tickets',
          icon: <ProfileOutlined />,
          label: 'æˆ‘çš„å·¥å•'
        },
        {
          key: '/agent/sessions',
          icon: <MessageOutlined />,
          label: 'å¾…æ¥å…¥ä¼šè¯'
        },
        {
          key: '/agent/workspace',
          icon: <DesktopOutlined />,
          label: 'æˆ‘çš„å·¥ä½œå°'
        },
        {
          key: '/agent/knowledge',
          icon: <BookOutlined />,
          label: 'çŸ¥è¯†åº“æŸ¥è¯¢'
        },
        {
          key: '/agent/notify',
          icon: <BellOutlined />,
          label: 'é€šçŸ¥ä¸­å¿ƒ'
        },
        {
          key: '/agent/profile',
          icon: <UserOutlined />,
          label: 'ä¸ªäººè®¾ç½®'
        }
      ]}
    >
      {children}
    </PortalLayout>
  );
}
```

### 5.4 å®¢æœå·¥å•é¡µé¢

**æ–‡ä»¶**: `frontend/src/pages/agent/AgentTicketPage.tsx` (æ–°å»º)

```typescript
import { useState, useEffect } from 'react';
import { Card, Table, Tag, Button, Space, message } from 'antd';
import { ticketApi } from '../../api/ticket';
import type { Ticket } from '../../api/types';

export default function AgentTicketPage() {
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(false);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0
  });

  const loadTickets = async (page = 1, pageSize = 10, status?: string) => {
    setLoading(true);
    try {
      const res = await ticketApi.list({
        page,
        size: pageSize,
        status
      });
      if (res.success || res.code === '200') {
        setTickets(res.data.records || []);
        setPagination({
          current: res.data.current || 1,
          pageSize: res.data.size || 10,
          total: res.data.total || 0
        });
      }
    } catch (e: any) {
      message.error(e?.response?.data?.message || 'åŠ è½½å·¥å•å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadTickets();
  }, []);

  const handleStatusChange = async (ticketId: number, targetStatus: string) => {
    try {
      await ticketApi.transition({
        ticketId,
        targetStatus,
        comment: ''
      });
      message.success('çŠ¶æ€æ›´æ–°æˆåŠŸ');
      loadTickets(pagination.current, pagination.pageSize);
    } catch (e: any) {
      message.error(e?.response?.data?.message || 'æ“ä½œå¤±è´¥');
    }
  };

  const columns = [
    {
      title: 'å·¥å•ID',
      dataIndex: 'id',
      key: 'id',
      width: 80
    },
    {
      title: 'æ ‡é¢˜',
      dataIndex: 'title',
      key: 'title',
      ellipsis: true
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'status',
      key: 'status',
      width: 100,
      render: (status: string) => {
        const colorMap: Record<string, string> = {
          PENDING: 'orange',
          PROCESSING: 'blue',
          DONE: 'green',
          CLOSED: 'default'
        };
        const textMap: Record<string, string> = {
          PENDING: 'å¾…å¤„ç†',
          PROCESSING: 'å¤„ç†ä¸­',
          DONE: 'å·²å®Œæˆ',
          CLOSED: 'å·²å…³é—­'
        };
        return <Tag color={colorMap[status]}>{textMap[status] || status}</Tag>;
      }
    },
    {
      title: 'ä¼˜å…ˆçº§',
      dataIndex: 'priority',
      key: 'priority',
      width: 100,
      render: (priority: string) => {
        const colorMap: Record<string, string> = {
          LOW: 'default',
          MEDIUM: 'blue',
          HIGH: 'orange',
          URGENT: 'red'
        };
        return <Tag color={colorMap[priority]}>{priority}</Tag>;
      }
    },
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'createTime',
      key: 'createTime',
      width: 180
    },
    {
      title: 'æ“ä½œ',
      key: 'action',
      width: 200,
      render: (_: any, record: Ticket) => (
        <Space>
          <Button 
            type="link" 
            onClick={() => handleStatusChange(record.id, 'PROCESSING')}
            disabled={record.status === 'PROCESSING'}
          >
            å¼€å§‹å¤„ç†
          </Button>
          <Button 
            type="link" 
            onClick={() => handleStatusChange(record.id, 'DONE')}
            disabled={record.status === 'DONE' || record.status === 'CLOSED'}
          >
            å®Œæˆ
          </Button>
        </Space>
      )
    }
  ];

  return (
    <Card title="æˆ‘çš„å·¥å•">
      <Table
        columns={columns}
        dataSource={tickets}
        rowKey="id"
        loading={loading}
        pagination={{
          current: pagination.current,
          pageSize: pagination.pageSize,
          total: pagination.total,
          onChange: (page, pageSize) => loadTickets(page, pageSize),
          showSizeChanger: true,
          showTotal: (total) => `å…± ${total} æ¡`
        }}
      />
    </Card>
  );
}
```

### 5.5 ç®¡ç†å‘˜å·¥å•é¡µé¢å¢å¼ºï¼ˆæ´¾å•åŠŸèƒ½ï¼‰

**æ–‡ä»¶**: `frontend/src/pages/admin/TicketListPage.tsx` (ä¿®æ”¹)

**æ–°å¢åŠŸèƒ½**:
1. åœ¨å·¥å•åˆ—è¡¨ä¸­æ˜¾ç¤º"åˆ†é…äºº"åˆ—
2. æ·»åŠ "æ´¾å•"æŒ‰é’®ï¼ˆä»…æœªåˆ†é…çš„å·¥å•æ˜¾ç¤ºï¼‰
3. æ´¾å•å¼¹çª—ï¼šé€‰æ‹©å®¢æœä¸‹æ‹‰æ¡†
4. è°ƒç”¨æ´¾å•æ¥å£

**ä»£ç ç¤ºä¾‹**:
```typescript
// åœ¨ columns ä¸­æ·»åŠ "åˆ†é…äºº"åˆ—
{
  title: 'åˆ†é…äºº',
  dataIndex: 'assignee',
  key: 'assignee',
  width: 120,
  render: (assignee: number | null, record: Ticket) => {
    if (!assignee) {
      return <Tag color="orange">æœªåˆ†é…</Tag>;
    }
    // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºå®¢æœåç§°ï¼ˆéœ€è¦ä»ç”¨æˆ·åˆ—è¡¨è·å–ï¼‰
    return <span>å®¢æœ#{assignee}</span>;
  }
},
{
  title: 'æ“ä½œ',
  key: 'action',
  width: 250,
  render: (_: any, record: Ticket) => (
    <Space>
      {!record.assignee && (
        <Button 
          type="primary" 
          size="small"
          onClick={() => handleAssign(record)}
        >
          æ´¾å•
        </Button>
      )}
      {/* å…¶ä»–æ“ä½œæŒ‰é’® */}
    </Space>
  )
}

// æ´¾å•åŠŸèƒ½
const [assignModalVisible, setAssignModalVisible] = useState(false);
const [selectedTicket, setSelectedTicket] = useState<Ticket | null>(null);
const [agents, setAgents] = useState<any[]>([]);

const loadAgents = async () => {
  try {
    const res = await ticketApi.getAgents();
    if (res.success || res.code === '200') {
      setAgents(res.data || []);
    }
  } catch (e: any) {
    message.error('åŠ è½½å®¢æœåˆ—è¡¨å¤±è´¥');
  }
};

const handleAssign = (ticket: Ticket) => {
  setSelectedTicket(ticket);
  setAssignModalVisible(true);
  loadAgents();
};

const handleAssignSubmit = async (values: { agentId: number }) => {
  if (!selectedTicket) return;
  
  try {
    await ticketApi.assign({
      ticketId: selectedTicket.id,
      assigneeUserId: values.agentId
    });
    message.success('æ´¾å•æˆåŠŸ');
    setAssignModalVisible(false);
    loadTickets();
  } catch (e: any) {
    message.error(e?.response?.data?.message || 'æ´¾å•å¤±è´¥');
  }
};

// æ´¾å•å¼¹çª—
<Modal
  title="æ´¾å•"
  open={assignModalVisible}
  onCancel={() => setAssignModalVisible(false)}
  footer={null}
>
  <Form onFinish={handleAssignSubmit}>
    <Form.Item
      label="é€‰æ‹©å®¢æœ"
      name="agentId"
      rules={[{ required: true, message: 'è¯·é€‰æ‹©å®¢æœ' }]}
    >
      <Select placeholder="è¯·é€‰æ‹©å®¢æœ">
        {agents.map(agent => (
          <Select.Option key={agent.id} value={agent.id}>
            {agent.username} {agent.nickName ? `(${agent.nickName})` : ''}
          </Select.Option>
        ))}
      </Select>
    </Form.Item>
    <Form.Item>
      <Space>
        <Button type="primary" htmlType="submit">ç¡®å®š</Button>
        <Button onClick={() => setAssignModalVisible(false)}>å–æ¶ˆ</Button>
      </Space>
    </Form.Item>
  </Form>
</Modal>
```

### 5.6 è·¯ç”±é…ç½®ä¿®æ”¹

**æ–‡ä»¶**: `frontend/src/App.tsx`

**ä¿®æ”¹ç‚¹**:
1. æ ¹æ®è§’è‰²è·³è½¬åˆ°ä¸åŒé¡µé¢
2. æ·»åŠ å®¢æœè·¯ç”±

**ä»£ç ç¤ºä¾‹**:
```typescript
function HomeRedirect() {
  const token = getToken();
  const role = getRole();
  if (!token) return <Navigate to="/login" replace />;
  
  // æ ¹æ®è§’è‰²è·³è½¬
  if (role === 'USER') {
    return <Navigate to="/customer/chat" replace />;
  } else if (role === 'ADMIN') {
    return <Navigate to="/admin/dashboard" replace />;
  } else if (role === 'AGENT') {
    return <Navigate to="/agent/tickets" replace />;
  }
  
  return <Navigate to="/login" replace />;
}

// æ·»åŠ å®¢æœè·¯ç”±
<Route
  path="/agent/tickets"
  element={
    <RequireAuth>
      <AgentLayout>
        <AgentTicketPage />
      </AgentLayout>
    </RequireAuth>
  }
/>
<Route
  path="/agent/sessions"
  element={
    <RequireAuth>
      <AgentLayout>
        <AgentSessionsPage />
      </AgentLayout>
    </RequireAuth>
  }
/>
// ... å…¶ä»–å®¢æœè·¯ç”±
```

### 5.7 APIæ¥å£æ‰©å±•

**æ–‡ä»¶**: `frontend/src/api/ticket.ts`

**æ–°å¢æ–¹æ³•**:
```typescript
// è·å–å®¢æœåˆ—è¡¨ï¼ˆç®¡ç†å‘˜æ´¾å•ç”¨ï¼‰
getAgents() {
  return http.get<ApiResponse<any[]>>('/admin/ticket/agents');
}

// æ´¾å•
assign(request: { ticketId: number; assigneeUserId: number }) {
  return http.post<ApiResponse<void>>('/admin/ticket/assign', request);
}
```

---

## ğŸ“ å…­ã€å®ç°æ­¥éª¤

### æ­¥éª¤1: æ•°æ®åº“å‡†å¤‡ï¼ˆ1å¤©ï¼‰

1. **åˆ›å»º/ç¡®è®¤å®¢æœé…ç½®è¡¨ä¸çŠ¶æ€è¡¨**
   - `agent_config`ï¼ˆä½é¢‘é…ç½®ï¼š`max_concurrent_sessions` ç­‰ï¼‰
   - `agent_status`ï¼ˆå¦‚æœä½ å†³å®šè½åº“ï¼›è‹¥ä½ ç”¨ Redis ä¸ºä¸»ï¼Œåˆ™æ­¤è¡¨å¯é€‰ï¼‰

2. **åˆ›å»ºè½¬äººå·¥è®°å½•è¡¨**ï¼ˆä¸ºåç»­åŠŸèƒ½å‡†å¤‡ï¼‰
   ```sql
   CREATE TABLE IF NOT EXISTS `transfer_record` (...);
   ```

### æ­¥éª¤2: åç«¯å¼€å‘ï¼ˆ3-4å¤©ï¼‰

#### Day 1: ç™»å½•/æ³¨å†Œæ¥å£ä¿®æ”¹
- [x] ç¡®è®¤ `AdminAuthController.login` æ¥å£é€»è¾‘ï¼ˆæ”¯æŒ ADMIN/AGENT ç™»å½•ï¼‰
- [x] ç¡®è®¤ `AdminAuthController.registerTenant` æ¥å£é€»è¾‘ï¼ˆå›ºå®šåˆ›å»º ADMIN è§’è‰²ï¼‰
- [x] ç¡®è®¤æ³¨å†Œé¡µé¢ä¸åŒ…å«è§’è‰²é€‰æ‹©ï¼ˆåªåˆ›å»ºç§Ÿæˆ·å’Œç®¡ç†å‘˜ï¼‰
- [x] ç¡®è®¤è´¦æˆ·ç®¡ç†åŠŸèƒ½å·²å®ç°ï¼ˆå¯ä»¥åœ¨ç®¡ç†å‘˜ç•Œé¢åˆ›å»º ADMIN/AGENT è´¦å·ï¼‰
- [ ] æµ‹è¯•ç™»å½•/æ³¨å†ŒåŠŸèƒ½

#### Day 2: å·¥å•æœåŠ¡æ‰©å±•
- [ ] åœ¨ `TicketService` æ¥å£ä¸­æ·»åŠ  `listTicketsByAssignee` æ–¹æ³•
- [ ] åœ¨ `TicketService` æ¥å£ä¸­æ·»åŠ  `listAllTickets` æ–¹æ³•
- [ ] å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•
- [ ] ä¿®æ”¹ `AdminTicketController.list` æ¥å£ï¼Œæ ¹æ®è§’è‰²è¿”å›ä¸åŒæ•°æ®
- [ ] æ·»åŠ  `AdminTicketController.listAgents` æ¥å£
- [ ] åœ¨ `UserService` ä¸­æ·»åŠ  `listByTenantIdAndRole` æ–¹æ³•
- [ ] æµ‹è¯•å·¥å•æŸ¥è¯¢åŠŸèƒ½

#### Day 3: åœ¨çº¿çŠ¶æ€ç®¡ç†
- [ ] åˆ›å»º `AdminUserController`
- [ ] å®ç°åœ¨çº¿çŠ¶æ€æ›´æ–°æ¥å£ï¼ˆè°ƒç”¨ `AgentStatusService`ï¼Œè€Œä¸æ˜¯å†™ `user` è¡¨ï¼‰
- [ ] å®ç°å¿ƒè·³æ¥å£ï¼ˆæ¨èï¼š`POST /api/admin/user/heartbeat`ï¼Œåˆ·æ–°åœ¨çº¿ TTLï¼‰
- [ ] ï¼ˆå¯é€‰ï¼‰å®ç°åœ¨çº¿å®¢æœåˆ—è¡¨æ¥å£ï¼ˆåŸºäº `agent_status` æˆ– Redisï¼‰
- [ ] æµ‹è¯•åœ¨çº¿çŠ¶æ€åŠŸèƒ½

#### Day 4: æµ‹è¯•ä¸ä¼˜åŒ–
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] ä»£ç å®¡æŸ¥
- [ ] æ–‡æ¡£æ›´æ–°

### æ­¥éª¤3: å‰ç«¯å¼€å‘ï¼ˆ3-4å¤©ï¼‰

#### Day 1: ç™»å½•/æ³¨å†Œé¡µé¢ç¡®è®¤
- [x] ç¡®è®¤ `Login.tsx` å·²æ·»åŠ èº«ä»½é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰
- [x] ç¡®è®¤ç™»å½•é€»è¾‘å·²æ ¹æ®è§’è‰²è·³è½¬ï¼ˆADMIN â†’ `/admin/dashboard`ï¼ŒAGENT â†’ `/agent/tickets`ï¼‰
- [x] ç¡®è®¤ `Register.tsx` ä¸åŒ…å«è§’è‰²é€‰æ‹©ï¼ˆåªæ³¨å†Œç§Ÿæˆ·å’Œç®¡ç†å‘˜ï¼‰
- [x] ç¡®è®¤è´¦æˆ·ç®¡ç†é¡µé¢å·²å®ç°ï¼ˆå¯ä»¥åœ¨ç®¡ç†å‘˜ç•Œé¢åˆ›å»º ADMIN/AGENT è´¦å·ï¼‰
- [ ] æµ‹è¯•ç™»å½•/æ³¨å†Œæµç¨‹

#### Day 2: å®¢æœå¸ƒå±€å’Œè·¯ç”±
- [ ] åˆ›å»º `AgentLayout.tsx` ç»„ä»¶
- [ ] ä¿®æ”¹ `App.tsx`ï¼Œæ·»åŠ å®¢æœè·¯ç”±
- [ ] ä¿®æ”¹ `HomeRedirect`ï¼Œæ”¯æŒå®¢æœè§’è‰²è·³è½¬
- [ ] æµ‹è¯•è·¯ç”±è·³è½¬

#### Day 3: å®¢æœå·¥å•é¡µé¢
- [ ] åˆ›å»º `AgentTicketPage.tsx`
- [ ] å®ç°å·¥å•åˆ—è¡¨å±•ç¤º
- [ ] å®ç°çŠ¶æ€æ›´æ–°åŠŸèƒ½
- [ ] æµ‹è¯•å®¢æœå·¥å•åŠŸèƒ½

#### Day 4: ç®¡ç†å‘˜æ´¾å•åŠŸèƒ½
- [ ] ä¿®æ”¹ `TicketListPage.tsx`ï¼Œæ·»åŠ æ´¾å•åŠŸèƒ½
- [ ] å®ç°æ´¾å•å¼¹çª—
- [ ] å®ç°å®¢æœåˆ—è¡¨åŠ è½½
- [ ] æ‰©å±• `ticketApi`ï¼Œæ·»åŠ æ´¾å•æ¥å£
- [ ] æµ‹è¯•æ´¾å•åŠŸèƒ½

### æ­¥éª¤4: è”è°ƒä¸æµ‹è¯•ï¼ˆ1-2å¤©ï¼‰

- [ ] å‰åç«¯è”è°ƒ
- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] æƒé™æµ‹è¯•ï¼ˆç®¡ç†å‘˜/å®¢æœ/ç”¨æˆ·ï¼‰
- [ ] å¤šç§Ÿæˆ·éš”ç¦»æµ‹è¯•
- [ ] Bugä¿®å¤

---

## ğŸ¯ ä¸ƒã€æµ‹è¯•ç”¨ä¾‹

### 7.1 ç™»å½•æµ‹è¯•
- [ ] ç®¡ç†å‘˜ç™»å½•ï¼Œè·³è½¬åˆ° `/admin/dashboard`
- [ ] å®¢æœç™»å½•ï¼Œè·³è½¬åˆ° `/agent/tickets`
- [ ] ç”¨æˆ·ç™»å½•ï¼Œè·³è½¬åˆ° `/customer/chat`
- [ ] é”™è¯¯è§’è‰²ç™»å½•ï¼Œæç¤ºé”™è¯¯

### 7.2 æ³¨å†Œæµ‹è¯•
- [x] æ³¨å†Œç§Ÿæˆ·å’Œç®¡ç†å‘˜è´¦å·ï¼ˆè§’è‰²å›ºå®šä¸º `ADMIN`ï¼‰
- [x] æ³¨å†Œåå¯ä»¥æ­£å¸¸ç™»å½•
- [ ] åœ¨ç®¡ç†å‘˜ç•Œé¢çš„"è´¦æˆ·ç®¡ç†"ä¸­åˆ›å»ºæ–°çš„ç®¡ç†å‘˜è´¦å·ï¼ˆ`ADMIN` è§’è‰²ï¼‰
- [ ] åœ¨ç®¡ç†å‘˜ç•Œé¢çš„"è´¦æˆ·ç®¡ç†"ä¸­åˆ›å»ºæ–°çš„å®¢æœè´¦å·ï¼ˆ`AGENT` è§’è‰²ï¼‰
- [ ] åˆ›å»ºçš„è´¦å·å¯ä»¥æ­£å¸¸ç™»å½•

### 7.3 å·¥å•åŠŸèƒ½æµ‹è¯•
- [ ] ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰å·¥å•
- [ ] å®¢æœåªèƒ½çœ‹åˆ°åˆ†é…ç»™è‡ªå·±çš„å·¥å•
- [ ] ç®¡ç†å‘˜å¯ä»¥æ´¾å•ç»™å®¢æœ
- [ ] æ´¾å•åå®¢æœå¯ä»¥çœ‹åˆ°è¯¥å·¥å•
- [ ] å®¢æœå¯ä»¥æ›´æ–°å·¥å•çŠ¶æ€

### 7.4 æƒé™æµ‹è¯•
- [ ] å®¢æœæ— æ³•è®¿é—®ç®¡ç†å‘˜ä¸“å±åŠŸèƒ½
- [ ] ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰åŠŸèƒ½
- [ ] ç”¨æˆ·æ— æ³•è®¿é—®Bç«¯åŠŸèƒ½

---

## ğŸ“š å…«ã€åç»­åŠŸèƒ½å‡†å¤‡

å®Œæˆå½“å‰åŠŸèƒ½åï¼Œä¸ºè½¬äººå·¥åŠŸèƒ½åšå‡†å¤‡ï¼š

1. **è½¬äººå·¥è®°å½•è¡¨**ï¼ˆå·²è®¾è®¡ï¼‰
2. **å®¢æœåœ¨çº¿çŠ¶æ€**ï¼ˆå·²å®ç°ï¼‰
3. **å¾…æ¥å…¥ä¼šè¯åˆ—è¡¨**ï¼ˆéœ€è¦å®ç°ï¼‰
4. **è½¬äººå·¥é€šçŸ¥æ¨é€**ï¼ˆéœ€è¦å®ç°ï¼‰

---

## ğŸ”§ ä¹ã€æ³¨æ„äº‹é¡¹

1. **æ³¨å†Œé€»è¾‘**: 
   - âš ï¸ æ³¨å†Œé¡µé¢åªåˆ›å»ºç§Ÿæˆ·å’Œç®¡ç†å‘˜ï¼ˆå›ºå®šä¸º `ADMIN` è§’è‰²ï¼‰
   - âœ… å®¢æœå’Œç®¡ç†å‘˜çš„åˆ›å»ºéƒ½åœ¨ç®¡ç†å‘˜ç•Œé¢çš„"è´¦æˆ·ç®¡ç†"é¡µé¢å®Œæˆ
   - âœ… ç®¡ç†å‘˜å¯ä»¥åœ¨"è´¦æˆ·ç®¡ç†" â†’ "Bç«¯ç”¨æˆ·ç®¡ç†"ä¸­åˆ›å»ºæ–°çš„ç®¡ç†å‘˜æˆ–å®¢æœè´¦å·
2. **è§’è‰²éªŒè¯**: å‰ç«¯ç™»å½•æ—¶é€‰æ‹©è§’è‰²ä»…ç”¨äºUIæç¤ºå’Œè·³è½¬ï¼Œå®é™…è§’è‰²ç”±åç«¯æ•°æ®åº“å†³å®š
3. **æƒé™æ§åˆ¶**: æ‰€æœ‰æ¥å£éƒ½è¦åŠ ä¸Š `@RequireRole` æ³¨è§£
4. **æ•°æ®éš”ç¦»**: ç¡®ä¿å®¢æœåªèƒ½çœ‹åˆ°è‡ªå·±ç§Ÿæˆ·çš„æ•°æ®
5. **åœ¨çº¿çŠ¶æ€**: ç™»å½•æˆåŠŸåè®¾ç½® `ONLINE`ï¼›å‰ç«¯å®šæ—¶å¿ƒè·³ç»´æŒåœ¨çº¿ï¼›ç™»å‡º/å¿ƒè·³è¶…æ—¶åˆ™ç½®ä¸º `OFFLINE`ï¼ˆæˆ–åœ¨ Redis æ–¹æ¡ˆä¸­ç›´æ¥è¿‡æœŸæ¸…é™¤ï¼‰
6. **æ´¾å•é€šçŸ¥**: æ´¾å•åéœ€è¦å‘é€é€šçŸ¥ç»™å®¢æœï¼ˆå·²æœ‰é€šçŸ¥ç³»ç»Ÿï¼‰
7. **è´¦æˆ·ç®¡ç†**: è¯¦è§ `docs/è´¦å·ç®¡ç†åŠŸèƒ½å®ç°æ–¹æ¡ˆ.md`

---

**æ–‡æ¡£ç»´æŠ¤**: è¯·æ ¹æ®å®ç°è¿›å±•åŠæ—¶æ›´æ–°æ­¤æ–‡æ¡£  
**æœ€åæ›´æ–°**: 2026-01-23  
**æ›´æ–°è¯´æ˜**: 
- æ›´æ–°äº† 4.1.2 æ³¨å†Œæ¥å£è¯´æ˜ï¼Œæ˜ç¡®æ³¨å†Œæ—¶åªåˆ›å»ºç§Ÿæˆ·å’Œç®¡ç†å‘˜ï¼ˆå›ºå®šä¸º ADMINï¼‰
- æ›´æ–°äº† 5.2 æ³¨å†Œé¡µé¢è¯´æ˜ï¼Œæ˜ç¡®æ³¨å†Œé¡µé¢ä¸åŒ…å«è§’è‰²é€‰æ‹©
- æ˜ç¡®äº†å®¢æœå’Œç®¡ç†å‘˜çš„åˆ›å»ºéƒ½åœ¨ç®¡ç†å‘˜ç•Œé¢çš„"è´¦æˆ·ç®¡ç†"é¡µé¢å®Œæˆ
- æ›´æ–°äº†å®ç°æ­¥éª¤å’Œæµ‹è¯•ç”¨ä¾‹ï¼Œåæ˜ å½“å‰çš„å®ç°çŠ¶æ€

