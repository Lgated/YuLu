# ç™»å½•æ³¨å†Œé€»è¾‘é‡æ„æ–¹æ¡ˆ

## ğŸ“‹ ä¸€ã€å½“å‰é—®é¢˜åˆ†æ

### 1.1 ç°æœ‰ç™»å½•æ³¨å†Œæ¥å£

| æ¥å£   | è·¯å¾„                         | è¯´æ˜                                        | é—®é¢˜                            |
| ---- | -------------------------- | ----------------------------------------- | ----------------------------- |
| ç™»å½•   | `/api/auth/login`          | éœ€è¦ `tenantCode` + `username` + `password` | âŒ Bç«¯å’ŒCç«¯å…±ç”¨ï¼ŒCç«¯ç”¨æˆ·ä¸åº”è¯¥çŸ¥é“tenantCode |
| ç§Ÿæˆ·æ³¨å†Œ | `/api/auth/registerTenant` | åˆ›å»ºç§Ÿæˆ·+ç®¡ç†å‘˜è´¦æˆ·                                | âœ… ç¬¦åˆBç«¯é€»è¾‘                      |
| ç”¨æˆ·æ³¨å†Œ | `/api/auth/registerUser`   | åœ¨å·²æœ‰ç§Ÿæˆ·ä¸‹æ³¨å†Œç”¨æˆ·                                | âš ï¸ æ²¡æœ‰åŒºåˆ†Bç«¯å’ŒCç«¯æ³¨å†Œ                |
|      |                            |                                           |                               |

### 1.2 æ ¸å¿ƒé—®é¢˜

1. **Cç«¯ç”¨æˆ·ä¸åº”è¯¥çŸ¥é“tenantCode**
   - Cç«¯ç”¨æˆ·ï¼ˆç§Ÿæˆ·çš„å®¢æˆ·ï¼‰ä¸åº”è¯¥éœ€è¦è¾“å…¥ç§Ÿæˆ·ç¼–ç 
   - ç§Ÿæˆ·è¯†åˆ«åº”è¯¥é€šè¿‡å…¶ä»–æ–¹å¼ï¼šåŸŸåã€å­åŸŸåã€ç§Ÿæˆ·æ ‡è¯†ç ç­‰

2. **ç™»å½•æ¥å£æ²¡æœ‰åŒºåˆ†Bç«¯å’ŒCç«¯**
   - Bç«¯ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰ï¼šéœ€è¦tenantCodeï¼Œå› ä¸ºå¯èƒ½ç®¡ç†å¤šä¸ªç§Ÿæˆ·
   - Cç«¯ï¼ˆå®¢æˆ·ï¼‰ï¼šä¸éœ€è¦tenantCodeï¼Œé€šè¿‡ä¸Šä¸‹æ–‡è‡ªåŠ¨è¯†åˆ«

3. **æ³¨å†Œé€»è¾‘æ··åœ¨ä¸€èµ·**
   - Bç«¯æ³¨å†Œï¼šç§Ÿæˆ·æ³¨å†Œ + ç®¡ç†å‘˜è´¦æˆ·åˆ›å»º
   - Cç«¯æ³¨å†Œï¼šå®¢æˆ·æ³¨å†Œï¼ˆéœ€è¦ç§Ÿæˆ·æ ‡è¯†ï¼Œä½†ä¸ç›´æ¥æš´éœ²tenantCodeï¼‰

---

## ğŸ¯ äºŒã€é‡æ„ç›®æ ‡

### 2.1 æ¥å£åˆ†ç¦»

| ç”¨æˆ·ç±»å‹ | ç™»å½•æ¥å£ | æ³¨å†Œæ¥å£ | è¯´æ˜ |
|---------|---------|---------|------|
| **Bç«¯ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰** | `/api/admin/auth/login` | `/api/admin/auth/registerTenant` | éœ€è¦tenantCode |
| **Cç«¯ï¼ˆå®¢æˆ·ï¼‰** | `/api/customer/auth/login` | `/api/customer/auth/register` | ä¸éœ€è¦tenantCodeï¼Œé€šè¿‡ç§Ÿæˆ·æ ‡è¯†è¯†åˆ« |

### 2.2 ç§Ÿæˆ·è¯†åˆ«ç­–ç•¥

**Cç«¯ç§Ÿæˆ·è¯†åˆ«æ–¹å¼ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š**
1. **è¯·æ±‚å¤´**ï¼š`X-Tenant-Code` æˆ– `X-Tenant-Id`
2. **å­åŸŸå**ï¼š`tenant1.yulu.com` â†’ è¯†åˆ«ä¸º `tenant1`
3. **åŸŸåæ˜ å°„**ï¼šé€šè¿‡åŸŸåé…ç½®è¡¨æ˜ å°„åˆ°ç§Ÿæˆ·
4. **ç§Ÿæˆ·æ ‡è¯†ç **ï¼šCç«¯æ³¨å†Œæ—¶ä½¿ç”¨ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆä¸æ˜¯tenantCodeï¼‰

---

## ğŸ”§ ä¸‰ã€è¯¦ç»†å®ç°æ–¹æ¡ˆ

### æ­¥éª¤1ï¼šåˆ›å»ºç§Ÿæˆ·è¯†åˆ«å·¥å…·ç±»

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/common/tenant/TenantIdentifier.java`

```java
package com.ityfz.yulu.common.tenant;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.util.Optional;

/**
 * ç§Ÿæˆ·è¯†åˆ«å·¥å…·ç±»
 * ç”¨äºCç«¯åœºæ™¯ä¸‹è‡ªåŠ¨è¯†åˆ«ç§Ÿæˆ·ï¼Œæ— éœ€ç”¨æˆ·è¾“å…¥tenantCode
 */
@Slf4j
@Component
public class TenantIdentifier {

    /**
     * ä»è¯·æ±‚ä¸­è¯†åˆ«ç§Ÿæˆ·ID
     * ä¼˜å…ˆçº§ï¼šè¯·æ±‚å¤´ > å­åŸŸå > åŸŸåæ˜ å°„
     */
    public Optional<Long> identifyTenantId() {
        ServletRequestAttributes attributes = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        
        if (attributes == null) {
            return Optional.empty();
        }

        HttpServletRequest request = attributes.getRequest();

        // æ–¹å¼1ï¼šä»è¯·æ±‚å¤´è·å–
        String tenantCode = request.getHeader("X-Tenant-Code");
        if (tenantCode != null && !tenantCode.isEmpty()) {
            // TODO: æ ¹æ®tenantCodeæŸ¥è¯¢tenantId
            // return Optional.of(tenantId);
        }

        // æ–¹å¼2ï¼šä»å­åŸŸåè·å–
        String host = request.getHeader("Host");
        if (host != null) {
            // ä¾‹å¦‚ï¼štenant1.yulu.com -> tenant1
            String subdomain = extractSubdomain(host);
            if (subdomain != null) {
                // TODO: æ ¹æ®subdomainæŸ¥è¯¢tenantId
                // return Optional.of(tenantId);
            }
        }

        // æ–¹å¼3ï¼šä»åŸŸåæ˜ å°„è¡¨è·å–
        // TODO: å®ç°åŸŸååˆ°ç§Ÿæˆ·çš„æ˜ å°„

        return Optional.empty();
    }

    /**
     * ä»Hostå¤´ä¸­æå–å­åŸŸå
     */
    private String extractSubdomain(String host) {
        if (host == null || host.isEmpty()) {
            return null;
        }
        
        // ç§»é™¤ç«¯å£å·
        host = host.split(":")[0];
        
        // å¦‚æœæ˜¯ localhost æˆ– IPï¼Œè¿”å›null
        if (host.equals("localhost") || host.matches("^\\d+\\.\\d+\\.\\d+\\.\\d+$")) {
            return null;
        }
        
        // æå–å­åŸŸåï¼štenant1.yulu.com -> tenant1
        String[] parts = host.split("\\.");
        if (parts.length >= 3) {
            return parts[0];
        }
        
        return null;
    }

    /**
     * æ ¹æ®ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆtenantIdentifierï¼‰æŸ¥è¯¢ç§Ÿæˆ·ID
     * tenantIdentifieræ˜¯ç»™Cç«¯ç”¨æˆ·ä½¿ç”¨çš„ï¼Œæ¯”tenantCodeæ›´å‹å¥½
     */
    public Optional<Long> identifyByTenantIdentifier(String tenantIdentifier) {
        // TODO: å®ç°ç§Ÿæˆ·æ ‡è¯†ç åˆ°tenantIdçš„æŸ¥è¯¢
        // å¯ä»¥åœ¨Tenantè¡¨ä¸­å¢åŠ tenantIdentifierå­—æ®µ
        return Optional.empty();
    }
}
```

### æ­¥éª¤2ï¼šåˆ›å»ºCç«¯ç™»å½•DTO

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/customer/dto/CustomerLoginRequest.java`

```java
package com.ityfz.yulu.customer.dto;

import javax.validation.constraints.NotBlank;
import lombok.Data;

/**
 * Cç«¯ç™»å½•è¯·æ±‚
 * ä¸éœ€è¦tenantCodeï¼Œç§Ÿæˆ·é€šè¿‡å…¶ä»–æ–¹å¼è¯†åˆ«
 */
@Data
public class CustomerLoginRequest {
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    private String username;

    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    private String password;

    /**
     * ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆå¯é€‰ï¼‰
     * å¦‚æœé€šè¿‡è¯·æ±‚å¤´/åŸŸåæ— æ³•è¯†åˆ«ç§Ÿæˆ·ï¼Œå¯ä»¥ä½¿ç”¨æ­¤å­—æ®µ
     */
    private String tenantIdentifier;
}
```

### æ­¥éª¤3ï¼šåˆ›å»ºCç«¯æ³¨å†ŒDTO

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/customer/dto/CustomerRegisterRequest.java`

```java
package com.ityfz.yulu.customer.dto;

import javax.validation.constraints.NotBlank;
import lombok.Data;

/**
 * Cç«¯æ³¨å†Œè¯·æ±‚
 * ä½¿ç”¨tenantIdentifierè€Œä¸æ˜¯tenantCode
 */
@Data
public class CustomerRegisterRequest {
    /**
     * ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆå¿…å¡«ï¼‰
     * ä¾‹å¦‚ï¼šEDU_001ã€COMPANY_ABC
     * è¿™æ˜¯ç§Ÿæˆ·å¯¹å¤–æä¾›çš„æ ‡è¯†ï¼Œæ¯”tenantCodeæ›´å‹å¥½
     */
    @NotBlank(message = "ç§Ÿæˆ·æ ‡è¯†ç ä¸èƒ½ä¸ºç©º")
    private String tenantIdentifier;

    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    private String username;

    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    private String password;

    private String nickName;
    private String email;
    private String phone;
}
```

### æ­¥éª¤4ï¼šåˆ›å»ºCç«¯è®¤è¯Controller

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/customer/controller/CustomerAuthController.java`

```java
package com.ityfz.yulu.customer.controller;

import com.ityfz.yulu.common.error.ErrorCodes;
import com.ityfz.yulu.common.exception.BizException;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.tenant.TenantContextHolder;
import com.ityfz.yulu.common.tenant.TenantIdentifier;
import com.ityfz.yulu.customer.dto.CustomerLoginRequest;
import com.ityfz.yulu.customer.dto.CustomerRegisterRequest;
import com.ityfz.yulu.user.dto.LoginResponse;
import com.ityfz.yulu.user.entity.Tenant;
import com.ityfz.yulu.user.entity.User;
import com.ityfz.yulu.user.mapper.TenantMapper;
import com.ityfz.yulu.user.mapper.UserMapper;
import com.ityfz.yulu.user.service.UserService;
import com.ityfz.yulu.common.security.JwtUtil;
import com.ityfz.yulu.common.security.JwtUtil.LoginUser;
import lombok.RequiredArgsConstructor;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.time.Duration;
import java.util.Optional;

/**
 * Cç«¯è®¤è¯Controller
 * APIå‰ç¼€ï¼š/api/customer/auth
 * æƒé™ï¼šæ— éœ€æƒé™ï¼ˆå…¬å¼€æ¥å£ï¼‰
 */
@RestController
@RequestMapping("/api/customer/auth")
@RequiredArgsConstructor
public class CustomerAuthController {

    private final TenantMapper tenantMapper;
    private final UserMapper userMapper;
    private final UserService userService;
    private final TenantIdentifier tenantIdentifier;
    private final BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder();

    /**
     * Cç«¯ç™»å½•
     * POST /api/customer/auth/login
     */
    @PostMapping("/login")
    public ApiResponse<LoginResponse> login(@Valid @RequestBody CustomerLoginRequest request) {
        // 1. è¯†åˆ«ç§Ÿæˆ·
        Long tenantId = identifyTenant(request.getTenantIdentifier());
        
        // 2. æŸ¥è¯¢ç§Ÿæˆ·
        Tenant tenant = tenantMapper.selectById(tenantId);
        if (tenant == null || tenant.getStatus() != 1) {
            throw new BizException(ErrorCodes.TENANT_NOT_FOUND, "ç§Ÿæˆ·ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
        }

        // 3. è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
        TenantContextHolder.setTenantId(tenantId);
        try {
            // 4. æŸ¥è¯¢ç”¨æˆ·ï¼ˆå¿…é¡»æ˜¯USERè§’è‰²ï¼‰
            User user = userMapper.selectOne(
                new com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper<User>()
                    .eq(User::getTenantId, tenantId)
                    .eq(User::getUsername, request.getUsername())
                    .eq(User::getRole, "USER")  // Cç«¯ç™»å½•åªèƒ½æ˜¯USERè§’è‰²
            );

            if (user == null || user.getStatus() != 1) {
                throw new BizException(ErrorCodes.USER_NOT_FOUND, "ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
            }

            if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
                throw new BizException(ErrorCodes.BAD_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            }

            // 5. ç”ŸæˆToken
            LoginUser loginUser = new LoginUser();
            loginUser.setUserId(user.getId());
            loginUser.setTenantId(tenantId);
            loginUser.setRole(user.getRole());
            loginUser.setUsername(user.getUsername());

            String token = JwtUtil.generateToken(loginUser);

            LoginResponse response = new LoginResponse();
            response.setToken(token);
            response.setExpireIn(Duration.ofHours(12).toSeconds());
            response.setUserId(user.getId());
            response.setTenantId(tenantId);
            response.setRole(user.getRole());
            response.setUsername(user.getUsername());

            return ApiResponse.success("ç™»å½•æˆåŠŸ", response);
        } finally {
            TenantContextHolder.clear();
        }
    }

    /**
     * Cç«¯æ³¨å†Œ
     * POST /api/customer/auth/register
     */
    @PostMapping("/register")
    public ApiResponse<LoginResponse> register(@Valid @RequestBody CustomerRegisterRequest request) {
        // 1. æ ¹æ®tenantIdentifieræŸ¥è¯¢ç§Ÿæˆ·
        Tenant tenant = tenantMapper.selectOne(
            new com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper<Tenant>()
                .eq(Tenant::getTenantIdentifier, request.getTenantIdentifier())
        );

        if (tenant == null || tenant.getStatus() != 1) {
            throw new BizException(ErrorCodes.TENANT_NOT_FOUND, 
                "ç§Ÿæˆ·æ ‡è¯†ç ä¸å­˜åœ¨æˆ–ç§Ÿæˆ·å·²ç¦ç”¨");
        }

        // 2. æ ¡éªŒç”¨æˆ·åå”¯ä¸€æ€§
        TenantContextHolder.setTenantId(tenant.getId());
        try {
            boolean exists = userService.lambdaQuery()
                .eq(User::getTenantId, tenant.getId())
                .eq(User::getUsername, request.getUsername())
                .exists();
            
            if (exists) {
                throw new BizException(ErrorCodes.USER_EXISTS, "ç”¨æˆ·åå·²å­˜åœ¨");
            }

            // 3. åˆ›å»ºç”¨æˆ·ï¼ˆå›ºå®šä¸ºUSERè§’è‰²ï¼‰
            User user = new User();
            user.setTenantId(tenant.getId());
            user.setUsername(request.getUsername());
            user.setPassword(passwordEncoder.encode(request.getPassword()));
            user.setRole("USER");  // Cç«¯æ³¨å†Œå›ºå®šä¸ºUSERè§’è‰²
            user.setStatus(1);
            user.setNickName(request.getNickName());
            user.setEmail(request.getEmail());
            user.setPhone(request.getPhone());
            userService.save(user);

            // 4. è‡ªåŠ¨ç™»å½•ï¼ˆè¿”å›Tokenï¼‰
            LoginUser loginUser = new LoginUser();
            loginUser.setUserId(user.getId());
            loginUser.setTenantId(tenant.getId());
            loginUser.setRole(user.getRole());
            loginUser.setUsername(user.getUsername());

            String token = JwtUtil.generateToken(loginUser);

            LoginResponse response = new LoginResponse();
            response.setToken(token);
            response.setExpireIn(Duration.ofHours(12).toSeconds());
            response.setUserId(user.getId());
            response.setTenantId(tenant.getId());
            response.setRole(user.getRole());
            response.setUsername(user.getUsername());

            return ApiResponse.success("æ³¨å†ŒæˆåŠŸ", response);
        } finally {
            TenantContextHolder.clear();
        }
    }

    /**
     * è¯†åˆ«ç§Ÿæˆ·ID
     */
    private Long identifyTenant(String tenantIdentifier) {
        // ä¼˜å…ˆçº§1ï¼šå¦‚æœè¯·æ±‚ä¸­æä¾›äº†tenantIdentifierï¼Œä½¿ç”¨å®ƒ
        if (tenantIdentifier != null && !tenantIdentifier.isEmpty()) {
            Optional<Long> tenantId = tenantIdentifier.identifyByTenantIdentifier(tenantIdentifier);
            if (tenantId.isPresent()) {
                return tenantId.get();
            }
        }

        // ä¼˜å…ˆçº§2ï¼šä»è¯·æ±‚å¤´/åŸŸåè‡ªåŠ¨è¯†åˆ«
        Optional<Long> tenantId = tenantIdentifier.identifyTenantId();
        if (tenantId.isPresent()) {
            return tenantId.get();
        }

        throw new BizException(ErrorCodes.TENANT_REQUIRED, 
            "æ— æ³•è¯†åˆ«ç§Ÿæˆ·ï¼Œè¯·æä¾›ç§Ÿæˆ·æ ‡è¯†ç ");
    }
}
```

### æ­¥éª¤5ï¼šåˆ›å»ºBç«¯è®¤è¯Controller

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/admin/controller/AdminAuthController.java`

```java
package com.ityfz.yulu.admin.controller;

import com.ityfz.yulu.common.annotation.RequireAnyRole;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.user.dto.LoginRequest;
import com.ityfz.yulu.user.dto.LoginResponse;
import com.ityfz.yulu.user.dto.TenantRegisterRequest;
import com.ityfz.yulu.user.dto.TenantRegisterResponse;
import com.ityfz.yulu.user.service.TenantService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;

/**
 * Bç«¯è®¤è¯Controller
 * APIå‰ç¼€ï¼š/api/admin/auth
 * æƒé™ï¼šéƒ¨åˆ†æ¥å£éœ€è¦æƒé™ï¼Œéƒ¨åˆ†å…¬å¼€
 */
@RestController
@RequestMapping("/api/admin/auth")
@RequiredArgsConstructor
public class AdminAuthController {

    private final TenantService tenantService;

    /**
     * Bç«¯ç™»å½•ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰
     * POST /api/admin/auth/login
     * éœ€è¦tenantCodeï¼Œå› ä¸ºBç«¯ç”¨æˆ·å¯èƒ½ç®¡ç†å¤šä¸ªç§Ÿæˆ·
     */
    @PostMapping("/login")
    public ApiResponse<LoginResponse> login(@Valid @RequestBody LoginRequest request) {
        // å¤ç”¨ç°æœ‰çš„ç™»å½•é€»è¾‘
        LoginResponse response = tenantService.login(request);
        return ApiResponse.success("ç™»å½•æˆåŠŸ", response);
    }

    /**
     * ç§Ÿæˆ·æ³¨å†Œï¼ˆåˆ›å»ºç§Ÿæˆ·+ç®¡ç†å‘˜è´¦æˆ·ï¼‰
     * POST /api/admin/auth/registerTenant
     * å…¬å¼€æ¥å£ï¼Œæ— éœ€æƒé™
     */
    @PostMapping("/registerTenant")
    public ApiResponse<TenantRegisterResponse> registerTenant(
            @Valid @RequestBody TenantRegisterRequest request) {
        TenantRegisterResponse response = tenantService.registerTenant(request);
        return ApiResponse.success("ç§Ÿæˆ·æ³¨å†ŒæˆåŠŸ", response);
    }
}
```

### æ­¥éª¤6ï¼šæ›´æ–°Tenantå®ä½“ï¼ˆæ·»åŠ tenantIdentifierå­—æ®µï¼‰

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/user/entity/Tenant.java`

```java
// åœ¨Tenantç±»ä¸­æ·»åŠ å­—æ®µï¼š
/**
 * ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆå¯¹å¤–ä½¿ç”¨ï¼Œæ¯”tenantCodeæ›´å‹å¥½ï¼‰
 * ä¾‹å¦‚ï¼šEDU_001ã€COMPANY_ABC
 * Cç«¯ç”¨æˆ·ä½¿ç”¨æ­¤å­—æ®µæ³¨å†Œ/ç™»å½•ï¼Œè€Œä¸æ˜¯tenantCode
 */
private String tenantIdentifier;
```

**æ•°æ®åº“è¿ç§»SQL**ï¼š
```sql
ALTER TABLE tenant ADD COLUMN tenant_identifier VARCHAR(64) UNIQUE COMMENT 'ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆCç«¯ä½¿ç”¨ï¼‰';
-- ä¸ºç°æœ‰ç§Ÿæˆ·è®¾ç½®tenantIdentifierï¼ˆå¯ä»¥ç­‰äºtenantCodeï¼‰
UPDATE tenant SET tenant_identifier = tenant_code WHERE tenant_identifier IS NULL;
```

### æ­¥éª¤7ï¼šæ›´æ–°ç°æœ‰AuthControllerï¼ˆæ ‡è®°ä¸ºåºŸå¼ƒï¼‰

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/user/controller/AuthController.java`

```java
/**
 * è®¤è¯Controllerï¼ˆæ—§ç‰ˆï¼Œä¿æŒå…¼å®¹ï¼‰
 * 
 * @deprecated è¯·ä½¿ç”¨ CustomerAuthController æˆ– AdminAuthController
 * æ­¤Controllerå°†åœ¨åç»­ç‰ˆæœ¬ä¸­ç§»é™¤
 */
@Deprecated
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    // ... ä¿æŒåŸæœ‰ä»£ç ä¸å˜ï¼Œä½†æ·»åŠ @Deprecatedæ³¨è§£
}
```

---

## ğŸ“ å››ã€å®æ–½æ£€æŸ¥æ¸…å•

### âœ… æ­¥éª¤1ï¼šæ•°æ®åº“æ›´æ–°
- [ ] åœ¨`tenant`è¡¨æ·»åŠ `tenant_identifier`å­—æ®µ
- [ ] ä¸ºç°æœ‰ç§Ÿæˆ·è®¾ç½®`tenant_identifier`å€¼
- [ ] åˆ›å»ºç´¢å¼•ï¼š`CREATE INDEX idx_tenant_identifier ON tenant(tenant_identifier);`

### âœ… æ­¥éª¤2ï¼šåˆ›å»ºå·¥å…·ç±»
- [ ] åˆ›å»º`TenantIdentifier`å·¥å…·ç±»
- [ ] å®ç°ç§Ÿæˆ·è¯†åˆ«é€»è¾‘ï¼ˆè¯·æ±‚å¤´ã€å­åŸŸåã€åŸŸåæ˜ å°„ï¼‰

### âœ… æ­¥éª¤3ï¼šåˆ›å»ºDTO
- [ ] åˆ›å»º`CustomerLoginRequest`
- [ ] åˆ›å»º`CustomerRegisterRequest`

### âœ… æ­¥éª¤4ï¼šåˆ›å»ºController
- [ ] åˆ›å»º`CustomerAuthController`ï¼ˆ`/api/customer/auth/*`ï¼‰
- [ ] åˆ›å»º`AdminAuthController`ï¼ˆ`/api/admin/auth/*`ï¼‰
- [ ] æ ‡è®°æ—§`AuthController`ä¸º`@Deprecated`

### âœ… æ­¥éª¤5ï¼šæ›´æ–°å®ä½“ç±»
- [ ] åœ¨`Tenant`å®ä½“æ·»åŠ `tenantIdentifier`å­—æ®µ
- [ ] æ›´æ–°Mapperï¼ˆå¦‚æœéœ€è¦ï¼‰

### âœ… æ­¥éª¤6ï¼šæµ‹è¯•éªŒè¯
- [ ] æµ‹è¯•Cç«¯ç™»å½•ï¼ˆä¸éœ€è¦tenantCodeï¼‰
- [ ] æµ‹è¯•Cç«¯æ³¨å†Œï¼ˆä½¿ç”¨tenantIdentifierï¼‰
- [ ] æµ‹è¯•Bç«¯ç™»å½•ï¼ˆéœ€è¦tenantCodeï¼‰
- [ ] æµ‹è¯•Bç«¯ç§Ÿæˆ·æ³¨å†Œ
- [ ] æµ‹è¯•ç§Ÿæˆ·è¯†åˆ«ï¼ˆè¯·æ±‚å¤´ã€å­åŸŸåï¼‰

---

## ğŸ” äº”ã€ç§Ÿæˆ·è¯†åˆ«ç­–ç•¥è¯¦è§£

### 5.1 è¯·æ±‚å¤´æ–¹å¼ï¼ˆæ¨èï¼‰

**å‰ç«¯è®¾ç½®**ï¼š
```javascript
// åœ¨axiosæ‹¦æˆªå™¨ä¸­è®¾ç½®
axios.defaults.headers.common['X-Tenant-Code'] = 'EDU_001';
```

**åç«¯è¯†åˆ«**ï¼š
```java
String tenantCode = request.getHeader("X-Tenant-Code");
```

### 5.2 å­åŸŸåæ–¹å¼

**é…ç½®ç¤ºä¾‹**ï¼š
- `edu001.yulu.com` â†’ ç§Ÿæˆ·ï¼š`EDU_001`
- `company-abc.yulu.com` â†’ ç§Ÿæˆ·ï¼š`COMPANY_ABC`

**å®ç°**ï¼šåœ¨`TenantIdentifier`ä¸­è§£æå­åŸŸåå¹¶æŸ¥è¯¢ç§Ÿæˆ·

### 5.3 åŸŸåæ˜ å°„è¡¨æ–¹å¼

**æ•°æ®åº“è¡¨**ï¼š`tenant_domain`
```sql
CREATE TABLE tenant_domain (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    domain VARCHAR(255) NOT NULL UNIQUE,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## ğŸ¯ å…­ã€å‰ç«¯é€‚é…å»ºè®®

### 6.1 Cç«¯ç™»å½•è¡¨å•

**ç§»é™¤tenantCodeè¾“å…¥æ¡†**ï¼Œæ”¹ä¸ºï¼š
- é€šè¿‡è¯·æ±‚å¤´è‡ªåŠ¨è®¾ç½®ç§Ÿæˆ·
- æˆ–æä¾›ç§Ÿæˆ·æ ‡è¯†ç è¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼‰

### 6.2 APIè°ƒç”¨è·¯å¾„

- Cç«¯ç™»å½•ï¼š`/api/customer/auth/login`
- Cç«¯æ³¨å†Œï¼š`/api/customer/auth/register`
- Bç«¯ç™»å½•ï¼š`/api/admin/auth/login`
- Bç«¯æ³¨å†Œï¼š`/api/admin/auth/registerTenant`

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¶é—´**ï¼š2026-01-14

