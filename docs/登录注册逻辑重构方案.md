# ç™»å½•é€»è¾‘é‡æ„æ–¹æ¡ˆï¼ˆå‰åç«¯åŒ¹é…ç‰ˆï¼‰

## ğŸ“‹ ä¸€ã€å½“å‰é—®é¢˜åˆ†æ

### 1.1 ç°æœ‰ç™»å½•æ¥å£

| æ¥å£ | è·¯å¾„ | è¯´æ˜ | é—®é¢˜ |
|------|------|------|------|
| ç™»å½• | `/api/auth/login` | éœ€è¦ `tenantCode` + `username` + `password` | âŒ Bç«¯å’ŒCç«¯å…±ç”¨ï¼ŒCç«¯ç”¨æˆ·ä¸åº”è¯¥çŸ¥é“tenantCode |

### 1.2 æ ¸å¿ƒé—®é¢˜

1. **Cç«¯ç”¨æˆ·ä¸åº”è¯¥çŸ¥é“tenantCode**
   - Cç«¯ç”¨æˆ·ï¼ˆç§Ÿæˆ·çš„å®¢æˆ·ï¼‰ä¸åº”è¯¥éœ€è¦è¾“å…¥ç§Ÿæˆ·ç¼–ç 
   - ç§Ÿæˆ·è¯†åˆ«åº”è¯¥é€šè¿‡URLå‚æ•°è‡ªåŠ¨ä¼ é€’ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

2. **ç™»å½•æ¥å£æ²¡æœ‰åŒºåˆ†Bç«¯å’ŒCç«¯**
   - Bç«¯ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰ï¼šéœ€è¦tenantCodeï¼Œå› ä¸ºå¯èƒ½ç®¡ç†å¤šä¸ªç§Ÿæˆ·
   - Cç«¯ï¼ˆå®¢æˆ·ï¼‰ï¼šä¸éœ€è¦tenantCodeï¼Œé€šè¿‡URLå‚æ•°æˆ–è¯·æ±‚å¤´è‡ªåŠ¨è¯†åˆ«

---

## ğŸ¯ äºŒã€é‡æ„ç›®æ ‡

### 2.1 æ¥å£åˆ†ç¦»

| ç”¨æˆ·ç±»å‹ | ç™»å½•æ¥å£ | è¯´æ˜ |
|---------|---------|------|
| **Bç«¯ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰** | `/api/admin/auth/login` | éœ€è¦tenantCode + username + password |
| **Cç«¯ï¼ˆå®¢æˆ·ï¼‰** | `/api/customer/auth/login` | åªéœ€è¦username + passwordï¼Œç§Ÿæˆ·æ ‡è¯†é€šè¿‡URLå‚æ•°æˆ–è¯·æ±‚å¤´è‡ªåŠ¨è¯†åˆ« |

### 2.2 å‰ç«¯å®ç°ï¼ˆå·²å®Œæˆï¼‰

**ç»Ÿä¸€ç™»å½•é¡µé¢**ï¼š`/login`
- é»˜è®¤æ˜¾ç¤ºCç«¯ç™»å½•ç•Œé¢ï¼ˆåªéœ€è¦ç”¨æˆ·åå’Œå¯†ç ï¼‰
- é¡µé¢åº•éƒ¨æœ‰"æˆ‘æ˜¯ç®¡ç†å‘˜ â†’"é“¾æ¥ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°Bç«¯ç™»å½•ç•Œé¢
- Bç«¯ç™»å½•ç•Œé¢æ˜¾ç¤ºï¼šç§Ÿæˆ·ç¼–ç ã€ç”¨æˆ·åã€å¯†ç 

**Cç«¯ç™»å½•æµç¨‹**ï¼š
1. ç§Ÿæˆ·åœ¨è‡ªå·±çš„ç½‘ç«™æ”¾ç½®é“¾æ¥ï¼š`https://yulu.com/login?tenant=EDU_001`
2. ç”¨æˆ·ç‚¹å‡»é“¾æ¥ï¼Œè‡ªåŠ¨å¸¦ä¸Šç§Ÿæˆ·æ ‡è¯†ï¼ˆä¸æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼‰
3. ç”¨æˆ·åªéœ€è¾“å…¥ç”¨æˆ·åå’Œå¯†ç å³å¯ç™»å½•

**Bç«¯ç™»å½•æµç¨‹**ï¼š
1. è®¿é—® `/login` é¡µé¢
2. ç‚¹å‡»"æˆ‘æ˜¯ç®¡ç†å‘˜ â†’"åˆ‡æ¢åˆ°Bç«¯ç™»å½•
3. è¾“å…¥ç§Ÿæˆ·ç¼–ç ã€ç”¨æˆ·åã€å¯†ç ç™»å½•

### 2.3 ç§Ÿæˆ·è¯†åˆ«ç­–ç•¥

**Cç«¯ç§Ÿæˆ·è¯†åˆ«æ–¹å¼ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š**
1. **URLå‚æ•°**ï¼š`/login?tenant=EDU_001` â†’ ä»URLå‚æ•°è·å–ç§Ÿæˆ·æ ‡è¯†
2. **è¯·æ±‚å¤´**ï¼š`X-Tenant-Identifier` â†’ å‰ç«¯axiosæ‹¦æˆªå™¨è‡ªåŠ¨è®¾ç½®ï¼ˆä»localStorageè¯»å–ï¼‰

**æ³¨æ„**ï¼šCç«¯ç™»å½•é¡µé¢**ä¸æ˜¾ç¤º**ç§Ÿæˆ·æ ‡è¯†è¾“å…¥æ¡†ï¼Œå®Œå…¨é€šè¿‡URLå‚æ•°æˆ–è¯·æ±‚å¤´è‡ªåŠ¨è¯†åˆ«ã€‚

---

## ğŸ”§ ä¸‰ã€åç«¯è¯¦ç»†å®ç°æ–¹æ¡ˆ

### æ­¥éª¤1ï¼šæ•°æ®åº“æ›´æ–°ï¼ˆæ·»åŠ tenant_identifierå­—æ®µï¼‰

**SQLè„šæœ¬**ï¼š
```sql
-- æ·»åŠ ç§Ÿæˆ·æ ‡è¯†ç å­—æ®µï¼ˆCç«¯ä½¿ç”¨ï¼‰
ALTER TABLE tenant ADD COLUMN tenant_identifier VARCHAR(64) UNIQUE COMMENT 'ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆCç«¯ä½¿ç”¨ï¼‰';

-- ä¸ºç°æœ‰ç§Ÿæˆ·è®¾ç½®tenantIdentifierï¼ˆå¯ä»¥ç­‰äºtenantCodeï¼‰
UPDATE tenant SET tenant_identifier = tenant_code WHERE tenant_identifier IS NULL;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_tenant_identifier ON tenant(tenant_identifier);
```

### æ­¥éª¤2ï¼šæ›´æ–°Tenantå®ä½“ç±»

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/user/entity/Tenant.java`

```java
// åœ¨Tenantç±»ä¸­æ·»åŠ å­—æ®µï¼š
/**
 * ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆå¯¹å¤–ä½¿ç”¨ï¼Œæ¯”tenantCodeæ›´å‹å¥½ï¼‰
 * ä¾‹å¦‚ï¼šEDU_001ã€COMPANY_ABC
 * Cç«¯ç”¨æˆ·ä½¿ç”¨æ­¤å­—æ®µç™»å½•ï¼Œè€Œä¸æ˜¯tenantCode
 */
@TableField("tenant_identifier")
private String tenantIdentifier;
```

### æ­¥éª¤3ï¼šåˆ›å»ºç§Ÿæˆ·è¯†åˆ«å·¥å…·ç±»

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/common/tenant/TenantIdentifier.java`

```java
package com.ityfz.yulu.common.tenant;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.ityfz.yulu.user.entity.Tenant;
import com.ityfz.yulu.user.mapper.TenantMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.util.Optional;

/**
 * ç§Ÿæˆ·è¯†åˆ«å·¥å…·ç±»
 * ç”¨äºCç«¯åœºæ™¯ä¸‹è‡ªåŠ¨è¯†åˆ«ç§Ÿæˆ·ï¼Œæ— éœ€ç”¨æˆ·è¾“å…¥tenantCode
 * è¯†åˆ«æ–¹å¼ï¼šURLå‚æ•° > è¯·æ±‚å¤´
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class TenantIdentifier {

    private final TenantMapper tenantMapper;

    /**
     * ä»è¯·æ±‚ä¸­è¯†åˆ«ç§Ÿæˆ·ID
     * ä¼˜å…ˆçº§ï¼šURLå‚æ•° > è¯·æ±‚å¤´
     */
    public Optional<Long> identifyTenantId() {
        ServletRequestAttributes attributes = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        
        if (attributes == null) {
            return Optional.empty();
        }

        HttpServletRequest request = attributes.getRequest();

        // æ–¹å¼1ï¼šä»URLå‚æ•°è·å–ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
        String tenantIdentifier = request.getParameter("tenant");
        if (tenantIdentifier != null && !tenantIdentifier.isEmpty()) {
            Optional<Long> tenantId = identifyByTenantIdentifier(tenantIdentifier);
            if (tenantId.isPresent()) {
                log.debug("ä»URLå‚æ•°è¯†åˆ«ç§Ÿæˆ·: tenantIdentifier={}, tenantId={}", 
                    tenantIdentifier, tenantId.get());
                return tenantId;
            }
        }

        // æ–¹å¼2ï¼šä»è¯·æ±‚å¤´è·å–
        tenantIdentifier = request.getHeader("X-Tenant-Identifier");
        if (tenantIdentifier != null && !tenantIdentifier.isEmpty()) {
            Optional<Long> tenantId = identifyByTenantIdentifier(tenantIdentifier);
            if (tenantId.isPresent()) {
                log.debug("ä»è¯·æ±‚å¤´è¯†åˆ«ç§Ÿæˆ·: tenantIdentifier={}, tenantId={}", 
                    tenantIdentifier, tenantId.get());
                return tenantId;
            }
        }

        return Optional.empty();
    }

    /**
     * æ ¹æ®ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆtenantIdentifierï¼‰æŸ¥è¯¢ç§Ÿæˆ·ID
     * tenantIdentifieræ˜¯ç»™Cç«¯ç”¨æˆ·ä½¿ç”¨çš„ï¼Œæ¯”tenantCodeæ›´å‹å¥½
     * ä¾‹å¦‚ï¼šEDU_001ã€COMPANY_ABC
     */
    public Optional<Long> identifyByTenantIdentifier(String tenantIdentifier) {
        if (tenantIdentifier == null || tenantIdentifier.isEmpty()) {
            return Optional.empty();
        }

        Tenant tenant = tenantMapper.selectOne(
            new LambdaQueryWrapper<Tenant>()
                .eq(Tenant::getTenantIdentifier, tenantIdentifier)
                .eq(Tenant::getStatus, 1)  // åªæŸ¥è¯¢å¯ç”¨çš„ç§Ÿæˆ·
        );

        if (tenant != null) {
            return Optional.of(tenant.getId());
        }

        log.warn("æœªæ‰¾åˆ°ç§Ÿæˆ·æ ‡è¯†ç å¯¹åº”çš„ç§Ÿæˆ·: tenantIdentifier={}", tenantIdentifier);
        return Optional.empty();
    }
}
```

### æ­¥éª¤4ï¼šåˆ›å»ºCç«¯ç™»å½•DTO

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/customer/dto/CustomerLoginRequest.java`

```java
package com.ityfz.yulu.customer.dto;

import javax.validation.constraints.NotBlank;
import lombok.Data;

	/**
	 * Cç«¯ç™»å½•è¯·æ±‚
	 * ä¸éœ€è¦tenantCodeï¼Œç§Ÿæˆ·é€šè¿‡URLå‚æ•°æˆ–è¯·æ±‚å¤´è‡ªåŠ¨è¯†åˆ«
	 */
@Data
public class CustomerLoginRequest {
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    private String username;

    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    private String password;

    /**
     * ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆå¯é€‰ï¼‰
     * å¦‚æœé€šè¿‡URLå‚æ•°/è¯·æ±‚å¤´æ— æ³•è¯†åˆ«ç§Ÿæˆ·ï¼Œå¯ä»¥ä½¿ç”¨æ­¤å­—æ®µ
     * å‰ç«¯ä¼šä»URLå‚æ•°è·å–å¹¶ä¼ é€’
     */
    private String tenantIdentifier;
}
```

### æ­¥éª¤5ï¼šåˆ›å»ºCç«¯è®¤è¯Controller

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/customer/controller/CustomerAuthController.java`

```java
package com.ityfz.yulu.customer.controller;

import com.ityfz.yulu.common.error.ErrorCodes;
import com.ityfz.yulu.common.exception.BizException;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.tenant.TenantContextHolder;
import com.ityfz.yulu.common.tenant.TenantIdentifier;
import com.ityfz.yulu.customer.dto.CustomerLoginRequest;
import com.ityfz.yulu.common.dto.LoginResponse;
import com.ityfz.yulu.user.entity.Tenant;
import com.ityfz.yulu.user.entity.User;
import com.ityfz.yulu.user.mapper.TenantMapper;
import com.ityfz.yulu.user.mapper.UserMapper;
import com.ityfz.yulu.common.security.JwtUtil;
import com.ityfz.yulu.common.security.JwtUtil.LoginUser;
import lombok.RequiredArgsConstructor;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.time.Duration;
import java.util.Optional;

/**
 * Cç«¯è®¤è¯Controller
 * APIå‰ç¼€ï¼š/api/customer/auth
 * æƒé™ï¼šæ— éœ€æƒé™ï¼ˆå…¬å¼€æ¥å£ï¼‰
 */
@RestController
@RequestMapping("/api/customer/auth")
@RequiredArgsConstructor
public class CustomerAuthController {

   private final TenantMapper tenantMapper;
   private final UserMapper userMapper;
   private final TenantIdentifier tenantIdentifier;
   private final BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder();

   /**
    * Cç«¯ç™»å½•
    * POST /api/customer/auth/login?tenant=EDU_001
    * æˆ– POST /api/customer/auth/loginï¼ˆè¯·æ±‚å¤´åŒ…å«X-Tenant-Identifierï¼‰
    */
   @PostMapping("/login")
   public ApiResponse<LoginResponse> login(
           @RequestParam(required = false) String tenant,  // ä»URLå‚æ•°è·å–
           @Valid @RequestBody CustomerLoginRequest request) {

      // 1. è¯†åˆ«ç§Ÿæˆ·ï¼ˆä¼˜å…ˆçº§ï¼šURLå‚æ•° > è¯·æ±‚å¤´ > è¯·æ±‚ä½“ï¼‰
      String tenantIdentifierValue = tenant != null ? tenant : request.getTenantIdentifier();
      Long tenantId = identifyTenant(tenantIdentifierValue);

      // 2. æŸ¥è¯¢ç§Ÿæˆ·
      Tenant tenantEntity = tenantMapper.selectById(tenantId);
      if (tenantEntity == null || tenantEntity.getStatus() != 1) {
         throw new BizException(ErrorCodes.TENANT_NOT_FOUND, "ç§Ÿæˆ·ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
      }

      // 3. è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
      TenantContextHolder.setTenantId(tenantId);
      try {
         // 4. æŸ¥è¯¢ç”¨æˆ·ï¼ˆå¿…é¡»æ˜¯USERè§’è‰²ï¼‰
         User user = userMapper.selectOne(
                 new com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper<User>()
                         .eq(User::getTenantId, tenantId)
                         .eq(User::getUsername, request.getUsername())
                         .eq(User::getRole, "USER")  // Cç«¯ç™»å½•åªèƒ½æ˜¯USERè§’è‰²
         );

         if (user == null || user.getStatus() != 1) {
            throw new BizException(ErrorCodes.USER_NOT_FOUND, "ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
         }

         if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            throw new BizException(ErrorCodes.BAD_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
         }

         // 5. ç”ŸæˆToken
         LoginUser loginUser = new LoginUser();
         loginUser.setUserId(user.getId());
         loginUser.setTenantId(tenantId);
         loginUser.setRole(user.getRole());
         loginUser.setUsername(user.getUsername());

         String token = JwtUtil.generateToken(loginUser);

         LoginResponse response = new LoginResponse();
         response.setToken(token);
         response.setExpireIn(Duration.ofHours(12).toSeconds());
         response.setUserId(user.getId());
         response.setTenantId(tenantId);
         response.setRole(user.getRole());
         response.setUsername(user.getUsername());

         return ApiResponse.success("ç™»å½•æˆåŠŸ", response);
      } finally {
         TenantContextHolder.clear();
      }
   }

   /**
    * è¯†åˆ«ç§Ÿæˆ·ID
    */
   private Long identifyTenant(String tenantIdentifierValue) {
      // ä¼˜å…ˆçº§1ï¼šå¦‚æœè¯·æ±‚ä¸­æä¾›äº†tenantIdentifierï¼Œä½¿ç”¨å®ƒ
      if (tenantIdentifierValue != null && !tenantIdentifierValue.isEmpty()) {
         Optional<Long> tenantId = tenantIdentifier.identifyByTenantIdentifier(tenantIdentifierValue);
         if (tenantId.isPresent()) {
            return tenantId.get();
         }
         throw new BizException(ErrorCodes.TENANT_NOT_FOUND,
                 "ç§Ÿæˆ·æ ‡è¯†ç ä¸å­˜åœ¨: " + tenantIdentifierValue);
      }

      // ä¼˜å…ˆçº§2ï¼šä»è¯·æ±‚å¤´/URLå‚æ•°è‡ªåŠ¨è¯†åˆ«
      Optional<Long> tenantId = tenantIdentifier.identifyTenantId();
      if (tenantId.isPresent()) {
         return tenantId.get();
      }

      throw new BizException(ErrorCodes.TENANT_REQUIRED,
              "æ— æ³•è¯†åˆ«ç§Ÿæˆ·ï¼Œè¯·æä¾›ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆå¯é€šè¿‡URLå‚æ•°?tenant=xxxæˆ–è¯·æ±‚å¤´X-Tenant-Identifierä¼ é€’ï¼‰");
   }
}
```

### æ­¥éª¤6ï¼šåˆ›å»ºBç«¯è®¤è¯Controller

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/admin/controller/AdminAuthController.java`

```java
package com.ityfz.yulu.admin.controller;

import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.dto.LoginRequest;
import com.ityfz.yulu.common.dto.LoginResponse;
import com.ityfz.yulu.user.service.TenantService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;

/**
 * Bç«¯è®¤è¯Controller
 * APIå‰ç¼€ï¼š/api/admin/auth
 * æƒé™ï¼šå…¬å¼€æ¥å£ï¼ˆç™»å½•æ— éœ€æƒé™ï¼‰
 */
@RestController
@RequestMapping("/api/admin/auth")
@RequiredArgsConstructor
public class AdminAuthController {

   private final TenantService tenantService;

   /**
    * Bç«¯ç™»å½•ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰
    * POST /api/admin/auth/login
    * éœ€è¦tenantCodeï¼Œå› ä¸ºBç«¯ç”¨æˆ·å¯èƒ½ç®¡ç†å¤šä¸ªç§Ÿæˆ·
    */
   @PostMapping("/login")
   public ApiResponse<LoginResponse> login(@Valid @RequestBody LoginRequest request) {
      // å¤ç”¨ç°æœ‰çš„ç™»å½•é€»è¾‘
      LoginResponse response = tenantService.login(request);
      return ApiResponse.success("ç™»å½•æˆåŠŸ", response);
   }
}
```

### æ­¥éª¤7ï¼šæ›´æ–°ç°æœ‰AuthControllerï¼ˆæ ‡è®°ä¸ºåºŸå¼ƒï¼‰

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/user/controller/AuthController.java`

```java
/**
 * è®¤è¯Controllerï¼ˆæ—§ç‰ˆï¼Œä¿æŒå…¼å®¹ï¼‰
 * 
 * @deprecated è¯·ä½¿ç”¨ CustomerAuthController æˆ– AdminAuthController
 * æ­¤Controllerå°†åœ¨åç»­ç‰ˆæœ¬ä¸­ç§»é™¤
 */
@Deprecated
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    // ... ä¿æŒåŸæœ‰ä»£ç ä¸å˜ï¼Œä½†æ·»åŠ @Deprecatedæ³¨è§£
}
```

---

## ğŸ“ å››ã€å®æ–½æ£€æŸ¥æ¸…å•

### âœ… æ­¥éª¤1ï¼šæ•°æ®åº“æ›´æ–°
- [x] åœ¨`tenant`è¡¨æ·»åŠ `tenant_identifier`å­—æ®µ
- [x] ä¸ºç°æœ‰ç§Ÿæˆ·è®¾ç½®`tenant_identifier`å€¼
- [ ] åˆ›å»ºç´¢å¼•ï¼š`CREATE INDEX idx_tenant_identifier ON tenant(tenant_identifier);`

### âœ… æ­¥éª¤2ï¼šæ›´æ–°å®ä½“ç±»
- [ ] åœ¨`Tenant`å®ä½“æ·»åŠ `tenantIdentifier`å­—æ®µ
- [ ] æ›´æ–°Mapperï¼ˆå¦‚æœéœ€è¦ï¼‰

### âœ… æ­¥éª¤3ï¼šåˆ›å»ºå·¥å…·ç±»
- [ ] åˆ›å»º`TenantIdentifier`å·¥å…·ç±»
- [ ] å®ç°ç§Ÿæˆ·è¯†åˆ«é€»è¾‘ï¼ˆURLå‚æ•°ã€è¯·æ±‚å¤´ï¼‰

### âœ… æ­¥éª¤4ï¼šåˆ›å»ºDTO
- [ ] åˆ›å»º`CustomerLoginRequest`

### âœ… æ­¥éª¤5ï¼šåˆ›å»ºController
- [ ] åˆ›å»º`CustomerAuthController`ï¼ˆ`/api/customer/auth/login`ï¼‰
- [ ] åˆ›å»º`AdminAuthController`ï¼ˆ`/api/admin/auth/login`ï¼‰
- [ ] æ ‡è®°æ—§`AuthController`ä¸º`@Deprecated`

### âœ… æ­¥éª¤6ï¼šæµ‹è¯•éªŒè¯
- [ ] æµ‹è¯•Cç«¯ç™»å½•ï¼ˆé€šè¿‡URLå‚æ•°ä¼ é€’tenantIdentifierï¼‰
- [ ] æµ‹è¯•Cç«¯ç™»å½•ï¼ˆé€šè¿‡è¯·æ±‚å¤´ä¼ é€’tenantIdentifierï¼‰
- [ ] æµ‹è¯•Bç«¯ç™»å½•ï¼ˆéœ€è¦tenantCodeï¼‰
- [ ] æµ‹è¯•ç§Ÿæˆ·è¯†åˆ«å¤±è´¥çš„é”™è¯¯å¤„ç†

---

## ğŸ” äº”ã€ç§Ÿæˆ·è¯†åˆ«ç­–ç•¥è¯¦è§£

### 5.1 URLå‚æ•°æ–¹å¼ï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰

**å‰ç«¯è·¯ç”±**ï¼š
```typescript
// ç§Ÿæˆ·åœ¨è‡ªå·±çš„ç½‘ç«™æ”¾ç½®é“¾æ¥
<a href="https://yulu.com/login?tenant=EDU_001">å®¢æˆ·ç™»å½•</a>
```

**åç«¯è¯†åˆ«**ï¼š
```java
@PostMapping("/login")
public ApiResponse<LoginResponse> login(
    @RequestParam(required = false) String tenant,  // ä»URLå‚æ•°è·å–
    @Valid @RequestBody CustomerLoginRequest request) {
    // tenantå‚æ•°ä¼šè‡ªåŠ¨ä»URLä¸­è·å–
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç§Ÿæˆ·åœ¨è‡ªå·±çš„ç½‘ç«™ä¸Šæ”¾ç½®é“¾æ¥ï¼š`https://yulu.com/login?tenant=EDU_001`
- ç”¨æˆ·ç‚¹å‡»é“¾æ¥åï¼Œè‡ªåŠ¨å¸¦ä¸Šç§Ÿæˆ·æ ‡è¯†ï¼ˆä¸æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼‰
- åªéœ€è¾“å…¥ç”¨æˆ·åå’Œå¯†ç å³å¯ç™»å½•

### 5.2 è¯·æ±‚å¤´æ–¹å¼ï¼ˆé€‚åˆSPAåº”ç”¨ï¼‰

**å‰ç«¯è®¾ç½®**ï¼ˆå·²åœ¨`frontend/src/api/axios.ts`ä¸­å®ç°ï¼‰ï¼š
```typescript
// axiosæ‹¦æˆªå™¨è‡ªåŠ¨è®¾ç½®
const urlParams = new URLSearchParams(window.location.search);
const tenantFromUrl = urlParams.get('tenant');
const tenantIdentifier = tenantFromUrl || localStorage.getItem('tenantIdentifier');

if (tenantIdentifier) {
  config.headers['X-Tenant-Identifier'] = tenantIdentifier;
}
```

**åç«¯è¯†åˆ«**ï¼š
```java
String tenantIdentifier = request.getHeader("X-Tenant-Identifier");
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- å•é¡µåº”ç”¨ï¼ˆSPAï¼‰ï¼Œç”¨æˆ·é€‰æ‹©ç§Ÿæˆ·åï¼Œåç»­æ‰€æœ‰è¯·æ±‚éƒ½è‡ªåŠ¨å¸¦ä¸Šç§Ÿæˆ·æ ‡è¯†
- é€‚åˆéœ€è¦ä¿æŒç§Ÿæˆ·ä¸Šä¸‹æ–‡çš„åº”ç”¨

---

## ğŸ¯ å…­ã€å‰ç«¯å®ç°è¯´æ˜ï¼ˆå·²å®Œæˆï¼‰

### 6.1 ç»Ÿä¸€ç™»å½•é¡µé¢

**æ–‡ä»¶**ï¼š`frontend/src/pages/Login.tsx`

- é»˜è®¤æ˜¾ç¤ºCç«¯ç™»å½•ç•Œé¢ï¼ˆåªéœ€è¦ç”¨æˆ·åå’Œå¯†ç ï¼‰
- é¡µé¢åº•éƒ¨æœ‰"æˆ‘æ˜¯ç®¡ç†å‘˜ â†’"é“¾æ¥ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°Bç«¯ç™»å½•ç•Œé¢
- Bç«¯ç™»å½•ç•Œé¢æ˜¾ç¤ºï¼šç§Ÿæˆ·ç¼–ç ã€ç”¨æˆ·åã€å¯†ç 

### 6.2 APIè°ƒç”¨

**æ–‡ä»¶**ï¼š`frontend/src/api/auth.ts`

```typescript
export const authApi = {
  // Bç«¯ç™»å½•ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰- éœ€è¦tenantCode
  adminLogin(data: LoginRequest) {
    return http.post<ApiResponse<LoginResponse>>('/admin/auth/login', data);
  },
  // Cç«¯ç™»å½•ï¼ˆå®¢æˆ·ï¼‰- ä¸éœ€è¦tenantCodeï¼Œé€šè¿‡ç§Ÿæˆ·æ ‡è¯†è¯†åˆ«
  customerLogin(data: { username: string; password: string; tenantIdentifier?: string }) {
    return http.post<ApiResponse<LoginResponse>>('/customer/auth/login', data);
  }
};
```

### 6.3 axiosæ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨è®¾ç½®è¯·æ±‚å¤´ï¼‰

**æ–‡ä»¶**ï¼š`frontend/src/api/axios.ts`

```typescript
// è‡ªåŠ¨è®¾ç½®ç§Ÿæˆ·æ ‡è¯†åˆ°è¯·æ±‚å¤´ï¼ˆCç«¯ä½¿ç”¨ï¼‰
const urlParams = new URLSearchParams(window.location.search);
const tenantFromUrl = urlParams.get('tenant');
const tenantIdentifier = tenantFromUrl || localStorage.getItem('tenantIdentifier');

if (tenantIdentifier) {
  config.headers['X-Tenant-Identifier'] = tenantIdentifier;
}
```

---

## ğŸ“‹ ä¸ƒã€ä½¿ç”¨æµç¨‹

### 7.1 Cç«¯ï¼ˆå®¢æˆ·ï¼‰ç™»å½•æµç¨‹

1. **ç§Ÿæˆ·åœ¨è‡ªå·±çš„ç½‘ç«™æ”¾ç½®ç™»å½•é“¾æ¥**ï¼š
   ```html
   <a href="https://yulu.com/login?tenant=EDU_001">å®¢æˆ·ç™»å½•</a>
   ```

2. **ç”¨æˆ·ç‚¹å‡»é“¾æ¥**ï¼š
   - è‡ªåŠ¨è·³è½¬åˆ° `/login?tenant=EDU_001`
   - ç§Ÿæˆ·æ ‡è¯†è‡ªåŠ¨ä¿å­˜åˆ°localStorage
   - é¡µé¢åªæ˜¾ç¤ºï¼šç”¨æˆ·åå’Œå¯†ç è¾“å…¥æ¡†ï¼ˆä¸æ˜¾ç¤ºç§Ÿæˆ·æ ‡è¯†ï¼‰

3. **ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œç‚¹å‡»ç™»å½•**ï¼š
   - å‰ç«¯è°ƒç”¨ `/api/customer/auth/login?tenant=EDU_001`
   - åç«¯ä»URLå‚æ•°è¯†åˆ«ç§Ÿæˆ·
   - éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
   - è¿”å›Token

4. **ç™»å½•æˆåŠŸåè·³è½¬åˆ° `/chat`**ï¼ˆèŠå¤©é¡µé¢ï¼‰

### 7.2 Bç«¯ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰ç™»å½•æµç¨‹

1. **è®¿é—® `/login` é¡µé¢**

2. **ç‚¹å‡»"æˆ‘æ˜¯ç®¡ç†å‘˜ â†’"é“¾æ¥**ï¼š
   - åˆ‡æ¢åˆ°Bç«¯ç™»å½•ç•Œé¢
   - æ˜¾ç¤ºï¼šç§Ÿæˆ·ç¼–ç ã€ç”¨æˆ·åã€å¯†ç è¾“å…¥æ¡†

3. **è¾“å…¥ç§Ÿæˆ·ç¼–ç ã€ç”¨æˆ·åã€å¯†ç ï¼Œç‚¹å‡»ç™»å½•**ï¼š
   - å‰ç«¯è°ƒç”¨ `/api/admin/auth/login`
   - åç«¯éªŒè¯ç§Ÿæˆ·ç¼–ç ã€ç”¨æˆ·åå’Œå¯†ç 
   - è¿”å›Token

4. **ç™»å½•æˆåŠŸåè·³è½¬åˆ° `/tickets`**ï¼ˆå·¥å•ç®¡ç†é¡µé¢ï¼‰

---

## âš ï¸ å…«ã€æ³¨æ„äº‹é¡¹

### 8.1 ç§Ÿæˆ·æ ‡è¯†ç è®¾ç½®

- æ¯ä¸ªç§Ÿæˆ·å¿…é¡»è®¾ç½®`tenant_identifier`å­—æ®µ
- `tenant_identifier`åº”è¯¥æ˜¯å”¯ä¸€çš„ã€å‹å¥½çš„æ ‡è¯†ï¼ˆå¦‚ï¼šEDU_001ã€COMPANY_ABCï¼‰
- å¯ä»¥é€šè¿‡ç®¡ç†åå°æˆ–æ•°æ®åº“ç›´æ¥è®¾ç½®

### 8.2 é”™è¯¯å¤„ç†

- å¦‚æœURLå‚æ•°æˆ–è¯·æ±‚å¤´ä¸­æ²¡æœ‰ç§Ÿæˆ·æ ‡è¯†ï¼Œåç«¯ä¼šè¿”å›é”™è¯¯ï¼š`æ— æ³•è¯†åˆ«ç§Ÿæˆ·ï¼Œè¯·æä¾›ç§Ÿæˆ·æ ‡è¯†ç `
- å¦‚æœç§Ÿæˆ·æ ‡è¯†ä¸å­˜åœ¨ï¼Œåç«¯ä¼šè¿”å›é”™è¯¯ï¼š`ç§Ÿæˆ·æ ‡è¯†ç ä¸å­˜åœ¨`
- å¦‚æœç§Ÿæˆ·å·²ç¦ç”¨ï¼Œåç«¯ä¼šè¿”å›é”™è¯¯ï¼š`ç§Ÿæˆ·ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨`

### 8.3 å®‰å…¨æ€§

- Cç«¯ç™»å½•åªèƒ½ç™»å½•USERè§’è‰²çš„ç”¨æˆ·
- Bç«¯ç™»å½•å¯ä»¥ç™»å½•ADMINæˆ–AGENTè§’è‰²çš„ç”¨æˆ·
- ç§Ÿæˆ·æ ‡è¯†ç ä¸åº”è¯¥æš´éœ²ç»™Cç«¯ç”¨æˆ·ï¼ˆé€šè¿‡URLå‚æ•°è‡ªåŠ¨ä¼ é€’ï¼Œä¸æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼‰

---

## ğŸ“ ä¹ã€å®æ–½æ­¥éª¤æ€»ç»“

### 9.1 åç«¯å®æ–½æ­¥éª¤

1. **æ•°æ®åº“æ›´æ–°**
   ```sql
   ALTER TABLE tenant ADD COLUMN tenant_identifier VARCHAR(64) UNIQUE COMMENT 'ç§Ÿæˆ·æ ‡è¯†ç ï¼ˆCç«¯ä½¿ç”¨ï¼‰';
   UPDATE tenant SET tenant_identifier = tenant_code WHERE tenant_identifier IS NULL;
   CREATE INDEX idx_tenant_identifier ON tenant(tenant_identifier);
   ```

2. **æ›´æ–°å®ä½“ç±»**
   - åœ¨`Tenant.java`æ·»åŠ `tenantIdentifier`å­—æ®µ

3. **åˆ›å»ºå·¥å…·ç±»**
   - åˆ›å»º`TenantIdentifier.java`ï¼ˆæ”¯æŒURLå‚æ•°ã€è¯·æ±‚å¤´è¯†åˆ«ï¼‰

4. **åˆ›å»ºDTO**
   - `CustomerLoginRequest.java`

5. **åˆ›å»ºController**
   - `CustomerAuthController.java`ï¼ˆ`/api/customer/auth/login`ï¼‰
   - `AdminAuthController.java`ï¼ˆ`/api/admin/auth/login`ï¼‰

6. **æ ‡è®°æ—§Controllerä¸ºåºŸå¼ƒ**
   - åœ¨`AuthController.java`æ·»åŠ `@Deprecated`æ³¨è§£

### 9.2 å‰ç«¯å®æ–½æ­¥éª¤ï¼ˆå·²å®Œæˆï¼‰

1. âœ… ç»Ÿä¸€ç™»å½•é¡µé¢ï¼ˆ`Login.tsx`ï¼‰
2. âœ… APIè°ƒç”¨ï¼ˆ`auth.ts`ï¼‰
3. âœ… axiosæ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨è®¾ç½®è¯·æ±‚å¤´ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**åˆ›å»ºæ—¶é—´**ï¼š2026-01-14  
**æœ€åæ›´æ–°**ï¼š2026-01-14ï¼ˆæ ¹æ®å‰åç«¯å®é™…å®ç°æ›´æ–°ï¼‰
