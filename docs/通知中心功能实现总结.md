# 通知中心功能实现总结

本文档总结“通知中心”功能从后端到前端的实现步骤、关键技术点、踩坑与排查，以及常见八股问答（面试/答辩用）。

## 1. 功能范围

- 管理员发送通知
- 客服端实时接收通知（WebSocket）
- 通知中心分页查询（DB）
- 未读/已读分开展示
- 未读计数（小铃铛）
- 单条标记已读 + 全部已读

## 2. 关键数据模型

### 2.1 表结构（notify_message）

核心字段：
- id
- tenant_id
- user_id（收件人）
- type（如 TICKET_ASSIGNED / ADMIN_BROADCAST）
- title
- content
- read_flag（0 未读 / 1 已读）
- create_time / update_time

### 2.2 DTO

- NotifyListRequest
  - onlyUnread（默认 true）
  - page / size

- NotifyReadRequest
  - ids（可选）
  - all（true 时全部置已读）

## 3. 后端实现步骤

### 3.1 通知查询接口

位置：`src/main/java/com/ityfz/yulu/ticket/controller/NotifyController.java`

- GET `/api/notify/list`
- 根据 tenantId + userId + onlyUnread 查询
- 返回分页数据（IPage）

### 3.2 标记已读接口

位置：`src/main/java/com/ityfz/yulu/ticket/controller/NotifyController.java`

- POST `/api/notify/read`
- 支持：
  - ids 指定标记
  - all=true 标记全部未读

### 3.3 管理员广播写库 + WS 推送

位置：
- `AdminAgentManagementServiceImpl#broadcastNotification`

流程：
1) 取租户内客服列表
2) 写入 notify_message（ADMIN_BROADCAST）
3) WebSocket 广播给在线客服
4) 同步写一份给管理员自己（便于管理员在通知中心查看发送记录）

## 4. 前端实现步骤

### 4.1 API 层

文件：`frontend/src/api/notify.ts`

- list({page,size,onlyUnread})
- markRead(ids)
- markAllRead()

### 4.2 通知中心页面

文件：`frontend/src/pages/NotifyCenterPage.tsx`

核心逻辑：
- 页面加载时调用 list(onlyUnread=false)
- 将 records 按 readFlag 分组
- Tabs 展示「未读 / 已读」
- 点击单条未读 -> markRead([id])
- 点击“全部已读” -> markAllRead()

### 4.3 小铃铛未读数

文件：
- `frontend/src/components/layout/PortalLayout.tsx`
- `frontend/src/components/layout/AgentLayout.tsx`
- `frontend/src/components/layout/AdminLayout.tsx`

逻辑：
- WebSocket 收到 ADMIN_NOTIFICATION
- 本地 localStorage 计数 +1
- 触发 notify:badge 事件
- PortalLayout 读取并展示 Badge
- 点击铃铛跳转通知中心并清零

## 5. 实时推送链路

1) 管理员调用 /api/admin/handoff/notify
2) 后端写库 + WS 推送
3) 前端（客服）监听 ADMIN_NOTIFICATION
4) 更新铃铛计数 + 触发通知中心刷新

## 6. 常见问题与排查

### 6.1 已读列表为空

原因：`onlyUnread` 默认 true
解决：前端 list 时传 onlyUnread=false

### 6.2 通知中心无数据

原因：tenantId / userId 不匹配
排查：
- 查看当前登录 userId
- SQL：
  `select * from notify_message where tenant_id=? and user_id=?`

### 6.3 实时通知无弹出

原因：WebSocket 未连接或频繁断开
排查：
- Console 是否有 `[WebSocket] Connection established.`
- 后端是否打印握手成功日志

### 6.4 小铃铛无数字

原因：
- 在通知中心页面会清零
- localStorage 未更新
排查：
- 看 localStorage 中 `agent_notify_unread_count`

## 7. 八股总结

### Q1: 为什么通知中心要写库？
A: WS 只能保证在线实时，离线用户需要通过 DB 追溯消息。

### Q2: WebSocket 推送和数据库写入顺序？
A: 先写库，再推送。保证即使推送失败，消息也不丢失。

### Q3: onlyUnread 默认 true 的意义？
A: 通知中心通常更关注未读，减少无效数据传输。

### Q4: 如何确保多租户隔离？
A: 所有查询条件带 tenantId，写入时记录 tenantId。

### Q5: 实时未读数的最佳实践？
A: 使用 WS 触发 + 本地缓存计数，结合进入页面清零。

## 8. 建议优化

- 通知中心分页加载
- 提供“只看未读”筛选
- 增加批量标记已读
- 增加通知类型筛选

---
文档完成。
