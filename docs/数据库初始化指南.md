# 数据库初始化指南

## 📋 前置条件

1. **MySQL 8.0+** 已安装并运行
2. **Redis 6.0+** 已安装并运行（可选，用于对话上下文存储）
3. **RabbitMQ 3.8+** 已安装并运行（可选，用于消息队列）

## 🚀 快速开始

### 步骤 1：启动 MySQL 服务

**Windows:**
```bash
# 方式1：通过服务管理器
net start MySQL80

# 方式2：通过命令行（如果MySQL在PATH中）
mysqld --console
```

**Linux/Mac:**
```bash
# 方式1：通过systemd
sudo systemctl start mysql

# 方式2：通过service
sudo service mysql start
```

### 步骤 2：创建数据库和表

1. **打开 MySQL 客户端**（可以使用 MySQL Workbench、Navicat、命令行等）

2. **执行 SQL 脚本**：
   ```bash
   # 方式1：命令行执行
   mysql -u root -p < docs/sql/init.sql
   
   # 方式2：在 MySQL 客户端中执行
   # 打开 docs/sql/init.sql 文件，复制所有内容，在 MySQL 客户端中执行
   ```

3. **验证数据库创建**：
   ```sql
   USE yulu;
   SHOW TABLES;
   ```
   应该看到以下表：
   - tenant
   - user
   - chat_session
   - chat_message
   - ticket
   - ticket_comment
   - notify_message

### 步骤 3：配置 application.yml

1. **复制配置文件**：
   ```bash
   # 如果还没有 application.yml，从 example 复制
   cp src/main/resources/application.yml.example src/main/resources/application.yml
   ```

2. **修改数据库配置**：
   打开 `src/main/resources/application.yml`，修改以下配置：

   ```yaml
   spring:
     datasource:
       url: jdbc:mysql://localhost:3306/yulu?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai
       username: root          # 修改为你的MySQL用户名
       password: root          # 修改为你的MySQL密码
   ```

3. **配置 Redis**（如果已安装）：
   ```yaml
   spring:
     redis:
       host: localhost
       port: 6379
       password:              # 如果有密码，填写密码
   ```

4. **配置 RabbitMQ**（如果已安装）：
   ```yaml
   spring:
     rabbitmq:
       host: localhost
       port: 5672
       username: guest        # 默认用户名
       password: guest          # 默认密码
   ```

5. **配置 AI API Key**（通义千问）：
   ```yaml
   ai:
     qianwen:
       api-key: your_api_key_here  # 替换为你的通义千问API Key
   ```

### 步骤 4：测试数据库连接

在 IDE 的数据库工具中测试连接：

1. **连接信息**：
   - Host: `localhost`
   - Port: `3306`
   - Database: `yulu`
   - Username: `root`（或你的MySQL用户名）
   - Password: `root`（或你的MySQL密码）

2. **如果连接失败，检查**：
   - MySQL 服务是否启动
   - 用户名密码是否正确
   - 端口是否被占用
   - 防火墙是否阻止连接

## 🔧 常见问题

### 问题 1：Connection refused: connect

**原因**：MySQL 服务未启动

**解决方案**：
```bash
# Windows
net start MySQL80

# Linux/Mac
sudo systemctl start mysql
```

### 问题 2：Access denied for user

**原因**：用户名或密码错误

**解决方案**：
1. 检查 `application.yml` 中的用户名和密码
2. 确认 MySQL 用户有访问 `yulu` 数据库的权限

### 问题 3：Unknown database 'yulu'

**原因**：数据库未创建

**解决方案**：
执行 `docs/sql/init.sql` 脚本创建数据库

### 问题 4：Table already exists

**原因**：表已存在

**解决方案**：
SQL 脚本中已包含 `DROP TABLE IF EXISTS`，如果仍有问题，可以手动删除表后重新执行脚本

## 📝 数据库表说明

| 表名 | 说明 | 主要字段 |
|------|------|---------|
| tenant | 租户表 | id, tenant_code, name, status |
| user | 用户表 | id, tenant_id, username, password, role |
| chat_session | 会话表 | id, tenant_id, user_id, session_title |
| chat_message | 消息表 | id, tenant_id, session_id, content, emotion |
| ticket | 工单表 | id, tenant_id, user_id, status, priority |
| ticket_comment | 工单备注表 | id, ticket_id, tenant_id, content |
| notify_message | 通知消息表 | id, tenant_id, user_id, type, read_flag |

## 🎯 下一步

数据库初始化完成后，可以：

1. **启动项目**：
   ```bash
   mvn spring-boot:run
   ```

2. **注册第一个租户**：
   ```bash
   POST http://localhost:8080/api/auth/registerTenant
   {
     "tenantCode": "TENANT_001",
     "name": "测试租户",
     "adminUsername": "admin",
     "adminPassword": "123456"
   }
   ```

3. **登录获取 Token**：
   ```bash
   POST http://localhost:8080/api/auth/login
   {
     "tenantCode": "TENANT_001",
     "username": "admin",
     "password": "123456"
   }
   ```

## 📚 相关文档

- [项目概述文档](./project-overview.md)
- [SQL 初始化脚本](./sql/init.sql)






























