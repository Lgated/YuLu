# è½¬äººå·¥åŠŸèƒ½å®Œæ•´ä¿®å¤æ­¥éª¤ - ç«‹å³æ‰§è¡Œ

## é—®é¢˜è¯Šæ–­

æ ¹æ®æ—¥å¿—åˆ†æï¼Œæ ¸å¿ƒé—®é¢˜ï¼š
1. **Redisæ•°æ®ç»“æ„é”™è¯¯**ï¼š`agent:status:1:3` æ˜¯ STRING ç±»å‹ï¼ˆå­˜å‚¨æ—¶é—´æˆ³ï¼‰ï¼Œåº”è¯¥æ˜¯ HASH ç±»å‹
2. **chat_session.agent_id ä¸º NULL**ï¼šè™½ç„¶ä»£ç å·²ä¿®å¤ï¼Œä½†éœ€è¦é‡å¯åç«¯æœåŠ¡
3. **å®¢æœè´Ÿè½½æ— æ³•æ­£ç¡®è®¡ç®—**ï¼šå› ä¸º Redis HASH ç»“æ„æŸå

### Redis Key è¯´æ˜
- `agent:status:1:3` æ ¼å¼ï¼š`agent:status:{tenantId}:{agentId}`
  - `1` = tenantIdï¼ˆç§Ÿæˆ·IDï¼‰
  - `3` = agentIdï¼ˆå®¢æœç”¨æˆ·IDï¼‰
- åº”è¯¥æ˜¯ HASH ç±»å‹ï¼ŒåŒ…å«å­—æ®µï¼š
  - `status`: "ONLINE" / "OFFLINE" / "AWAY"
  - `current_sessions`: å½“å‰ä¼šè¯æ•°ï¼ˆæ•´æ•°ï¼‰
  - `max_sessions`: æœ€å¤§å¹¶å‘æ•°ï¼ˆæ•´æ•°ï¼‰
  - `heartbeat_time`: å¿ƒè·³æ—¶é—´æˆ³
  - `last_active_time`: æœ€åæ´»è·ƒæ—¶é—´

---

## ğŸš¨ ç«‹å³æ‰§è¡Œçš„ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1ï¼šé‡å¯åç«¯æœåŠ¡ï¼ˆå¿…é¡»ï¼‰

```bash
# åœæ­¢å½“å‰è¿è¡Œçš„ Spring Boot åº”ç”¨
# ç„¶åé‡æ–°å¯åŠ¨

# å¦‚æœä½¿ç”¨ Maven
mvn spring-boot:run

# æˆ–è€…å¦‚æœå·²ç»æ‰“åŒ…
java -jar target/yulu-*.jar
```

**ä¸ºä»€ä¹ˆå¿…é¡»é‡å¯**ï¼šä»£ç ä¸­çš„ `asyncAssignAgent` æ–¹æ³•å·²ç»ä¿®å¤ï¼Œä¼šåŒæ­¥æ›´æ–° `chat_session.agent_id`ï¼Œä½†åªæœ‰é‡å¯åæ–°ä»£ç æ‰ä¼šç”Ÿæ•ˆã€‚

---

### æ­¥éª¤ 2ï¼šæ¸…ç†æŸåçš„ Redis æ•°æ®

#### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ Debug APIï¼ˆæ¨èï¼‰

```bash
# 1. å¼ºåˆ¶é‡ç½®å®¢æœ Redis æ•°æ®ï¼ˆä¼šåˆ é™¤å¹¶é‡å»ºæ‰€æœ‰ç›¸å…³ keyï¼‰
curl -X POST "http://localhost:8080/api/admin/debug/force-reset-agent/3" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. æ£€æŸ¥ Redis æ•°æ®ç»“æ„æ˜¯å¦æ­£ç¡®
curl -X GET "http://localhost:8080/api/admin/debug/check-agent-redis/3" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. æ¸…ç©ºè½¬äººå·¥é˜Ÿåˆ—ï¼ˆæ¸…é™¤æ‰€æœ‰å¾…åˆ†é…çš„è¯·æ±‚ï¼‰
curl -X DELETE "http://localhost:8080/api/admin/debug/clear-queue" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### æ–¹æ¡ˆ Bï¼šç›´æ¥æ“ä½œ Redisï¼ˆå¦‚æœ API ä¸å¯ç”¨ï¼‰

```bash
# è¿æ¥åˆ° Redis
redis-cli

# 1. åˆ é™¤æŸåçš„ key
DEL agent:status:1:3
DEL agent:sessions:1:3
DEL agent:online:1

# 2. éªŒè¯åˆ é™¤æˆåŠŸ
EXISTS agent:status:1:3
# åº”è¯¥è¿”å› (integer) 0

# 3. é€€å‡º Redis
exit
```

---

### æ­¥éª¤ 3ï¼šå®¢æœé‡æ–°ä¸Šçº¿

å®¢æœéœ€è¦åœ¨å‰ç«¯æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **åˆ·æ–°é¡µé¢**ï¼ˆæ¸…é™¤æ—§çš„ WebSocket è¿æ¥ï¼‰
2. **é‡æ–°ç™»å½•**ï¼ˆå¦‚æœéœ€è¦ï¼‰
3. **ç‚¹å‡»"ä¸Šçº¿"æŒ‰é’®**æˆ–è°ƒç”¨ä¸Šçº¿æ¥å£ï¼š

```bash
# å®¢æœä¸Šçº¿æ¥å£
curl -X PUT "http://localhost:8080/api/admin/user/online-status?status=ONLINE" \
  -H "Authorization: Bearer AGENT_TOKEN"
```

è¿™ä¼šè§¦å‘ `AgentStatusServiceImpl.setOnline()` æ–¹æ³•ï¼Œæ­£ç¡®åˆ›å»º HASH ç»“æ„ï¼š

```
agent:status:1:3 (HASH)
â”œâ”€â”€ status: "ONLINE"
â”œâ”€â”€ current_sessions: 0
â”œâ”€â”€ max_sessions: 5
â”œâ”€â”€ heartbeat_time: 1707472800000
â””â”€â”€ last_active_time: "2026-02-09T16:30:00"
```

---

### æ­¥éª¤ 4ï¼šéªŒè¯ä¿®å¤ç»“æœ

#### 4.1 æ£€æŸ¥ Redis æ•°æ®ç»“æ„

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ Debug API
curl -X GET "http://localhost:8080/api/admin/debug/check-agent-redis/3" \
  -H "Authorization: Bearer YOUR_TOKEN"

# æœŸæœ›è¾“å‡ºï¼š
{
  "agent:status:1:3": "hash",
  "agent:sessions:1:3": "string",
  "agent:online:1": "zset"
}
```

```bash
# æ–¹æ³• 2ï¼šç›´æ¥æŸ¥è¯¢ Redis
redis-cli

TYPE agent:status:1:3
# åº”è¯¥è¿”å›ï¼šhash

HGETALL agent:status:1:3
# åº”è¯¥è¿”å›ï¼š
# 1) "status"
# 2) "ONLINE"
# 3) "current_sessions"
# 4) "0"
# 5) "max_sessions"
# 6) "5"
# ...
```

#### 4.2 æ£€æŸ¥å®¢æœçŠ¶æ€

```bash
# æŸ¥çœ‹å®¢æœè¯¦ç»†çŠ¶æ€
curl -X GET "http://localhost:8080/api/admin/debug/agent-status/3" \
  -H "Authorization: Bearer YOUR_TOKEN"

# æœŸæœ›è¾“å‡ºï¼š
{
  "agentId": 3,
  "status": "ONLINE",
  "currentSessions": 0,
  "maxSessions": 5,
  "canAcceptSession": true
}
```

#### 4.3 æµ‹è¯•è½¬äººå·¥æµç¨‹

1. **ç”¨æˆ·ç«¯å‘èµ·è½¬äººå·¥è¯·æ±‚**
2. **è§‚å¯Ÿåç«¯æ—¥å¿—**ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[HandoffService] å®¢æœåˆ†é…å®Œæˆï¼šhandoffRequestId=XX, agentId=3, sessionId=XX
[HandoffService] å·²æ›´æ–°ä¼šè¯çš„å®¢æœIDï¼šsessionId=XX, agentId=3
```

3. **æŸ¥è¯¢æ•°æ®åº“éªŒè¯**ï¼š

```sql
-- æ£€æŸ¥ handoff_request è¡¨
SELECT id, session_id, agent_id, status 
FROM handoff_request 
WHERE id = XX;

-- æ£€æŸ¥ chat_session è¡¨ï¼ˆå…³é”®ï¼ï¼‰
SELECT id, agent_id, handoff_request_id 
FROM chat_session 
WHERE id = XX;

-- agent_id åº”è¯¥ä¸å†æ˜¯ NULL
```

4. **ç”¨æˆ·ç«¯å‘é€æ¶ˆæ¯**ï¼Œä¸åº”è¯¥å†å‡ºç° "å½“å‰ä¼šè¯æœªæ¥å…¥å®¢æœ" é”™è¯¯

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šé‡å¯åä»ç„¶æŠ¥é”™ "å½“å‰ä¼šè¯æœªæ¥å…¥å®¢æœ"

**åŸå› **ï¼šæ—§çš„ä¼šè¯ `agent_id` ä»ç„¶æ˜¯ NULL

**è§£å†³**ï¼š
```sql
-- æ‰‹åŠ¨ä¿®å¤æ—§ä¼šè¯ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
UPDATE chat_session 
SET agent_id = (
    SELECT agent_id 
    FROM handoff_request 
    WHERE handoff_request.session_id = chat_session.id 
    AND handoff_request.status = 'ASSIGNED'
    LIMIT 1
)
WHERE agent_id IS NULL 
AND handoff_request_id IS NOT NULL;
```

**é•¿æœŸæ–¹æ¡ˆ**ï¼šç”¨æˆ·é‡æ–°å‘èµ·è½¬äººå·¥è¯·æ±‚

---

### é—®é¢˜ 2ï¼šå®¢æœä¸Šçº¿å Redis ä»ç„¶æ˜¯ STRING ç±»å‹

**åŸå› **ï¼šå¯èƒ½æœ‰å…¶ä»–ä»£ç åœ¨é”™è¯¯åœ°å†™å…¥ Redis

**è§£å†³**ï¼š
```bash
# 1. æœç´¢ä»£ç ä¸­æ˜¯å¦æœ‰å…¶ä»–åœ°æ–¹å†™å…¥ agent:status
grep -r "agent:status" src/

# 2. ç¡®ä¿åªæœ‰ AgentStatusServiceImpl åœ¨æ“ä½œè¿™ä¸ª key

# 3. å¼ºåˆ¶åˆ é™¤å¹¶é‡å»º
redis-cli DEL agent:status:1:3
# ç„¶åå®¢æœé‡æ–°ä¸Šçº¿
```

---

### é—®é¢˜ 3ï¼šè½¬äººå·¥è¯·æ±‚ä¸€ç›´åœ¨é˜Ÿåˆ—ä¸­ï¼Œæ²¡æœ‰åˆ†é…

**å¯èƒ½åŸå› **ï¼š
1. å®¢æœæœªä¸Šçº¿ï¼ˆstatus != "ONLINE"ï¼‰
2. å®¢æœè´Ÿè½½å·²æ»¡ï¼ˆcurrent_sessions >= max_sessionsï¼‰
3. é˜Ÿåˆ—æœåŠ¡å¼‚å¸¸

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥åœ¨çº¿å®¢æœåˆ—è¡¨
curl -X GET "http://localhost:8080/api/admin/debug/queue-info" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. æ£€æŸ¥å®¢æœçŠ¶æ€
curl -X GET "http://localhost:8080/api/admin/debug/agent-status/3" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. æŸ¥çœ‹åç«¯æ—¥å¿—
# æœç´¢ "[HandoffService]" å’Œ "[AgentAssigner]"
```

---

## ğŸ“‹ å®Œæ•´æµ‹è¯•æ¸…å•

- [ ] åç«¯æœåŠ¡å·²é‡å¯
- [ ] Redis ä¸­ `agent:status:1:3` å·²åˆ é™¤
- [ ] å®¢æœå·²é‡æ–°ä¸Šçº¿
- [ ] Redis æ•°æ®ç»“æ„éªŒè¯ä¸º HASH ç±»å‹
- [ ] å®¢æœçŠ¶æ€æ˜¾ç¤º "ONLINE"
- [ ] ç”¨æˆ·å‘èµ·è½¬äººå·¥è¯·æ±‚
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤º "å·²æ›´æ–°ä¼šè¯çš„å®¢æœID"
- [ ] æ•°æ®åº“ `chat_session.agent_id` ä¸ä¸º NULL
- [ ] ç”¨æˆ·å¯ä»¥æ­£å¸¸å‘é€æ¶ˆæ¯ç»™å®¢æœ
- [ ] å®¢æœå¯ä»¥æ­£å¸¸æ¥æ”¶å’Œå›å¤æ¶ˆæ¯
- [ ] å®¢æœå¯ä»¥æ­£å¸¸ç»“æŸä¼šè¯

---

## ğŸ¯ æ ¸å¿ƒä¿®å¤ç‚¹æ€»ç»“

1. **ä»£ç å±‚é¢**ï¼š`HandoffService.asyncAssignAgent()` å·²ä¿®å¤ï¼Œä¼šåŒæ­¥æ›´æ–° `chat_session.agent_id`
2. **Redis å±‚é¢**ï¼šåˆ é™¤æŸåçš„ STRING ç±»å‹ keyï¼Œè®©ç³»ç»Ÿé‡å»ºæ­£ç¡®çš„ HASH ç»“æ„
3. **è¿ç»´å±‚é¢**ï¼šé‡å¯åç«¯æœåŠ¡ä½¿æ–°ä»£ç ç”Ÿæ•ˆ
4. **ä¸šåŠ¡å±‚é¢**ï¼šå®¢æœé‡æ–°ä¸Šçº¿ï¼Œè§¦å‘æ­£ç¡®çš„ Redis åˆå§‹åŒ–æµç¨‹

---

## ğŸ“ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **åç«¯æ—¥å¿—**ï¼ˆåŒ…å« HandoffService å’Œ AgentAssigner çš„æ—¥å¿—ï¼‰
2. **Redis æ•°æ®**ï¼š
   ```bash
   redis-cli
   TYPE agent:status:1:3
   HGETALL agent:status:1:3
   ```
3. **æ•°æ®åº“æŸ¥è¯¢ç»“æœ**ï¼š
   ```sql
   SELECT * FROM chat_session WHERE id = XX;
   SELECT * FROM handoff_request WHERE session_id = XX;
   ```
4. **å‰ç«¯æ§åˆ¶å°é”™è¯¯**ï¼ˆå¦‚æœæœ‰ï¼‰
