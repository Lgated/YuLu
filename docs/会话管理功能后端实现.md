# 会话管理功能后端实现

本文档提供完整的会话管理功能后端实现代码，包括创建、删除、重命名、获取会话列表等功能。

---

## 一、DTO 类

### 1.1 创建会话请求 DTO

**文件位置**：`src/main/java/com/ityfz/yulu/chat/dto/CreateSessionRequest.java`

```java
package com.ityfz.yulu.chat.dto;

import lombok.Data;

/**
 * 创建会话请求
 */
@Data
public class CreateSessionRequest {
    /**
     * 会话标题（可选，如果不提供则自动生成）
     */
    private String title;
}
```

### 1.2 更新会话请求 DTO

**文件位置**：`src/main/java/com/ityfz/yulu/chat/dto/UpdateSessionRequest.java`

```java
package com.ityfz.yulu.chat.dto;

import lombok.Data;

/**
 * 更新会话请求
 */
@Data
public class UpdateSessionRequest {
    /**
     * 会话标题
     */
    private String title;
    
    /**
     * 会话状态（0-正常，1-已删除）
     */
    private Integer status;
}
```

### 1.3 会话响应 DTO（可选，用于返回更丰富的信息）

**文件位置**：`src/main/java/com/ityfz/yulu/chat/dto/SessionResponse.java`

```java
package com.ityfz.yulu.chat.dto;

import com.ityfz.yulu.chat.entity.ChatSession;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

/**
 * 会话响应 DTO（包含统计信息）
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SessionResponse {
    /**
     * 会话ID
     */
    private Long id;
    
    /**
     * 会话标题
     */
    private String title;
    
    /**
     * 创建时间
     */
    private LocalDateTime createTime;
    
    /**
     * 更新时间
     */
    private LocalDateTime updateTime;
    
    /**
     * 消息总数
     */
    private Integer messageCount;
    
    /**
     * 最后一条消息时间
     */
    private LocalDateTime lastMessageTime;
    
    /**
     * 最后一条消息内容（预览）
     */
    private String lastMessagePreview;
    
    /**
     * 从 ChatSession 实体转换
     */
    public static SessionResponse from(ChatSession session, Integer messageCount, 
                                       LocalDateTime lastMessageTime, String lastMessagePreview) {
        return SessionResponse.builder()
                .id(session.getId())
                .title(session.getSessionTitle())
                .createTime(session.getCreateTime())
                .updateTime(session.getUpdateTime())
                .messageCount(messageCount)
                .lastMessageTime(lastMessageTime)
                .lastMessagePreview(lastMessagePreview)
                .build();
    }
}
```

---

## 二、Service 接口扩展

### 2.1 ChatService 接口新增方法

**文件位置**：`src/main/java/com/ityfz/yulu/chat/service/ChatService.java`

在现有接口中添加以下方法：

```java
/**
 * 创建新会话
 * @param userId 用户ID
 * @param tenantId 租户ID
 * @param title 会话标题（可选）
 * @return 会话ID
 */
Long createSession(Long userId, Long tenantId, String title);

/**
 * 删除会话（软删除）
 * @param tenantId 租户ID
 * @param userId 用户ID
 * @param sessionId 会话ID
 */
void deleteSession(Long tenantId, Long userId, Long sessionId);

/**
 * 更新会话信息（标题、状态等）
 * @param tenantId 租户ID
 * @param userId 用户ID
 * @param sessionId 会话ID
 * @param title 新标题（可选）
 * @param status 新状态（可选）
 */
void updateSession(Long tenantId, Long userId, Long sessionId, String title, Integer status);

/**
 * 获取会话详情（包含统计信息）
 * @param tenantId 租户ID
 * @param userId 用户ID
 * @param sessionId 会话ID
 * @return 会话详情
 */
SessionResponse getSessionDetail(Long tenantId, Long userId, Long sessionId);
```

---

## 三、Service 实现

### 3.1 ChatServiceImpl 实现新增方法

**文件位置**：`src/main/java/com/ityfz/yulu/chat/service/impl/ChatServiceImpl.java`

在现有类中添加以下方法：

```java
/**
 * 创建新会话
 */
@Override
public Long createSession(Long userId, Long tenantId, String title) {
    TenantContextHolder.setTenantId(tenantId);
    
    // 如果标题为空，自动生成
    if (title == null || title.trim().isEmpty()) {
        title = "新会话 " + LocalDateTime.now().format(DateTimeFormatter.ofPattern("MM-dd HH:mm"));
    }
    
    ChatSession session = new ChatSession();
    session.setTenantId(tenantId);
    session.setUserId(userId);
    session.setSessionTitle(title);
    session.setStatus(0); // 0-正常
    session.setCreateTime(LocalDateTime.now());
    session.setUpdateTime(LocalDateTime.now());
    
    chatSessionMapper.insert(session);
    
    log.info("[Chat] 创建会话成功: sessionId={}, userId={}, tenantId={}, title={}", 
            session.getId(), userId, tenantId, title);
    
    return session.getId();
}

/**
 * 删除会话（软删除）
 */
@Override
public void deleteSession(Long tenantId, Long userId, Long sessionId) {
    TenantContextHolder.setTenantId(tenantId);
    
    // 检查会话归属
    checkSessionOwnerOrAgent(tenantId, userId, sessionId);
    
    // 软删除：更新状态为 1（已删除）
    ChatSession session = chatSessionMapper.selectById(sessionId);
    if (session == null) {
        throw new BizException(ErrorCodes.NOT_FOUND, "会话不存在");
    }
    
    session.setStatus(1); // 1-已删除
    session.setUpdateTime(LocalDateTime.now());
    chatSessionMapper.updateById(session);
    
    // 可选：删除 Redis 中的上下文缓存
    String contextKey = "chat:context:" + sessionId;
    stringRedisTemplate.delete(contextKey);
    String summaryKey = "chat:summary:" + sessionId;
    stringRedisTemplate.delete(summaryKey);
    
    log.info("[Chat] 删除会话成功: sessionId={}, userId={}, tenantId={}", 
            sessionId, userId, tenantId);
}

/**
 * 更新会话信息
 */
@Override
public void updateSession(Long tenantId, Long userId, Long sessionId, String title, Integer status) {
    TenantContextHolder.setTenantId(tenantId);
    
    // 检查会话归属
    checkSessionOwnerOrAgent(tenantId, userId, sessionId);
    
    ChatSession session = chatSessionMapper.selectById(sessionId);
    if (session == null) {
        throw new BizException(ErrorCodes.NOT_FOUND, "会话不存在");
    }
    
    boolean updated = false;
    
    // 更新标题
    if (title != null && !title.trim().isEmpty() && !title.equals(session.getSessionTitle())) {
        session.setSessionTitle(title.trim());
        updated = true;
    }
    
    // 更新状态
    if (status != null && !status.equals(session.getStatus())) {
        session.setStatus(status);
        updated = true;
    }
    
    if (updated) {
        session.setUpdateTime(LocalDateTime.now());
        chatSessionMapper.updateById(session);
        log.info("[Chat] 更新会话成功: sessionId={}, userId={}, tenantId={}, title={}, status={}", 
                sessionId, userId, tenantId, title, status);
    }
}

/**
 * 获取会话详情（包含统计信息）
 */
@Override
public SessionResponse getSessionDetail(Long tenantId, Long userId, Long sessionId) {
    TenantContextHolder.setTenantId(tenantId);
    
    // 检查会话归属
    checkSessionOwnerOrAgent(tenantId, userId, sessionId);
    
    ChatSession session = chatSessionMapper.selectById(sessionId);
    if (session == null) {
        throw new BizException(ErrorCodes.NOT_FOUND, "会话不存在");
    }
    
    // 统计消息数量
    Long messageCount = chatMessageMapper.selectCount(
            Wrappers.lambdaQuery(ChatMessage.class)
                    .eq(ChatMessage::getSessionId, sessionId)
    );
    
    // 获取最后一条消息
    ChatMessage lastMessage = chatMessageMapper.selectOne(
            Wrappers.lambdaQuery(ChatMessage.class)
                    .eq(ChatMessage::getSessionId, sessionId)
                    .orderByDesc(ChatMessage::getCreateTime)
                    .last("LIMIT 1")
    );
    
    LocalDateTime lastMessageTime = lastMessage != null ? lastMessage.getCreateTime() : null;
    String lastMessagePreview = lastMessage != null 
            ? (lastMessage.getContent().length() > 50 
                ? lastMessage.getContent().substring(0, 50) + "..." 
                : lastMessage.getContent())
            : null;
    
    return SessionResponse.from(session, messageCount.intValue(), lastMessageTime, lastMessagePreview);
}
```

**需要添加的导入**：

```java
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.ityfz.yulu.chat.dto.SessionResponse;
import java.time.format.DateTimeFormatter;
```

---

## 四、Controller 接口

### 4.1 CustomerChatController 新增接口

**文件位置**：`src/main/java/com/ityfz/yulu/customer/controller/CustomerChatController.java`

在现有类中添加以下接口：

```java
/**
 * 创建新会话
 * POST /api/customer/chat/sessions
 */
@PostMapping("/sessions")
public ApiResponse<ChatSession> createSession(@RequestBody CreateSessionRequest request) {
    Long tenantId = TenantContextHolder.getTenantId();
    Long userId = UserContextHolder.getUserId();
    
    if (tenantId == null) {
        throw new BizException(ErrorCodes.TENANT_REQUIRED, "缺少租户信息，请先登录");
    }
    if (userId == null) {
        throw new BizException(ErrorCodes.UNAUTHORIZED, "缺少用户信息，请先登录");
    }
    
    Long sessionId = chatService.createSession(userId, tenantId, request.getTitle());
    ChatSession session = chatSessionMapper.selectById(sessionId);
    
    return ApiResponse.success("会话创建成功", session);
}

/**
 * 删除会话
 * DELETE /api/customer/chat/sessions/{sessionId}
 */
@DeleteMapping("/sessions/{sessionId}")
public ApiResponse<Void> deleteSession(@PathVariable Long sessionId) {
    Long tenantId = TenantContextHolder.getTenantId();
    Long userId = UserContextHolder.getUserId();
    
    if (tenantId == null || userId == null) {
        throw new BizException(ErrorCodes.UNAUTHORIZED, "请先登录");
    }
    
    chatService.deleteSession(tenantId, userId, sessionId);
    return ApiResponse.success("会话删除成功", null);
}

/**
 * 更新会话信息（标题、状态等）
 * PUT /api/customer/chat/sessions/{sessionId}
 */
@PutMapping("/sessions/{sessionId}")
public ApiResponse<Void> updateSession(@PathVariable Long sessionId, 
                                       @RequestBody UpdateSessionRequest request) {
    Long tenantId = TenantContextHolder.getTenantId();
    Long userId = UserContextHolder.getUserId();
    
    if (tenantId == null || userId == null) {
        throw new BizException(ErrorCodes.UNAUTHORIZED, "请先登录");
    }
    
    chatService.updateSession(tenantId, userId, sessionId, request.getTitle(), request.getStatus());
    return ApiResponse.success("会话更新成功", null);
}

/**
 * 获取会话详情（包含统计信息）
 * GET /api/customer/chat/sessions/{sessionId}
 */
@GetMapping("/sessions/{sessionId}")
public ApiResponse<SessionResponse> getSessionDetail(@PathVariable Long sessionId) {
    Long tenantId = TenantContextHolder.getTenantId();
    Long userId = UserContextHolder.getUserId();
    
    if (tenantId == null || userId == null) {
        throw new BizException(ErrorCodes.UNAUTHORIZED, "请先登录");
    }
    
    SessionResponse detail = chatService.getSessionDetail(tenantId, userId, sessionId);
    return ApiResponse.success("OK", detail);
}

/**
 * 获取会话列表（增强版，包含最后一条消息预览）
 * GET /api/customer/chat/sessions/enhanced
 */
@GetMapping("/sessions/enhanced")
public ApiResponse<List<SessionResponse>> listSessionsEnhanced() {
    Long tenantId = TenantContextHolder.getTenantId();
    Long userId = UserContextHolder.getUserId();
    
    if (tenantId == null || userId == null) {
        throw new BizException(ErrorCodes.UNAUTHORIZED, "请先登录");
    }
    
    // 获取会话列表
    List<ChatSession> sessions = chatService.listUserSessionsByUsers(tenantId, userId);
    
    // 转换为增强版响应
    List<SessionResponse> responses = sessions.stream()
            .map(session -> {
                // 统计消息数量
                Long messageCount = chatMessageMapper.selectCount(
                        Wrappers.lambdaQuery(ChatMessage.class)
                                .eq(ChatMessage::getSessionId, session.getId())
                );
                
                // 获取最后一条消息
                ChatMessage lastMessage = chatMessageMapper.selectOne(
                        Wrappers.lambdaQuery(ChatMessage.class)
                                .eq(ChatMessage::getSessionId, session.getId())
                                .orderByDesc(ChatMessage::getCreateTime)
                                .last("LIMIT 1")
                );
                
                LocalDateTime lastMessageTime = lastMessage != null 
                        ? lastMessage.getCreateTime() 
                        : null;
                String lastMessagePreview = lastMessage != null 
                        ? (lastMessage.getContent().length() > 50 
                            ? lastMessage.getContent().substring(0, 50) + "..." 
                            : lastMessage.getContent())
                        : null;
                
                return SessionResponse.from(session, messageCount.intValue(), 
                        lastMessageTime, lastMessagePreview);
            })
            .sorted((a, b) -> {
                // 按最后消息时间降序排序，没有消息的按创建时间降序
                LocalDateTime timeA = a.getLastMessageTime() != null 
                        ? a.getLastMessageTime() 
                        : a.getCreateTime();
                LocalDateTime timeB = b.getLastMessageTime() != null 
                        ? b.getLastMessageTime() 
                        : b.getCreateTime();
                return timeB.compareTo(timeA);
            })
            .collect(Collectors.toList());
    
    return ApiResponse.success("OK", responses);
}
```

**需要添加的导入和依赖**：

```java
import com.ityfz.yulu.chat.dto.CreateSessionRequest;
import com.ityfz.yulu.chat.dto.UpdateSessionRequest;
import com.ityfz.yulu.chat.dto.SessionResponse;
import com.ityfz.yulu.chat.mapper.ChatSessionMapper;
import com.ityfz.yulu.chat.mapper.ChatMessageMapper;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import java.util.stream.Collectors;
```

**注意**：需要在 Controller 中注入 `ChatSessionMapper` 和 `ChatMessageMapper`：

```java
private final ChatService chatService;
private final ChatSessionMapper chatSessionMapper;  // 新增
private final ChatMessageMapper chatMessageMapper;  // 新增
```

---

## 五、优化建议

### 5.1 会话列表查询优化

如果会话数量较多，建议在 Mapper 中添加自定义 SQL，一次性查询会话和统计信息：

**文件位置**：`src/main/java/com/ityfz/yulu/chat/mapper/ChatSessionMapper.java`

```java
/**
 * 查询用户会话列表（包含统计信息）
 */
@Select("SELECT s.*, " +
        "COUNT(m.id) as message_count, " +
        "MAX(m.create_time) as last_message_time, " +
        "SUBSTRING(MAX(CONCAT(m.create_time, '|', m.content)), LOCATE('|', MAX(CONCAT(m.create_time, '|', m.content))) + 1) as last_message_preview " +
        "FROM chat_session s " +
        "LEFT JOIN chat_message m ON s.id = m.session_id " +
        "WHERE s.tenant_id = #{tenantId} AND s.user_id = #{userId} AND s.status = 0 " +
        "GROUP BY s.id " +
        "ORDER BY last_message_time DESC, s.create_time DESC")
List<SessionResponse> selectSessionsWithStats(@Param("tenantId") Long tenantId, 
                                               @Param("userId") Long userId);
```

### 5.2 批量删除会话

如果需要批量删除，可以添加：

```java
/**
 * 批量删除会话
 * DELETE /api/customer/chat/sessions/batch
 */
@DeleteMapping("/sessions/batch")
public ApiResponse<Void> deleteSessionsBatch(@RequestBody List<Long> sessionIds) {
    Long tenantId = TenantContextHolder.getTenantId();
    Long userId = UserContextHolder.getUserId();
    
    if (tenantId == null || userId == null) {
        throw new BizException(ErrorCodes.UNAUTHORIZED, "请先登录");
    }
    
    for (Long sessionId : sessionIds) {
        try {
            chatService.deleteSession(tenantId, userId, sessionId);
        } catch (Exception e) {
            log.warn("[Chat] 删除会话失败: sessionId={}, error={}", sessionId, e.getMessage());
        }
    }
    
    return ApiResponse.success("批量删除完成", null);
}
```

### 5.3 会话搜索功能

如果需要搜索会话，可以添加：

```java
/**
 * 搜索会话
 * GET /api/customer/chat/sessions/search?keyword=xxx
 */
@GetMapping("/sessions/search")
public ApiResponse<List<SessionResponse>> searchSessions(@RequestParam String keyword) {
    Long tenantId = TenantContextHolder.getTenantId();
    Long userId = UserContextHolder.getUserId();
    
    if (tenantId == null || userId == null) {
        throw new BizException(ErrorCodes.UNAUTHORIZED, "请先登录");
    }
    
    // 查询标题包含关键词的会话
    List<ChatSession> sessions = chatSessionMapper.selectList(
            Wrappers.lambdaQuery(ChatSession.class)
                    .eq(ChatSession::getTenantId, tenantId)
                    .eq(ChatSession::getUserId, userId)
                    .eq(ChatSession::getStatus, 0)
                    .like(ChatSession::getSessionTitle, keyword)
                    .orderByDesc(ChatSession::getUpdateTime)
    );
    
    // 转换为响应格式（简化版，不包含统计信息）
    List<SessionResponse> responses = sessions.stream()
            .map(session -> SessionResponse.from(session, 0, null, null))
            .collect(Collectors.toList());
    
    return ApiResponse.success("OK", responses);
}
```

---

## 六、API 接口汇总

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/customer/chat/sessions` | 创建新会话 |
| GET | `/api/customer/chat/sessions` | 获取会话列表（基础版） |
| GET | `/api/customer/chat/sessions/enhanced` | 获取会话列表（增强版，含统计） |
| GET | `/api/customer/chat/sessions/{sessionId}` | 获取会话详情 |
| PUT | `/api/customer/chat/sessions/{sessionId}` | 更新会话信息 |
| DELETE | `/api/customer/chat/sessions/{sessionId}` | 删除会话 |
| DELETE | `/api/customer/chat/sessions/batch` | 批量删除会话（可选） |
| GET | `/api/customer/chat/sessions/search?keyword=xxx` | 搜索会话（可选） |

---

## 七、前端对接示例

### 7.1 创建会话

```javascript
// POST /api/customer/chat/sessions
const createSession = async (title) => {
  const response = await fetch('/api/customer/chat/sessions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title: title || null })
  });
  const result = await response.json();
  return result.data; // ChatSession 对象
};
```

### 7.2 获取会话列表

```javascript
// GET /api/customer/chat/sessions/enhanced
const getSessions = async () => {
  const response = await fetch('/api/customer/chat/sessions/enhanced');
  const result = await response.json();
  return result.data; // SessionResponse[] 数组
};
```

### 7.3 删除会话

```javascript
// DELETE /api/customer/chat/sessions/{sessionId}
const deleteSession = async (sessionId) => {
  const response = await fetch(`/api/customer/chat/sessions/${sessionId}`, {
    method: 'DELETE'
  });
  return response.ok;
};
```

### 7.4 更新会话标题

```javascript
// PUT /api/customer/chat/sessions/{sessionId}
const updateSession = async (sessionId, title) => {
  const response = await fetch(`/api/customer/chat/sessions/${sessionId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title })
  });
  return response.ok;
};
```

---

## 八、注意事项

1. **权限校验**：所有接口都需要校验用户身份和会话归属
2. **软删除**：删除会话使用软删除（status=1），保留历史数据
3. **Redis 清理**：删除会话时清理 Redis 中的上下文缓存
4. **性能优化**：如果会话数量多，建议使用分页查询
5. **并发控制**：更新会话时注意并发问题，可以使用乐观锁

---

以上是完整的会话管理功能后端实现代码，可以根据实际需求进行调整和优化。


