# 用户端结束对话功能（转人工）- 实现指南（贴合当前代码）

## 一、你当前项目里的“结束”语义（先对齐上下文）

你项目里已经存在一条成熟的“结束人工会话”链路：

- 客服侧：`AgentHandoffController.completeHandoff()` -> `HandoffService.complete()`
- 服务端收敛状态：`handoff_request.status = COMPLETED`，`chat_session.chat_mode = AI`
- 服务端通知：给客户 WebSocket 推送 `HANDOFF_COMPLETED`
- 客户端：收到 `HANDOFF_COMPLETED` 后清理 `handoffStatus`，回到 AI 对话

因此，“用户端结束对话（用户主动结束人工）”最适合采用**同一套状态收敛方式**，只在以下点上区分：

- 发起方不同：`OperatorType.USER`
- 通知文案不同：`endedBy = USER`
- 是否需要通知客服：如果该请求已绑定 `agentId`，建议也通知客服端清理会话（同样复用 `HANDOFF_COMPLETED`）

## 二、设计原则（为什么原文档不太适配）

原文档里建议新增：

- `HandoffStatus.USER_ENDED`
- `HandoffEventType.USER_ENDED`
- 单独的 WebSocket 消息 `HANDOFF_USER_ENDED`

这会引入额外的枚举/分支判断/兼容逻辑，**而你当前代码已经以 `COMPLETED` 作为结束态的唯一收敛点**。

在不需要做复杂统计维度拆分的前提下，更适合：

- **复用** `HandoffStatus.COMPLETED`
- 通过 `HandoffEvent.eventData` 记录 `endedBy: USER/AGENT`
- WebSocket 仍用 `HANDOFF_COMPLETED`，payload 增加 `endedBy`

这样对现有前端/后端的侵入最小，也最符合你当前“转人工结束功能板块”的上下文。

## 三、后端实现（最小改动版本）

### 3.1 C 端接口（已接入/进行中才允许结束）

- Controller：`CustomerHandoffController`
- Endpoint：`POST /api/customer/handoff/end-by-user`
- Body：`{ handoffRequestId: number }`

### 3.2 DTO

新增 `EndHandoffByUserRequest`：

- `handoffRequestId` 必填

### 3.3 Service：`HandoffService.endByUser()`

核心逻辑（与 `complete()` 对齐）：

- **权限校验**：`handoff_request.tenant_id` + `handoff_request.user_id`
- **状态校验**：仅允许 `ACCEPTED` / `IN_PROGRESS`
- **状态收敛**：将 `handoff_request.status` 更新为 `COMPLETED`，填 `completed_at`
- **会话切回 AI**：`chat_session.chat_mode = AI`
- **释放客服会话数**：如果 `agent_id != null`，调用 `agentStatusService.decrementSessionCount()`
- **事件记录**：`HandoffEventType.COMPLETED`，`OperatorType.USER`，并在 `eventData` 写入 `endedBy=USER`
- **WebSocket 通知**：
  - 通知客户：`HANDOFF_COMPLETED`，payload 带 `endedBy=USER`
  - 通知客服（如果已接入）：同样用 `HANDOFF_COMPLETED`，payload 带 `endedBy=USER`

> 注意：如需把“用户结束”在工单上体现为取消（`CANCELLED`），可以后续再做。但为了不引入额外状态分裂，此处建议先维持 `DONE` 收敛（与你现有 complete 逻辑一致）。

## 四、前端实现（用户端 ChatPage）

### 4.1 API

在 `frontend/src/api/handoff.ts` 增加：

- `handoffApi.endByUser(handoffRequestId)` -> `POST /customer/handoff/end-by-user`

### 4.2 UI：仅在人工对话中展示“结束对话”

在 `ChatPage.tsx` 的输入区按钮组中：

- 当 `handoffStatus.status` 为 `ACCEPTED` / `IN_PROGRESS`：展示“结束对话”按钮
- 点击后弹确认框，确认则调用 `handoffApi.endByUser()`
- 成功后清理 `handoffStatus`

### 4.3 WebSocket：统一处理结束消息

你的前端已经监听了 `HANDOFF_COMPLETED`，推荐增强为：

- 若 `payload.endedBy === 'USER'`：提示“您已结束与客服的对话…”
- 否则：提示“客服已结束…”

这样同一个 WS type 即可覆盖：

- 客服 complete
- 用户 end-by-user

## 五、客服端（B 端）处理建议

如果你客服端已接入 WebSocket 并且需要在“用户结束”后自动移除会话：

- 也监听 `HANDOFF_COMPLETED`
- 根据 `endedBy` 决定提示文案和 UI 清理逻辑

不建议新增独立 `HANDOFF_USER_ENDED` 消息类型，除非你的 B 端架构对消息类型强依赖且不方便共用。

## 六、检查清单（按你项目现状）

- [ ] `CustomerHandoffController` 存在 `/end-by-user` 端点且 DTO 可编译
- [ ] `HandoffService.endByUser()` 实现完成并通过状态/权限校验
- [ ] `HANDOFF_COMPLETED` payload 增加 `endedBy`
- [ ] 前端 `handoffApi.endByUser()` 已接入
- [ ] `ChatPage.tsx` 人工中展示“结束对话”按钮
- [ ] `ChatPage.tsx` 对 `HANDOFF_COMPLETED` 做 endedBy 分支提示

