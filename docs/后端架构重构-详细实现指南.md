# åç«¯æ¶æ„é‡æ„ - è¯¦ç»†å®ç°æŒ‡å—

## ğŸ“‹ ä¸€ã€é‡æ„ç›®æ ‡

1. **åŒ…ç»“æ„é‡ç»„**ï¼šå°†ControlleræŒ‰Cç«¯/Bç«¯åˆ†ç¦»
2. **APIå‰ç¼€åˆ†ç¦»**ï¼š`/api/customer/*` å’Œ `/api/admin/*`
3. **AOPæƒé™æ§åˆ¶**ï¼šä½¿ç”¨æ³¨è§£æ–¹å¼ç»Ÿä¸€æƒé™æ ¡éªŒ
4. **ä»£ç å¤ç”¨**ï¼šServiceå±‚ä¿æŒä¸å˜ï¼Œåªé‡æ„Controllerå±‚

---

## ğŸ—ï¸ äºŒã€æ–°çš„åŒ…ç»“æ„è®¾è®¡

```
src/main/java/com/ityfz/yulu/
â”œâ”€â”€ customer/                    # Cç«¯æ¨¡å—ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”œâ”€â”€ CustomerChatController.java      # Cç«¯å¯¹è¯æ¥å£
â”‚   â”‚   â”œâ”€â”€ CustomerFAQController.java        # Cç«¯FAQæ¥å£
â”‚   â”‚   â””â”€â”€ CustomerHistoryController.java    # Cç«¯å†å²è®°å½•æ¥å£
â”‚   â””â”€â”€ dto/
â”‚       â”œâ”€â”€ TransferToAgentRequest.java       # è½¬äººå·¥è¯·æ±‚
â”‚       â””â”€â”€ SatisfactionRatingRequest.java   # æ»¡æ„åº¦è¯„ä»·è¯·æ±‚
â”‚
â”œâ”€â”€ admin/                       # Bç«¯æ¨¡å—ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”œâ”€â”€ AdminDashboardController.java    # æ•°æ®çœ‹æ¿
â”‚   â”‚   â”œâ”€â”€ AdminTicketController.java        # å·¥å•ç®¡ç†ï¼ˆå¤ç”¨ç°æœ‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminWorkspaceController.java     # äººå·¥å·¥ä½œå°
â”‚   â”‚   â”œâ”€â”€ AdminSessionController.java       # ä¼šè¯ç®¡ç†
â”‚   â”‚   â””â”€â”€ AdminKnowledgeController.java     # çŸ¥è¯†åº“ç®¡ç†
â”‚   â””â”€â”€ dto/
â”‚       â””â”€â”€ ...ï¼ˆæŒ‰éœ€æ–°å¢ï¼‰
â”‚
â”œâ”€â”€ common/                      # å…¬å…±æ¨¡å—ï¼ˆå·²æœ‰ï¼Œéœ€æ‰©å±•ï¼‰
â”‚   â”œâ”€â”€ annotation/              # æ–°å¢ï¼šè‡ªå®šä¹‰æ³¨è§£
â”‚   â”‚   â”œâ”€â”€ RequireRole.java                  # è§’è‰²æƒé™æ³¨è§£
â”‚   â”‚   â””â”€â”€ RequireAnyRole.java               # å¤šè§’è‰²æƒé™æ³¨è§£
â”‚   â”œâ”€â”€ aspect/                  # æ–°å¢ï¼šAOPåˆ‡é¢
â”‚   â”‚   â””â”€â”€ RoleCheckAspect.java             # æƒé™æ ¡éªŒåˆ‡é¢
â”‚   â””â”€â”€ ...ï¼ˆå…¶ä»–å·²æœ‰æ¨¡å—ï¼‰
â”‚
â”œâ”€â”€ chat/                        # å¯¹è¯æ¨¡å—ï¼ˆä¿æŒä¸å˜ï¼‰
â”œâ”€â”€ ticket/                      # å·¥å•æ¨¡å—ï¼ˆä¿æŒä¸å˜ï¼‰
â””â”€â”€ user/                        # ç”¨æˆ·æ¨¡å—ï¼ˆä¿æŒä¸å˜ï¼‰
```

---

## ğŸ”§ ä¸‰ã€å®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºæƒé™æ§åˆ¶æ³¨è§£ï¼ˆAOPåŸºç¡€ï¼‰

#### 1.1 åˆ›å»º `RequireRole` æ³¨è§£

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/common/annotation/RequireRole.java`

```java
package com.ityfz.yulu.common.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * è§’è‰²æƒé™æ³¨è§£
 * ç”¨äºæ ‡è®°æ–¹æ³•éœ€è¦ç‰¹å®šè§’è‰²æ‰èƒ½è®¿é—®
 * 
 * ä½¿ç”¨ç¤ºä¾‹ï¼š
 * @RequireRole("ADMIN")           // ä»…ç®¡ç†å‘˜
 * @RequireRole("AGENT")           // ä»…å®¢æœ
 * @RequireRole("USER")            // ä»…æ™®é€šç”¨æˆ·
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireRole {
    /**
     * å…è®¸çš„è§’è‰²ï¼ˆè‡³å°‘éœ€è¦å…¶ä¸­ä¸€ä¸ªï¼‰
     */
    String[] value();
    
    /**
     * é”™è¯¯æç¤ºä¿¡æ¯
     */
    String message() default "æƒé™ä¸è¶³ï¼Œç¦æ­¢è®¿é—®";
}
```

#### 1.2 åˆ›å»º `RequireAnyRole` æ³¨è§£ï¼ˆå¯é€‰ï¼Œæ›´çµæ´»ï¼‰

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/common/annotation/RequireAnyRole.java`

```java
package com.ityfz.yulu.common.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * å¤šè§’è‰²æƒé™æ³¨è§£ï¼ˆè‡³å°‘éœ€è¦å…¶ä¸­ä¸€ä¸ªè§’è‰²ï¼‰
 * 
 * ä½¿ç”¨ç¤ºä¾‹ï¼š
 * @RequireAnyRole({"ADMIN", "AGENT"})  // ç®¡ç†å‘˜æˆ–å®¢æœ
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireAnyRole {
    String[] value();
    String message() default "æƒé™ä¸è¶³ï¼Œç¦æ­¢è®¿é—®";
}
```

### æ­¥éª¤2ï¼šåˆ›å»ºAOPåˆ‡é¢ï¼ˆæƒé™æ ¡éªŒé€»è¾‘ï¼‰

#### 2.1 åˆ›å»ºæƒé™æ ¡éªŒåˆ‡é¢

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/common/aspect/RoleCheckAspect.java`

```java
package com.ityfz.yulu.common.aspect;

import com.ityfz.yulu.common.annotation.RequireAnyRole;
import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.enums.Roles;
import com.ityfz.yulu.common.error.ErrorCodes;
import com.ityfz.yulu.common.exception.BizException;
import com.ityfz.yulu.common.tenant.UserContextHolder;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.List;

/**
 * è§’è‰²æƒé™æ ¡éªŒåˆ‡é¢
 * ä½¿ç”¨AOPç»Ÿä¸€å¤„ç†æƒé™æ ¡éªŒï¼Œé¿å…åœ¨æ¯ä¸ªControlleræ–¹æ³•ä¸­é‡å¤å†™æƒé™åˆ¤æ–­ä»£ç 
 * 
 * æ‰§è¡Œé¡ºåºï¼šOrder(1) ç¡®ä¿åœ¨ä¸šåŠ¡é€»è¾‘ä¹‹å‰æ‰§è¡Œ
 */
@Slf4j
@Aspect
@Component
@Order(1)  // ä¼˜å…ˆçº§è®¾ä¸º1ï¼Œç¡®ä¿åœ¨ä¸šåŠ¡é€»è¾‘ä¹‹å‰æ‰§è¡Œ
public class RoleCheckAspect {

    /**
     * å®šä¹‰åˆ‡ç‚¹ï¼šæ‰€æœ‰æ ‡æ³¨äº† @RequireRole çš„æ–¹æ³•
     */
    @Pointcut("@annotation(com.ityfz.yulu.common.annotation.RequireRole)")
    public void requireRolePointcut() {}

    /**
     * å®šä¹‰åˆ‡ç‚¹ï¼šæ‰€æœ‰æ ‡æ³¨äº† @RequireAnyRole çš„æ–¹æ³•
     */
    @Pointcut("@annotation(com.ityfz.yulu.common.annotation.RequireAnyRole)")
    public void requireAnyRolePointcut() {}

    /**
     * å®šä¹‰åˆ‡ç‚¹ï¼šç±»ä¸Šæ ‡æ³¨äº† @RequireRole çš„æ‰€æœ‰æ–¹æ³•
     */
    @Pointcut("@within(com.ityfz.yulu.common.annotation.RequireRole)")
    public void requireRoleClassPointcut() {}

    /**
     * å®šä¹‰åˆ‡ç‚¹ï¼šç±»ä¸Šæ ‡æ³¨äº† @RequireAnyRole çš„æ‰€æœ‰æ–¹æ³•
     */
    @Pointcut("@within(com.ityfz.yulu.common.annotation.RequireAnyRole)")
    public void requireAnyRoleClassPointcut() {}

    /**
     * å¤„ç† @RequireRole æ³¨è§£
     */
    @Before("requireRolePointcut() || requireRoleClassPointcut()")
    public void checkRole(JoinPoint joinPoint) {
        // è·å–å½“å‰ç”¨æˆ·è§’è‰²
        String currentRole = UserContextHolder.getRole();
        if (currentRole == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }

        // è·å–æ³¨è§£ä¿¡æ¯
        RequireRole annotation = getAnnotation(joinPoint, RequireRole.class);
        if (annotation == null) {
            return;
        }

        String[] requiredRoles = annotation.value();
        String message = annotation.message();

        // æ£€æŸ¥å½“å‰ç”¨æˆ·è§’è‰²æ˜¯å¦åœ¨å…è®¸çš„è§’è‰²åˆ—è¡¨ä¸­
        boolean hasPermission = Arrays.stream(requiredRoles)
                .anyMatch(role -> role.equalsIgnoreCase(currentRole));

        if (!hasPermission) {
            log.warn("æƒé™æ ¡éªŒå¤±è´¥: å½“å‰è§’è‰²={}, éœ€è¦è§’è‰²={}, æ–¹æ³•={}", 
                    currentRole, Arrays.toString(requiredRoles), joinPoint.getSignature());
            throw new BizException(ErrorCodes.FORBIDDEN, message);
        }

        log.debug("æƒé™æ ¡éªŒé€šè¿‡: è§’è‰²={}, æ–¹æ³•={}", currentRole, joinPoint.getSignature());
    }

    /**
     * å¤„ç† @RequireAnyRole æ³¨è§£
     */
    @Before("requireAnyRolePointcut() || requireAnyRoleClassPointcut()")
    public void checkAnyRole(JoinPoint joinPoint) {
        String currentRole = UserContextHolder.getRole();
        if (currentRole == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }

        RequireAnyRole annotation = getAnnotation(joinPoint, RequireAnyRole.class);
        if (annotation == null) {
            return;
        }

        String[] requiredRoles = annotation.value();
        String message = annotation.message();

        boolean hasPermission = Arrays.stream(requiredRoles)
                .anyMatch(role -> role.equalsIgnoreCase(currentRole));

        if (!hasPermission) {
            log.warn("æƒé™æ ¡éªŒå¤±è´¥: å½“å‰è§’è‰²={}, éœ€è¦è§’è‰²ä¹‹ä¸€={}, æ–¹æ³•={}", 
                    currentRole, Arrays.toString(requiredRoles), joinPoint.getSignature());
            throw new BizException(ErrorCodes.FORBIDDEN, message);
        }

        log.debug("æƒé™æ ¡éªŒé€šè¿‡: è§’è‰²={}, æ–¹æ³•={}", currentRole, joinPoint.getSignature());
    }

    /**
     * ä»æ–¹æ³•æˆ–ç±»ä¸Šè·å–æ³¨è§£
     */
    private <T> T getAnnotation(JoinPoint joinPoint, Class<T> annotationClass) {
        // å…ˆå°è¯•ä»æ–¹æ³•ä¸Šè·å–
        try {
            T methodAnnotation = (T) joinPoint.getSignature()
                    .getClass()
                    .getMethod("getMethod")
                    .invoke(joinPoint.getSignature())
                    .getClass()
                    .getMethod("getAnnotation", Class.class)
                    .invoke(null, annotationClass);
            
            if (methodAnnotation != null) {
                return methodAnnotation;
            }
        } catch (Exception e) {
            // å¿½ç•¥å¼‚å¸¸ï¼Œç»§ç»­ä»ç±»ä¸Šè·å–
        }

        // ä»ç±»ä¸Šè·å–
        try {
            return (T) joinPoint.getTarget().getClass().getAnnotation(annotationClass);
        } catch (Exception e) {
            return null;
        }
    }
}
```

**æ³¨æ„**ï¼šä¸Šé¢çš„ `getAnnotation` æ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨æ›´ç®€å•çš„æ–¹å¼ï¼š

```java
package com.ityfz.yulu.common.aspect;

import com.ityfz.yulu.common.annotation.RequireAnyRole;
import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.error.ErrorCodes;
import com.ityfz.yulu.common.exception.BizException;
import com.ityfz.yulu.common.tenant.UserContextHolder;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

import java.lang.reflect.Method;
import java.util.Arrays;

/**
 * è§’è‰²æƒé™æ ¡éªŒåˆ‡é¢
 */
@Slf4j
@Aspect
@Component
@Order(1)
public class RoleCheckAspect {

    /**
     * å¤„ç† @RequireRole æ³¨è§£
     */
    @Before("@annotation(com.ityfz.yulu.common.annotation.RequireRole)")
    public void checkRole(JoinPoint joinPoint) {
        String currentRole = UserContextHolder.getRole();
        if (currentRole == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }

        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();
        RequireRole annotation = method.getAnnotation(RequireRole.class);
        
        if (annotation == null) {
            return;
        }

        String[] requiredRoles = annotation.value();
        String message = annotation.message();

        boolean hasPermission = Arrays.stream(requiredRoles)
                .anyMatch(role -> role.equalsIgnoreCase(currentRole));

        if (!hasPermission) {
            log.warn("æƒé™æ ¡éªŒå¤±è´¥: å½“å‰è§’è‰²={}, éœ€è¦è§’è‰²={}, æ–¹æ³•={}.{}", 
                    currentRole, Arrays.toString(requiredRoles), 
                    method.getDeclaringClass().getSimpleName(), method.getName());
            throw new BizException(ErrorCodes.FORBIDDEN, message);
        }

        log.debug("æƒé™æ ¡éªŒé€šè¿‡: è§’è‰²={}, æ–¹æ³•={}.{}", 
                currentRole, method.getDeclaringClass().getSimpleName(), method.getName());
    }

    /**
     * å¤„ç† @RequireAnyRole æ³¨è§£
     */
    @Before("@annotation(com.ityfz.yulu.common.annotation.RequireAnyRole)")
    public void checkAnyRole(JoinPoint joinPoint) {
        String currentRole = UserContextHolder.getRole();
        if (currentRole == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }

        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();
        RequireAnyRole annotation = method.getAnnotation(RequireAnyRole.class);
        
        if (annotation == null) {
            return;
        }

        String[] requiredRoles = annotation.value();
        String message = annotation.message();

        boolean hasPermission = Arrays.stream(requiredRoles)
                .anyMatch(role -> role.equalsIgnoreCase(currentRole));

        if (!hasPermission) {
            log.warn("æƒé™æ ¡éªŒå¤±è´¥: å½“å‰è§’è‰²={}, éœ€è¦è§’è‰²ä¹‹ä¸€={}, æ–¹æ³•={}.{}", 
                    currentRole, Arrays.toString(requiredRoles),
                    method.getDeclaringClass().getSimpleName(), method.getName());
            throw new BizException(ErrorCodes.FORBIDDEN, message);
        }

        log.debug("æƒé™æ ¡éªŒé€šè¿‡: è§’è‰²={}, æ–¹æ³•={}.{}", 
                currentRole, method.getDeclaringClass().getSimpleName(), method.getName());
    }

    /**
     * å¤„ç†ç±»çº§åˆ«çš„ @RequireRole æ³¨è§£
     */
    @Before("@within(com.ityfz.yulu.common.annotation.RequireRole)")
    public void checkRoleOnClass(JoinPoint joinPoint) {
        String currentRole = UserContextHolder.getRole();
        if (currentRole == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }

        RequireRole annotation = joinPoint.getTarget().getClass()
                .getAnnotation(RequireRole.class);
        
        if (annotation == null) {
            return;
        }

        String[] requiredRoles = annotation.value();
        String message = annotation.message();

        boolean hasPermission = Arrays.stream(requiredRoles)
                .anyMatch(role -> role.equalsIgnoreCase(currentRole));

        if (!hasPermission) {
            log.warn("æƒé™æ ¡éªŒå¤±è´¥: å½“å‰è§’è‰²={}, éœ€è¦è§’è‰²={}, ç±»={}", 
                    currentRole, Arrays.toString(requiredRoles), 
                    joinPoint.getTarget().getClass().getSimpleName());
            throw new BizException(ErrorCodes.FORBIDDEN, message);
        }
    }

    /**
     * å¤„ç†ç±»çº§åˆ«çš„ @RequireAnyRole æ³¨è§£
     */
    @Before("@within(com.ityfz.yulu.common.annotation.RequireAnyRole)")
    public void checkAnyRoleOnClass(JoinPoint joinPoint) {
        String currentRole = UserContextHolder.getRole();
        if (currentRole == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }

        RequireAnyRole annotation = joinPoint.getTarget().getClass()
                .getAnnotation(RequireAnyRole.class);
        
        if (annotation == null) {
            return;
        }

        String[] requiredRoles = annotation.value();
        String message = annotation.message();

        boolean hasPermission = Arrays.stream(requiredRoles)
                .anyMatch(role -> role.equalsIgnoreCase(currentRole));

        if (!hasPermission) {
            log.warn("æƒé™æ ¡éªŒå¤±è´¥: å½“å‰è§’è‰²={}, éœ€è¦è§’è‰²ä¹‹ä¸€={}, ç±»={}", 
                    currentRole, Arrays.toString(requiredRoles),
                    joinPoint.getTarget().getClass().getSimpleName());
            throw new BizException(ErrorCodes.FORBIDDEN, message);
        }
    }
}
```

### æ­¥éª¤3ï¼šåˆ›å»ºCç«¯Controller

#### 3.1 åˆ›å»ºCç«¯å¯¹è¯Controller

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/customer/controller/CustomerChatController.java`

```java
package com.ityfz.yulu.customer.controller;

import com.ityfz.yulu.chat.dto.ChatAskRequest;
import com.ityfz.yulu.chat.entity.ChatMessage;
import com.ityfz.yulu.chat.service.ChatService;
import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.tenant.TenantContextHolder;
import com.ityfz.yulu.common.tenant.UserContextHolder;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * Cç«¯å¯¹è¯Controller
 * é¢å‘ç§Ÿæˆ·çš„å®¢æˆ·ä½¿ç”¨
 * 
 * APIå‰ç¼€ï¼š/api/customer/chat
 * æƒé™è¦æ±‚ï¼šUSERè§’è‰²
 */
@RestController
@RequestMapping("/api/customer/chat")
@RequiredArgsConstructor
@RequireRole("USER")  // ç±»çº§åˆ«ï¼šæ•´ä¸ªControlleréƒ½éœ€è¦USERè§’è‰²
public class CustomerChatController {

    private final ChatService chatService;

    /**
     * å‘é€æ¶ˆæ¯ç»™AI
     * POST /api/customer/chat/ask
     */
    @PostMapping("/ask")
    public ApiResponse<ChatMessage> ask(@RequestBody ChatAskRequest req) {
        Long tenantId = TenantContextHolder.getTenantId();
        Long userId = UserContextHolder.getUserId();

        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        if (userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }

        ChatMessage aiMsg = chatService.chatWithAi(req.getSessionId(), userId, tenantId, req.getQuestion());
        return ApiResponse.success("OK", aiMsg);
    }

    /**
     * æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„å†å²æ¶ˆæ¯
     * GET /api/customer/chat/messages/{sessionId}
     * 
     * æ³¨æ„ï¼šCç«¯ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä¼šè¯
     */
    @GetMapping("/messages/{sessionId}")
    public ApiResponse<List<ChatMessage>> listMessages(@PathVariable Long sessionId) {
        Long tenantId = TenantContextHolder.getTenantId();
        Long userId = UserContextHolder.getUserId();

        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }

        // æ ¡éªŒä¼šè¯å½’å±ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä¼šè¯
        chatService.checkSessionOwnerOrAgent(tenantId, userId, sessionId);
        List<ChatMessage> messages = chatService.listMessages(sessionId);
        return ApiResponse.success("OK", messages);
    }

    /**
     * è½¬äººå·¥æœåŠ¡
     * POST /api/customer/chat/transfer
     * 
     * åŠŸèƒ½ï¼šå½“AIæ— æ³•è§£å†³æˆ–å®¢æˆ·ä¸»åŠ¨è¦æ±‚æ—¶ï¼Œè½¬æ¥äººå·¥å®¢æœ
     */
    @PostMapping("/transfer")
    public ApiResponse<Void> transferToAgent(@RequestParam Long sessionId) {
        Long tenantId = TenantContextHolder.getTenantId();
        Long userId = UserContextHolder.getUserId();

        // TODO: å®ç°è½¬äººå·¥é€»è¾‘
        // 1. åˆ›å»ºå·¥å•ï¼ˆçŠ¶æ€ï¼šå¾…åˆ†é…ï¼Œä¼˜å…ˆçº§ï¼šMEDIUMï¼‰
        // 2. é€šçŸ¥åœ¨çº¿å®¢æœ
        // 3. è¿”å›æˆåŠŸ

        return ApiResponse.success("å·²è½¬æ¥äººå·¥å®¢æœï¼Œè¯·ç¨å€™...", null);
    }
}
```

#### 3.2 åˆ›å»ºCç«¯FAQ Controllerï¼ˆå¯é€‰ï¼Œåç»­å®ç°ï¼‰

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/customer/controller/CustomerFAQController.java`

```java
package com.ityfz.yulu.customer.controller;

import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.model.ApiResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * Cç«¯FAQ Controller
 * APIå‰ç¼€ï¼š/api/customer/faq
 */
@RestController
@RequestMapping("/api/customer/faq")
@RequiredArgsConstructor
@RequireRole("USER")
public class CustomerFAQController {

    /**
     * è·å–FAQåˆ—è¡¨
     * GET /api/customer/faq/list?category=xxx&keyword=xxx
     */
    @GetMapping("/list")
    public ApiResponse<List<Object>> listFAQ(
            @RequestParam(required = false) String category,
            @RequestParam(required = false) String keyword
    ) {
        // TODO: å®ç°çŸ¥è¯†åº“æŸ¥è¯¢é€»è¾‘
        return ApiResponse.success("OK", List.of());
    }
}
```

### æ­¥éª¤4ï¼šåˆ›å»ºBç«¯Controller

#### 4.1 é‡æ„ç°æœ‰TicketControllerä¸ºAdminTicketController

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/admin/controller/AdminTicketController.java`

```java
package com.ityfz.yulu.admin.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.ityfz.yulu.common.annotation.RequireAnyRole;
import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.security.SecurityUtil;
import com.ityfz.yulu.ticket.dto.TicketAssignRequest;
import com.ityfz.yulu.ticket.dto.TicketCommentCreateRequest;
import com.ityfz.yulu.ticket.dto.TicketTransitionRequest;
import com.ityfz.yulu.ticket.entity.Ticket;
import com.ityfz.yulu.ticket.entity.TicketComment;
import com.ityfz.yulu.ticket.enums.TicketStatsResponse;
import com.ityfz.yulu.ticket.service.TicketService;
import lombok.RequiredArgsConstructor;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.util.List;

/**
 * Bç«¯å·¥å•ç®¡ç†Controller
 * é¢å‘ç§Ÿæˆ·çš„ç®¡ç†å‘˜å’Œå®¢æœä½¿ç”¨
 * 
 * APIå‰ç¼€ï¼š/api/admin/ticket
 * æƒé™è¦æ±‚ï¼šADMIN æˆ– AGENT
 */
@RestController
@RequestMapping("/api/admin/ticket")
@RequiredArgsConstructor
@Validated
@RequireAnyRole({"ADMIN", "AGENT"})  // ç®¡ç†å‘˜æˆ–å®¢æœéƒ½å¯ä»¥è®¿é—®
public class AdminTicketController {

    private final TicketService ticketService;

    /**
     * åˆ†é¡µæŸ¥è¯¢å·¥å•åˆ—è¡¨
     * GET /api/admin/ticket/list?status=PENDING&page=1&size=10
     */
    @GetMapping("/list")
    public ApiResponse<IPage<Ticket>> list(
            @RequestParam(required = false) String status,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "10") int size
    ) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long userId = SecurityUtil.currentUserId();

        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }

        if (page < 1) page = 1;
        if (size < 1 || size > 100) size = 10;

        IPage<Ticket> result = ticketService.listTickets(tenantId, status, page, size);
        return ApiResponse.success("æŸ¥è¯¢æˆåŠŸ", result);
    }

    /**
     * åˆ†é…å·¥å•ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
     * POST /api/admin/ticket/assign
     */
    @PostMapping("/assign")
    @RequireRole("ADMIN")  // æ–¹æ³•çº§åˆ«ï¼šä»…ç®¡ç†å‘˜å¯åˆ†é…å·¥å•
    public ApiResponse<Void> assign(@Valid @RequestBody TicketAssignRequest request) {
        Long tenantId = SecurityUtil.currentTenantId();
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }

        ticketService.assign(tenantId, request.getTicketId(), request.getAssigneeUserId());
        return ApiResponse.success("å·¥å•åˆ†é…æˆåŠŸ", null);
    }

    /**
     * å·¥å•çŠ¶æ€æµè½¬
     * POST /api/admin/ticket/transition
     */
    @PostMapping("/transition")
    public ApiResponse<Void> transition(@Valid @RequestBody TicketTransitionRequest req) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long userId = SecurityUtil.currentUserId();
        String role = SecurityUtil.currentRole();
        
        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }
        
        ticketService.transitionStatus(tenantId, userId, role,
                req.getTicketId(), req.getTargetStatus(), req.getComment());
        return ApiResponse.success("çŠ¶æ€æ›´æ–°æˆåŠŸ", null);
    }

    /**
     * æ·»åŠ å·¥å•å¤‡æ³¨
     * POST /api/admin/ticket/comment
     */
    @PostMapping("/comment")
    public ApiResponse<Void> addComment(@Valid @RequestBody TicketCommentCreateRequest req) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long userId = SecurityUtil.currentUserId();
        
        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }
        
        ticketService.addComment(tenantId, userId, req.getTicketId(), req.getContent());
        return ApiResponse.success("æ·»åŠ æˆåŠŸ", null);
    }

    /**
     * è·å–å·¥å•å¤‡æ³¨åˆ—è¡¨
     * GET /api/admin/ticket/comment/list?ticketId=xxx
     */
    @GetMapping("/comment/list")
    public ApiResponse<List<TicketComment>> listComment(@RequestParam Long ticketId) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long userId = SecurityUtil.currentUserId();
        
        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }
        
        return ApiResponse.success("OK", ticketService.listComments(tenantId, ticketId));
    }

    /**
     * è·å–å·¥å•ç»Ÿè®¡ä¿¡æ¯
     * GET /api/admin/ticket/stats
     */
    @GetMapping("/stats")
    public ApiResponse<TicketStatsResponse> stats() {
        Long tenantId = SecurityUtil.currentTenantId();
        Long userId = SecurityUtil.currentUserId();
        
        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }
        
        return ApiResponse.success("OK", ticketService.stats(tenantId));
    }
}
```

#### 4.2 åˆ›å»ºBç«¯ä¼šè¯ç®¡ç†Controller

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/admin/controller/AdminSessionController.java`

```java
package com.ityfz.yulu.admin.controller;

import com.ityfz.yulu.chat.entity.ChatMessage;
import com.ityfz.yulu.chat.entity.ChatSession;
import com.ityfz.yulu.chat.service.ChatService;
import com.ityfz.yulu.common.annotation.RequireAnyRole;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.security.SecurityUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * Bç«¯ä¼šè¯ç®¡ç†Controller
 * APIå‰ç¼€ï¼š/api/admin/session
 * æƒé™è¦æ±‚ï¼šADMIN æˆ– AGENT
 */
@RestController
@RequestMapping("/api/admin/session")
@RequiredArgsConstructor
@RequireAnyRole({"ADMIN", "AGENT"})
public class AdminSessionController {

    private final ChatService chatService;

    /**
     * è·å–å½“å‰ç§Ÿæˆ·ä¸‹æ‰€æœ‰ä¼šè¯ï¼ˆç®¡ç†å‘˜/å®¢æœå¯æŸ¥çœ‹ï¼‰
     * GET /api/admin/session/list
     */
    @GetMapping("/list")
    public ApiResponse<List<ChatSession>> listAllSessions() {
        Long tenantId = SecurityUtil.currentTenantId();
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }

        List<ChatSession> sessions = chatService.listAllSessionsByTenant(tenantId);
        return ApiResponse.success("OK", sessions);
    }

    /**
     * æŸ¥çœ‹æŸä¸ªç”¨æˆ·çš„ä¼šè¯åˆ—è¡¨
     * GET /api/admin/session/user/{userId}
     */
    @GetMapping("/user/{userId}")
    public ApiResponse<List<ChatSession>> listUserSessions(@PathVariable Long userId) {
        Long tenantId = SecurityUtil.currentTenantId();
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        
        List<ChatSession> sessions = chatService.listUserSessionsByUsers(tenantId, userId);
        return ApiResponse.success("OK", sessions);
    }

    /**
     * æŸ¥çœ‹ä¼šè¯æ¶ˆæ¯åˆ—è¡¨
     * GET /api/admin/session/{sessionId}/messages
     */
    @GetMapping("/{sessionId}/messages")
    public ApiResponse<List<ChatMessage>> listMessages(@PathVariable Long sessionId) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long userId = SecurityUtil.currentUserId();
        
        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }
        
        // ç®¡ç†å‘˜/å®¢æœå¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä¼šè¯
        chatService.checkSessionOwnerOrAgent(tenantId, userId, sessionId);
        List<ChatMessage> messages = chatService.listMessages(sessionId);
        return ApiResponse.success("OK", messages);
    }
}
```

#### 4.3 åˆ›å»ºBç«¯æ•°æ®çœ‹æ¿Controller

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/admin/controller/AdminDashboardController.java`

```java
package com.ityfz.yulu.admin.controller;

import com.ityfz.yulu.common.annotation.RequireAnyRole;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.security.SecurityUtil;
import lombok.Data;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.time.LocalDate;
import java.util.HashMap;
import java.util.Map;

/**
 * Bç«¯æ•°æ®çœ‹æ¿Controller
 * APIå‰ç¼€ï¼š/api/admin/dashboard
 * æƒé™è¦æ±‚ï¼šADMIN æˆ– AGENT
 */
@RestController
@RequestMapping("/api/admin/dashboard")
@RequiredArgsConstructor
@RequireAnyRole({"ADMIN", "AGENT"})
public class AdminDashboardController {

    /**
     * è·å–ç»Ÿè®¡æ•°æ®
     * GET /api/admin/dashboard/stats
     */
    @GetMapping("/stats")
    public ApiResponse<DashboardStats> getStats() {
        Long tenantId = SecurityUtil.currentTenantId();
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }

        // TODO: å®ç°ç»Ÿè®¡æ•°æ®æŸ¥è¯¢
        // 1. ä»Šæ—¥å¯¹è¯é‡
        // 2. AIè§£å†³ç‡
        // 3. è½¬äººå·¥ç‡
        // 4. å·¥å•å¤„ç†é‡
        // 5. å¹³å‡å“åº”æ—¶é—´
        // 6. å®¢æˆ·æ»¡æ„åº¦

        DashboardStats stats = new DashboardStats();
        stats.setTodayChatCount(0L);
        stats.setAiResolveRate(0.0);
        stats.setTransferRate(0.0);
        stats.setTicketCount(0L);
        stats.setAvgResponseTime(0L);
        stats.setSatisfactionRate(0.0);

        return ApiResponse.success("OK", stats);
    }

    /**
     * ç»Ÿè®¡æ•°æ®DTO
     */
    @Data
    public static class DashboardStats {
        private Long todayChatCount;      // ä»Šæ—¥å¯¹è¯é‡
        private Double aiResolveRate;     // AIè§£å†³ç‡
        private Double transferRate;      // è½¬äººå·¥ç‡
        private Long ticketCount;         // å·¥å•æ•°é‡
        private Long avgResponseTime;     // å¹³å‡å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        private Double satisfactionRate; // æ»¡æ„åº¦
    }
}
```

### æ­¥éª¤5ï¼šæ›´æ–°ç°æœ‰Controllerï¼ˆä¿æŒå…¼å®¹ï¼‰

#### 5.1 ä¿ç•™åŸæœ‰ChatControllerï¼ˆæ ‡è®°ä¸ºåºŸå¼ƒï¼Œé€æ­¥è¿ç§»ï¼‰

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/chat/controller/ChatController.java`

```java
package com.ityfz.yulu.chat.controller;

import com.ityfz.yulu.chat.dto.ChatAskRequest;
import com.ityfz.yulu.chat.entity.ChatSession;
import com.ityfz.yulu.chat.entity.ChatMessage;
import com.ityfz.yulu.chat.service.ChatService;
import com.ityfz.yulu.common.annotation.RequireAnyRole;
import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.security.SecurityUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * å¯¹è¯Controllerï¼ˆæ—§ç‰ˆï¼Œä¿æŒå…¼å®¹ï¼‰
 * 
 * @deprecated è¯·ä½¿ç”¨ CustomerChatController æˆ– AdminSessionController
 * æ­¤Controllerå°†åœ¨åç»­ç‰ˆæœ¬ä¸­ç§»é™¤
 */
@Deprecated
@RestController
@RequestMapping("/api/chat")
@RequiredArgsConstructor
public class ChatController {
    private final ChatService chatService;

    @PostMapping("/ask")
    @RequireRole("USER")  // ä½¿ç”¨AOPæ³¨è§£æ›¿ä»£æ‰‹åŠ¨æ ¡éªŒ
    public ApiResponse<ChatMessage> ask(@RequestBody ChatAskRequest req) {
        // ä¿æŒåŸæœ‰é€»è¾‘ï¼Œä½†ä½¿ç”¨AOPæƒé™æ§åˆ¶
        Long tenantId = TenantContextHolder.getTenantId();
        Long userId = UserContextHolder.getUserId();

        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        if (userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }

        ChatMessage aiMsg = chatService.chatWithAi(req.getSessionId(), userId, tenantId, req.getQuestion());
        return ApiResponse.success("OK", aiMsg);
    }

    @GetMapping("/messages/{sessionId}")
    @RequireRole("USER")
    public ApiResponse<List<ChatMessage>> listMessages(@PathVariable Long sessionId) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long userId = SecurityUtil.currentUserId();
        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
        }
        chatService.checkSessionOwnerOrAgent(tenantId, userId, sessionId);
        List<ChatMessage> messages = chatService.listMessages(sessionId);
        return ApiResponse.success("OK", messages);
    }

    @GetMapping("/sessions/all")
    @RequireAnyRole({"ADMIN", "AGENT"})  // ä½¿ç”¨AOPæ³¨è§£
    public ApiResponse<List<ChatSession>> listAllSessionsForTenant() {
        Long tenantId = SecurityUtil.currentTenantId();
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        List<ChatSession> sessions = chatService.listAllSessionsByTenant(tenantId);
        return ApiResponse.success("OK", sessions);
    }

    @GetMapping("/sessions/user/{userId}")
    @RequireAnyRole({"ADMIN", "AGENT"})
    public ApiResponse<List<ChatSession>> listUserSessions(@PathVariable Long userId) {
        Long tenantId = SecurityUtil.currentTenantId();
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        List<ChatSession> sessions = chatService.listUserSessionsByUsers(tenantId, userId);
        return ApiResponse.success("OK", sessions);
    }
}
```

#### 5.2 æ›´æ–°TicketControllerï¼ˆæ ‡è®°ä¸ºåºŸå¼ƒï¼‰

**æ–‡ä»¶**ï¼š`src/main/java/com/ityfz/yulu/ticket/controller/TicketController.java`

```java
// åœ¨ç±»ä¸Šæ·»åŠ  @Deprecated æ³¨è§£
@Deprecated
@RestController
@RequestMapping("/api/ticket")  // æ—§è·¯å¾„ï¼Œä¿æŒå…¼å®¹
// ... å…¶ä»–ä»£ç ä¿æŒä¸å˜ï¼Œä½†å»ºè®®æ·»åŠ AOPæ³¨è§£
```

### æ­¥éª¤6ï¼šæ·»åŠ AOPä¾èµ–ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

**æ£€æŸ¥ `pom.xml`**ï¼Œç¡®ä¿æœ‰AOPä¾èµ–ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```

å¦‚æœå·²ç»æœ‰ `spring-boot-starter-web`ï¼Œé€šå¸¸å·²ç»åŒ…å«äº†AOPï¼Œä½†å»ºè®®æ˜¾å¼æ·»åŠ ã€‚

---

## ğŸ“ å››ã€å®æ–½æ£€æŸ¥æ¸…å•

### âœ… æ­¥éª¤1ï¼šåˆ›å»ºæ³¨è§£å’Œåˆ‡é¢
- [x] åˆ›å»º `RequireRole` æ³¨è§£
- [ ] åˆ›å»º `RequireAnyRole` æ³¨è§£
- [x] åˆ›å»º `RoleCheckAspect` åˆ‡é¢
- [x] åœ¨ `pom.xml` ç¡®è®¤AOPä¾èµ–

### âœ… æ­¥éª¤2ï¼šåˆ›å»ºCç«¯Controller
- [x] åˆ›å»º `CustomerChatController`ï¼ˆ`/api/customer/chat/*`ï¼‰
- [x] åˆ›å»º `CustomerFAQController`ï¼ˆå¯é€‰ï¼‰
- [ ] æµ‹è¯•Cç«¯æ¥å£æƒé™

### âœ… æ­¥éª¤3ï¼šåˆ›å»ºBç«¯Controller
- [ ] åˆ›å»º `AdminTicketController`ï¼ˆ`/api/admin/ticket/*`ï¼‰
- [ ] åˆ›å»º `AdminSessionController`ï¼ˆ`/api/admin/session/*`ï¼‰
- [ ] åˆ›å»º `AdminDashboardController`ï¼ˆ`/api/admin/dashboard/*`ï¼‰
- [ ] æµ‹è¯•Bç«¯æ¥å£æƒé™

### âœ… æ­¥éª¤4ï¼šæ›´æ–°ç°æœ‰Controller
- [ ] åœ¨ç°æœ‰Controllerä¸Šæ·»åŠ AOPæ³¨è§£
- [ ] æ ‡è®°æ—§Controllerä¸º `@Deprecated`
- [ ] ä¿æŒå‘åå…¼å®¹

### âœ… æ­¥éª¤5ï¼šæµ‹è¯•éªŒè¯
- [ ] æµ‹è¯•USERè§’è‰²è®¿é—®Cç«¯æ¥å£ï¼ˆåº”è¯¥æˆåŠŸï¼‰
- [ ] æµ‹è¯•USERè§’è‰²è®¿é—®Bç«¯æ¥å£ï¼ˆåº”è¯¥å¤±è´¥ï¼Œè¿”å›403ï¼‰
- [ ] æµ‹è¯•ADMINè§’è‰²è®¿é—®Bç«¯æ¥å£ï¼ˆåº”è¯¥æˆåŠŸï¼‰
- [ ] æµ‹è¯•AGENTè§’è‰²è®¿é—®Bç«¯æ¥å£ï¼ˆåº”è¯¥æˆåŠŸï¼‰
- [ ] æµ‹è¯•æœªç™»å½•è®¿é—®ï¼ˆåº”è¯¥è¿”å›401ï¼‰

---

## ğŸ” äº”ã€AOPå·¥ä½œåŸç†è¯´æ˜

### 5.1 æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ JwtAuthFilterï¼ˆè®¾ç½®ä¸Šä¸‹æ–‡ï¼‰ â†’ AOPåˆ‡é¢ï¼ˆæƒé™æ ¡éªŒï¼‰ â†’ Controlleræ–¹æ³• â†’ è¿”å›å“åº”
```

### 5.2 æ³¨è§£ä¼˜å…ˆçº§

1. **æ–¹æ³•çº§åˆ«æ³¨è§£** > **ç±»çº§åˆ«æ³¨è§£**
2. å¦‚æœæ–¹æ³•ä¸Šæœ‰ `@RequireRole("ADMIN")`ï¼Œç±»ä¸Šæœ‰ `@RequireAnyRole({"ADMIN", "AGENT"})`ï¼Œåˆ™æ–¹æ³•çº§åˆ«ç”Ÿæ•ˆ

### 5.3 å¸¸è§é—®é¢˜

**Q: AOPä¸ç”Ÿæ•ˆï¼Ÿ**
- æ£€æŸ¥ `@Aspect` å’Œ `@Component` æ³¨è§£
- æ£€æŸ¥ `@Order(1)` ç¡®ä¿ä¼˜å…ˆçº§
- æ£€æŸ¥æ–¹æ³•æ˜¯å¦è¢«Springç®¡ç†ï¼ˆä¸èƒ½æ˜¯privateã€staticï¼‰

**Q: æƒé™æ ¡éªŒå¤±è´¥ä½†æ²¡æŠ›å¼‚å¸¸ï¼Ÿ**
- æ£€æŸ¥ `UserContextHolder.getRole()` æ˜¯å¦è¿”å›null
- æ£€æŸ¥åˆ‡é¢æ˜¯å¦æ­£ç¡®æ‹¦æˆªåˆ°æ–¹æ³•

**Q: å¦‚ä½•è°ƒè¯•AOPï¼Ÿ**
- åœ¨åˆ‡é¢æ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—
- ä½¿ç”¨ `@Before` æ‰“å°æ–¹æ³•ç­¾åå’Œå‚æ•°

---

## ğŸ¯ å…­ã€ä¸‹ä¸€æ­¥

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼š

1. **å‰ç«¯é€‚é…**ï¼šä¿®æ”¹å‰ç«¯APIè°ƒç”¨è·¯å¾„
   - Cç«¯ï¼š`/api/customer/*`
   - Bç«¯ï¼š`/api/admin/*`

2. **é€æ­¥è¿ç§»**ï¼šå°†æ—§æ¥å£æ ‡è®°ä¸ºåºŸå¼ƒï¼Œå¼•å¯¼å‰ç«¯ä½¿ç”¨æ–°æ¥å£

3. **åŠŸèƒ½æ‰©å±•**ï¼šåŸºäºæ–°æ¶æ„ç»§ç»­å¼€å‘Cç«¯å’ŒBç«¯åŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¶é—´**ï¼š2026-01-14





























