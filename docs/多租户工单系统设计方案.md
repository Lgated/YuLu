## 多租户工单系统设计方案

> 面向 YuLu 多租户智能客服中台  
> 目标：支持不同行业（电商、教育、SaaS 等）在同一套工单系统上完成“问题接入 → 人工处理 → 反馈闭环”，并保持模型通用、可扩展。

---

### 一、设计目标与原则

#### 1.1 设计目标

- **多租户**：不同企业/机构在同一系统上创建自己的工单中心，数据相互隔离。
- **行业无关 + 可扩展**：工单模型不绑定某个行业（如电商订单），通过扩展字段承载行业差异。
- **多源触发**：不仅情绪报警，后续可支持转人工、RAG 低置信度、SLA 超时、合规风险等多种触发方式。
- **闭环流程**：从“创建 → 分配/接单 → 处理 → 完成/关闭 → 统计”形成完整生命周期。
- **简单接入**：对接租户业务系统（订单、课程等）时，尽量通过统一接口+扩展字段，而不是复制业务表结构。

#### 1.2 设计原则

- **一套 Ticket 核心模型，行业差异靠扩展**。
- **所有数据带 `tenant_id`，严格租户隔离**。
- **配置驱动**：工单字段、触发规则、行业类型由租户配置控制。
- **前后端分离**：接口返回统一结构（`ApiResponse` + DTO），前端根据字段配置动态渲染。

---

### 二、整体架构与角色

#### 2.1 角色

- **平台运营方**：部署平台、控制整体开关及计费。
- **租户管理员（ADMIN）**：
  - 配置工单字段、触发规则、行业信息。
  - 管理客服账号、查看统计报表。
- **客服坐席（AGENT）**：
  - 处理分配到自己的工单。
  - 查看会话、知识库信息，补充备注。
- **C 端用户（USER）**：
  - 与 AI/人工对话。
  - 间接触发工单（情绪报警、转人工、投诉等）。

#### 2.2 工单系统在整体中的位置

- **输入**：来自聊天系统（情绪报警、转人工）、业务系统（订单异常）、定时任务（SLA 超时）等。
- **内部**：`ticket` + `ticket_extra`/自定义字段 + `ticket_comment` + `ticket_action_log`。
- **输出**：给客服工作台、管理员报表、通知中心。

---

### 三、数据模型设计

#### 3.1 Ticket 核心表（通用）

表：`ticket`

- `id`：主键  
- `tenant_id`：租户 ID  
- `user_id`：发起用户 ID（C 端）  
- `session_id`：关联会话 ID（可为空）  
- `assignee`：当前处理人（客服 ID，可为空）  
- `status`：状态（PENDING/PROCESSING/DONE/CLOSED）  
- `priority`：优先级（LOW/MEDIUM/HIGH/URGENT）  
- `title`：标题（如“情绪告警-会话#3”、“退款申请-订单#12345”）  
- `description`：描述（可截取来自对话/系统日志）  
- `source`：来源（见 3.2）  
- `category`：业务分类（如 REFUND/COMPLAINT/INVOICE/TECH…）  
- `biz_type`：业务类型（ORDER/COURSE/CONTRACT/GENERIC…）  
- `biz_id`：业务 ID（租户业务系统中的主键）  
- `created_at`：创建时间  
- `updated_at`：更新时间  
- `resolved_at`：解决时间（状态 DONE 时填）  
- `closed_at`：关闭时间（状态 CLOSED 时填）  

> 说明：`biz_type` + `biz_id` 构成工单与业务对象的轻量关联，不强依赖行业。

#### 3.2 工单来源枚举（source）

推荐枚举（可扩展）：

- `EMOTION`：情绪报警（负面情绪严重）  
- `TRANSFER`：用户主动转人工  
- `RAG_LOW_SCORE`：RAG 无命中/置信度过低  
- `SLA_TIMEOUT`：服务超时（会话/工单未及时处理）  
- `COMPLIANCE`：敏感词/违法/合规风险  
- `SYSTEM_ERROR`：内部系统错误（支付、库存、接口失败）  
- `MANUAL`：管理员/客服手工创建  

> 统一在 `ticket` 表存 `source` 字段，便于统计和路由。

#### 3.3 工单扩展字段

有两种方案，可按演进阶段选择：

##### 方案 A：单表 JSON（简单版本）

在 `ticket` 表加一个字段：

- `extra`：`JSON`，存放行业相关信息，比如：

电商租户：

```json
{
  "orderNo": "202601160001",
  "orderAmount": 99.50,
  "logisticsStatus": "DELIVERED"
}
```

教育租户：

```json
{
  "courseName": "Python 入门班",
  "classTime": "2026-01-20 19:00",
  "teacher": "张老师"
}
```

优点：实现简单、改造少。  
缺点：字段不可配置、统计需要解析 JSON。

##### 方案 B：自定义字段模型（企业级）

新增表：

1. `ticket_custom_field`（字段定义）  
   - `id, tenant_id`  
   - `code`：字段编码，如 `order_no`、`course_name`  
   - `label`：展示名称  
   - `field_type`：STRING/NUMBER/DATE/SELECT…  
   - `biz_type`：适用业务类型（ORDER/COURSE/GENERIC…）  
   - `required`：是否必填  
   - `order_num`：排序  

2. `ticket_custom_field_value`（字段值）  
   - `id, tenant_id, ticket_id, field_code, field_value`  

优点：字段可配置、便于统计与表单生成。  
缺点：实现复杂度更高，建议在项目稳定后第二阶段做。

---

### 四、工单生命周期与状态流转

#### 4.1 状态枚举

- `PENDING`：待处理（刚创建，还未接单/未开始处理）  
- `PROCESSING`：处理中（已接单/正在处理）  
- `DONE`：已完成（问题已解决）  
- `CLOSED`：已关闭（用户确认/超时/管理员关闭）  

#### 4.2 流转规则（建议）

- `PENDING → PROCESSING`：  
  - 管理员派单 + 客服接单  
  - 或管理员直接“开始处理”（小团队）  
- `PROCESSING → DONE`：  
  - 客服/管理员提交“解决方案”（resolution）  
- `DONE → CLOSED`：  
  - 用户确认无问题，或系统定时自动关闭  
- `PENDING → CLOSED`：  
  - 管理员关闭（例如误报/重复单）  
- `PROCESSING → CLOSED`：  
  - 管理员强制关闭（例如用户取消/超时）  

> 后端通过 `TicketStatus` 枚举 + 状态机校验（你现在 `transitionStatus` 已有基础逻辑，可在此上加强）。

---

### 五、多源触发逻辑设计

#### 5.1 情绪报警（已有）

- 触发点：`ChatServiceImpl` 中情绪识别结果为强负面（ANGRY/SAD 等），且满足阈值（如连续 N 轮负面）。  
- 创建工单：  
  - `source=EMOTION`  
  - `biz_type=GENERIC`  
  - `title=情绪告警-会话#${sessionId}`  
  - `description=截取最近几轮对话内容`  

#### 5.2 转人工

- 触发点：`CustomerChatController.transferToAgent`（或者聊天中识别出“问题太复杂/我要人工”）  
- 创建工单：  
  - `source=TRANSFER`  
  - `category` 可由对话意图字段（intent）推断：REFUND/INVOICE/COMPLAIN…  
  - `biz_type/biz_id` 可从 RAG/对话中的订单号等识别出后填入  

#### 5.3 RAG 低置信度

- 触发点：`KnowledgeChatServiceImpl.buildRagAugment` 或 `ChatServiceImpl` 在拿到 `refs` 后判断：  
  - `refs` 为空，或最大 score < 动态阈值  
  - 同一会话内连续 2~3 次命中这类情况  
- 创建工单：  
  - `source=RAG_LOW_SCORE`  
  - 附上用户问题 + RAG 查询语句 + 命中结果（为空或低分）  

价值：帮助管理员发现“知识库缺口”或“分词/召回问题”。

#### 5.4 SLA 超时

- 触发点：定时任务（XXL-Job）扫描 `ticket`：  
  - `status` 为 PENDING/PROCESSING 且 `created_at` / `updated_at` 超过阈值  
- 行为：  
  - 给管理员发通知（`notify` 模块）  
  - 可以自动升级优先级，或者自动建一个“升级工单”  

#### 5.5 合规/敏感词

- 触发点：聊天消息经过敏感词规则引擎（简单可以先做关键字匹配）。  
- 创建工单：  
  - `source=COMPLIANCE`  
  - `category=COMPLAIN/RISK`  
  - 描述中包含命中的关键字和消息片段  

---

### 六、前端交互与页面设计

#### 6.1 管理员端工单列表（现状基础上增强）

功能：

- 分页、按状态/优先级过滤  
- **派单**（选择客服 → `assign`）  
- 查看工单详情（抽屉/详情页）  
- 手动创建工单（可选）  

建议扩展：

- 显示 `source/category` 等字段  
- 在详情里展示扩展字段（订单号/课程等）  

#### 6.2 客服端“我的工单”

功能：

- 只显示分配给自己的工单（`listTicketsByAssignee`）  
- 按状态过滤：待处理/处理中/已完成/已关闭  
- “开始处理/接单” → `PROCESSING`  
- “完成” → `DONE`（要求填写解决说明）  
- 查看备注、添加备注、查看知识库/会话信息  

---

### 七、多租户 & 行业接入策略

#### 7.1 租户表增加行业字段

`tenant` 增加：

- `industry`：枚举，如 `ECOMMERCE`、`EDU`、`SAAS`、`FINANCE`、`GENERIC`…  

关联影响：

- 工单字段模板  
- 触发规则默认值  
- RAG 知识库结构（分库/分类）  

#### 7.2 行业模板 + 自定义

每种行业预置一套“工单字段模板”，租户管理员可以：

- 启用/禁用字段  
- 添加自定义字段  
- 调整显示顺序  

例如电商模板：

- 订单号（必填，STRING）  
- 订单金额（NUMBER）  
- 商品名称（STRING）  
- 售后类型（SELECT：退款、换货、补发…）  

教育模板：

- 课程名称  
- 班级/年级  
- 学员 ID  
- 上课时间  

这些模板最终映射到 `ticket_extra` 或 `ticket_custom_field/value`。

#### 7.3 接入方式

- **API 接入**：租户在自己的系统中，调用你的“创建工单 API”，传入 `biz_type/biz_id/extra`。  
- **Webhook/回调**（可选）：工单状态变化时通知租户系统（用于双向同步）。  
- **导入方式**：允许租户上传 CSV/Excel 批量导入历史工单/订单关联。  

---

### 八、接口与实现步骤（高层级）

#### 8.1 建议新增/调整的后端接口（概要）

> 这里只列出关键接口，具体 DTO/参数可基于现有代码细化。

- `POST /api/admin/ticket/claim`（可选）  
  - 功能：客服接单 → `PENDING -> PROCESSING`  
- `POST /api/admin/ticket/resolve`  
  - 功能：设置 `DONE`，需要 `resolution` 文本  
- `GET /api/admin/ticket/{id}`  
  - 功能：查询工单详情（含扩展字段、评论、操作日志）  
- `POST /api/admin/ticket/create`（可选）  
  - 功能：管理员手工创建工单（source=MANUAL）  
- 触发方内部调用的 Service 方法（示例）：  
  - `TicketService.createFromEmotion(...)`  
  - `TicketService.createFromTransfer(...)`  
  - `TicketService.createFromRagLowScore(...)`  
  - `TicketService.createFromSystemError(...)`  

#### 8.2 实现步骤建议

1. **第一阶段（结构打底）**  
   - 在 `ticket` 表加上 `source/category/bizType/bizId/extra`（或加 `ticket_extra` 表）  
   - 把“情绪报警工单”创建逻辑改为使用这些字段  
   - 管理员、客服端页面适配新的字段展示（先只读）  

2. **第二阶段（多源触发）**  
   - 在 `ChatServiceImpl` 中，加 RAG 低置信度触发逻辑  
   - 在 `transferToAgent` 中实现转人工→工单创建  
   - 添加简单的敏感词规则触发  

3. **第三阶段（行业模板 & 字段配置）**  
   - 在租户管理后台加行业选择字段（industry）  
   - 为电商/教育等创建预置字段模板，写到 `ticket_custom_field`  
   - 工单详情页根据字段定义动态渲染  

4. **第四阶段（SLA & 报表）**  
   - 定时任务扫描超时工单（`SLA_TIMEOUT`）  
   - 报表统计按 source/category/priority/assignee 展示  

---

### 九、总结

- 工单系统的核心不是“订单工单/课程工单”，而是“一套通用的事件/任务闭环机制”。  
- 通过 `source/category/bizType/bizId/extra` 或自定义字段模型，可以在不牺牲通用性的前提下，对接任何行业。  
- 现有的“情绪报警工单”是一个很好的起点，只需按本方案逐步演进，就能升级为面向多行业的 SaaS 级工单系统。  


