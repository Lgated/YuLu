 # è´¦å·ç®¡ç†åŠŸèƒ½å®ç°æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¶é—´**: 2026-01-21  
> **ç›®æ ‡**: åœ¨ç®¡ç†å‘˜é¡µé¢å®ç°è´¦å·ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬Cç«¯ç”¨æˆ·ç®¡ç†å’ŒBç«¯ç”¨æˆ·ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰ç®¡ç†

---

## ğŸ“‹ ä¸€ã€éœ€æ±‚åˆ†æ

### 1.1 å½“å‰çŠ¶æ€
- âœ… æ³¨å†Œé€»è¾‘ï¼š`registerTenant` åŒæ—¶åˆ›å»ºç§Ÿæˆ·å’Œç®¡ç†å‘˜
- âœ… ç”¨æˆ·è¡¨ç»“æ„å®Œæ•´ï¼šid, tenantId, username, password, role, status, nickName, email, phone
- âœ… è§’è‰²ç³»ç»Ÿï¼šADMINã€AGENTã€USER
- âœ… æƒé™æ§åˆ¶ï¼š`@RequireRole` æ³¨è§£
- âŒ ç¼ºå°‘è´¦å·ç®¡ç†åŠŸèƒ½
- âŒ æ— æ³•æŸ¥çœ‹/ç®¡ç†å½“å‰ç§Ÿæˆ·ä¸‹çš„ç”¨æˆ·
- âŒ æ— æ³•åˆ›å»º/ä¿®æ”¹ç®¡ç†å‘˜å’Œå®¢æœè´¦å·

### 1.2 åŠŸèƒ½éœ€æ±‚

#### 1.2.1 è´¦å·ç®¡ç†Tabç»“æ„

```
è´¦å·ç®¡ç†
â”œâ”€â”€ Cç«¯ç”¨æˆ·ç®¡ç†ï¼ˆrole=USERï¼‰
â”‚   â”œâ”€â”€ ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µã€æœç´¢ã€ç­›é€‰ï¼‰
â”‚   â”œâ”€â”€ åˆ›å»ºç”¨æˆ·
â”‚   â”œâ”€â”€ ç¼–è¾‘ç”¨æˆ·
â”‚   â”œâ”€â”€ åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
â”‚   â””â”€â”€ å¯ç”¨/ç¦ç”¨ç”¨æˆ·
â”‚
â””â”€â”€ Bç«¯ç”¨æˆ·ç®¡ç†ï¼ˆrole=ADMIN/AGENTï¼‰
    â”œâ”€â”€ ç®¡ç†å‘˜/å®¢æœåˆ—è¡¨ï¼ˆåˆ†é¡µã€æœç´¢ã€ç­›é€‰ï¼‰
    â”œâ”€â”€ åˆ›å»ºç®¡ç†å‘˜/å®¢æœ
    â”œâ”€â”€ ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
    â”œâ”€â”€ ä¿®æ”¹è§’è‰²ï¼ˆADMIN â†” AGENTï¼‰
    â”œâ”€â”€ é‡ç½®å¯†ç 
    â”œâ”€â”€ åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
    â””â”€â”€ å¯ç”¨/ç¦ç”¨ç”¨æˆ·
```

### 1.3 æƒé™è¦æ±‚

- **ä»…ç®¡ç†å‘˜ï¼ˆADMINï¼‰**å¯ä»¥è®¿é—®è´¦å·ç®¡ç†åŠŸèƒ½
- æ‰€æœ‰æ“ä½œéƒ½éœ€è¦éªŒè¯ç§Ÿæˆ·éš”ç¦»ï¼ˆåªèƒ½æ“ä½œå½“å‰ç§Ÿæˆ·çš„ç”¨æˆ·ï¼‰
- ä¸èƒ½åˆ é™¤è‡ªå·±ï¼ˆé˜²æ­¢è¯¯æ“ä½œï¼‰

---

## ğŸ—ï¸ äºŒã€æ¶æ„è®¾è®¡

### 2.1 æ¨¡å—åˆ’åˆ†

```
AdminUserManagementController (è´¦å·ç®¡ç†Controller)
    â†“
UserManagementService (è´¦å·ç®¡ç†Service)
    â†“
UserService (ç”¨æˆ·åŸºç¡€æœåŠ¡ï¼Œå·²å­˜åœ¨)
    â†“
UserMapper (ç”¨æˆ·æ•°æ®è®¿é—®ï¼Œå·²å­˜åœ¨)
```

### 2.2 æ•°æ®æµ

```
å‰ç«¯è¯·æ±‚
  â†“
AdminUserManagementController (æƒé™æ ¡éªŒã€å‚æ•°éªŒè¯)
  â†“
UserManagementService (ä¸šåŠ¡é€»è¾‘ã€æ•°æ®ç»„è£…)
  â†“
UserService (åŸºç¡€CRUD)
  â†“
UserMapper (æ•°æ®åº“æ“ä½œ)
  â†“
è¿”å›ç»“æœ
```

---

## ğŸ’» ä¸‰ã€åç«¯å®ç°æ–¹æ¡ˆ

### 3.1 DTOè®¾è®¡

#### 3.1.1 ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢DTO

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/dto/UserListRequest.java`

```java
package com.ityfz.yulu.admin.dto;

import lombok.Data;

/**
 * ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢è¯·æ±‚
 */
@Data
public class UserListRequest {
    /**
     * è§’è‰²ç­›é€‰ï¼šUSER/ADMIN/AGENTï¼Œå¦‚æœä¸ºnullåˆ™æŸ¥è¯¢æ‰€æœ‰
     */
    private String role;
    
    /**
     * çŠ¶æ€ç­›é€‰ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨ï¼Œå¦‚æœä¸ºnullåˆ™æŸ¥è¯¢æ‰€æœ‰
     */
    private Integer status;
    
    /**
     * å…³é”®è¯æœç´¢ï¼ˆç”¨æˆ·åã€æ˜µç§°ã€é‚®ç®±ã€æ‰‹æœºå·ï¼‰
     */
    private String keyword;
    
    /**
     * é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
     */
    private Integer page = 1;
    
    /**
     * æ¯é¡µå¤§å°
     */
    private Integer size = 10;
}
```

#### 3.1.2 ç”¨æˆ·å“åº”DTO

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/dto/UserResponse.java`

```java
package com.ityfz.yulu.admin.dto;

import lombok.Data;
import java.time.LocalDateTime;

/**
 * ç”¨æˆ·ä¿¡æ¯å“åº”
 */
@Data
public class UserResponse {
    private Long id;
    private Long tenantId;
    private String username;
    private String role;
    private Integer status;
    private String nickName;
    private String email;
    private String phone;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    
    /**
     * çŠ¶æ€æ–‡æœ¬ï¼ˆå‰ç«¯æ˜¾ç¤ºç”¨ï¼‰
     */
    private String statusText;
    
    /**
     * è§’è‰²æ–‡æœ¬ï¼ˆå‰ç«¯æ˜¾ç¤ºç”¨ï¼‰
     */
    private String roleText;
}
```

#### 3.1.3 åˆ›å»ºç”¨æˆ·è¯·æ±‚DTO

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/dto/CreateUserRequest.java`

```java
package com.ityfz.yulu.admin.dto;

import lombok.Data;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;
import javax.validation.constraints.Pattern;

/**
 * åˆ›å»ºç”¨æˆ·è¯·æ±‚
 */
@Data
public class CreateUserRequest {
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    private String username;
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = ".{6,20}", message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä½ä¹‹é—´")
    private String password;
    
    @NotBlank(message = "è§’è‰²ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "USER|ADMIN|AGENT", message = "è§’è‰²å¿…é¡»æ˜¯USERã€ADMINæˆ–AGENT")
    private String role;
    
    private String nickName;
    
    private String email;
    
    private String phone;
    
    /**
     * çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨ï¼Œé»˜è®¤ä¸º1
     */
    private Integer status = 1;
}
```

#### 3.1.4 æ›´æ–°ç”¨æˆ·è¯·æ±‚DTO

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/dto/UpdateUserRequest.java`

```java
package com.ityfz.yulu.admin.dto;

import lombok.Data;
import javax.validation.constraints.Pattern;

/**
 * æ›´æ–°ç”¨æˆ·è¯·æ±‚
 */
@Data
public class UpdateUserRequest {
    private String nickName;
    
    private String email;
    
    private String phone;
    
    /**
     * è§’è‰²ï¼ˆä»…Bç«¯ç”¨æˆ·å¯ä¿®æ”¹ï¼‰
     */
    @Pattern(regexp = "ADMIN|AGENT", message = "Bç«¯ç”¨æˆ·è§’è‰²åªèƒ½æ˜¯ADMINæˆ–AGENT")
    private String role;
    
    /**
     * çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨
     */
    private Integer status;
}
```

#### 3.1.5 é‡ç½®å¯†ç è¯·æ±‚DTO

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/dto/ResetPasswordRequest.java`

```java
package com.ityfz.yulu.admin.dto;

import lombok.Data;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.Pattern;

/**
 * é‡ç½®å¯†ç è¯·æ±‚
 */
@Data
public class ResetPasswordRequest {
    @NotBlank(message = "æ–°å¯†ç ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = ".{6,20}", message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä½ä¹‹é—´")
    private String newPassword;
}
```

---

### 3.2 Serviceå±‚è®¾è®¡

#### 3.2.1 UserManagementServiceæ¥å£

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/service/UserManagementService.java`

```java
package com.ityfz.yulu.admin.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.ityfz.yulu.admin.dto.*;

/**
 * è´¦å·ç®¡ç†æœåŠ¡æ¥å£
 */
public interface UserManagementService {
    
    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     * 
     * @param tenantId ç§Ÿæˆ·ID
     * @param request æŸ¥è¯¢æ¡ä»¶
     * @return åˆ†é¡µç»“æœ
     */
    IPage<UserResponse> listUsers(Long tenantId, UserListRequest request);
    
    /**
     * æ ¹æ®IDè·å–ç”¨æˆ·è¯¦æƒ…
     * 
     * @param tenantId ç§Ÿæˆ·ID
     * @param userId ç”¨æˆ·ID
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    UserResponse getUserById(Long tenantId, Long userId);
    
    /**
     * åˆ›å»ºç”¨æˆ·
     * 
     * @param tenantId ç§Ÿæˆ·ID
     * @param request åˆ›å»ºè¯·æ±‚
     * @return åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯
     */
    UserResponse createUser(Long tenantId, CreateUserRequest request);
    
    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     * 
     * @param tenantId ç§Ÿæˆ·ID
     * @param userId ç”¨æˆ·ID
     * @param request æ›´æ–°è¯·æ±‚
     * @return æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯
     */
    UserResponse updateUser(Long tenantId, Long userId, UpdateUserRequest request);
    
    /**
     * é‡ç½®ç”¨æˆ·å¯†ç 
     * 
     * @param tenantId ç§Ÿæˆ·ID
     * @param userId ç”¨æˆ·ID
     * @param request é‡ç½®å¯†ç è¯·æ±‚
     */
    void resetPassword(Long tenantId, Long userId, ResetPasswordRequest request);
    
    /**
     * åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼šè®¾ç½®status=0ï¼‰
     * 
     * @param tenantId ç§Ÿæˆ·ID
     * @param userId ç”¨æˆ·ID
     * @param currentUserId å½“å‰æ“ä½œäººIDï¼ˆä¸èƒ½åˆ é™¤è‡ªå·±ï¼‰
     */
    void deleteUser(Long tenantId, Long userId, Long currentUserId);
    
    /**
     * å¯ç”¨/ç¦ç”¨ç”¨æˆ·
     * 
     * @param tenantId ç§Ÿæˆ·ID
     * @param userId ç”¨æˆ·ID
     * @param status çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨
     * @param currentUserId å½“å‰æ“ä½œäººIDï¼ˆä¸èƒ½ç¦ç”¨è‡ªå·±ï¼‰
     */
    void updateUserStatus(Long tenantId, Long userId, Integer status, Long currentUserId);
}
```

#### 3.2.2 UserManagementServiceå®ç°

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/service/impl/UserManagementServiceImpl.java`

```java
package com.ityfz.yulu.admin.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.ityfz.yulu.admin.dto.*;
import com.ityfz.yulu.admin.service.UserManagementService;
import com.ityfz.yulu.common.enums.ErrorCodes;
import com.ityfz.yulu.common.enums.Roles;
import com.ityfz.yulu.common.exception.BizException;
import com.ityfz.yulu.user.entity.User;
import com.ityfz.yulu.user.service.UserService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class UserManagementServiceImpl implements UserManagementService {
    
    private final UserService userService;
    private final BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder();
    
    @Override
    public IPage<UserResponse> listUsers(Long tenantId, UserListRequest request) {
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç§Ÿæˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        // åˆ†é¡µå‚æ•°
        int page = request.getPage() != null && request.getPage() > 0 ? request.getPage() : 1;
        int size = request.getSize() != null && request.getSize() > 0 && request.getSize() <= 100 
                ? request.getSize() : 10;
        
        Page<User> pageParam = new Page<>(page, size);
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
        
        // ç§Ÿæˆ·éš”ç¦»
        wrapper.eq(User::getTenantId, tenantId);
        
        // è§’è‰²ç­›é€‰
        if (StringUtils.hasText(request.getRole())) {
            wrapper.eq(User::getRole, request.getRole().toUpperCase());
        }
        
        // çŠ¶æ€ç­›é€‰
        if (request.getStatus() != null) {
            wrapper.eq(User::getStatus, request.getStatus());
        }
        
        // å…³é”®è¯æœç´¢ï¼ˆç”¨æˆ·åã€æ˜µç§°ã€é‚®ç®±ã€æ‰‹æœºå·ï¼‰
        if (StringUtils.hasText(request.getKeyword())) {
            String keyword = request.getKeyword().trim();
            wrapper.and(w -> w
                .like(User::getUsername, keyword)
                .or()
                .like(User::getNickName, keyword)
                .or()
                .like(User::getEmail, keyword)
                .or()
                .like(User::getPhone, keyword)
            );
        }
        
        // æ’åºï¼šæŒ‰åˆ›å»ºæ—¶é—´å€’åº
        wrapper.orderByDesc(User::getCreateTime);
        
        // æŸ¥è¯¢
        IPage<User> userPage = userService.page(pageParam, wrapper);
        
        // è½¬æ¢ä¸ºå“åº”DTO
        IPage<UserResponse> responsePage = userPage.convert(this::toUserResponse);
        
        return responsePage;
    }
    
    @Override
    public UserResponse getUserById(Long tenantId, Long userId) {
        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.VALIDATION_ERROR, "ç§Ÿæˆ·IDå’Œç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        User user = userService.getOne(new LambdaQueryWrapper<User>()
                .eq(User::getTenantId, tenantId)
                .eq(User::getId, userId));
        
        if (user == null) {
            throw new BizException(ErrorCodes.USER_NOT_FOUND, "ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        return toUserResponse(user);
    }
    
    @Override
    public UserResponse createUser(Long tenantId, CreateUserRequest request) {
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç§Ÿæˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        // 1. éªŒè¯è§’è‰²
        String role = request.getRole().toUpperCase();
        if (!isValidRole(role)) {
            throw new BizException(ErrorCodes.INVALID_ROLE, "è§’è‰²å¿…é¡»æ˜¯USERã€ADMINæˆ–AGENT");
        }
        
        // 2. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨ï¼ˆåŒç§Ÿæˆ·å†…ï¼‰
        boolean exists = userService.lambdaQuery()
                .eq(User::getTenantId, tenantId)
                .eq(User::getUsername, request.getUsername())
                .exists();
        
        if (exists) {
            throw new BizException(ErrorCodes.USER_EXISTS, "ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // 3. åˆ›å»ºç”¨æˆ·
        User user = new User();
        user.setTenantId(tenantId);
        user.setUsername(request.getUsername());
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        user.setRole(role);
        user.setStatus(request.getStatus() != null ? request.getStatus() : 1);
        user.setNickName(request.getNickName());
        user.setEmail(request.getEmail());
        user.setPhone(request.getPhone());
        user.setCreateTime(LocalDateTime.now());
        user.setUpdateTime(LocalDateTime.now());
        
        userService.save(user);
        
        log.info("[UserManagement] åˆ›å»ºç”¨æˆ·æˆåŠŸ: tenantId={}, userId={}, username={}, role={}", 
                tenantId, user.getId(), user.getUsername(), role);
        
        return toUserResponse(user);
    }
    
    @Override
    public UserResponse updateUser(Long tenantId, Long userId, UpdateUserRequest request) {
        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.VALIDATION_ERROR, "ç§Ÿæˆ·IDå’Œç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        // 1. æŸ¥è¯¢ç”¨æˆ·
        User user = userService.getOne(new LambdaQueryWrapper<User>()
                .eq(User::getTenantId, tenantId)
                .eq(User::getId, userId));
        
        if (user == null) {
            throw new BizException(ErrorCodes.USER_NOT_FOUND, "ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 2. æ›´æ–°å­—æ®µ
        boolean updated = false;
        
        if (StringUtils.hasText(request.getNickName())) {
            user.setNickName(request.getNickName());
            updated = true;
        }
        
        if (StringUtils.hasText(request.getEmail())) {
            user.setEmail(request.getEmail());
            updated = true;
        }
        
        if (StringUtils.hasText(request.getPhone())) {
            user.setPhone(request.getPhone());
            updated = true;
        }
        
        // 3. æ›´æ–°è§’è‰²ï¼ˆä»…Bç«¯ç”¨æˆ·å¯ä¿®æ”¹ï¼‰
        if (StringUtils.hasText(request.getRole())) {
            String newRole = request.getRole().toUpperCase();
            
            // éªŒè¯ï¼šåªèƒ½ä¿®æ”¹Bç«¯ç”¨æˆ·çš„è§’è‰²ï¼ˆADMIN/AGENTä¹‹é—´åˆ‡æ¢ï¼‰
            if (Roles.isUser(user.getRole())) {
                throw new BizException(ErrorCodes.FORBIDDEN, "Cç«¯ç”¨æˆ·ï¼ˆUSERï¼‰çš„è§’è‰²ä¸èƒ½ä¿®æ”¹");
            }
            
            if (!Roles.isAdmin(newRole) && !Roles.isAgent(newRole)) {
                throw new BizException(ErrorCodes.INVALID_ROLE, "Bç«¯ç”¨æˆ·è§’è‰²åªèƒ½æ˜¯ADMINæˆ–AGENT");
            }
            
            user.setRole(newRole);
            updated = true;
        }
        
        // 4. æ›´æ–°çŠ¶æ€
        if (request.getStatus() != null) {
            user.setStatus(request.getStatus());
            updated = true;
        }
        
        if (updated) {
            user.setUpdateTime(LocalDateTime.now());
            userService.updateById(user);
            
            log.info("[UserManagement] æ›´æ–°ç”¨æˆ·æˆåŠŸ: tenantId={}, userId={}, username={}", 
                    tenantId, userId, user.getUsername());
        }
        
        return toUserResponse(user);
    }
    
    @Override
    public void resetPassword(Long tenantId, Long userId, ResetPasswordRequest request) {
        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.VALIDATION_ERROR, "ç§Ÿæˆ·IDå’Œç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        // 1. æŸ¥è¯¢ç”¨æˆ·
        User user = userService.getOne(new LambdaQueryWrapper<User>()
                .eq(User::getTenantId, tenantId)
                .eq(User::getId, userId));
        
        if (user == null) {
            throw new BizException(ErrorCodes.USER_NOT_FOUND, "ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 2. é‡ç½®å¯†ç 
        user.setPassword(passwordEncoder.encode(request.getNewPassword()));
        user.setUpdateTime(LocalDateTime.now());
        userService.updateById(user);
        
        log.info("[UserManagement] é‡ç½®å¯†ç æˆåŠŸ: tenantId={}, userId={}, username={}", 
                tenantId, userId, user.getUsername());
    }
    
    @Override
    public void deleteUser(Long tenantId, Long userId, Long currentUserId) {
        if (tenantId == null || userId == null) {
            throw new BizException(ErrorCodes.VALIDATION_ERROR, "ç§Ÿæˆ·IDå’Œç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        // 1. ä¸èƒ½åˆ é™¤è‡ªå·±
        if (userId.equals(currentUserId)) {
            throw new BizException(ErrorCodes.FORBIDDEN, "ä¸èƒ½åˆ é™¤è‡ªå·±çš„è´¦å·");
        }
        
        // 2. æŸ¥è¯¢ç”¨æˆ·
        User user = userService.getOne(new LambdaQueryWrapper<User>()
                .eq(User::getTenantId, tenantId)
                .eq(User::getId, userId));
        
        if (user == null) {
            throw new BizException(ErrorCodes.USER_NOT_FOUND, "ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 3. è½¯åˆ é™¤ï¼šè®¾ç½®status=0
        user.setStatus(0);
        user.setUpdateTime(LocalDateTime.now());
        userService.updateById(user);
        
        log.info("[UserManagement] åˆ é™¤ç”¨æˆ·æˆåŠŸ: tenantId={}, userId={}, username={}", 
                tenantId, userId, user.getUsername());
    }
    
    @Override
    public void updateUserStatus(Long tenantId, Long userId, Integer status, Long currentUserId) {
        if (tenantId == null || userId == null || status == null) {
            throw new BizException(ErrorCodes.VALIDATION_ERROR, "å‚æ•°ä¸èƒ½ä¸ºç©º");
        }
        
        if (status != 0 && status != 1) {
            throw new BizException(ErrorCodes.VALIDATION_ERROR, "çŠ¶æ€å€¼å¿…é¡»æ˜¯0æˆ–1");
        }
        
        // 1. ä¸èƒ½ç¦ç”¨è‡ªå·±
        if (userId.equals(currentUserId)) {
            throw new BizException(ErrorCodes.FORBIDDEN, "ä¸èƒ½ç¦ç”¨è‡ªå·±çš„è´¦å·");
        }
        
        // 2. æŸ¥è¯¢ç”¨æˆ·
        User user = userService.getOne(new LambdaQueryWrapper<User>()
                .eq(User::getTenantId, tenantId)
                .eq(User::getId, userId));
        
        if (user == null) {
            throw new BizException(ErrorCodes.USER_NOT_FOUND, "ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 3. æ›´æ–°çŠ¶æ€
        user.setStatus(status);
        user.setUpdateTime(LocalDateTime.now());
        userService.updateById(user);
        
        log.info("[UserManagement] æ›´æ–°ç”¨æˆ·çŠ¶æ€æˆåŠŸ: tenantId={}, userId={}, username={}, status={}", 
                tenantId, userId, user.getUsername(), status);
    }
    
    /**
     * è½¬æ¢ä¸ºå“åº”DTO
     */
    private UserResponse toUserResponse(User user) {
        UserResponse response = new UserResponse();
        response.setId(user.getId());
        response.setTenantId(user.getTenantId());
        response.setUsername(user.getUsername());
        response.setRole(user.getRole());
        response.setStatus(user.getStatus());
        response.setNickName(user.getNickName());
        response.setEmail(user.getEmail());
        response.setPhone(user.getPhone());
        response.setCreateTime(user.getCreateTime());
        response.setUpdateTime(user.getUpdateTime());
        
        // çŠ¶æ€æ–‡æœ¬
        response.setStatusText(user.getStatus() != null && user.getStatus() == 1 ? "å¯ç”¨" : "ç¦ç”¨");
        
        // è§’è‰²æ–‡æœ¬
        String role = user.getRole();
        if (Roles.isAdmin(role)) {
            response.setRoleText("ç®¡ç†å‘˜");
        } else if (Roles.isAgent(role)) {
            response.setRoleText("å®¢æœ");
        } else if (Roles.isUser(role)) {
            response.setRoleText("ç”¨æˆ·");
        } else {
            response.setRoleText(role);
        }
        
        return response;
    }
    
    /**
     * éªŒè¯è§’è‰²æ˜¯å¦æœ‰æ•ˆ
     */
    private boolean isValidRole(String role) {
        return Roles.ADMIN.equalsIgnoreCase(role)
                || Roles.AGENT.equalsIgnoreCase(role)
                || Roles.USER.equalsIgnoreCase(role);
    }
}
```

---

### 3.3 Controllerå±‚è®¾è®¡

#### 3.3.1 AdminUserManagementController

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/controller/AdminUserManagementController.java`

```java
package com.ityfz.yulu.admin.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.ityfz.yulu.admin.dto.*;
import com.ityfz.yulu.admin.service.UserManagementService;
import com.ityfz.yulu.common.annotation.RequireRole;
import com.ityfz.yulu.common.enums.ErrorCodes;
import com.ityfz.yulu.common.exception.BizException;
import com.ityfz.yulu.common.model.ApiResponse;
import com.ityfz.yulu.common.security.SecurityUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;

/**
 * è´¦å·ç®¡ç†Controller
 * ä»…ç®¡ç†å‘˜å¯ä»¥è®¿é—®
 */
@Slf4j
@RestController
@RequestMapping("/api/admin/user-management")
@RequiredArgsConstructor
@Validated
@RequireRole("ADMIN") // ç±»çº§åˆ«ï¼šä»…ç®¡ç†å‘˜å¯è®¿é—®
public class AdminUserManagementController {
    
    private final UserManagementService userManagementService;
    
    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     * GET /api/admin/user-management/list?role=USER&status=1&keyword=xxx&page=1&size=10
     */
    @GetMapping("/list")
    public ApiResponse<IPage<UserResponse>> listUsers(
            @RequestParam(required = false) String role,
            @RequestParam(required = false) Integer status,
            @RequestParam(required = false) String keyword,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer size
    ) {
        Long tenantId = SecurityUtil.currentTenantId();
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        
        UserListRequest request = new UserListRequest();
        request.setRole(role);
        request.setStatus(status);
        request.setKeyword(keyword);
        request.setPage(page);
        request.setSize(size);
        
        IPage<UserResponse> result = userManagementService.listUsers(tenantId, request);
        return ApiResponse.success("æŸ¥è¯¢æˆåŠŸ", result);
    }
    
    /**
     * è·å–ç”¨æˆ·è¯¦æƒ…
     * GET /api/admin/user-management/{userId}
     */
    @GetMapping("/{userId}")
    public ApiResponse<UserResponse> getUserById(@PathVariable Long userId) {
        Long tenantId = SecurityUtil.currentTenantId();
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        
        UserResponse user = userManagementService.getUserById(tenantId, userId);
        return ApiResponse.success("æŸ¥è¯¢æˆåŠŸ", user);
    }
    
    /**
     * åˆ›å»ºç”¨æˆ·
     * POST /api/admin/user-management/create
     */
    @PostMapping("/create")
    public ApiResponse<UserResponse> createUser(@Valid @RequestBody CreateUserRequest request) {
        Long tenantId = SecurityUtil.currentTenantId();
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        
        UserResponse user = userManagementService.createUser(tenantId, request);
        return ApiResponse.success("åˆ›å»ºç”¨æˆ·æˆåŠŸ", user);
    }
    
    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     * PUT /api/admin/user-management/{userId}
     */
    @PutMapping("/{userId}")
    public ApiResponse<UserResponse> updateUser(
            @PathVariable Long userId,
            @Valid @RequestBody UpdateUserRequest request
    ) {
        Long tenantId = SecurityUtil.currentTenantId();
        if (tenantId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        
        UserResponse user = userManagementService.updateUser(tenantId, userId, request);
        return ApiResponse.success("æ›´æ–°ç”¨æˆ·æˆåŠŸ", user);
    }
    
    /**
     * é‡ç½®ç”¨æˆ·å¯†ç 
     * POST /api/admin/user-management/{userId}/reset-password
     */
    @PostMapping("/{userId}/reset-password")
    public ApiResponse<Void> resetPassword(
            @PathVariable Long userId,
            @Valid @RequestBody ResetPasswordRequest request
    ) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long currentUserId = SecurityUtil.currentUserId();
        
        if (tenantId == null || currentUserId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        
        userManagementService.resetPassword(tenantId, userId, request);
        return ApiResponse.success("é‡ç½®å¯†ç æˆåŠŸ");
    }
    
    /**
     * åˆ é™¤ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
     * DELETE /api/admin/user-management/{userId}
     */
    @DeleteMapping("/{userId}")
    public ApiResponse<Void> deleteUser(@PathVariable Long userId) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long currentUserId = SecurityUtil.currentUserId();
        
        if (tenantId == null || currentUserId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        
        userManagementService.deleteUser(tenantId, userId, currentUserId);
        return ApiResponse.success("åˆ é™¤ç”¨æˆ·æˆåŠŸ");
    }
    
    /**
     * å¯ç”¨/ç¦ç”¨ç”¨æˆ·
     * PUT /api/admin/user-management/{userId}/status
     */
    @PutMapping("/{userId}/status")
    public ApiResponse<Void> updateUserStatus(
            @PathVariable Long userId,
            @RequestParam Integer status
    ) {
        Long tenantId = SecurityUtil.currentTenantId();
        Long currentUserId = SecurityUtil.currentUserId();
        
        if (tenantId == null || currentUserId == null) {
            throw new BizException(ErrorCodes.TENANT_REQUIRED, "ç¼ºå°‘ç§Ÿæˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•");
        }
        
        userManagementService.updateUserStatus(tenantId, userId, status, currentUserId);
        return ApiResponse.success(status == 1 ? "å¯ç”¨ç”¨æˆ·æˆåŠŸ" : "ç¦ç”¨ç”¨æˆ·æˆåŠŸ");
    }
}
```

---

## ğŸ¨ å››ã€å‰ç«¯å®ç°æ–¹æ¡ˆ

### 4.1 è·¯ç”±å’Œå¸ƒå±€ä¿®æ”¹

#### 4.1.1 AdminLayoutæ·»åŠ è´¦å·ç®¡ç†Tab

**æ–‡ä»¶**: `frontend/src/components/layout/AdminLayout.tsx`

```typescript
import { 
  MessageOutlined, 
  ProfileOutlined, 
  BellOutlined, 
  DashboardOutlined, 
  BookOutlined,
  UserOutlined  // æ–°å¢
} from '@ant-design/icons';

export function AdminLayout({ children }: { children: ReactNode }) {
  return (
    <PortalLayout
      logoText="YuLu ç§Ÿæˆ·å·¥ä½œå°"
      headerTitle="YuLuç§Ÿæˆ·ç«¯"
      menuItems={[
        {
          key: '/admin/dashboard',
          icon: <DashboardOutlined />,
          label: 'æ•°æ®çœ‹æ¿'
        },
        {
          key: '/admin/tickets',
          icon: <ProfileOutlined />,
          label: 'å·¥å•ç³»ç»Ÿ'
        },
        {
          key: '/admin/sessions',
          icon: <MessageOutlined />,
          label: 'ä¼šè¯ç®¡ç†'
        },
        {
          key: '/admin/knowledge',
          icon: <BookOutlined />,
          label: 'çŸ¥è¯†åº“'
        },
        {
          key: '/admin/notify',
          icon: <BellOutlined />,
          label: 'é€šçŸ¥ä¸­å¿ƒ'
        },
        {
          key: '/admin/users',  // æ–°å¢
          icon: <UserOutlined />,
          label: 'è´¦å·ç®¡ç†'
        }
      ]}
    >
      {children}
    </PortalLayout>
  );
}
```

#### 4.1.2 App.tsxæ·»åŠ è·¯ç”±

**æ–‡ä»¶**: `frontend/src/App.tsx`

```typescript
import UserManagementPage from './pages/admin/UserManagementPage';

// åœ¨è·¯ç”±ä¸­æ·»åŠ 
<Route
  path="/admin/users"
  element={
    <RequireAuth>
      <AdminLayout>
        <UserManagementPage />
      </AdminLayout>
    </RequireAuth>
  }
/>
```

### 4.2 è´¦å·ç®¡ç†é¡µé¢

**æ–‡ä»¶**: `frontend/src/pages/admin/UserManagementPage.tsx` (æ–°å»º)

```typescript
import { useState, useEffect } from 'react';
import { 
  Card, 
  Tabs, 
  Table, 
  Button, 
  Space, 
  Tag, 
  message, 
  Modal, 
  Form, 
  Input, 
  Select, 
  Popconfirm,
  Switch,
  Tooltip
} from 'antd';
import { 
  PlusOutlined, 
  EditOutlined, 
  DeleteOutlined, 
  KeyOutlined,
  UserOutlined,
  TeamOutlined
} from '@ant-design/icons';
import { userManagementApi } from '../../api/userManagement';
import type { UserResponse, CreateUserRequest, UpdateUserRequest } from '../../api/types';

const { TabPane } = Tabs;

export default function UserManagementPage() {
  const [activeTab, setActiveTab] = useState<'customer' | 'staff'>('customer');
  const [customerUsers, setCustomerUsers] = useState<UserResponse[]>([]);
  const [staffUsers, setStaffUsers] = useState<UserResponse[]>([]);
  const [loading, setLoading] = useState(false);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 10,
    total: 0
  });
  
  // å¼¹çª—çŠ¶æ€
  const [createModalVisible, setCreateModalVisible] = useState(false);
  const [editModalVisible, setEditModalVisible] = useState(false);
  const [resetPasswordModalVisible, setResetPasswordModalVisible] = useState(false);
  const [selectedUser, setSelectedUser] = useState<UserResponse | null>(null);
  const [form] = Form.useForm();
  const [passwordForm] = Form.useForm();

  // åŠ è½½ç”¨æˆ·åˆ—è¡¨
  const loadUsers = async (page = 1, pageSize = 10, keyword?: string) => {
    setLoading(true);
    try {
      const role = activeTab === 'customer' ? 'USER' : undefined; // Cç«¯ç”¨æˆ·å›ºå®šä¸ºUSER
      const res = await userManagementApi.list({
        role,
        status: undefined, // æŸ¥è¯¢æ‰€æœ‰çŠ¶æ€
        keyword,
        page,
        size: pageSize
      });
      
      if (res.success || res.code === '200') {
        const users = res.data.records || [];
        if (activeTab === 'customer') {
          setCustomerUsers(users);
        } else {
          // Bç«¯ç”¨æˆ·ï¼šè¿‡æ»¤å‡ºADMINå’ŒAGENT
          setStaffUsers(users.filter(u => u.role === 'ADMIN' || u.role === 'AGENT'));
        }
        setPagination({
          current: res.data.current || 1,
          pageSize: res.data.size || 10,
          total: res.data.total || 0
        });
      }
    } catch (e: any) {
      message.error(e?.response?.data?.message || 'åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadUsers();
  }, [activeTab]);

  // åˆ›å»ºç”¨æˆ·
  const handleCreate = async (values: CreateUserRequest) => {
    try {
      // å¦‚æœæ˜¯Cç«¯ç”¨æˆ·ï¼Œå›ºå®šè§’è‰²ä¸ºUSER
      if (activeTab === 'customer') {
        values.role = 'USER';
      }
      
      const res = await userManagementApi.create(values);
      if (res.success || res.code === '200') {
        message.success('åˆ›å»ºç”¨æˆ·æˆåŠŸ');
        setCreateModalVisible(false);
        form.resetFields();
        loadUsers(pagination.current, pagination.pageSize);
      }
    } catch (e: any) {
      message.error(e?.response?.data?.message || 'åˆ›å»ºç”¨æˆ·å¤±è´¥');
    }
  };

  // ç¼–è¾‘ç”¨æˆ·
  const handleEdit = async (values: UpdateUserRequest) => {
    if (!selectedUser) return;
    
    try {
      const res = await userManagementApi.update(selectedUser.id, values);
      if (res.success || res.code === '200') {
        message.success('æ›´æ–°ç”¨æˆ·æˆåŠŸ');
        setEditModalVisible(false);
        setSelectedUser(null);
        form.resetFields();
        loadUsers(pagination.current, pagination.pageSize);
      }
    } catch (e: any) {
      message.error(e?.response?.data?.message || 'æ›´æ–°ç”¨æˆ·å¤±è´¥');
    }
  };

  // é‡ç½®å¯†ç 
  const handleResetPassword = async (values: { newPassword: string }) => {
    if (!selectedUser) return;
    
    try {
      const res = await userManagementApi.resetPassword(selectedUser.id, {
        newPassword: values.newPassword
      });
      if (res.success || res.code === '200') {
        message.success('é‡ç½®å¯†ç æˆåŠŸ');
        setResetPasswordModalVisible(false);
        setSelectedUser(null);
        passwordForm.resetFields();
      }
    } catch (e: any) {
      message.error(e?.response?.data?.message || 'é‡ç½®å¯†ç å¤±è´¥');
    }
  };

  // åˆ é™¤ç”¨æˆ·
  const handleDelete = async (userId: number) => {
    try {
      const res = await userManagementApi.delete(userId);
      if (res.success || res.code === '200') {
        message.success('åˆ é™¤ç”¨æˆ·æˆåŠŸ');
        loadUsers(pagination.current, pagination.pageSize);
      }
    } catch (e: any) {
      message.error(e?.response?.data?.message || 'åˆ é™¤ç”¨æˆ·å¤±è´¥');
    }
  };

  // æ›´æ–°çŠ¶æ€
  const handleStatusChange = async (userId: number, status: number) => {
    try {
      const res = await userManagementApi.updateStatus(userId, status);
      if (res.success || res.code === '200') {
        message.success(status === 1 ? 'å¯ç”¨ç”¨æˆ·æˆåŠŸ' : 'ç¦ç”¨ç”¨æˆ·æˆåŠŸ');
        loadUsers(pagination.current, pagination.pageSize);
      }
    } catch (e: any) {
      message.error(e?.response?.data?.message || 'æ“ä½œå¤±è´¥');
    }
  };

  // è¡¨æ ¼åˆ—å®šä¹‰ï¼ˆCç«¯ç”¨æˆ·ï¼‰
  const customerColumns = [
    {
      title: 'ID',
      dataIndex: 'id',
      key: 'id',
      width: 80
    },
    {
      title: 'ç”¨æˆ·å',
      dataIndex: 'username',
      key: 'username',
      width: 150
    },
    {
      title: 'æ˜µç§°',
      dataIndex: 'nickName',
      key: 'nickName',
      width: 120
    },
    {
      title: 'é‚®ç®±',
      dataIndex: 'email',
      key: 'email',
      width: 180
    },
    {
      title: 'æ‰‹æœºå·',
      dataIndex: 'phone',
      key: 'phone',
      width: 120
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'status',
      key: 'status',
      width: 100,
      render: (status: number, record: UserResponse) => (
        <Switch
          checked={status === 1}
          onChange={(checked) => handleStatusChange(record.id, checked ? 1 : 0)}
        />
      )
    },
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'createTime',
      key: 'createTime',
      width: 180
    },
    {
      title: 'æ“ä½œ',
      key: 'action',
      width: 200,
      render: (_: any, record: UserResponse) => (
        <Space>
          <Button
            type="link"
            icon={<EditOutlined />}
            onClick={() => {
              setSelectedUser(record);
              form.setFieldsValue({
                nickName: record.nickName,
                email: record.email,
                phone: record.phone,
                status: record.status
              });
              setEditModalVisible(true);
            }}
          >
            ç¼–è¾‘
          </Button>
          <Popconfirm
            title="ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿ"
            onConfirm={() => handleDelete(record.id)}
          >
            <Button type="link" danger icon={<DeleteOutlined />}>
              åˆ é™¤
            </Button>
          </Popconfirm>
        </Space>
      )
    }
  ];

  // è¡¨æ ¼åˆ—å®šä¹‰ï¼ˆBç«¯ç”¨æˆ·ï¼‰
  const staffColumns = [
    {
      title: 'ID',
      dataIndex: 'id',
      key: 'id',
      width: 80
    },
    {
      title: 'ç”¨æˆ·å',
      dataIndex: 'username',
      key: 'username',
      width: 150
    },
    {
      title: 'è§’è‰²',
      dataIndex: 'role',
      key: 'role',
      width: 100,
      render: (role: string) => {
        const colorMap: Record<string, string> = {
          ADMIN: 'red',
          AGENT: 'blue'
        };
        const textMap: Record<string, string> = {
          ADMIN: 'ç®¡ç†å‘˜',
          AGENT: 'å®¢æœ'
        };
        return <Tag color={colorMap[role]}>{textMap[role] || role}</Tag>;
      }
    },
    {
      title: 'æ˜µç§°',
      dataIndex: 'nickName',
      key: 'nickName',
      width: 120
    },
    {
      title: 'é‚®ç®±',
      dataIndex: 'email',
      key: 'email',
      width: 180
    },
    {
      title: 'æ‰‹æœºå·',
      dataIndex: 'phone',
      key: 'phone',
      width: 120
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'status',
      key: 'status',
      width: 100,
      render: (status: number, record: UserResponse) => (
        <Switch
          checked={status === 1}
          onChange={(checked) => handleStatusChange(record.id, checked ? 1 : 0)}
        />
      )
    },
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'createTime',
      key: 'createTime',
      width: 180
    },
    {
      title: 'æ“ä½œ',
      key: 'action',
      width: 300,
      render: (_: any, record: UserResponse) => (
        <Space>
          <Button
            type="link"
            icon={<EditOutlined />}
            onClick={() => {
              setSelectedUser(record);
              form.setFieldsValue({
                nickName: record.nickName,
                email: record.email,
                phone: record.phone,
                role: record.role,
                status: record.status
              });
              setEditModalVisible(true);
            }}
          >
            ç¼–è¾‘
          </Button>
          <Button
            type="link"
            icon={<KeyOutlined />}
            onClick={() => {
              setSelectedUser(record);
              setResetPasswordModalVisible(true);
            }}
          >
            é‡ç½®å¯†ç 
          </Button>
          <Popconfirm
            title="ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿ"
            onConfirm={() => handleDelete(record.id)}
          >
            <Button type="link" danger icon={<DeleteOutlined />}>
              åˆ é™¤
            </Button>
          </Popconfirm>
        </Space>
      )
    }
  ];

  const currentUsers = activeTab === 'customer' ? customerUsers : staffUsers;
  const currentColumns = activeTab === 'customer' ? customerColumns : staffColumns;

  return (
    <Card>
      <Tabs
        activeKey={activeTab}
        onChange={(key) => {
          setActiveTab(key as 'customer' | 'staff');
          setPagination({ ...pagination, current: 1 });
        }}
        tabBarExtraContent={
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => {
              form.resetFields();
              setCreateModalVisible(true);
            }}
          >
            æ–°å»º{activeTab === 'customer' ? 'ç”¨æˆ·' : 'è´¦å·'}
          </Button>
        }
      >
        <TabPane
          tab={
            <span>
              <UserOutlined />
              Cç«¯ç”¨æˆ·ç®¡ç†
            </span>
          }
          key="customer"
        >
          <Table
            columns={currentColumns}
            dataSource={currentUsers}
            rowKey="id"
            loading={loading}
            pagination={{
              current: pagination.current,
              pageSize: pagination.pageSize,
              total: pagination.total,
              onChange: (page, pageSize) => loadUsers(page, pageSize),
              showSizeChanger: true,
              showTotal: (total) => `å…± ${total} æ¡`
            }}
          />
        </TabPane>
        
        <TabPane
          tab={
            <span>
              <TeamOutlined />
              Bç«¯ç”¨æˆ·ç®¡ç†ï¼ˆç®¡ç†å‘˜/å®¢æœï¼‰
            </span>
          }
          key="staff"
        >
          <Table
            columns={currentColumns}
            dataSource={currentUsers}
            rowKey="id"
            loading={loading}
            pagination={{
              current: pagination.current,
              pageSize: pagination.pageSize,
              total: pagination.total,
              onChange: (page, pageSize) => loadUsers(page, pageSize),
              showSizeChanger: true,
              showTotal: (total) => `å…± ${total} æ¡`
            }}
          />
        </TabPane>
      </Tabs>

      {/* åˆ›å»ºç”¨æˆ·å¼¹çª— */}
      <Modal
        title={activeTab === 'customer' ? 'åˆ›å»ºCç«¯ç”¨æˆ·' : 'åˆ›å»ºBç«¯è´¦å·'}
        open={createModalVisible}
        onCancel={() => {
          setCreateModalVisible(false);
          form.resetFields();
        }}
        footer={null}
        width={600}
      >
        <Form
          form={form}
          layout="vertical"
          onFinish={handleCreate}
        >
          <Form.Item
            label="ç”¨æˆ·å"
            name="username"
            rules={[{ required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å' }]}
          >
            <Input placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
          </Form.Item>

          <Form.Item
            label="å¯†ç "
            name="password"
            rules={[
              { required: true, message: 'è¯·è¾“å…¥å¯†ç ' },
              { min: 6, max: 20, message: 'å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä½ä¹‹é—´' }
            ]}
          >
            <Input.Password placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆ6-20ä½ï¼‰" />
          </Form.Item>

          {activeTab === 'staff' && (
            <Form.Item
              label="è§’è‰²"
              name="role"
              rules={[{ required: true, message: 'è¯·é€‰æ‹©è§’è‰²' }]}
            >
              <Select placeholder="è¯·é€‰æ‹©è§’è‰²">
                <Select.Option value="ADMIN">ç®¡ç†å‘˜</Select.Option>
                <Select.Option value="AGENT">å®¢æœ</Select.Option>
              </Select>
            </Form.Item>
          )}

          <Form.Item label="æ˜µç§°" name="nickName">
            <Input placeholder="å¯é€‰" />
          </Form.Item>

          <Form.Item
            label="é‚®ç®±"
            name="email"
            rules={[{ type: 'email', message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' }]}
          >
            <Input placeholder="å¯é€‰" />
          </Form.Item>

          <Form.Item
            label="æ‰‹æœºå·"
            name="phone"
          >
            <Input placeholder="å¯é€‰" />
          </Form.Item>

          <Form.Item>
            <Space>
              <Button type="primary" htmlType="submit">
                åˆ›å»º
              </Button>
              <Button onClick={() => {
                setCreateModalVisible(false);
                form.resetFields();
              }}>
                å–æ¶ˆ
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>

      {/* ç¼–è¾‘ç”¨æˆ·å¼¹çª— */}
      <Modal
        title="ç¼–è¾‘ç”¨æˆ·"
        open={editModalVisible}
        onCancel={() => {
          setEditModalVisible(false);
          setSelectedUser(null);
          form.resetFields();
        }}
        footer={null}
        width={600}
      >
        <Form
          form={form}
          layout="vertical"
          onFinish={handleEdit}
        >
          {activeTab === 'staff' && (
            <Form.Item
              label="è§’è‰²"
              name="role"
              rules={[{ required: true, message: 'è¯·é€‰æ‹©è§’è‰²' }]}
            >
              <Select placeholder="è¯·é€‰æ‹©è§’è‰²">
                <Select.Option value="ADMIN">ç®¡ç†å‘˜</Select.Option>
                <Select.Option value="AGENT">å®¢æœ</Select.Option>
              </Select>
            </Form.Item>
          )}

          <Form.Item label="æ˜µç§°" name="nickName">
            <Input placeholder="å¯é€‰" />
          </Form.Item>

          <Form.Item
            label="é‚®ç®±"
            name="email"
            rules={[{ type: 'email', message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' }]}
          >
            <Input placeholder="å¯é€‰" />
          </Form.Item>

          <Form.Item
            label="æ‰‹æœºå·"
            name="phone"
          >
            <Input placeholder="å¯é€‰" />
          </Form.Item>

          <Form.Item
            label="çŠ¶æ€"
            name="status"
            valuePropName="checked"
            getValueFromEvent={(checked) => checked ? 1 : 0}
          >
            <Switch checkedChildren="å¯ç”¨" unCheckedChildren="ç¦ç”¨" />
          </Form.Item>

          <Form.Item>
            <Space>
              <Button type="primary" htmlType="submit">
                ä¿å­˜
              </Button>
              <Button onClick={() => {
                setEditModalVisible(false);
                setSelectedUser(null);
                form.resetFields();
              }}>
                å–æ¶ˆ
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>

      {/* é‡ç½®å¯†ç å¼¹çª— */}
      <Modal
        title="é‡ç½®å¯†ç "
        open={resetPasswordModalVisible}
        onCancel={() => {
          setResetPasswordModalVisible(false);
          setSelectedUser(null);
          passwordForm.resetFields();
        }}
        footer={null}
        width={500}
      >
        <Form
          form={passwordForm}
          layout="vertical"
          onFinish={handleResetPassword}
        >
          <Form.Item
            label="æ–°å¯†ç "
            name="newPassword"
            rules={[
              { required: true, message: 'è¯·è¾“å…¥æ–°å¯†ç ' },
              { min: 6, max: 20, message: 'å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä½ä¹‹é—´' }
            ]}
          >
            <Input.Password placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆ6-20ä½ï¼‰" />
          </Form.Item>

          <Form.Item
            label="ç¡®è®¤å¯†ç "
            name="confirmPassword"
            dependencies={['newPassword']}
            rules={[
              { required: true, message: 'è¯·ç¡®è®¤å¯†ç ' },
              ({ getFieldValue }) => ({
                validator(_, value) {
                  if (!value || getFieldValue('newPassword') === value) {
                    return Promise.resolve();
                  }
                  return Promise.reject(new Error('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´'));
                }
              })
            ]}
          >
            <Input.Password placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " />
          </Form.Item>

          <Form.Item>
            <Space>
              <Button type="primary" htmlType="submit">
                ç¡®å®š
              </Button>
              <Button onClick={() => {
                setResetPasswordModalVisible(false);
                setSelectedUser(null);
                passwordForm.resetFields();
              }}>
                å–æ¶ˆ
              </Button>
            </Space>
          </Form.Item>
        </Form>
      </Modal>
    </Card>
  );
}
```

### 4.3 APIæ¥å£å®šä¹‰

**æ–‡ä»¶**: `frontend/src/api/userManagement.ts` (æ–°å»º)

```typescript
import http from './axios';
import type { ApiResponse } from './types';

export interface UserListRequest {
  role?: string;
  status?: number;
  keyword?: string;
  page?: number;
  size?: number;
}

export interface UserResponse {
  id: number;
  tenantId: number;
  username: string;
  role: string;
  status: number;
  nickName?: string;
  email?: string;
  phone?: string;
  createTime: string;
  updateTime: string;
  statusText: string;
  roleText: string;
}

export interface CreateUserRequest {
  username: string;
  password: string;
  role: string;
  nickName?: string;
  email?: string;
  phone?: string;
  status?: number;
}

export interface UpdateUserRequest {
  nickName?: string;
  email?: string;
  phone?: string;
  role?: string;
  status?: number;
}

export interface ResetPasswordRequest {
  newPassword: string;
}

export const userManagementApi = {
  // æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
  list(params: UserListRequest) {
    return http.get<ApiResponse<any>>('/admin/user-management/list', { params });
  },

  // è·å–ç”¨æˆ·è¯¦æƒ…
  getById(userId: number) {
    return http.get<ApiResponse<UserResponse>>(`/admin/user-management/${userId}`);
  },

  // åˆ›å»ºç”¨æˆ·
  create(data: CreateUserRequest) {
    return http.post<ApiResponse<UserResponse>>('/admin/user-management/create', data);
  },

  // æ›´æ–°ç”¨æˆ·
  update(userId: number, data: UpdateUserRequest) {
    return http.put<ApiResponse<UserResponse>>(`/admin/user-management/${userId}`, data);
  },

  // é‡ç½®å¯†ç 
  resetPassword(userId: number, data: ResetPasswordRequest) {
    return http.post<ApiResponse<void>>(`/admin/user-management/${userId}/reset-password`, data);
  },

  // åˆ é™¤ç”¨æˆ·
  delete(userId: number) {
    return http.delete<ApiResponse<void>>(`/admin/user-management/${userId}`);
  },

  // æ›´æ–°ç”¨æˆ·çŠ¶æ€
  updateStatus(userId: number, status: number) {
    return http.put<ApiResponse<void>>(`/admin/user-management/${userId}/status`, null, {
      params: { status }
    });
  }
};
```

### 4.4 ç±»å‹å®šä¹‰æ›´æ–°

**æ–‡ä»¶**: `frontend/src/api/types.ts`

```typescript
// åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ 
export interface UserResponse {
  id: number;
  tenantId: number;
  username: string;
  role: string;
  status: number;
  nickName?: string;
  email?: string;
  phone?: string;
  createTime: string;
  updateTime: string;
  statusText: string;
  roleText: string;
}

export interface CreateUserRequest {
  username: string;
  password: string;
  role: string;
  nickName?: string;
  email?: string;
  phone?: string;
  status?: number;
}

export interface UpdateUserRequest {
  nickName?: string;
  email?: string;
  phone?: string;
  role?: string;
  status?: number;
}
```

---

## ğŸ“ äº”ã€å®ç°æ­¥éª¤

### æ­¥éª¤1: åç«¯å¼€å‘ï¼ˆ2-3å¤©ï¼‰

#### Day 1: DTOå’ŒServiceå±‚
- [ ] åˆ›å»ºæ‰€æœ‰DTOç±»ï¼ˆUserListRequest, UserResponse, CreateUserRequest, UpdateUserRequest, ResetPasswordRequestï¼‰
- [ ] åˆ›å»º `UserManagementService` æ¥å£
- [ ] å®ç° `UserManagementServiceImpl`
- [ ] å•å…ƒæµ‹è¯•Serviceå±‚

#### Day 2: Controllerå±‚
- [ ] åˆ›å»º `AdminUserManagementController`
- [ ] å®ç°æ‰€æœ‰æ¥å£ï¼ˆlist, getById, create, update, resetPassword, delete, updateStatusï¼‰
- [ ] æ·»åŠ æƒé™æ³¨è§£ `@RequireRole("ADMIN")`
- [ ] é›†æˆæµ‹è¯•

#### Day 3: æµ‹è¯•å’Œä¼˜åŒ–
- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] æƒé™æµ‹è¯•
- [ ] å¤šç§Ÿæˆ·éš”ç¦»æµ‹è¯•
- [ ] ä»£ç å®¡æŸ¥

### æ­¥éª¤2: å‰ç«¯å¼€å‘ï¼ˆ2-3å¤©ï¼‰

#### Day 1: é¡µé¢åŸºç¡€ç»“æ„
- [ ] ä¿®æ”¹ `AdminLayout.tsx`ï¼Œæ·»åŠ è´¦å·ç®¡ç†Tab
- [ ] ä¿®æ”¹ `App.tsx`ï¼Œæ·»åŠ è·¯ç”±
- [ ] åˆ›å»º `UserManagementPage.tsx` åŸºç¡€ç»“æ„
- [ ] å®ç°Tabåˆ‡æ¢

#### Day 2: åŠŸèƒ½å®ç°
- [ ] å®ç°ç”¨æˆ·åˆ—è¡¨å±•ç¤ºï¼ˆåˆ†é¡µã€æœç´¢ï¼‰
- [ ] å®ç°åˆ›å»ºç”¨æˆ·åŠŸèƒ½
- [ ] å®ç°ç¼–è¾‘ç”¨æˆ·åŠŸèƒ½
- [ ] å®ç°åˆ é™¤ç”¨æˆ·åŠŸèƒ½

#### Day 3: å®Œå–„åŠŸèƒ½
- [ ] å®ç°é‡ç½®å¯†ç åŠŸèƒ½
- [ ] å®ç°å¯ç”¨/ç¦ç”¨åŠŸèƒ½
- [ ] å®ç°è§’è‰²ä¿®æ”¹åŠŸèƒ½ï¼ˆBç«¯ç”¨æˆ·ï¼‰
- [ ] ä¼˜åŒ–UIå’Œäº¤äº’

### æ­¥éª¤3: è”è°ƒä¸æµ‹è¯•ï¼ˆ1å¤©ï¼‰

- [ ] å‰åç«¯è”è°ƒ
- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] æƒé™æµ‹è¯•
- [ ] Bugä¿®å¤

---

## ğŸ¯ å…­ã€å…³é”®åŠŸèƒ½ç‚¹

### 6.1 æƒé™æ§åˆ¶

1. **Controllerçº§åˆ«**ï¼š`@RequireRole("ADMIN")` - ä»…ç®¡ç†å‘˜å¯è®¿é—®
2. **ç§Ÿæˆ·éš”ç¦»**ï¼šæ‰€æœ‰æ“ä½œéƒ½éªŒè¯ `tenantId`ï¼Œç¡®ä¿åªèƒ½æ“ä½œå½“å‰ç§Ÿæˆ·çš„ç”¨æˆ·
3. **è‡ªæˆ‘ä¿æŠ¤**ï¼šä¸èƒ½åˆ é™¤/ç¦ç”¨è‡ªå·±

### 6.2 æ•°æ®éªŒè¯

1. **ç”¨æˆ·åå”¯ä¸€æ€§**ï¼šåŒç§Ÿæˆ·å†…ç”¨æˆ·åä¸èƒ½é‡å¤
2. **è§’è‰²éªŒè¯**ï¼šåˆ›å»º/ä¿®æ”¹æ—¶éªŒè¯è§’è‰²æœ‰æ•ˆæ€§
3. **å¯†ç è§„åˆ™**ï¼š6-20ä½
4. **é‚®ç®±æ ¼å¼**ï¼šä½¿ç”¨ `@Email` æ³¨è§£éªŒè¯

### 6.3 è½¯åˆ é™¤

- åˆ é™¤æ“ä½œï¼šè®¾ç½® `status=0`ï¼Œä¸ç‰©ç†åˆ é™¤
- æŸ¥è¯¢æ—¶ï¼šå¯ä»¥ç­›é€‰ `status` æ¥æŸ¥çœ‹å·²åˆ é™¤çš„ç”¨æˆ·

### 6.4 è§’è‰²ç®¡ç†

- **Cç«¯ç”¨æˆ·ï¼ˆUSERï¼‰**ï¼šè§’è‰²å›ºå®šï¼Œä¸èƒ½ä¿®æ”¹
- **Bç«¯ç”¨æˆ·ï¼ˆADMIN/AGENTï¼‰**ï¼šå¯ä»¥åœ¨ADMINå’ŒAGENTä¹‹é—´åˆ‡æ¢

---

## ğŸ”§ ä¸ƒã€æ³¨æ„äº‹é¡¹

1. **ç§Ÿæˆ·éš”ç¦»**ï¼šæ‰€æœ‰æ“ä½œå¿…é¡»éªŒè¯ `tenantId`ï¼Œé˜²æ­¢è·¨ç§Ÿæˆ·æ“ä½œ
2. **æƒé™æ§åˆ¶**ï¼šç¡®ä¿åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®è´¦å·ç®¡ç†åŠŸèƒ½
3. **æ•°æ®å®‰å…¨**ï¼šå¯†ç ä½¿ç”¨BCryptåŠ å¯†å­˜å‚¨
4. **æ“ä½œæ—¥å¿—**ï¼šé‡è¦æ“ä½œï¼ˆåˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹è§’è‰²ï¼‰å»ºè®®è®°å½•æ—¥å¿—
5. **è‡ªæˆ‘ä¿æŠ¤**ï¼šä¸èƒ½åˆ é™¤/ç¦ç”¨è‡ªå·±ï¼Œé˜²æ­¢è¯¯æ“ä½œ
6. **è½¯åˆ é™¤**ï¼šåˆ é™¤ç”¨æˆ·ä½¿ç”¨è½¯åˆ é™¤ï¼Œä¿ç•™æ•°æ®ç”¨äºå®¡è®¡

---

## ğŸ“Š å…«ã€APIæ¥å£æ¸…å•

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|
| GET | `/api/admin/user-management/list` | æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ | ADMIN |
| GET | `/api/admin/user-management/{userId}` | è·å–ç”¨æˆ·è¯¦æƒ… | ADMIN |
| POST | `/api/admin/user-management/create` | åˆ›å»ºç”¨æˆ· | ADMIN |
| PUT | `/api/admin/user-management/{userId}` | æ›´æ–°ç”¨æˆ· | ADMIN |
| POST | `/api/admin/user-management/{userId}/reset-password` | é‡ç½®å¯†ç  | ADMIN |
| DELETE | `/api/admin/user-management/{userId}` | åˆ é™¤ç”¨æˆ· | ADMIN |
| PUT | `/api/admin/user-management/{userId}/status` | å¯ç”¨/ç¦ç”¨ç”¨æˆ· | ADMIN |

---

**æ–‡æ¡£ç»´æŠ¤**: è¯·æ ¹æ®å®ç°è¿›å±•åŠæ—¶æ›´æ–°æ­¤æ–‡æ¡£  
**æœ€åæ›´æ–°**: 2026-01-21






