# å®¢æœçŠ¶æ€ç®¡ç† - ä¼ä¸šçº§æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¶é—´**: 2026-01-21  
> **ç›®æ ‡**: è®¾è®¡ç¬¦åˆä¼ä¸šçº§æ ‡å‡†çš„å®¢æœçŠ¶æ€ç®¡ç†æ–¹æ¡ˆ

---

## ğŸ“Š ä¸€ã€é—®é¢˜åˆ†æ

### 1.1 å­—æ®µç‰¹æ€§åˆ†æ

| å­—æ®µ | ç‰¹æ€§ | æ›´æ–°é¢‘ç‡ | æ•°æ®æ€§è´¨ | å»ºè®®å­˜å‚¨æ–¹å¼ |
|------|------|---------|---------|------------|
| **online_status** | åœ¨çº¿çŠ¶æ€ | é«˜é¢‘ï¼ˆç™»å½•/ç™»å‡º/å¿ƒè·³ï¼‰ | è¿è¡Œæ—¶çŠ¶æ€ | **Redisç¼“å­˜** |
| **max_concurrent_sessions** | æœ€å¤§å¹¶å‘æ•° | ä½é¢‘ï¼ˆé…ç½®å˜æ›´ï¼‰ | ä¸šåŠ¡é…ç½® | **é…ç½®è¡¨** |
| **current_sessions** | å½“å‰ä¼šè¯æ•° | è¶…é«˜é¢‘ï¼ˆæ¯æ¬¡æ¥å…¥/ç»“æŸï¼‰ | å®æ—¶ç»Ÿè®¡ | **Redisç¼“å­˜** |

### 1.2 ä¸ºä»€ä¹ˆä¸åº”è¯¥å…¨éƒ¨æ”¾åœ¨userè¡¨ï¼Ÿ

#### âŒ é—®é¢˜1ï¼šæ•°æ®æ€§è´¨æ··ä¹±
- `user` è¡¨åº”è¯¥åªå­˜å‚¨**ç”¨æˆ·çš„åŸºç¡€å±æ€§**ï¼ˆç”¨æˆ·åã€å¯†ç ã€è§’è‰²ç­‰ï¼‰
- åœ¨çº¿çŠ¶æ€å’Œå½“å‰ä¼šè¯æ•°æ˜¯**è¿è¡Œæ—¶çŠ¶æ€**ï¼Œä¸æ˜¯æŒä¹…åŒ–å±æ€§
- æ··åˆå­˜å‚¨ä¼šå¯¼è‡´æ•°æ®æ¨¡å‹ä¸æ¸…æ™°

#### âŒ é—®é¢˜2ï¼šæ€§èƒ½é—®é¢˜
- **é¢‘ç¹æ›´æ–°**ï¼šåœ¨çº¿çŠ¶æ€å’Œå½“å‰ä¼šè¯æ•°æ›´æ–°éå¸¸é¢‘ç¹
- **æ•°æ®åº“å‹åŠ›**ï¼šæ¯æ¬¡æ›´æ–°éƒ½è¦å†™æ•°æ®åº“ï¼Œé€ æˆä¸å¿…è¦çš„IO
- **é”ç«äº‰**ï¼šé«˜å¹¶å‘ä¸‹å¯èƒ½å¯¼è‡´è¡Œé”ç«äº‰

#### âŒ é—®é¢˜3ï¼šæ•°æ®ä¸€è‡´æ€§
- ç”¨æˆ·ä¸‹çº¿åï¼Œåœ¨çº¿çŠ¶æ€åº”è¯¥**ç«‹å³æ¸…é™¤**ï¼Œè€Œä¸æ˜¯æ›´æ–°ä¸ºOFFLINE
- å½“å‰ä¼šè¯æ•°åº”è¯¥**å®æ—¶è®¡ç®—**ï¼Œè€Œä¸æ˜¯æŒä¹…åŒ–å­˜å‚¨
- æ•°æ®åº“å­˜å‚¨ä¼šå¯¼è‡´çŠ¶æ€æ»å

#### âŒ é—®é¢˜4ï¼šæ‰©å±•æ€§å·®
- æœªæ¥å¯èƒ½éœ€è¦æ›´å¤šè¿è¡Œæ—¶çŠ¶æ€ï¼ˆæœ€åæ´»è·ƒæ—¶é—´ã€å½“å‰å¤„ç†çš„å·¥å•IDç­‰ï¼‰
- å…¨éƒ¨æ”¾åœ¨userè¡¨ä¼šå¯¼è‡´è¡¨ç»“æ„è‡ƒè‚¿

---

## ğŸ—ï¸ äºŒã€ä¼ä¸šçº§è®¾è®¡æ–¹æ¡ˆ

### 2.1 è®¾è®¡åŸåˆ™

1. **æ•°æ®åˆ†ç¦»åŸåˆ™**
   - åŸºç¡€ä¿¡æ¯ vs ä¸šåŠ¡é…ç½® vs è¿è¡Œæ—¶çŠ¶æ€
   - ä¸åŒæ€§è´¨çš„æ•°æ®åˆ†å¼€å­˜å‚¨

2. **æ€§èƒ½ä¼˜å…ˆåŸåˆ™**
   - é«˜é¢‘è¯»å†™çš„æ•°æ®ç”¨ç¼“å­˜ï¼ˆRedisï¼‰
   - ä½é¢‘é…ç½®æ•°æ®ç”¨æ•°æ®åº“

3. **å®æ—¶æ€§åŸåˆ™**
   - è¿è¡Œæ—¶çŠ¶æ€å¿…é¡»å®æ—¶ï¼Œç”¨Redis
   - å†å²æ•°æ®å¯ä»¥å¼‚æ­¥è½åº“

### 2.2 ä¸‰å±‚å­˜å‚¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç”¨æˆ·åŸºç¡€ä¿¡æ¯ï¼ˆuserè¡¨ï¼‰              â”‚
â”‚  - ç”¨æˆ·åã€å¯†ç ã€è§’è‰²ã€é‚®ç®±ç­‰              â”‚
â”‚  - ç›¸å¯¹ç¨³å®šï¼Œä½é¢‘æ›´æ–°                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       å®¢æœé…ç½®ä¿¡æ¯ï¼ˆagent_configè¡¨ï¼‰       â”‚
â”‚  - æœ€å¤§å¹¶å‘ä¼šè¯æ•°                          â”‚
â”‚  - å·¥ä½œæ—¶æ®µé…ç½®                            â”‚
â”‚  - æŠ€èƒ½æ ‡ç­¾ç­‰                              â”‚
â”‚  - é…ç½®å±æ€§ï¼Œä¸­é¢‘æ›´æ–°                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       è¿è¡Œæ—¶çŠ¶æ€ï¼ˆRedisç¼“å­˜ï¼‰               â”‚
â”‚  - åœ¨çº¿çŠ¶æ€                                â”‚
â”‚  - å½“å‰ä¼šè¯æ•°                              â”‚
â”‚  - æœ€åæ´»è·ƒæ—¶é—´                            â”‚
â”‚  - å¿ƒè·³æ—¶é—´æˆ³                              â”‚
â”‚  - è¿è¡Œæ—¶çŠ¶æ€ï¼Œè¶…é«˜é¢‘æ›´æ–°                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 userè¡¨ï¼ˆä¿æŒä¸å˜ï¼‰

```sql
-- userè¡¨åªå­˜å‚¨ç”¨æˆ·åŸºç¡€ä¿¡æ¯ï¼Œä¸åšä¿®æ”¹
CREATE TABLE `user` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
  `tenant_id` BIGINT(20) NOT NULL,
  `username` VARCHAR(50) NOT NULL,
  `password` VARCHAR(255) NOT NULL,
  `role` VARCHAR(20) NOT NULL DEFAULT 'USER',
  `status` TINYINT(1) NOT NULL DEFAULT 1,
  `nick_name` VARCHAR(50) DEFAULT NULL,
  `email` VARCHAR(100) DEFAULT NULL,
  `phone` VARCHAR(20) DEFAULT NULL,
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_username` (`tenant_id`, `username`),
  KEY `idx_tenant_id` (`tenant_id`),
  KEY `idx_role` (`role`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

**è¯´æ˜**ï¼š
- âœ… åªå­˜å‚¨ç”¨æˆ·çš„åŸºç¡€å±æ€§
- âœ… ä¸åŒ…å«è¿è¡Œæ—¶çŠ¶æ€
- âœ… ä¿æŒè¡¨ç»“æ„ç®€æ´

---

### 3.2 agent_configè¡¨ï¼ˆæ–°å¢ - å®¢æœé…ç½®è¡¨ï¼‰

```sql
-- å®¢æœé…ç½®è¡¨ï¼šå­˜å‚¨å®¢æœçš„å·¥ä½œé…ç½®ä¿¡æ¯
CREATE TABLE `agent_config` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `tenant_id` BIGINT(20) NOT NULL COMMENT 'ç§Ÿæˆ·ID',
  `user_id` BIGINT(20) NOT NULL COMMENT 'ç”¨æˆ·IDï¼ˆå®¢æœIDï¼‰',
  `max_concurrent_sessions` INT NOT NULL DEFAULT 5 COMMENT 'æœ€å¤§å¹¶å‘ä¼šè¯æ•°',
  `work_schedule` JSON DEFAULT NULL COMMENT 'å·¥ä½œæ—¶æ®µé…ç½®ï¼ˆJSONæ ¼å¼ï¼‰',
  `skill_tags` VARCHAR(500) DEFAULT NULL COMMENT 'æŠ€èƒ½æ ‡ç­¾ï¼Œé€—å·åˆ†éš”',
  `auto_accept` TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦è‡ªåŠ¨æ¥å…¥ï¼š1-æ˜¯ï¼Œ0-å¦',
  `response_template` TEXT DEFAULT NULL COMMENT 'å¿«æ·å›å¤æ¨¡æ¿ï¼ˆJSONæ ¼å¼ï¼‰',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_tenant_id` (`tenant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å®¢æœé…ç½®è¡¨';
```

**è¯´æ˜**ï¼š
- âœ… å­˜å‚¨å®¢æœçš„**ä¸šåŠ¡é…ç½®**ï¼ˆç›¸å¯¹ç¨³å®šï¼‰
- âœ… æ”¯æŒæœªæ¥æ‰©å±•ï¼ˆå·¥ä½œæ—¶æ®µã€æŠ€èƒ½æ ‡ç­¾ç­‰ï¼‰
- âœ… ä¸userè¡¨ä¸€å¯¹ä¸€å…³ç³»ï¼ˆä¸€ä¸ªå®¢æœä¸€ä¸ªé…ç½®ï¼‰

**ç¤ºä¾‹æ•°æ®**ï¼š
```json
{
  "work_schedule": {
    "monday": {"start": "09:00", "end": "18:00"},
    "tuesday": {"start": "09:00", "end": "18:00"},
    // ...
  },
  "response_template": [
    {"key": "greeting", "content": "æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ"},
    {"key": "busy", "content": "æŠ±æ­‰ï¼Œå½“å‰å’¨è¯¢è¾ƒå¤šï¼Œè¯·ç¨å€™..."}
  ]
}
```

---

### 3.3 Rediså­˜å‚¨è®¾è®¡ï¼ˆè¿è¡Œæ—¶çŠ¶æ€ï¼‰

#### 3.3.1 åœ¨çº¿çŠ¶æ€å­˜å‚¨

**Keyè®¾è®¡**ï¼š
```
agent:status:{tenantId}:{userId}
```

**Valueç»“æ„**ï¼ˆHashï¼‰ï¼š
```
{
  "status": "ONLINE|OFFLINE|AWAY",
  "last_active_time": "2026-01-21 10:30:00",
  "heartbeat_time": 1705812600000,
  "current_sessions": 3,
  "max_sessions": 5
}
```

**TTLè®¾ç½®**ï¼š
- é»˜è®¤ï¼š30åˆ†é’Ÿï¼ˆå¿ƒè·³è¶…æ—¶è‡ªåŠ¨æ¸…é™¤ï¼‰
- ç™»å½•æ—¶ï¼šè®¾ç½®TTLä¸º30åˆ†é’Ÿ
- å¿ƒè·³æ—¶ï¼šåˆ·æ–°TTL

#### 3.3.2 å½“å‰ä¼šè¯æ•°å­˜å‚¨

**Keyè®¾è®¡**ï¼š
```
agent:sessions:{tenantId}:{userId}
```

**Value**ï¼šæ•´æ•°ï¼ˆå½“å‰å¤„ç†çš„ä¼šè¯æ•°ï¼‰

**æ“ä½œ**ï¼š
- æ¥å…¥ä¼šè¯ï¼š`INCR`
- ç»“æŸä¼šè¯ï¼š`DECR`
- æŸ¥è¯¢ï¼š`GET`

#### 3.3.3 åœ¨çº¿å®¢æœåˆ—è¡¨ï¼ˆSorted Setï¼‰

**Keyè®¾è®¡**ï¼š
```
agent:online:{tenantId}
```

**Valueç»“æ„**ï¼ˆSorted Setï¼‰ï¼š
```
member: userId
score: last_active_time (timestamp)
```

**ç”¨é€”**ï¼š
- å¿«é€ŸæŸ¥è¯¢åœ¨çº¿å®¢æœåˆ—è¡¨
- æŒ‰æœ€åæ´»è·ƒæ—¶é—´æ’åº
- è‡ªåŠ¨æ¸…ç†ç¦»çº¿å®¢æœï¼ˆé€šè¿‡TTLæˆ–å®šæ—¶ä»»åŠ¡ï¼‰

---

## ğŸ’» å››ã€ä»£ç å®ç°æ–¹æ¡ˆ

### 4.1 AgentConfigå®ä½“ç±»

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/user/entity/AgentConfig.java`

```java
package com.ityfz.yulu.user.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.time.LocalDateTime;

@Data
@TableName("agent_config")
public class AgentConfig {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private Long tenantId;
    
    private Long userId; // å®¢æœç”¨æˆ·ID
    
    private Integer maxConcurrentSessions; // æœ€å¤§å¹¶å‘ä¼šè¯æ•°
    
    private String workSchedule; // JSONæ ¼å¼çš„å·¥ä½œæ—¶æ®µ
    
    private String skillTags; // æŠ€èƒ½æ ‡ç­¾ï¼Œé€—å·åˆ†éš”
    
    private Integer autoAccept; // æ˜¯å¦è‡ªåŠ¨æ¥å…¥
    
    private String responseTemplate; // JSONæ ¼å¼çš„å¿«æ·å›å¤æ¨¡æ¿
    
    private LocalDateTime createTime;
    
    private LocalDateTime updateTime;
}
```

### 4.2 AgentConfigService

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/user/service/AgentConfigService.java`

```java
package com.ityfz.yulu.user.service;

import com.ityfz.yulu.user.entity.AgentConfig;

public interface AgentConfigService {
    /**
     * è·å–å®¢æœé…ç½®ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºé»˜è®¤é…ç½®ï¼‰
     */
    AgentConfig getOrCreateConfig(Long tenantId, Long userId);
    
    /**
     * æ›´æ–°å®¢æœé…ç½®
     */
    void updateConfig(Long tenantId, Long userId, AgentConfig config);
    
    /**
     * è·å–æœ€å¤§å¹¶å‘ä¼šè¯æ•°
     */
    Integer getMaxConcurrentSessions(Long tenantId, Long userId);
}
```

### 4.3 AgentStatusServiceï¼ˆRedisæ“ä½œï¼‰

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/user/service/AgentStatusService.java`

```java
package com.ityfz.yulu.user.service;

import java.util.List;
import java.util.Map;

/**
 * å®¢æœçŠ¶æ€æœåŠ¡ï¼ˆåŸºäºRedisï¼‰
 */
public interface AgentStatusService {
    /**
     * è®¾ç½®åœ¨çº¿çŠ¶æ€
     */
    void setOnline(Long tenantId, Long userId);
    
    /**
     * è®¾ç½®ç¦»çº¿çŠ¶æ€
     */
    void setOffline(Long tenantId, Long userId);
    
    /**
     * è®¾ç½®ç¦»å¼€çŠ¶æ€
     */
    void setAway(Long tenantId, Long userId);
    
    /**
     * æ›´æ–°å¿ƒè·³æ—¶é—´
     */
    void updateHeartbeat(Long tenantId, Long userId);
    
    /**
     * è·å–åœ¨çº¿çŠ¶æ€
     */
    String getStatus(Long tenantId, Long userId);
    
    /**
     * å¢åŠ å½“å‰ä¼šè¯æ•°
     */
    void incrementSessionCount(Long tenantId, Long userId);
    
    /**
     * å‡å°‘å½“å‰ä¼šè¯æ•°
     */
    void decrementSessionCount(Long tenantId, Long userId);
    
    /**
     * è·å–å½“å‰ä¼šè¯æ•°
     */
    Integer getCurrentSessionCount(Long tenantId, Long userId);
    
    /**
     * è·å–åœ¨çº¿å®¢æœåˆ—è¡¨
     */
    List<Long> getOnlineAgents(Long tenantId);
    
    /**
     * è·å–å®¢æœå®Œæ•´çŠ¶æ€ä¿¡æ¯
     */
    Map<String, Object> getAgentStatus(Long tenantId, Long userId);
    
    /**
     * æ£€æŸ¥æ˜¯å¦å¯ä»¥æ¥å…¥æ–°ä¼šè¯ï¼ˆæœªè¾¾åˆ°æœ€å¤§å¹¶å‘æ•°ï¼‰
     */
    boolean canAcceptSession(Long tenantId, Long userId);
}
```

### 4.4 AgentStatusServiceå®ç°

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/user/service/impl/AgentStatusServiceImpl.java`

```java
package com.ityfz.yulu.user.service.impl;

import com.ityfz.yulu.user.service.AgentConfigService;
import com.ityfz.yulu.user.service.AgentStatusService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.core.ZSetOperations;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.util.*;
import java.util.concurrent.TimeUnit;

@Slf4j
@Service
@RequiredArgsConstructor
public class AgentStatusServiceImpl implements AgentStatusService {
    
    private final RedisTemplate<String, Object> redisTemplate;
    private final AgentConfigService agentConfigService;
    
    private static final String STATUS_KEY_PREFIX = "agent:status:";
    private static final String SESSIONS_KEY_PREFIX = "agent:sessions:";
    private static final String ONLINE_SET_KEY_PREFIX = "agent:online:";
    private static final int HEARTBEAT_TTL_MINUTES = 30;
    
    @Override
    public void setOnline(Long tenantId, Long userId) {
        String statusKey = buildStatusKey(tenantId, userId);
        String sessionsKey = buildSessionsKey(tenantId, userId);
        String onlineSetKey = buildOnlineSetKey(tenantId);
        
        long now = System.currentTimeMillis();
        LocalDateTime nowDateTime = LocalDateTime.now();
        
        // è®¾ç½®çŠ¶æ€Hash
        Map<String, Object> status = new HashMap<>();
        status.put("status", "ONLINE");
        status.put("last_active_time", nowDateTime.toString());
        status.put("heartbeat_time", now);
        status.put("current_sessions", 0);
        
        // è·å–æœ€å¤§å¹¶å‘æ•°ï¼ˆä»é…ç½®è¡¨ï¼‰
        Integer maxSessions = agentConfigService.getMaxConcurrentSessions(tenantId, userId);
        status.put("max_sessions", maxSessions != null ? maxSessions : 5);
        
        redisTemplate.opsForHash().putAll(statusKey, status);
        redisTemplate.expire(statusKey, HEARTBEAT_TTL_MINUTES, TimeUnit.MINUTES);
        
        // åˆå§‹åŒ–ä¼šè¯æ•°
        redisTemplate.opsForValue().set(sessionsKey, 0);
        redisTemplate.expire(sessionsKey, HEARTBEAT_TTL_MINUTES, TimeUnit.MINUTES);
        
        // æ·»åŠ åˆ°åœ¨çº¿é›†åˆ
        redisTemplate.opsForZSet().add(onlineSetKey, userId.toString(), now);
        redisTemplate.expire(onlineSetKey, HEARTBEAT_TTL_MINUTES, TimeUnit.MINUTES);
        
        log.info("[AgentStatus] å®¢æœä¸Šçº¿: tenantId={}, userId={}", tenantId, userId);
    }
    
    @Override
    public void setOffline(Long tenantId, Long userId) {
        String statusKey = buildStatusKey(tenantId, userId);
        String sessionsKey = buildSessionsKey(tenantId, userId);
        String onlineSetKey = buildOnlineSetKey(tenantId);
        
        // åˆ é™¤çŠ¶æ€å’Œä¼šè¯æ•°
        redisTemplate.delete(statusKey);
        redisTemplate.delete(sessionsKey);
        
        // ä»åœ¨çº¿é›†åˆç§»é™¤
        redisTemplate.opsForZSet().remove(onlineSetKey, userId.toString());
        
        log.info("[AgentStatus] å®¢æœä¸‹çº¿: tenantId={}, userId={}", tenantId, userId);
    }
    
    @Override
    public void setAway(Long tenantId, Long userId) {
        String statusKey = buildStatusKey(tenantId, userId);
        redisTemplate.opsForHash().put(statusKey, "status", "AWAY");
        redisTemplate.expire(statusKey, HEARTBEAT_TTL_MINUTES, TimeUnit.MINUTES);
        
        log.debug("[AgentStatus] å®¢æœç¦»å¼€: tenantId={}, userId={}", tenantId, userId);
    }
    
    @Override
    public void updateHeartbeat(Long tenantId, Long userId) {
        String statusKey = buildStatusKey(tenantId, userId);
        String onlineSetKey = buildOnlineSetKey(tenantId);
        
        long now = System.currentTimeMillis();
        LocalDateTime nowDateTime = LocalDateTime.now();
        
        // æ›´æ–°å¿ƒè·³æ—¶é—´
        redisTemplate.opsForHash().put(statusKey, "heartbeat_time", now);
        redisTemplate.opsForHash().put(statusKey, "last_active_time", nowDateTime.toString());
        redisTemplate.expire(statusKey, HEARTBEAT_TTL_MINUTES, TimeUnit.MINUTES);
        
        // æ›´æ–°åœ¨çº¿é›†åˆçš„score
        redisTemplate.opsForZSet().add(onlineSetKey, userId.toString(), now);
        redisTemplate.expire(onlineSetKey, HEARTBEAT_TTL_MINUTES, TimeUnit.MINUTES);
    }
    
    @Override
    public String getStatus(Long tenantId, Long userId) {
        String statusKey = buildStatusKey(tenantId, userId);
        Object status = redisTemplate.opsForHash().get(statusKey, "status");
        return status != null ? status.toString() : "OFFLINE";
    }
    
    @Override
    public void incrementSessionCount(Long tenantId, Long userId) {
        String sessionsKey = buildSessionsKey(tenantId, userId);
        String statusKey = buildStatusKey(tenantId, userId);
        
        Long count = redisTemplate.opsForValue().increment(sessionsKey);
        redisTemplate.expire(sessionsKey, HEARTBEAT_TTL_MINUTES, TimeUnit.MINUTES);
        
        // åŒæ­¥æ›´æ–°çŠ¶æ€Hash
        if (count != null) {
            redisTemplate.opsForHash().put(statusKey, "current_sessions", count);
        }
        
        log.debug("[AgentStatus] å¢åŠ ä¼šè¯æ•°: tenantId={}, userId={}, count={}", 
                tenantId, userId, count);
    }
    
    @Override
    public void decrementSessionCount(Long tenantId, Long userId) {
        String sessionsKey = buildSessionsKey(tenantId, userId);
        String statusKey = buildStatusKey(tenantId, userId);
        
        Long count = redisTemplate.opsForValue().decrement(sessionsKey);
        if (count != null && count < 0) {
            count = 0L;
            redisTemplate.opsForValue().set(sessionsKey, 0);
        }
        redisTemplate.expire(sessionsKey, HEARTBEAT_TTL_MINUTES, TimeUnit.MINUTES);
        
        // åŒæ­¥æ›´æ–°çŠ¶æ€Hash
        if (count != null) {
            redisTemplate.opsForHash().put(statusKey, "current_sessions", count);
        }
        
        log.debug("[AgentStatus] å‡å°‘ä¼šè¯æ•°: tenantId={}, userId={}, count={}", 
                tenantId, userId, count);
    }
    
    @Override
    public Integer getCurrentSessionCount(Long tenantId, Long userId) {
        String sessionsKey = buildSessionsKey(tenantId, userId);
        Object count = redisTemplate.opsForValue().get(sessionsKey);
        return count != null ? Integer.parseInt(count.toString()) : 0;
    }
    
    @Override
    public List<Long> getOnlineAgents(Long tenantId) {
        String onlineSetKey = buildOnlineSetKey(tenantId);
        Set<Object> members = redisTemplate.opsForZSet().range(onlineSetKey, 0, -1);
        
        List<Long> agentIds = new ArrayList<>();
        if (members != null) {
            for (Object member : members) {
                try {
                    agentIds.add(Long.parseLong(member.toString()));
                } catch (NumberFormatException e) {
                    log.warn("[AgentStatus] æ— æ•ˆçš„å®¢æœID: {}", member);
                }
            }
        }
        
        return agentIds;
    }
    
    @Override
    public Map<String, Object> getAgentStatus(Long tenantId, Long userId) {
        String statusKey = buildStatusKey(tenantId, userId);
        Map<Object, Object> hash = redisTemplate.opsForHash().entries(statusKey);
        
        Map<String, Object> result = new HashMap<>();
        if (hash != null && !hash.isEmpty()) {
            for (Map.Entry<Object, Object> entry : hash.entrySet()) {
                result.put(entry.getKey().toString(), entry.getValue());
            }
        } else {
            result.put("status", "OFFLINE");
            result.put("current_sessions", 0);
        }
        
        return result;
    }
    
    @Override
    public boolean canAcceptSession(Long tenantId, Long userId) {
        Map<String, Object> status = getAgentStatus(tenantId, userId);
        
        String currentStatus = (String) status.get("status");
        if (!"ONLINE".equals(currentStatus)) {
            return false; // ä¸åœ¨çº¿
        }
        
        Integer currentSessions = (Integer) status.get("current_sessions");
        Integer maxSessions = (Integer) status.get("max_sessions");
        
        if (currentSessions == null) currentSessions = 0;
        if (maxSessions == null) maxSessions = 5;
        
        return currentSessions < maxSessions;
    }
    
    // å·¥å…·æ–¹æ³•
    private String buildStatusKey(Long tenantId, Long userId) {
        return STATUS_KEY_PREFIX + tenantId + ":" + userId;
    }
    
    private String buildSessionsKey(Long tenantId, Long userId) {
        return SESSIONS_KEY_PREFIX + tenantId + ":" + userId;
    }
    
    private String buildOnlineSetKey(Long tenantId) {
        return ONLINE_SET_KEY_PREFIX + tenantId;
    }
}
```

### 4.5 ç™»å½•æ—¶è‡ªåŠ¨è®¾ç½®åœ¨çº¿çŠ¶æ€

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/controller/AdminAuthController.java`

```java
// åœ¨ç™»å½•æˆåŠŸå
@PostMapping("/login")
public ApiResponse<LoginResponse> login(@RequestBody LoginRequest request) {
    // ... éªŒè¯é€»è¾‘ ...
    
    // ç™»å½•æˆåŠŸ
    if (Roles.isAgent(user.getRole()) || Roles.isAdmin(user.getRole())) {
        // è®¾ç½®åœ¨çº¿çŠ¶æ€ï¼ˆä»…å®¢æœå’Œç®¡ç†å‘˜ï¼‰
        agentStatusService.setOnline(user.getTenantId(), user.getId());
    }
    
    // ... è¿”å›token ...
}
```

### 4.6 ç™»å‡ºæ—¶æ¸…é™¤çŠ¶æ€

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/controller/AdminAuthController.java`

```java
@PostMapping("/logout")
public ApiResponse<Void> logout() {
    Long tenantId = SecurityUtil.currentTenantId();
    Long userId = SecurityUtil.currentUserId();
    String role = SecurityUtil.currentRole();
    
    if ((Roles.isAgent(role) || Roles.isAdmin(role)) && tenantId != null && userId != null) {
        agentStatusService.setOffline(tenantId, userId);
    }
    
    return ApiResponse.success("ç™»å‡ºæˆåŠŸ");
}
```

### 4.7 å¿ƒè·³æ¥å£ï¼ˆä¿æŒåœ¨çº¿ï¼‰

**æ–‡ä»¶**: `src/main/java/com/ityfz/yulu/admin/controller/AdminUserController.java`

```java
/**
 * å¿ƒè·³æ¥å£ï¼ˆå®¢æœä¿æŒåœ¨çº¿çŠ¶æ€ï¼‰
 * POST /api/admin/user/heartbeat
 */
@PostMapping("/heartbeat")
@RequireRole({"ADMIN", "AGENT"})
public ApiResponse<Void> heartbeat() {
    Long tenantId = SecurityUtil.currentTenantId();
    Long userId = SecurityUtil.currentUserId();
    
    if (tenantId == null || userId == null) {
        throw new BizException(ErrorCodes.UNAUTHORIZED, "è¯·å…ˆç™»å½•");
    }
    
    agentStatusService.updateHeartbeat(tenantId, userId);
    return ApiResponse.success("å¿ƒè·³æˆåŠŸ");
}
```

---

## ğŸ“Š äº”ã€æ–¹æ¡ˆå¯¹æ¯”

### 5.1 æ–¹æ¡ˆå¯¹æ¯”è¡¨

| æ–¹æ¡ˆ           | ä¼˜ç‚¹            | ç¼ºç‚¹            | é€‚ç”¨åœºæ™¯     |
| ------------ | ------------- | ------------- | -------- |
| **å…¨éƒ¨æ”¾userè¡¨** | ç®€å•ï¼ŒæŸ¥è¯¢æ–¹ä¾¿       | æ€§èƒ½å·®ï¼Œæ•°æ®æ··ä¹±ï¼Œæ‰©å±•æ€§å·® | âŒ ä¸æ¨è    |
| **åˆ†è¡¨+Redis** | æ€§èƒ½å¥½ï¼Œæ•°æ®æ¸…æ™°ï¼Œæ‰©å±•æ€§å¼º | å®ç°ç¨å¤æ‚         | âœ… **æ¨è** |

### 5.2 æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | userè¡¨æ–¹æ¡ˆ | Redisæ–¹æ¡ˆ | æ€§èƒ½æå‡ |
|------|-----------|-----------|---------|
| æ›´æ–°åœ¨çº¿çŠ¶æ€ | 10-50ms | <1ms | **10-50å€** |
| æ›´æ–°ä¼šè¯æ•° | 10-50ms | <1ms | **10-50å€** |
| æŸ¥è¯¢åœ¨çº¿åˆ—è¡¨ | 100-500ms | 1-5ms | **100å€** |
| å¹¶å‘æ”¯æŒ | ä½ï¼ˆé”ç«äº‰ï¼‰ | é«˜ï¼ˆæ— é”ï¼‰ | **æ˜¾è‘—æå‡** |

---

## ğŸ¯ å…­ã€å®æ–½å»ºè®®

### 6.1 å®æ–½æ­¥éª¤

1. **ç¬¬ä¸€æ­¥**ï¼šåˆ›å»º `agent_config` è¡¨
2. **ç¬¬äºŒæ­¥**ï¼šå®ç° `AgentConfigService`
3. **ç¬¬ä¸‰æ­¥**ï¼šå®ç° `AgentStatusService`ï¼ˆRedisï¼‰
4. **ç¬¬å››æ­¥**ï¼šä¿®æ”¹ç™»å½•/ç™»å‡ºé€»è¾‘
5. **ç¬¬äº”æ­¥**ï¼šæ·»åŠ å¿ƒè·³æ¥å£
6. **ç¬¬å…­æ­¥**ï¼šå‰ç«¯é›†æˆï¼ˆå®šæ—¶å¿ƒè·³ï¼‰

### 6.2 æ³¨æ„äº‹é¡¹

1. **Redisé«˜å¯ç”¨**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Redis Sentinelæˆ–Cluster
2. **æ•°æ®å¤‡ä»½**ï¼šé‡è¦çŠ¶æ€å¯ä»¥å¼‚æ­¥è½åº“ï¼ˆå¯é€‰ï¼‰
3. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§Redisè¿æ¥å’Œå†…å­˜ä½¿ç”¨
4. **TTLè®¾ç½®**ï¼šæ ¹æ®ä¸šåŠ¡è°ƒæ•´å¿ƒè·³è¶…æ—¶æ—¶é—´

---

## ğŸ“ ä¸ƒã€æ€»ç»“

### âœ… æ¨èæ–¹æ¡ˆ

1. **userè¡¨**ï¼šåªå­˜å‚¨ç”¨æˆ·åŸºç¡€ä¿¡æ¯
2. **agent_configè¡¨**ï¼šå­˜å‚¨å®¢æœä¸šåŠ¡é…ç½®
3. **Redis**ï¼šå­˜å‚¨è¿è¡Œæ—¶çŠ¶æ€ï¼ˆåœ¨çº¿çŠ¶æ€ã€å½“å‰ä¼šè¯æ•°ï¼‰

### âœ… ä¼˜åŠ¿

1. **æ€§èƒ½ä¼˜å¼‚**ï¼šRedisè¯»å†™é€Ÿåº¦å¿«ï¼Œæ”¯æŒé«˜å¹¶å‘
2. **æ•°æ®æ¸…æ™°**ï¼šä¸åŒæ€§è´¨çš„æ•°æ®åˆ†ç¦»å­˜å‚¨
3. **æ‰©å±•æ€§å¼º**ï¼šæœªæ¥å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„è¿è¡Œæ—¶çŠ¶æ€
4. **ç¬¦åˆä¼ä¸šçº§æ ‡å‡†**ï¼šéµå¾ªæ•°æ®åˆ†ç¦»å’Œæ€§èƒ½ä¼˜åŒ–åŸåˆ™

---

**æ–‡æ¡£ç»´æŠ¤**: è¯·æ ¹æ®å®ç°è¿›å±•åŠæ—¶æ›´æ–°æ­¤æ–‡æ¡£  
**æœ€åæ›´æ–°**: 2026-01-21


















